<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Tides of Fortune</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Georgia,serif;background:linear-gradient(135deg,#2c3e50 0,#3498db 50%,#2980b9 100%);min-height:100vh;display:flex;align-items:center;justify-content:center}#gameContainer{width:90%;max-width:800px;min-height:600px}.screen{transition:opacity .5s ease}.screen.hidden{display:none}.screen.hidden{display:none}.hidden{display:none!important}.screen.active{display:block}#titleScreen{text-align:center;background:linear-gradient(145deg,#f4f1e8 0,#e8e1d3 100%);border:3px solid #8b4513;border-radius:15px;padding:60px 40px;box-shadow:0 20px 40px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.3);position:relative;overflow:hidden}#titleScreen::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%23d4af37" opacity="0.1"/></svg>') repeat;animation:shimmer 20s linear infinite;pointer-events:none}@keyframes shimmer{0%{transform:translateX(-100%) translateY(-100%)}100%{transform:translateX(100%) translateY(100%)}}#titleScreen h1{font-size:3em;color:#2c3e50;margin-bottom:20px;text-shadow:2px 2px 4px rgba(0,0,0,.1);font-weight:700;letter-spacing:2px}#titleScreen p{font-size:1.4em;color:#34495e;margin-bottom:50px;font-style:italic;text-shadow:1px 1px 2px rgba(0,0,0,.1)}#titleScreen button{background:linear-gradient(145deg,#d4af37,#b8941f);border:2px solid #8b7355;color:#2c3e50;font-size:1.2em;font-weight:700;padding:15px 30px;margin:10px 20px;border-radius:8px;cursor:pointer;transition:all .3s ease;font-family:Georgia,serif;text-shadow:1px 1px 2px rgba(0,0,0,.1);box-shadow:0 4px 8px rgba(0,0,0,.2)}#titleScreen button:hover{background:linear-gradient(145deg,#f1c40f,#d4af37);transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.3)}#titleScreen button:active{transform:translateY(0);box-shadow:0 2px 4px rgba(0,0,0,.2)}#gameScreen{background:linear-gradient(145deg,#f4f1e8 0,#e8e1d3 100%);border:3px solid #8b4513;border-radius:15px;padding:20px;box-shadow:0 20px 40px rgba(0,0,0,.3);min-height:600px}.game-section{transition:opacity .3s ease}.game-section.hidden{display:none}.creation-step{text-align:center;padding:20px}.creation-step.hidden{display:none}.creation-step h3{color:#2c3e50;margin-bottom:30px;font-size:1.8em}#characterName{padding:12px 20px;font-size:1.2em;border:2px solid #8b4513;border-radius:8px;margin-bottom:20px;width:300px;font-family:Georgia,serif}.background-options,.trait-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}.background-card,.trait-card{background:linear-gradient(145deg,#fff,#f0f0f0);border:2px solid #8b4513;border-radius:10px;padding:20px;cursor:pointer;transition:all .3s ease;text-align:left}.background-card:hover,.trait-card:hover{transform:translateY(-5px);box-shadow:0 8px 16px rgba(0,0,0,.2);border-color:#d4af37}.background-card.selected,.trait-card.selected{background:linear-gradient(145deg,#f1c40f,#d4af37);border-color:#b8941f;color:#2c3e50}.background-card h4,.trait-card h4{color:#2c3e50;margin-bottom:10px;font-size:1.3em}.background-card p,.trait-card p{color:#34495e;margin-bottom:8px}.background-card em{color:#7f8c8d;font-style:italic}button{background:linear-gradient(145deg,#d4af37,#b8941f);border:2px solid #8b7355;color:#2c3e50;font-size:1.1em;font-weight:700;padding:12px 25px;border-radius:8px;cursor:pointer;transition:all .3s ease;font-family:Georgia,serif}button:hover:not(:disabled){background:linear-gradient(145deg,#f1c40f,#d4af37);transform:translateY(-2px)}button:disabled{opacity:.5;cursor:not-allowed;transform:none}.status-bar{background:linear-gradient(145deg,#34495e,#2c3e50);color:#fff;padding:15px 20px;border-radius:10px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}.character-info h3{margin:0 0 8px 0;font-size:1.4em}.stats-row{display:flex;gap:25px}.stat{font-size:1.1em;font-weight:700}.action-buttons{display:flex;gap:10px;flex-wrap:wrap}@media (max-width:768px){.status-bar{flex-direction:column;gap:10px}.action-buttons{justify-content:center;width:100%}.action-buttons button{flex:1;min-width:100px;font-size:.8em;padding:6px 12px}}.action-buttons button{background:linear-gradient(145deg,#3498db,#2980b9);border:1px solid #2574a9;color:#fff;padding:8px 16px;font-size:.9em}.action-buttons button:hover{background:linear-gradient(145deg,#5dade2,#3498db)}.main-content{display:flex;gap:20px;min-height:400px}.content-panel{flex:1;background:rgba(255,255,255,.1);border:2px solid #8b4513;border-radius:10px;padding:20px}.location h2{color:#2c3e50;margin-bottom:15px;font-size:1.8em}.location-description{color:#34495e;font-style:italic;margin-bottom:25px;line-height:1.5}.location-activities{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}.activity-card{background:linear-gradient(145deg,#fff,#f8f9fa);border:2px solid #bdc3c7;border-radius:8px;padding:15px;cursor:pointer;transition:all .3s ease;text-align:center}.activity-card:hover{transform:translateY(-3px);border-color:#d4af37;box-shadow:0 6px 12px rgba(0,0,0,.1)}.activity-card h4{color:#2c3e50;margin-bottom:8px;font-size:1.2em}.activity-card p{color:#7f8c8d;margin-bottom:8px;font-size:.9em}.earnings{color:#27ae60;font-weight:700;font-size:.9em}.modal{position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}.modal.hidden{display:none}.modal-content{background:linear-gradient(145deg,#f4f1e8 0,#e8e1d3 100%);padding:30px;border:3px solid #8b4513;border-radius:15px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto;position:relative}.close{position:absolute;right:15px;top:15px;font-size:2em;cursor:pointer;color:#8b4513}.close:hover{color:#d4af37}.close:hover{color:#d4af37}.location{display:none}.location.active{display:block!important}.emergency-modal{position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(139,0,0,.8);display:flex;align-items:center;justify-content:center;animation:emergencyPulse 2s infinite}@keyframes emergencyPulse{0%,100%{background-color:rgba(139,0,0,.8)}50%{background-color:rgba(220,53,69,.9)}}.emergency-content{background:linear-gradient(145deg,#f8f9fa 0,#e9ecef 100%);padding:15px;border:4px solid #dc3545;border-radius:15px;width:95%;max-width:700px;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 25px 50px rgba(0,0,0,.5);animation:shake 1s ease-in-out}@keyframes shake{0%,100%,20%,40%,60%,80%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}}</style></head><body><div id="gameContainer"><div id="titleScreen" class="screen active"><h1>Tides of Fortune</h1><p>Build your fortune in the Age of Sail</p><button id="newGameBtn">New Game</button> <button id="loadGameBtn">Load Game</button></div><div id="gameScreen" class="screen hidden"><div id="characterCreation" class="game-section active"><h2>Create Your Character</h2><div class="creation-step" id="nameStep"><h3>Choose Your Name</h3><input type="text" id="characterName" placeholder="Enter your name" maxlength="20"> <button onclick="game.nextCreationStep()">Continue</button></div><div class="creation-step hidden" id="backgroundStep"><h3>Choose Your Background</h3><div class="background-options"><div class="background-card" data-background="dockworker"><h4>Poor Dock Worker</h4><p>Start with: 20 gold, high determination</p><p><em>"I'll work my way up from nothing"</em></p></div><div class="background-card" data-background="merchant"><h4>Merchant's Son</h4><p>Start with: 100 gold, trading knowledge</p><p><em>"Father taught me the value of a good deal"</em></p></div><div class="background-card" data-background="noble"><h4>Minor Noble</h4><p>Start with: 50 gold, social connections</p><p><em>"My family name opens doors"</em></p></div><div class="background-card" data-background="orphan"><h4>Ship's Orphan</h4><p>Start with: 10 gold, natural seamanship</p><p><em>"The sea is my home"</em></p></div><div class="background-card" data-background="testing"><h4>Rich Merchant (Testing)</h4><p>Start with: 10,000 gold, all skills</p><p><em>"Money is no object for testing"</em></p></div></div></div><div class="creation-step hidden" id="traitStep"><h3>Choose Your Traits (Pick 2)</h3><div class="trait-options"><div class="trait-card" data-trait="quicklearner"><h4>Quick Learner</h4><p>Faster skill progression</p></div><div class="trait-card" data-trait="bornsailor"><h4>Born Sailor</h4><p>Natural seamanship bonus</p></div><div class="trait-card" data-trait="silvertongue"><h4>Silver Tongue</h4><p>Better negotiations and prices</p></div><div class="trait-card" data-trait="lucky"><h4>Lucky</h4><p>More favorable random events</p></div><div class="trait-card" data-trait="brave"><h4>Brave</h4><p>Better military/danger outcomes</p></div><div class="trait-card" data-trait="frugal"><h4>Frugal</h4><p>Reduced living expenses</p></div></div><button id="finishCreation" onclick="game.finishCharacterCreation()" disabled="disabled">Begin Your Journey</button></div></div><div id="mainGame" class="game-section hidden"><div class="status-bar"><div class="character-info"><h3 id="characterNameDisplay"></h3><div class="stats-row"><span class="stat">üí∞ <span id="moneyDisplay">0</span> gold</span> <span class="stat">üìç <span id="locationDisplay">London</span></span> <span class="stat">üìÖ <span id="dateDisplay">January 1740</span></span></div></div><div class="action-buttons"><button onclick="game.showCharacterSheet()">Character</button> <button onclick="game.showSaveSlotMenu()">Save Game</button></div></div><div class="main-content"><div id="locationView" class="content-panel"><div id="londonLocation" class="location active"><h2>üè∞ London Docks</h2><p class="location-description">The bustling heart of England's maritime trade. Ships from across the empire dock here, bringing exotic goods and opportunities for those brave enough to seize them.</p><div class="location-activities"><div class="activity-card" onclick='game.startActivity("dockwork")'><h4>‚öì Dock Work</h4><p>Hard labor loading ships</p><span class="earnings">Earn: 2-4 gold/day</span></div><div class="activity-card" onclick='game.startActivity("tavern")'><h4>üç∫ Visit Tavern</h4><p>Meet sailors and merchants</p><span class="earnings">Cost: 1 gold</span></div><div class="activity-card" onclick='game.startActivity("shipyard")'><h4>‚õµ Shipyard</h4><p>Buy ships and supplies</p><span class="earnings">Browse ships</span></div><div class="activity-card" onclick='game.startActivity("market")'><h4>üè™ Market</h4><p>Trade goods locally</p><span class="earnings">Buy/Sell goods</span></div><div class="activity-card" onclick='game.startActivity("naval")'><h4>‚öîÔ∏è Naval Office</h4><p>Seek military service</p><span class="earnings">Join the Navy</span></div><div class="activity-card" onclick='game.startActivity("travel")'><h4>üó∫Ô∏è Travel</h4><p>Journey to other ports</p><span class="earnings">Explore Europe</span></div></div></div><div id="amsterdamLocation" class="location"><h2>üèõÔ∏è Amsterdam Harbor</h2><p class="location-description">The wealthy Dutch trading center bustles with merchants from across Europe. The air smells of spices, and gold changes hands quickly in this commercial paradise.</p><div class="location-activities"><div class="activity-card" onclick='game.startActivity("dockwork")'><h4>‚öì Dock Work</h4><p>Load Dutch merchant vessels</p><span class="earnings">Earn: 3-5 gold/day</span></div><div class="activity-card" onclick='game.startActivity("tavern")'><h4>üç∫ Visit Coffee House</h4><p>Meet Dutch traders and financiers</p><span class="earnings">Cost: 2 gold</span></div><div class="activity-card" onclick='game.startActivity("market")'><h4>üè™ Commodity Exchange</h4><p>Trade in the famous Dutch market</p><span class="earnings">Better prices</span></div><div class="activity-card" onclick='game.startActivity("shipyard")'><h4>‚õµ Dutch Shipyard</h4><p>Quality ships at fair prices</p><span class="earnings">Browse ships</span></div><div class="activity-card" onclick='game.startActivity("banking")'><h4>üè¶ Banking House</h4><p>Financial services and loans</p><span class="earnings">Manage money</span></div><div class="activity-card" onclick='game.startActivity("travel")'><h4>üó∫Ô∏è Travel</h4><p>Book passage elsewhere</p><span class="earnings">Explore Europe</span></div></div></div><div id="lisbonLocation" class="location"><h2>üåÖ Lisbon Port</h2><p class="location-description">Gateway to the Portuguese Empire, this sun-baked port thrums with tales of the New World. Ships laden with Brazilian gold and spices create opportunities for the bold.</p><div class="location-activities"><div class="activity-card" onclick='game.startActivity("dockwork")'><h4>‚öì Dock Work</h4><p>Handle exotic colonial goods</p><span class="earnings">Earn: 2-6 gold/day</span></div><div class="activity-card" onclick='game.startActivity("tavern")'><h4>üç∫ Sailor's Tavern</h4><p>Hear tales of the New World</p><span class="earnings">Cost: 1 gold</span></div><div class="activity-card" onclick='game.startActivity("market")'><h4>üè™ Colonial Market</h4><p>Exotic goods from Brazil</p><span class="earnings">Rare items</span></div><div class="activity-card" onclick='game.startActivity("exploration")'><h4>üó∫Ô∏è Exploration Office</h4><p>Join expeditions to new lands</p><span class="earnings">High risk, high reward</span></div><div class="activity-card" onclick='game.startActivity("shipyard")'><h4>‚õµ Portuguese Shipyard</h4><p>Ocean-worthy exploration vessels</p><span class="earnings">Browse ships</span></div><div class="activity-card" onclick='game.startActivity("travel")'><h4>üó∫Ô∏è Travel</h4><p>Book passage elsewhere</p><span class="earnings">Explore Europe</span></div></div></div><div id="bristolLocation" class="location"><h2>üö¢ Bristol Harbor</h2><p class="location-description">A growing English port with strong ties to the American colonies. Tobacco ships arrive regularly, and there's talk of great fortunes to be made across the Atlantic.</p><div class="location-activities"><div class="activity-card" onclick='game.startActivity("dockwork")'><h4>‚öì Dock Work</h4><p>Unload American tobacco</p><span class="earnings">Earn: 2-4 gold/day</span></div><div class="activity-card" onclick='game.startActivity("tavern")'><h4>üç∫ Colonial Tavern</h4><p>Meet colonial traders</p><span class="earnings">Cost: 1 gold</span></div><div class="activity-card" onclick='game.startActivity("market")'><h4>üè™ Tobacco Exchange</h4><p>Trade in colonial goods</p><span class="earnings">Colonial focus</span></div><div class="activity-card" onclick='game.startActivity("passage")'><h4>üö¢ New World Passage</h4><p>Book passage to America</p><span class="earnings">The big journey!</span></div><div class="activity-card" onclick='game.startActivity("hunt_pirates")'><h4>‚öîÔ∏è Hunt Pirates</h4><p>Patrol trade routes for pirates</p><span class="earnings">Ship required</span></div><div class="activity-card" onclick='game.startActivity("shipyard")'><h4>‚õµ Colonial Shipyard</h4><p>Ships built for Atlantic crossing</p><span class="earnings">Browse ships</span></div><div class="activity-card" onclick='game.startActivity("travel")'><h4>üó∫Ô∏è Travel</h4><p>Book passage elsewhere</p><span class="earnings">Explore Europe</span></div></div></div></div><div id="activityPanel" class="content-panel hidden"><h3 id="activityTitle">Activity</h3><div id="activityContent"></div><button onclick="game.returnToLocation()">Return to Docks</button></div></div><div id="characterSheet" class="modal hidden"><div class="modal-content"><span class="close" onclick="game.hideCharacterSheet()">&times;</span><h2>Character Sheet</h2><div id="characterSheetContent"></div></div></div></div><div id="emergencyModal" class="emergency-modal hidden"><div class="emergency-content"><h2 id="emergencyTitle" style="color:#dc3545;text-align:center;margin-bottom:20px">EMERGENCY!</h2><div id="emergencyContent"></div><div style="text-align:center;margin-top:20px"><button onclick="game.hideEmergencyEvent()" style="background:linear-gradient(145deg,#d4af37,#b8941f);border:2px solid #8b7355;color:#2c3e50;font-size:1.1em;font-weight:700;padding:12px 25px;border-radius:8px;cursor:pointer">Continue</button></div></div></div><script>class ColonialGame{constructor(){this.gameState={currentScreen:"title",character:null,gameData:null},this.initializeGame()}initializeGame(){this.bindEvents(),this.showScreen("titleScreen")}bindEvents(){document.getElementById("newGameBtn").addEventListener("click",()=>{this.startNewGame()}),document.getElementById("loadGameBtn").addEventListener("click",()=>{this.showLoadSlotMenu()})}showScreen(e){document.querySelectorAll(".screen").forEach(e=>{e.classList.remove("active"),e.classList.add("hidden")});const t=document.getElementById(e);t.classList.remove("hidden"),t.classList.add("active")}startNewGame(){this.showScreen("gameScreen"),this.characterData={name:"",background:null,traits:[],stats:{money:0,seamanship:0,trading:0,navigation:0,leadership:0,social:0},reputation:{crown:0,merchant:0,colonial:0,pirate:0}},this.currentCreationStep="name",this.setupCharacterCreationEvents(),document.getElementById("characterCreation").classList.remove("hidden"),document.getElementById("mainGame").classList.add("hidden")}setupCharacterCreationEvents(){document.querySelectorAll(".background-card").forEach(e=>{e.addEventListener("click",()=>{this.selectBackground(e.dataset.background,e)})}),document.querySelectorAll(".trait-card").forEach(e=>{e.addEventListener("click",()=>{this.toggleTrait(e.dataset.trait,e)})})}loadGame(){const e=localStorage.getItem("colonialGameSave");if(e){const t=JSON.parse(e),a=t.version||"1.0";if(console.log("Loading save from version:",a),this.gameState=t.gameState||t,this.characterData=t.characterData||t.character,!this.characterData)return void alert("Save file is corrupted!");this.showScreen("gameScreen"),document.getElementById("characterCreation").classList.add("hidden"),document.getElementById("mainGame").classList.remove("hidden"),this.initializeTrading(),this.characterData.age||(this.characterData.age=18,this.characterData.birthYear=this.gameState.year-18,this.characterData.health=100,this.gameState.daysSinceBirth=0),console.log("After compatibility check:",this.characterData.age),console.log("Character data:",this.characterData),this.updateDisplay(),this.updateLocationDisplay(),console.log("Game loaded successfully from version:",a)}else alert("No saved game found!")}saveGame(){const e={version:"2.01",gameState:this.gameState,characterData:this.characterData,savedDate:(new Date).toISOString()};localStorage.setItem("colonialGameSave",JSON.stringify(e)),alert("Game saved!")}showSaveSlotMenu(){let e="<strong>üíæ Save Game</strong><br><br>";e+="Choose a save slot:<br><br>";for(let t=1;t<=5;t++){const a=`colonialGameSave_slot${t}`,r=localStorage.getItem(a);if(r){const a=JSON.parse(r);e+='<div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 5px;">',e+=`<strong>Slot ${t}:</strong> ${this.getSaveInfo(a)}<br>`,e+=`<button onclick="game.saveToSlot(${t})" style="margin: 2px;">Overwrite</button>`,e+=`<button onclick="game.loadFromSlot(${t})" style="margin: 2px;">Load</button>`,e+=`<button onclick="game.deleteSlot(${t})" style="margin: 2px; background: #dc3545; color: white;">Delete</button>`,e+="</div>"}else e+='<div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 5px;">',e+=`<strong>Slot ${t}:</strong> <em>Empty</em><br>`,e+=`<button onclick="game.saveToSlot(${t})" style="margin: 2px;">Save Here</button>`,e+="</div>"}const t=`\n    <div id="saveGameModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">\n        <div style="background: linear-gradient(145deg, #f4f1e8 0%, #e8e1d3 100%); border: 3px solid #8b4513; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">\n            <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">üíæ Save Game</h2>\n            ${e}\n            <div style="text-align: center; margin-top: 20px;">\n                <button onclick="document.getElementById('saveGameModal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>\n            </div>\n        </div>\n    </div>\n`;document.body.insertAdjacentHTML("beforeend",t)}getSaveInfo(e){const t=e.characterData||e.character,a=e.savedDate?new Date(e.savedDate).toLocaleDateString():"Unknown date";return`${t.name} - ${t.stats.money} gold - ${a}`}saveToSlot(e){const t=`colonialGameSave_slot${e}`,a={version:"2.19",gameState:this.gameState,characterData:this.characterData,savedDate:(new Date).toISOString()};localStorage.setItem(t,JSON.stringify(a)),alert(`Game saved to slot ${e}!`),this.showSaveSlotMenu()}loadFromSlot(e){const t=`colonialGameSave_slot${e}`,a=localStorage.getItem(t);if(a&&confirm(`Load game from slot ${e}? Current progress will be lost!`)){const e=JSON.parse(a);this.gameState=e.gameState||e,this.characterData=e.characterData||e.character,this.showScreen("gameScreen"),document.getElementById("characterCreation").classList.add("hidden"),document.getElementById("mainGame").classList.remove("hidden"),this.initializeTrading(),this.characterData.age||(this.characterData.age=18,this.characterData.birthYear=this.gameState.year-18,this.characterData.health=100,this.gameState.daysSinceBirth=0),console.log("After compatibility check:",this.characterData.age),this.updateDisplay(),this.updateLocationDisplay(),this.updateDisplay(),this.updateLocationDisplay(),this.returnToLocation(),alert("Game loaded successfully!")}}deleteSlot(e){if(confirm(`Delete save slot ${e}? This cannot be undone!`)){const t=`colonialGameSave_slot${e}`;localStorage.removeItem(t),alert(`Slot ${e} deleted.`),this.showSaveSlotMenu()}}showLoadSlotMenu(){console.log("showLoadSlotMenu() called");const e=localStorage.getItem("colonialGameSave");e&&confirm("Found old save format. Convert to new slot system?")&&(localStorage.setItem("colonialGameSave_slot1",e),localStorage.removeItem("colonialGameSave"),alert("Save converted to Slot 1!"));let t='\n        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">\n            <div style="background: linear-gradient(145deg, #f4f1e8 0%, #e8e1d3 100%); border: 3px solid #8b4513; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%;">\n                <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">üìÅ Load Game</h2>\n                <p style="text-align: center; margin-bottom: 20px;">Choose a save slot to load:</p>\n                <div id="loadSlots">\n    ',a=!1;for(let e=1;e<=5;e++){const r=`colonialGameSave_slot${e}`,o=localStorage.getItem(r);if(o){a=!0;const r=JSON.parse(o);t+=`\n                <div style="border: 1px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px; background: white;">\n                    <strong>Slot ${e}:</strong> ${this.getSaveInfo(r)}<br><br>\n                    <button onclick="game.loadFromSlot(${e}); game.hideLoadMenu();" style="margin: 5px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Load This Save</button>\n                    <button onclick="game.deleteSlotFromLoad(${e})" style="margin: 5px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Delete</button>\n                </div>\n            `}else t+=`\n                <div style="border: 1px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f8f9fa; opacity: 0.7;">\n                    <strong>Slot ${e}:</strong> <em>Empty</em>\n                </div>\n            `}a||(t+='<p style="text-align: center; font-style: italic;">No saved games found. Start a new game first!</p>'),t+='\n                </div>\n                <div style="text-align: center; margin-top: 20px;">\n                    <button onclick="game.hideLoadMenu()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Back to Title</button>\n                </div>\n            </div>\n        </div>\n    ',document.body.insertAdjacentHTML("beforeend",t)}hideLoadMenu(){const e=document.querySelector('div[style*="position: fixed"]');e&&e.remove()}deleteSlotFromLoad(e){if(confirm(`Delete save slot ${e}? This cannot be undone!`)){const t=`colonialGameSave_slot${e}`;localStorage.removeItem(t),this.hideLoadMenu(),this.showLoadSlotMenu()}}nextCreationStep(){const e=document.getElementById("characterName");""!==e.value.trim()?this.characterData?(this.characterData.name=e.value.trim(),document.getElementById("nameStep").classList.add("hidden"),document.getElementById("backgroundStep").classList.remove("hidden"),this.currentCreationStep="background"):console.error("characterData is undefined!"):alert("Please enter a name for your character")}selectBackground(e,t){document.querySelectorAll(".background-card").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),this.characterData.background=e,this.applyBackgroundStats(e),setTimeout(()=>{document.getElementById("backgroundStep").classList.add("hidden"),document.getElementById("traitStep").classList.remove("hidden"),this.currentCreationStep="traits"},1e3)}applyBackgroundStats(e){const t={dockworker:{money:20,seamanship:1,social:2,reputation:{merchant:1}},merchant:{money:100,trading:2,social:1,reputation:{merchant:2}},noble:{money:50,social:2,leadership:1,reputation:{crown:2}},orphan:{money:10,seamanship:2,navigation:1,reputation:{pirate:1}},testing:{money:1e4,seamanship:3,trading:3,navigation:3,leadership:3,social:3,reputation:{merchant:5,crown:5,colonial:5,pirate:5}}}[e];this.characterData.stats.money=t.money,this.characterData.stats.seamanship+=t.seamanship||0,this.characterData.stats.trading+=t.trading||0,this.characterData.stats.social+=t.social||0,this.characterData.stats.leadership+=t.leadership||0,this.characterData.stats.navigation+=t.navigation||0,Object.keys(t.reputation||{}).forEach(e=>{this.characterData.reputation[e]+=t.reputation[e]})}toggleTrait(e,t){if(t.classList.contains("selected"))t.classList.remove("selected"),this.characterData.traits=this.characterData.traits.filter(t=>t!==e);else{if(this.characterData.traits.length>=2)return void alert("You can only choose 2 traits");t.classList.add("selected"),this.characterData.traits.push(e)}document.getElementById("finishCreation").disabled=2!==this.characterData.traits.length}finishCharacterCreation(){this.applyTraitBonuses(),this.gameState.character=this.characterData,this.characterData.age=18,this.characterData.birthYear=this.gameState.year-18,this.characterData.health=100,this.gameState.currentLocation="london",this.gameState.phase="oldworld",this.gameState.year=1740,this.gameState.month=1,document.getElementById("characterCreation").classList.add("hidden"),document.getElementById("mainGame").classList.remove("hidden"),this.startMainGame()}applyTraitBonuses(){const e={quicklearner:{learning_bonus:1.5},bornsailor:{seamanship:2},silvertongue:{trading:1,social:1},lucky:{luck_bonus:1.2},brave:{leadership:1,courage_bonus:1.5},frugal:{expense_reduction:.8}};this.characterData.traits.forEach(t=>{const a=e[t];Object.keys(a).forEach(e=>{void 0!==this.characterData.stats[e]?this.characterData.stats[e]+=a[e]:this.characterData[e]=a[e]})})}startMainGame(){this.updateDisplay(),this.initializeTrading(),this.initializeMainGameEvents(),console.log("Main game started with character:",this.characterData)}updateDisplay(){this.characterData&&(document.getElementById("characterNameDisplay").textContent=`${this.characterData.name} (Age ${this.characterData.age})`,document.getElementById("moneyDisplay").textContent=this.characterData.stats.money,document.getElementById("locationDisplay").textContent=this.gameState.currentLocation,document.getElementById("dateDisplay").textContent=this.getDateString())}getDateString(){return`${["January","February","March","April","May","June","July","August","September","October","November","December"][this.gameState.month-1]} ${this.gameState.year}`}initializeMainGameEvents(){console.log("Main game events initialized")}startActivity(e){switch(console.log("startActivity called with:",e),document.getElementById("locationView").classList.add("hidden"),document.getElementById("activityPanel").classList.remove("hidden"),e){case"dockwork":this.dockWork();break;case"tavern":this.visitTavern();break;case"shipyard":this.visitShipyard();break;case"market":this.visitMarket();break;case"naval":this.visitNavalOffice();break;case"exploration":this.visitExplorationOffice();break;case"travel":case"travel":this.planTravel();break;case"banking":this.visitBankingHouse();break;case"hunt_pirates":this.huntPirates();break;default:this.showActivityResult("Unknown Activity","This activity is not yet implemented.")}}dockWork(){const e=2+Math.floor(3*Math.random()),t=this.characterData.frugal?Math.floor(1.2*e):e;this.characterData.stats.money+=t,this.characterData.stats.seamanship+=.1;const a=[`You spend a hard day loading cargo ships. The foreman pays you ${t} gold.`,`A merchant ship from the Indies needs quick unloading. You earn ${t} gold for your efforts.`,`You help repair a damaged ship hull. The grateful captain gives you ${t} gold.`,`Loading barrels of rum and sugar cane nets you ${t} gold and some sailing knowledge.`],r=a[Math.floor(Math.random()*a.length)];this.showActivityResult("‚öì Dock Work",r+"<br><br><em>+0.1 Seamanship</em>"),this.advanceTime(1)}visitTavern(){if(this.characterData.stats.money<1)return void this.showActivityResult("üç∫ The Sailor's Rest Tavern","You don't have enough money for a drink. The tavern keeper eyes you suspiciously.");this.characterData.stats.money-=1;const e=[{title:"Grizzled Captain",text:'An old sea captain tells tales of the Caribbean sugar trade. "Aye, fortunes are made there, but the risks are high..."',bonus:{social:.1,knowledge:"caribbean_routes"},bonusText:"+0.1 Social"},{title:"Merchant Trader",text:'A well-dressed merchant mentions Amsterdam\'s competitive prices. "Smart traders know where to buy cheap and sell dear."',bonus:{trading:.1,social:.1}},{title:"Naval Officer",text:'A young naval officer speaks of opportunities for advancement. "The King\'s Navy rewards brave and capable men."',bonus:{social:.1,reputation:{crown:1}},bonusText:"+0.1 Social, +1 Crown Reputation"},{title:"Ship's Cook",text:"A friendly cook shares stories of life at sea and offers practical advice about provisioning ships.",bonus:{seamanship:.1,navigation:.1},bonusText:"+0.1 Seamanship, +0.1 Navigation"}],t=e[Math.floor(Math.random()*e.length)];Object.keys(t.bonus).forEach(e=>{"reputation"===e?Object.keys(t.bonus.reputation).forEach(e=>{this.characterData.reputation[e]+=t.bonus.reputation[e]}):void 0!==this.characterData.stats[e]&&(this.characterData.stats[e]+=t.bonus[e])}),this.showActivityResult("üç∫ The Sailor's Rest Tavern",`<br>${t.text}<br><br><em>Cost: 1 gold | ${t.bonusText}</em>`)}visitShipyard(){console.log("visitShipyard() method called!");let e="<strong>Ships Available for Purchase:</strong><br><br>";if(this.gameState.ownedShip){const t=this.gameState.ownedShip,a=this.calculateShipSellPrice(t);e+=`<div style="background: #e8f5e8; border: 2px solid #27ae60; padding: 15px; margin: 10px 0; border-radius: 8px;">\n    <strong>üö¢ Your Ship: "${this.gameState.ownedShip.shipName}"</strong><br>\n    <em>Type: ${t.name}</em><br>\n    Cargo Capacity: ${t.cargo} | Crew: ${t.crew}<br>\n    Condition: ${t.condition}%<br>\n    <button onclick="game.manageShip()">Manage Ship</button>\n    <button onclick="game.sellShip(${a})" style="margin-left: 10px; background: #dc3545; color: white;">Sell Ship (${a} gold)</button>\n</div><br>`}[{id:"rowboat",name:"Rowing Boat",price:50,cargo:2,crew:1,guns:0,speed:15,oceanWorthy:!1,description:"Tiny vessel for coastal trading only. Limited to short routes."},{id:"sloop",name:"Sloop",price:500,cargo:10,crew:3,guns:4,speed:18,oceanWorthy:!0,description:"Small single-masted ship, good for coastal voyages and light trading."},{id:"racing_schooner",name:"Racing Schooner",price:800,cargo:8,crew:2,guns:2,speed:25,oceanWorthy:!0,description:"Lightning-fast vessel perfect for smuggling and quick escapes.",special:"Can outrun most pirates"},{id:"dutch_fluyt",name:"Dutch Fluyt",price:1200,cargo:40,crew:6,guns:6,speed:10,oceanWorthy:!0,description:"Cargo specialist with massive holds and efficient crew requirements.",special:"Half crew wages, +15 cargo"},{id:"fast_frigate",name:"Fast Frigate",price:1500,cargo:15,crew:12,guns:20,speed:22,oceanWorthy:!0,description:"Military-grade vessel built for speed and firepower.",special:"Double pirate bounties",maintenance:"20 gold/month"},{id:"brigantine",name:"Brigantine",price:2e3,cargo:25,crew:8,guns:12,speed:12,oceanWorthy:!0,description:"Two-masted vessel capable of ocean crossing and serious trade."},{id:"explorer_bark",name:"Explorer's Bark",price:2500,cargo:20,crew:10,guns:10,speed:16,oceanWorthy:!0,description:"Rugged exploration vessel built for discovering new routes.",special:"+50% expedition success"},{id:"privateer_vessel",name:"Privateer Vessel",price:3e3,cargo:18,crew:15,guns:24,speed:20,oceanWorthy:!0,description:"Government-licensed warship for hunting pirates and enemies.",special:"Double bounties, Crown backing",maintenance:"30 gold/month",requires:"Naval Lieutenant rank"},{id:"treasure_galleon",name:"Treasure Galleon",price:4e3,cargo:60,crew:25,guns:18,speed:8,oceanWorthy:!0,description:"Massive cargo vessel capable of enormous profits.",special:"Huge cargo, attracts pirates",maintenance:"40 gold/month"},{id:"ship_of_line",name:"Ship of the Line",price:8e3,cargo:30,crew:40,guns:40,speed:6,oceanWorthy:!0,description:"Ultimate warship that dominates any naval battle.",special:"Unstoppable in combat",maintenance:"50 gold/month",requires:"Naval Commander rank"}].forEach(t=>{const a=this.characterData.stats.money>=t.price,r=!!this.gameState.ownedShip;let o;console.log(`Ship: ${t.name}, canAfford: ${a}, hasShip: ${r}, money: ${this.characterData.stats.money}`),o=r?"<em>You already own a ship</em>":a?`<button onclick="game.buyShip('${t.id}', ${t.price})">Buy Ship (${t.price} gold)</button>`:`<button disabled>Buy Ship (${t.price} gold)</button>`,e+=`<div style="border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px;">\n    <strong>${t.name}</strong> - ${t.price} gold<br>\n    ${t.description}<br>\n    <strong>Specs:</strong> Cargo: ${t.cargo} | Crew: ${t.crew} | Guns: ${t.guns} | Speed: ${t.speed}<br>\n    <strong>Ocean Worthy:</strong> ${t.oceanWorthy?"‚úÖ Yes (Can reach New World)":"‚ùå No (European waters only)"}<br>`,t.special&&(e+=`<strong>Special:</strong> ${t.special}<br>`),t.maintenance&&(e+=`<strong>Maintenance:</strong> ${t.maintenance}<br>`),t.requires&&(e+=`<strong>Requires:</strong> ${t.requires}<br>`),e+=`<br>${o}</div>`,console.log(`Button HTML for ${t.name}:`,o)}),this.showActivityResult("‚õµ Shipyard",e)}huntPirates(){if(!(this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation))return void this.showActivityResult("‚öîÔ∏è Pirate Hunting","You need your own ship in this port to hunt pirates!");if(this.characterData.stats.money<10)this.showActivityResult("‚öîÔ∏è Pirate Hunting","You need 10 gold for supplies and crew wages to hunt pirates.");else{if(this.characterData.stats.money-=10,Math.random()<.6)this.showActivityResult("üè¥‚Äç‚ò†Ô∏è Pirates Spotted!","Your patrol has found pirates terrorizing merchant ships!<br><br><em>Preparing for combat...</em>"),setTimeout(()=>{this.handlePirateAttack()},1e3);else{let e=Math.floor(15*Math.random())+10;if(e=Math.floor(this.applyShipSpecialBonuses(e,"pirate_bounty")),this.characterData.stats.money+=e,this.characterData.stats.seamanship+=.1,this.characterData.reputation.crown+=1,this.gameState.navalCareer&&this.gameState.navalCareer.enlisted){const t=Math.floor(.3*e);this.characterData.stats.money+=t;const a=this.gameState.navalCareer.experience;this.gameState.navalCareer.experience+=2,this.checkNavalPromotion(a,this.gameState.navalCareer.experience),this.gameState.navalCareer.reputation+=1}let t=`Your patrol finds no pirates today, but the Crown pays you for keeping the seas safe.<br><br><strong>Rewards:</strong><br>‚Ä¢ ${e} gold (Crown bounty)<br>`;if(this.gameState.navalCareer&&this.gameState.navalCareer.enlisted){t+=`‚Ä¢ ${Math.floor(.3*e)} gold (naval officer bonus)<br>‚Ä¢ +2 Naval experience<br>‚Ä¢ +1 Naval reputation<br>`}t+="‚Ä¢ +0.1 Seamanship<br>‚Ä¢ +1 Crown reputation<br>","pirate_hunter"===this.getShipSpecialAbility()?t+="‚Ä¢ <em>Fast Frigate bonus: Double bounty!</em><br>":"privateer"===this.getShipSpecialAbility()&&(t+="‚Ä¢ <em>Privateer license: Double bounty!</em><br>"),t+="<br><em>The merchants sleep safer knowing brave captains patrol these waters.</em>",this.showActivityResult("‚öîÔ∏è Patrol Complete",t)}this.advanceTime(1)}}generateCrewMember(e=null){const t=["William","Thomas","John","James","Samuel","Robert","Henry","Charles","Edward","Benjamin","Jonathan","Daniel","Michael","Richard","Joseph","Isaac","Jeremiah","Jacob","Abraham","Nathaniel"],a=["Blackwood","Saltwater","Ironside","Stormwind","Seahawk","Goldbeard","Hartwell","Fairwind","Longshot","Swiftblade","Greystone","Redmane","Whitecap","Thornberry","Wavecrest","Anchor","Compass","Crosswind"],r=["gunner","navigator","cook","bosun","surgeon","carpenter"],o=e||r[Math.floor(Math.random()*r.length)];return{name:`${t[Math.floor(Math.random()*t.length)]} ${a[Math.floor(Math.random()*a.length)]}`,specialty:o,level:1,experience:0,skills:{gunnery:"gunner"===o?3:1,seamanship:"bosun"===o?3:1,navigation:"navigator"===o?3:1,cooking:"cook"===o?3:1,medicine:"surgeon"===o?3:1,repair:"carpenter"===o?3:1},personality:this.generatePersonality(),loyalty:50+Math.floor(30*Math.random()),joinedDate:{year:this.gameState.year,month:this.gameState.month}}}generatePersonality(){const e=["Brave","Cautious","Cheerful","Grumpy","Loyal","Ambitious","Steady","Hothead","Wise","Young","Veteran","Lucky","Unlucky","Quiet","Talkative","Disciplined"],t=["former naval sailor","merchant marine veteran","dock worker","fisherman's son","escaped apprentice","reformed pirate","coastal trader","ship carpenter","tavern brawler"];return{trait:e[Math.floor(Math.random()*e.length)],background:t[Math.floor(Math.random()*t.length)]}}visitMarket(){const e=this.marketPrices[this.gameState.currentLocation];let t=`<strong>${this.getLocationName(this.gameState.currentLocation)} Market</strong><br><br>`;const a=this.getPersonalInventoryCount();if(t+='<div style="background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px;">',t+=`<strong>üì¶ Your Carrying Capacity:</strong> ${a}/${this.gameState.personalInventoryLimit}<br>`,this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation){const e=this.getShipCargoCount();t+=`<strong>üö¢ "${this.gameState.ownedShip.shipName}" Cargo:</strong> ${e}/${this.gameState.ownedShip.cargo}`}t+="</div>",t+='<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">',t+="<div><h4>üõí Buy Goods</h4>",Object.keys(e).forEach(r=>{const o=this.goodsInfo[r],n=e[r].buy,s=this.characterData.stats.money>=n,i=a<this.gameState.personalInventoryLimit,l=this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation&&this.getShipCargoCount()<this.getShipCargoCapacity();t+=`<div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0;">\n            <strong>${o.name}</strong> - ${n} gold each<br>\n            <small>${o.description}</small><br>`,s?(t+=`<input type="number" id="qty_${r}" min="1" max="${Math.floor(this.characterData.stats.money/n)}" value="1" style="width: 60px; margin: 5px;"><br>`,i&&(t+=`<button onclick="game.buyGoodToInventory('${r}', ${n})" style="margin: 2px;">Buy to Inventory</button>`),l&&(t+=`<button onclick="game.buyGoodToShip('${r}', ${n})" style="margin: 2px;">Buy to Ship</button>`),i||l||(t+="<em>No storage space available</em>")):t+=`<button disabled>Buy (${n} gold)</button>`,t+="</div>"}),t+="</div>",t+="<div><h4>üí∞ Sell Goods</h4>",t+="<strong>From Personal Inventory:</strong><br>";if(Object.keys(this.gameState.inventory).length>0?Object.keys(this.gameState.inventory).forEach(a=>{const r=this.gameState.inventory[a],o=this.goodsInfo[a],n=e[a]?e[a].sell:0;r>0&&(t+=`<div style="border: 1px solid #ccc; padding: 8px; margin: 3px 0;">\n                    <strong>${o.name}</strong> (${r}) - ${n} gold each<br>\n                    <button onclick="game.sellGood('${a}', ${n}, 'personal')">Sell 1</button>\n                    <button onclick="game.sellAllGood('${a}', ${n}, 'personal')">Sell All</button>\n                </div>`)}):t+="<p><em>No personal goods to sell.</em></p>",this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation){t+="<br><strong>From Ship Cargo:</strong><br>";Object.keys(this.gameState.ownedShip.cargoHold||{}).length>0?Object.keys(this.gameState.ownedShip.cargoHold).forEach(a=>{const r=this.gameState.ownedShip.cargoHold[a],o=this.goodsInfo[a],n=e[a]?e[a].sell:0;r>0&&(t+=`<div style="border: 1px solid #ccc; padding: 8px; margin: 3px 0;">\n                        <strong>${o.name}</strong> (${r}) - ${n} gold each<br>\n                        <button onclick="game.sellGood('${a}', ${n}, 'ship')">Sell 1</button>\n                        <button onclick="game.sellAllGood('${a}', ${n}, 'ship')">Sell All</button>\n                    </div>`)}):t+="<p><em>No ship cargo to sell.</em></p>"}t+="</div></div>",this.showActivityResult("üè™ Market",t)}buyGoodBulk(e,t){const a=document.getElementById(`qty_${e}`),r=parseInt(a.value)||1,o=t*r;if(this.characterData.stats.money>=o){this.characterData.stats.money-=o,this.gameState.inventory[e]||(this.gameState.inventory[e]=0),this.gameState.inventory[e]+=r,this.characterData.stats.trading+=.1*r;const t=this.goodsInfo[e].name;this.showActivityResult("üõí Bulk Purchase Complete",`You bought ${r} ${t} for ${o} gold total.<br><br><em>+${(.1*r).toFixed(1)} Trading skill</em>`),setTimeout(()=>{this.visitMarket()},1500)}}visitNavalOffice(){this.gameState.navalCareer||(this.gameState.navalCareer={enlisted:!1,rank:null,experience:0,missions_completed:0,prize_money:0,current_mission:null,reputation:0});const e=this.gameState.navalCareer;let t="<strong>‚öîÔ∏è His Majesty's Naval Recruitment Office</strong><br><br>";if(e.enlisted){const a=["Seaman","Able Seaman","Midshipman","Lieutenant","Commander","Captain","Admiral"],r=Math.min(Math.floor(e.experience/10),a.length-1),o=a[r];t+=`Welcome back, ${o} ${this.characterData.name}!<br><br>`,t+='<div style="background: #e8f4f8; padding: 15px; margin: 10px 0; border-radius: 8px; border: 2px solid #3498db;">',t+="<strong>‚öì Naval Career Status</strong><br>",t+=`Rank: ${o}<br>`,t+=`Experience: ${e.experience}<br>`,t+=`Missions Completed: ${e.missions_completed}<br>`,t+=`Total Prize Money Earned: ${e.prize_money} gold<br>`,t+=`Naval Reputation: ${e.reputation}<br>`,t+="</div>",e.current_mission?(t+='<div style="background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 8px; border: 2px solid #ffc107;">',t+="<strong>üö¢ Current Mission</strong><br>",t+=`${e.current_mission.name}<br>`,t+=`Status: ${e.current_mission.status}<br>`,t+="</div>"):(t+="<strong>üìã Available Naval Missions:</strong><br><br>",t+=this.generateNavalMissions(r)),t+='<br><button onclick="game.requestNavalLeave()">Request Shore Leave</button>'}else{t+="A stern officer in naval uniform looks you over carefully.<br><br>",t+='"The Royal Navy offers opportunities for advancement to men of courage and skill. Are you prepared to serve King and Country?"<br><br>',t+='<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>Naval Service Benefits:</strong><br>",t+="‚Ä¢ Regular pay (based on rank)<br>",t+="‚Ä¢ Prize money from captured enemy ships<br>",t+="‚Ä¢ Access to military vessels<br>",t+="‚Ä¢ Rapid skill development<br>",t+="‚Ä¢ Crown reputation and social standing<br>",t+="</div>",t+="<strong>Entry Requirements:</strong><br>",this.characterData.stats.seamanship>=1?t+="‚úÖ Seamanship: "+this.characterData.stats.seamanship.toFixed(1)+"/1.0<br>":t+="‚ùå Seamanship: "+this.characterData.stats.seamanship.toFixed(1)+"/1.0 (Need more experience)<br>",this.characterData.reputation.crown>=0?t+="‚úÖ No criminal record<br><br>":t+="‚ùå Criminal record prevents enlistment<br><br>";t+=this.characterData.stats.seamanship>=1&&this.characterData.reputation.crown>=0?'<button onclick="game.enlistInNavy()">Enlist in the Royal Navy</button>':"<em>Return when you meet the requirements.</em>"}this.showActivityResult("‚öîÔ∏è Naval Recruitment Office",t)}enlistInNavy(){this.gameState.navalCareer.enlisted=!0,this.gameState.navalCareer.rank="Seaman",this.gameState.navalCareer.experience=0,this.characterData.stats.seamanship+=.5,this.characterData.stats.leadership+=.3,this.characterData.reputation.crown+=2,this.characterData.stats.money+=25,this.showActivityResult("üéâ Welcome to the Royal Navy!",'Congratulations! You have been sworn in as a Seaman in His Majesty\'s Royal Navy.<br><br><strong>Immediate Benefits:</strong><br>‚Ä¢ +25 gold enlistment bonus<br>‚Ä¢ +0.5 Seamanship skill<br>‚Ä¢ +0.3 Leadership skill<br>‚Ä¢ +2 Crown reputation<br><br><strong>Your Naval Career Begins:</strong><br>‚Ä¢ Report to Naval Office for missions<br>‚Ä¢ Earn experience through successful missions<br>‚Ä¢ Advance through the ranks for better pay and ships<br>‚Ä¢ Prize money from captured enemy vessels<br><br><em>"God save the King! May your service bring glory to the Empire!"</em>'),setTimeout(()=>{this.visitNavalOffice()},6e3)}generateNavalMissions(e){const t=[{id:"patrol_duty",name:"Coastal Patrol",description:"Patrol the English coast for smugglers and pirates",duration:7,difficulty:"Easy",requirements:{rank:0},rewards:{experience:3,pay:15,reputation:1},risks:{low_damage:.1}},{id:"merchant_escort",name:"Merchant Escort",description:"Escort a merchant convoy through pirate-infested waters",duration:10,difficulty:"Easy",requirements:{rank:0},rewards:{experience:4,pay:20,reputation:2},risks:{pirate_encounter:.3,low_damage:.2}},{id:"blockade_runner",name:"Blockade Duty",description:"Maintain naval blockade against enemy ports",duration:14,difficulty:"Medium",requirements:{rank:2},rewards:{experience:8,pay:40,reputation:3,prize_chance:.4},risks:{combat:.4,medium_damage:.3}},{id:"pirate_hunt",name:"Pirate Hunter",description:"Hunt down notorious pirates in the Caribbean",duration:21,difficulty:"Medium",requirements:{rank:2},rewards:{experience:12,pay:60,reputation:5,prize_chance:.6},risks:{combat:.6,medium_damage:.4}},{id:"enemy_raid",name:"Enemy Port Raid",description:"Lead a daring raid on an enemy colonial port",duration:28,difficulty:"Hard",requirements:{rank:3},rewards:{experience:18,pay:100,reputation:8,prize_chance:.8},risks:{combat:.7,high_damage:.5,casualties:.3}},{id:"treasure_fleet",name:"Spanish Treasure Fleet",description:"Intercept the Spanish treasure fleet from the Americas",duration:35,difficulty:"Very Hard",requirements:{rank:4},rewards:{experience:25,pay:200,reputation:12,prize_chance:.9,treasure_bonus:500},risks:{combat:.8,high_damage:.6,casualties:.4}},{id:"fleet_command",name:"Fleet Command",description:"Command a squadron in a major naval battle",duration:42,difficulty:"Legendary",requirements:{rank:5},rewards:{experience:35,pay:400,reputation:20,prize_chance:1,promotion_chance:.3},risks:{major_combat:.9,ship_loss:.2,heavy_casualties:.5}}].filter(t=>e>=t.requirements.rank&&!this.gameState.navalCareer.current_mission);let a="";return 0===t.length?a="<em>No missions available at your current rank. Continue serving to advance!</em>":t.slice(0,3).forEach(e=>{const t={Easy:"#28a745",Medium:"#ffc107",Hard:"#fd7e14","Very Hard":"#dc3545",Legendary:"#6f42c1"}[e.difficulty];a+=`<div style="border: 2px solid ${t}; padding: 15px; margin: 10px 0; border-radius: 8px;">`,a+=`<strong>${e.name}</strong> <span style="color: ${t}; font-weight: bold;">[${e.difficulty}]</span><br>`,a+=`${e.description}<br><br>`,a+="<strong>Mission Details:</strong><br>",a+=`‚Ä¢ Duration: ${e.duration} days<br>`,a+=`‚Ä¢ Base Pay: ${e.rewards.pay} gold<br>`,a+=`‚Ä¢ Experience: +${e.rewards.experience}<br>`,a+=`‚Ä¢ Reputation: +${e.rewards.reputation}<br>`,e.rewards.prize_chance&&(a+=`‚Ä¢ Prize Money Chance: ${(100*e.rewards.prize_chance).toFixed(0)}%<br>`),a+=`<br><button onclick="game.acceptNavalMission('${e.id}')">Accept Mission</button>`,a+="</div>"}),a}acceptNavalMission(e){const t=this.getAllNavalMissions().find(t=>t.id===e);this.gameState.navalCareer.current_mission={...t,status:"In Progress",start_date:{year:this.gameState.year,month:this.gameState.month}},this.showActivityResult("‚öîÔ∏è Mission Accepted",`You have accepted the mission: <strong>${t.name}</strong><br><br>Duration: ${t.duration} days<br>Difficulty: ${t.difficulty}<br><br>Your ship departs immediately. May fair winds and good fortune be with you!<br><br><em>Mission results will be available when you return...</em>`),this.advanceTime(t.duration),setTimeout(()=>{this.startMissionEvents(t)},2e3)}getAllNavalMissions(){return[{id:"patrol_duty",name:"Coastal Patrol",description:"Patrol the English coast for smugglers and pirates",duration:7,difficulty:"Easy",requirements:{rank:0},rewards:{experience:3,pay:15,reputation:1},risks:{low_damage:.1}},{id:"merchant_escort",name:"Merchant Escort",description:"Escort a merchant convoy through pirate-infested waters",duration:10,difficulty:"Easy",requirements:{rank:0},rewards:{experience:4,pay:20,reputation:2},risks:{pirate_encounter:.3,low_damage:.2}},{id:"blockade_runner",name:"Blockade Duty",description:"Maintain naval blockade against enemy ports",duration:14,difficulty:"Medium",requirements:{rank:2},rewards:{experience:8,pay:40,reputation:3,prize_chance:.4},risks:{combat:.4,medium_damage:.3}},{id:"pirate_hunt",name:"Pirate Hunter",description:"Hunt down notorious pirates in the Caribbean",duration:21,difficulty:"Medium",requirements:{rank:2},rewards:{experience:12,pay:60,reputation:5,prize_chance:.6},risks:{combat:.6,medium_damage:.4}},{id:"enemy_raid",name:"Enemy Port Raid",description:"Lead a daring raid on an enemy colonial port",duration:28,difficulty:"Hard",requirements:{rank:3},rewards:{experience:18,pay:100,reputation:8,prize_chance:.8},risks:{combat:.7,high_damage:.5,casualties:.3}},{id:"treasure_fleet",name:"Spanish Treasure Fleet",description:"Intercept the Spanish treasure fleet from the Americas",duration:35,difficulty:"Very Hard",requirements:{rank:4},rewards:{experience:25,pay:200,reputation:12,prize_chance:.9,treasure_bonus:500},risks:{combat:.8,high_damage:.6,casualties:.4}},{id:"fleet_command",name:"Fleet Command",description:"Command a squadron in a major naval battle",duration:42,difficulty:"Legendary",requirements:{rank:5},rewards:{experience:35,pay:400,reputation:20,prize_chance:1,promotion_chance:.3},risks:{major_combat:.9,ship_loss:.2,heavy_casualties:.5}}]}processNavalMissionOutcome(e){const t=this.gameState.navalCareer;let a=.7;a+=.05*this.characterData.stats.seamanship,a+=.05*this.characterData.stats.leadership,a+=.03*this.characterData.stats.navigation,a+=.01*t.experience,this.gameState.ownedShip&&(a+=this.gameState.ownedShip.condition/100*.1);a+={Easy:0,Medium:-.1,Hard:-.2,"Very Hard":-.3,Legendary:-.4}[e.difficulty];const r=Math.random()<Math.max(.2,Math.min(.95,a));this.displayMissionResults(e,r)}requestNavalLeave(){const e=this.gameState.navalCareer;let t="<strong>üèñÔ∏è Request Shore Leave</strong><br><br>";t+='"What type of leave are you requesting, officer?"<br><br>';const a=["Seaman","Able Seaman","Midshipman","Lieutenant","Commander","Captain","Admiral"],r=Math.min(Math.floor(e.experience/10),a.length-1);t+='<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+=`<strong>Your Status:</strong> ${a[r]}<br>`,t+=`Naval Experience: ${e.experience}<br>`,t+=`Missions Completed: ${e.missions_completed}<br>`,t+="</div>",t+='<div style="border: 1px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>üåä Short Shore Leave</strong> (7 days)<br>",t+="Brief leave for personal business and rest.<br>",t+="‚Ä¢ Return to civilian activities temporarily<br>",t+="‚Ä¢ Naval career remains active<br>",t+="‚Ä¢ No penalty to naval status<br><br>",t+='<button onclick="game.takeShoreLeave(7)">Request Short Leave</button>',t+="</div>",e.missions_completed>=3&&e.reputation>=5?(t+='<div style="border: 1px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>üèñÔ∏è Extended Shore Leave</strong> (30 days)<br>",t+="Extended leave for major personal affairs.<br>",t+="‚Ä¢ Longer break from naval duties<br>",t+="‚Ä¢ Small reputation penalty (-1)<br>",t+="‚Ä¢ Requires good service record<br><br>",t+='<button onclick="game.takeShoreLeave(30)">Request Extended Leave</button>',t+="</div>"):(t+='<div style="border: 1px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px; opacity: 0.6;">',t+="<strong>üèñÔ∏è Extended Shore Leave</strong> (30 days)<br>",t+="<em>Requires: 3+ missions completed and 5+ naval reputation</em><br>",t+="</div>"),this.gameState.ownedShip&&this.gameState.ownedShip.condition<70&&(t+='<div style="border: 1px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>üè• Medical/Repair Leave</strong> (14 days)<br>",t+="Leave to repair your vessel and recover from injuries.<br>",t+="‚Ä¢ Ship condition automatically improved<br>",t+="‚Ä¢ Health and morale restoration<br>",t+="‚Ä¢ No reputation penalty<br><br>",t+='<button onclick="game.takeMedicalLeave()">Request Medical Leave</button>',t+="</div>"),r>=4&&(t+='<div style="border: 2px solid #6f42c1; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>üéñÔ∏è Request Honorable Discharge</strong><br>",t+="Leave naval service with full honors.<br>",t+="‚Ä¢ Retain all naval benefits and reputation<br>",t+="‚Ä¢ Receive pension based on rank and service<br>",t+="‚Ä¢ Can re-enlist later if desired<br>",t+='‚Ä¢ Special "Naval Veteran" status<br><br>',t+='<button onclick="game.requestDischarge()">Request Discharge</button>',t+="</div>"),this.showActivityResult("üèñÔ∏è Naval Leave Options",t)}displayMissionResults(e,t){const a=this.gameState.navalCareer;a.current_mission=null,a.missions_completed++;let r=`<strong>‚öîÔ∏è Mission Complete: ${e.name}</strong><br><br>`;if(t){this.characterData.stats.money+=e.rewards.pay;const t=a.experience;if(a.experience+=e.rewards.experience,this.checkNavalPromotion(t,a.experience),a.reputation+=e.rewards.reputation,r+="<strong>üéâ MISSION SUCCESS!</strong><br><br>",r+="<strong>Rewards:</strong><br>",r+=`‚Ä¢ ${e.rewards.pay} gold<br>`,r+=`‚Ä¢ +${e.rewards.experience} naval experience<br>`,r+=`‚Ä¢ +${e.rewards.reputation} naval reputation<br>`,e.rewards.prize_chance&&Math.random()<e.rewards.prize_chance){const e=Math.floor(200*Math.random())+100;this.characterData.stats.money+=e,r+=`‚Ä¢ ${e} gold prize money!<br>`}e.rewards.treasure_bonus&&(this.characterData.stats.money+=e.rewards.treasure_bonus,r+=`‚Ä¢ ${e.rewards.treasure_bonus} gold treasure bonus!<br>`),r+='<br><em>"Well done! The Admiralty is pleased with your service."</em>'}else{const t=Math.floor(.3*e.rewards.pay);this.characterData.stats.money+=t;const o=a.experience;a.experience+=1,this.checkNavalPromotion(o,a.experience),a.reputation-=1,r+="<strong>‚ö†Ô∏è MISSION DIFFICULTIES</strong><br><br>",r+="Your mission encountered serious problems.<br><br>",r+="<strong>Partial Compensation:</strong><br>",r+=`‚Ä¢ ${t} gold (partial pay)<br>`,r+="‚Ä¢ +1 naval experience (lessons learned)<br>",r+="‚Ä¢ -1 naval reputation<br><br>",r+='<em>"The Navy expects better results, officer."</em>'}this.showEmergencyEvent("‚öîÔ∏è Naval Mission Report",r)}startMissionEvents(e){switch(e.id){case"patrol_duty":this.coastalPatrolEvent(e);break;case"merchant_escort":this.merchantEscortEvent(e);break;case"pirate_hunt":this.navalPirateHuntEvent(e);break;default:this.genericMissionEvent(e)}}coastalPatrolEvent(e){let t=`<strong>üåä Coastal Patrol - Day ${Math.floor(e.duration/2)}</strong><br><br>`;t+="Your ship patrols the English coast, watching for smugglers and pirates.<br><br>",t+='Suddenly, your lookout shouts: "Ship on the horizon, Captain! Looks suspicious!"<br><br>',t+="<strong>What are your orders?</strong><br><br>",t+='<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>‚öîÔ∏è PURSUE AND ENGAGE</strong><br>",t+="Chase down the suspicious vessel!<br>",t+="<em>Risk: Combat, ship damage | Reward: Prize money, reputation</em><br>",t+=`<button onclick="game.coastalPatrolChoice('pursue', '${e.id}')">Full speed ahead!</button>`,t+="</div>",t+='<div style="border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>üîç CAREFUL INVESTIGATION</strong><br>",t+="Approach cautiously and demand identification.<br>",t+="<em>Lower risk but smaller rewards</em><br>",t+=`<button onclick="game.coastalPatrolChoice('investigate', '${e.id}')">Signal them to stop</button>`,t+="</div>",t+='<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>üìã CONTINUE PATROL</strong><br>",t+="Too distant to engage - continue regular patrol.<br>",t+="<em>Safe but no bonus rewards</em><br>",t+=`<button onclick="game.coastalPatrolChoice('continue', '${e.id}')">Maintain course</button>`,t+="</div>",this.showEmergencyEvent("üåä Naval Patrol Decision",t)}merchantEscortEvent(e){let t="<strong>üö¢ Merchant Escort - Mid-Journey</strong><br><br>";t+="You're escorting a valuable merchant convoy when pirates attack!<br><br>",t+='"Three pirate ships approaching from the starboard bow!" shouts your navigator.<br><br>',t+="<strong>Battle stations! What are your orders?</strong><br><br>",t+='<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>‚öîÔ∏è FIGHT THE PIRATES</strong><br>",t+="Engage in full naval combat to protect the convoy!<br>",t+="<em>Uses the full combat system</em><br>",t+=`<button onclick="game.navalMissionCombat('${e.id}')">Battle stations!</button>`,t+="</div>",t+='<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>üõ°Ô∏è DEFENSIVE FORMATION</strong><br>",t+="Form up around the merchants and wait for them to attack.<br>",t+="<em>Safer but pirates may escape with some cargo</em><br>",t+=`<button onclick="game.merchantEscortChoice('defend', '${e.id}')">Protect the convoy!</button>`,t+="</div>",this.showEmergencyEvent("üè¥‚Äç‚ò†Ô∏è Pirates Attack Convoy!",t)}navalPirateHuntEvent(e){let t="<strong>üè¥‚Äç‚ò†Ô∏è Pirate Hunt - Target Sighted!</strong><br><br>";t+="Your mission has led you to a notorious pirate captain!<br><br>",t+="\"That's the 'Bloody Revenge' - one of the most wanted ships in these waters!\"<br><br>",t+="<strong>This could make your career... or end it.</strong><br><br>",t+='<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>‚öîÔ∏è ATTACK IMMEDIATELY</strong><br>",t+="Strike fast before they can escape or call for help!<br>",t+="<em>Full pirate combat with naval bonuses</em><br>",t+=`<button onclick="game.navalMissionCombat('${e.id}')">Attack! For King and Country!</button>`,t+="</div>",this.showEmergencyEvent("üè¥‚Äç‚ò†Ô∏è Notorious Pirate Spotted!",t)}coastalPatrolChoice(e,t){const a=this.getAllNavalMissions().find(e=>e.id===t);let r="";"pursue"===e?Math.random()<.6?(r="<strong>‚öîÔ∏è Smugglers Caught!</strong><br><br>Your aggressive pursuit pays off! You've caught a smuggling vessel red-handed.<br><br><strong>Bonus Rewards:</strong><br>‚Ä¢ +50 gold (confiscated contraband)<br>‚Ä¢ +2 Naval reputation<br>‚Ä¢ +0.2 Leadership skill<br><br><em>The Admiralty will be pleased with your initiative!</em>",this.characterData.stats.money+=50,this.gameState.navalCareer.reputation+=2,this.characterData.stats.leadership+=.2):(r='<strong>‚ö†Ô∏è False Alarm</strong><br><br>The ship was just a legitimate merchant - your aggressive pursuit causes a diplomatic incident.<br><br><strong>Consequences:</strong><br>‚Ä¢ -1 Naval reputation<br>‚Ä¢ Formal reprimand<br><br><em>"More caution next time, officer."</em>',this.gameState.navalCareer.reputation-=1):"investigate"===e?Math.random()<.4?(r="<strong>üîç Suspicious Cargo Found</strong><br><br>Your careful investigation reveals minor contraband.<br><br><strong>Modest Rewards:</strong><br>‚Ä¢ +20 gold<br>‚Ä¢ +1 Naval reputation<br><br><em>Steady police work - the backbone of naval service.</em>",this.characterData.stats.money+=20,this.gameState.navalCareer.reputation+=1):r="<strong>‚úÖ Legitimate Vessel</strong><br><br>Your investigation reveals the ship is completely legitimate.<br><br>No rewards, but no problems either. You continue your patrol professionally.":r="<strong>üìã Patrol Continued</strong><br><br>You maintain your regular patrol route without incident.<br><br>Sometimes the most important naval work is simply showing the flag.",this.showEmergencyEvent("üåä Patrol Result",r),setTimeout(()=>{this.hideEmergencyEvent(),this.processNavalMissionOutcome(a)},4e3)}merchantEscortChoice(e,t){const a=this.getAllNavalMissions().find(e=>e.id===t);if("defend"===e){let e="";Math.random()<.7?(e='<strong>üõ°Ô∏è Convoy Protected!</strong><br><br>Your defensive formation works! The pirates can\'t break through your screen.<br><br><strong>Success:</strong><br>‚Ä¢ All merchant ships safe<br>‚Ä¢ +30 gold bonus from grateful merchants<br>‚Ä¢ +1 Naval reputation<br><br><em>"Thank you, Captain! Our cargo is safe because of you!"</em>',this.characterData.stats.money+=30,this.gameState.navalCareer.reputation+=1):(e="<strong>‚ö†Ô∏è Partial Success</strong><br><br>The pirates manage to capture one merchant ship before fleeing.<br><br><strong>Mixed Results:</strong><br>‚Ä¢ 2 of 3 ships saved<br>‚Ä¢ +10 gold (reduced payment)<br>‚Ä¢ Mission still counts as success<br><br><em>You did your best under difficult circumstances.</em>",this.characterData.stats.money+=10),this.showEmergencyEvent("üö¢ Escort Mission Result",e),setTimeout(()=>{this.hideEmergencyEvent(),this.processNavalMissionOutcome(a)},4e3)}}navalMissionCombat(e){this.currentNavalMission=e,this.isNavalMissionCombat=!0,this.hideEmergencyEvent(),this.handlePirateAttack()}genericMissionEvent(e){let t=`<strong>‚öîÔ∏è ${e.name} - Critical Moment</strong><br><br>`;t+="Your mission reaches a crucial decision point.<br><br>",t+="<strong>How do you proceed?</strong><br><br>",t+='<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>‚öîÔ∏è AGGRESSIVE APPROACH</strong><br>",t+="Take bold action to ensure mission success.<br>",t+="<em>Higher risk, higher reward</em><br>",t+=`<button onclick="game.genericMissionChoice('aggressive', '${e.id}')">Bold Action</button>`,t+="</div>",t+='<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+="<strong>üõ°Ô∏è CAUTIOUS APPROACH</strong><br>",t+="Proceed carefully to minimize risks.<br>",t+="<em>Safer but smaller rewards</em><br>",t+=`<button onclick="game.genericMissionChoice('cautious', '${e.id}')">Careful Planning</button>`,t+="</div>",this.showEmergencyEvent("‚öîÔ∏è Mission Decision",t)}genericMissionChoice(e,t){const a=this.getAllNavalMissions().find(e=>e.id===t);if("aggressive"===e){if(Math.random()<.6){const e=Math.floor(.5*a.rewards.pay);this.characterData.stats.money+=e,this.gameState.navalCareer.reputation+=2,this.showEmergencyEvent("üéâ Bold Success!",`Your aggressive tactics pay off handsomely!<br><br><strong>Bonus Rewards:</strong><br>‚Ä¢ +${e} gold bonus<br>‚Ä¢ +2 Naval reputation<br><br><em>"Outstanding initiative, officer!"</em>`)}else this.gameState.navalCareer.reputation-=1,this.showEmergencyEvent("‚ö†Ô∏è Risky Gamble Failed","Your bold approach backfires and causes complications.<br><br><strong>Setback:</strong><br>‚Ä¢ -1 Naval reputation<br>‚Ä¢ Mission still completes but with reduced rewards<br><br><em>Sometimes caution is the better part of valor.</em>")}else this.showEmergencyEvent("‚úÖ Steady Progress","Your careful approach ensures solid, reliable success.<br><br><strong>Reliable Results:</strong><br>‚Ä¢ Mission completed safely<br>‚Ä¢ Standard rewards earned<br><br><em>Professional naval service at its finest.</em>");setTimeout(()=>{this.hideEmergencyEvent(),this.processNavalMissionOutcome(a)},4e3)}takeShoreLeave(e){const t=this.gameState.navalCareer;30===e&&(t.reputation-=1),this.advanceTime(e);let a="<strong>üèñÔ∏è Shore Leave Granted</strong><br><br>";a+=`Your commanding officer approves your ${e}-day shore leave.<br><br>`,a+=`"Take the time you need, ${this.getCurrentNavalRank()}. The Navy will be here when you return."<br><br>`,7===e?(a+="<strong>Short Leave Benefits:</strong><br>",a+="‚Ä¢ Rest and relaxation (+0.1 to all skills)<br>",a+=`‚Ä¢ No naval obligations for ${e} days<br>`,this.characterData.stats.seamanship+=.1,this.characterData.stats.trading+=.1,this.characterData.stats.navigation+=.1,this.characterData.stats.leadership+=.1,this.characterData.stats.social+=.1):30===e&&(a+="<strong>Extended Leave:</strong><br>",a+=`‚Ä¢ ${e} days of freedom<br>`,a+="‚Ä¢ -1 naval reputation (absence noted)<br>",a+="‚Ä¢ Significant time for personal projects<br>"),a+="<br><em>You are now free to pursue civilian activities. Return to any Naval Office when ready to resume service.</em>",this.showActivityResult("üèñÔ∏è Leave Approved",a)}takeMedicalLeave(){this.gameState.navalCareer;this.advanceTime(14),this.gameState.ownedShip&&(this.gameState.ownedShip.condition=Math.min(100,this.gameState.ownedShip.condition+30)),this.characterData.stats.seamanship+=.2,this.characterData.stats.leadership+=.2,this.showActivityResult("üè• Medical Leave Complete","Your 14-day medical leave has restored your health and repaired your vessel.<br><br><strong>Recovery Benefits:</strong><br>‚Ä¢ Ship condition improved by 30 points<br>‚Ä¢ +0.2 Seamanship (rest and recovery)<br>‚Ä¢ +0.2 Leadership (reflection on command)<br>‚Ä¢ No reputation penalty<br><br><em>You return to service refreshed and ready for duty.</em>")}requestDischarge(){const e=this.gameState.navalCareer,t=["Seaman","Able Seaman","Midshipman","Lieutenant","Commander","Captain","Admiral"],a=Math.min(Math.floor(e.experience/10),t.length-1),r=t[a],o=50*(a+1)+10*e.missions_completed;this.characterData.stats.money+=o,this.characterData.reputation.crown+=5,e.veteran=!0,e.discharge_rank=r,e.enlisted=!1,this.showActivityResult("üéñÔ∏è Honorable Discharge Granted",`After distinguished service, you have been granted an honorable discharge from the Royal Navy.<br><br><strong>Final Service Record:</strong><br>‚Ä¢ Final Rank: ${r}<br>‚Ä¢ Missions Completed: ${e.missions_completed}<br>‚Ä¢ Total Experience: ${e.experience}<br>‚Ä¢ Naval Reputation: ${e.reputation}<br><br><strong>Veteran Benefits:</strong><br>‚Ä¢ Naval pension: ${o} gold<br>‚Ä¢ +5 Crown reputation (veteran status)<br>‚Ä¢ May re-enlist at previous rank<br>‚Ä¢ Access to veteran merchant opportunities<br><br><em>"Your service to the Crown has been exemplary. May fair winds follow you in civilian life."</em>`)}getCurrentNavalRank(){const e=["Seaman","Able Seaman","Midshipman","Lieutenant","Commander","Captain","Admiral"];return e[Math.min(Math.floor(this.gameState.navalCareer.experience/10),e.length-1)]}visitBankingHouse(){this.gameState.bankAccount||(this.gameState.bankAccount={balance:0,loan:0,loanInterestRate:.05,depositInterestRate:.02});const e=this.gameState.bankAccount,t=this.characterData.stats.money;let a="<strong>üè¶ Amsterdam Banking House</strong><br><br>";if(a+='"Welcome to the most trusted financial institution in Europe!"<br><br>',a+='<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>Account Status:</strong><br>",a+=`Bank Balance: ${e.balance} gold<br>`,a+=`Cash on Hand: ${t} gold<br>`,e.loan>0&&(a+=`Outstanding Loan: ${e.loan} gold (${(100*e.loanInterestRate).toFixed(1)}% monthly interest)<br>`),a+="</div>",a+='<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">',a+="<div><h4>üí∞ Deposit Gold</h4>",t>0?(a+="<p>Store your gold safely and earn 2% monthly interest.</p>",a+=`<input type="number" id="depositAmount" min="1" max="${t}" value="${Math.min(100,t)}" style="width: 80px; margin: 5px;"> gold<br>`,a+='<button onclick="game.depositGold()">Deposit</button>'):a+="<p><em>You have no gold to deposit.</em></p>",a+="</div>",a+="<div><h4>üè¶ Withdraw Gold</h4>",e.balance>0?(a+="<p>Withdraw your stored gold anytime.</p>",a+=`<input type="number" id="withdrawAmount" min="1" max="${e.balance}" value="${Math.min(100,e.balance)}" style="width: 80px; margin: 5px;"> gold<br>`,a+='<button onclick="game.withdrawGold()">Withdraw</button>'):a+="<p><em>No gold in your account.</em></p>",a+="</div></div>",a+="<h4>üìú Loans & Credit</h4>",0===e.loan)a+="<p>Need capital for a big investment? We offer loans up to 1,000 gold.</p>",a+='<input type="number" id="loanAmount" min="50" max="1000" step="50" value="200" style="width: 80px; margin: 5px;"> gold<br>',a+='<button onclick="game.takeLoan()">Request Loan (5% monthly interest)</button>';else{a+=`<p>You have an outstanding loan of ${e.loan} gold.</p>`;const r=Math.min(e.loan,t);r>0?(a+=`<input type="number" id="repayAmount" min="1" max="${r}" value="${r}" style="width: 80px; margin: 5px;"> gold<br>`,a+='<button onclick="game.repayLoan()">Repay Loan</button>'):a+="<p><em>You need gold to repay your loan.</em></p>"}this.showActivityResult("üè¶ Banking Services",a)}depositGold(){const e=parseInt(document.getElementById("depositAmount").value)||0;e>0&&e<=this.characterData.stats.money?(this.characterData.stats.money-=e,this.gameState.bankAccount.balance+=e,this.showActivityResult("üí∞ Deposit Complete",`You deposited ${e} gold into your account.<br><br>New account balance: ${this.gameState.bankAccount.balance} gold<br>Cash remaining: ${this.characterData.stats.money} gold`),setTimeout(()=>{this.visitBankingHouse()},2e3)):alert("Invalid deposit amount!")}withdrawGold(){const e=parseInt(document.getElementById("withdrawAmount").value)||0;e>0&&e<=this.gameState.bankAccount.balance?(this.characterData.stats.money+=e,this.gameState.bankAccount.balance-=e,this.showActivityResult("üè¶ Withdrawal Complete",`You withdrew ${e} gold from your account.<br><br>Account balance: ${this.gameState.bankAccount.balance} gold<br>Cash on hand: ${this.characterData.stats.money} gold`),setTimeout(()=>{this.visitBankingHouse()},2e3)):alert("Invalid withdrawal amount!")}takeLoan(){const e=parseInt(document.getElementById("loanAmount").value)||0;e>=50&&e<=1e3&&0===this.gameState.bankAccount.loan?(this.characterData.stats.money+=e,this.gameState.bankAccount.loan=e,this.showActivityResult("üìú Loan Approved",`The bank has approved your loan of ${e} gold!<br><br>You now have ${this.characterData.stats.money} gold in cash.<br>Monthly interest: ${(e*this.gameState.bankAccount.loanInterestRate).toFixed(1)} gold`),setTimeout(()=>{this.visitBankingHouse()},2500)):alert("Invalid loan amount or you already have a loan!")}repayLoan(){const e=parseInt(document.getElementById("repayAmount").value)||0;e>0&&e<=this.characterData.stats.money&&e<=this.gameState.bankAccount.loan?(this.characterData.stats.money-=e,this.gameState.bankAccount.loan-=e,this.showActivityResult("üí≥ Loan Payment",`You repaid ${e} gold towards your loan.<br><br>Remaining loan: ${this.gameState.bankAccount.loan} gold<br>Cash remaining: ${this.characterData.stats.money} gold`),setTimeout(()=>{this.visitBankingHouse()},2e3)):alert("Invalid repayment amount!")}visitExplorationOffice(){this.gameState.explorationData||(this.gameState.explorationData={completedExpeditions:[],discoveredRoutes:[],reputation:0});const e=this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation;let t="<strong>üó∫Ô∏è Portuguese Exploration Office</strong><br><br>";if(t+='"Portugal leads the world in maritime exploration. Join our expeditions to unknown lands!"<br><br>',!e)return t+='<div style="background: #ffebee; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #f44336;">',t+="<strong>‚ö†Ô∏è Ship Required</strong><br>You need your own ship in this port to join expeditions.",t+="</div>",void this.showActivityResult("üó∫Ô∏è Exploration Office",t);t+='<div style="background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px;">',t+=`<strong>Exploration Reputation:</strong> ${this.gameState.explorationData.reputation}<br>`,t+=`<strong>Completed Expeditions:</strong> ${this.gameState.explorationData.completedExpeditions.length}`,t+="</div>",t+="<strong>Available Expeditions:</strong><br><br>";[{id:"african_coast",name:"African Coast Survey",days:14,risk:.3,cost:50,rewards:{gold:[100,300],reputation:2},description:"Map the African coastline and establish trading posts",requirements:{reputation:0}},{id:"spice_route",name:"New Spice Route",days:21,risk:.4,cost:100,rewards:{gold:[200,500],reputation:3},description:"Discover faster routes to the spice islands",requirements:{reputation:2}},{id:"brazil_expedition",name:"Brazil Interior",days:30,risk:.5,cost:200,rewards:{gold:[300,800],reputation:5},description:"Explore the Brazilian interior for gold and rare goods",requirements:{reputation:5}}].forEach(e=>{const a=this.characterData.stats.money>=e.cost,r=this.gameState.explorationData.reputation>=e.requirements.reputation;let o;o=this.gameState.explorationData.completedExpeditions.includes(e.id)?"<em>Expedition completed</em>":r?a?`<button onclick="game.joinExpedition('${e.id}')">Join Expedition (${e.cost} gold)</button>`:`<button disabled>Join Expedition (${e.cost} gold)</button>`:`<em>Requires ${e.requirements.reputation} reputation</em>`;const n=`${(100*e.risk).toFixed(0)}% risk`,s=`${e.rewards.gold[0]}-${e.rewards.gold[1]} gold`;t+=`<div style="border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px;">\n            <strong>${e.name}</strong> (${e.days} days)<br>\n            ${e.description}<br>\n            <strong>Risk:</strong> ${n} | <strong>Reward:</strong> ${s}<br><br>\n            ${o}\n        </div>`}),this.showActivityResult("üó∫Ô∏è Exploration Office",t)}planTravel(){const e=this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation;if(!e&&this.characterData.stats.money<5)return void this.showActivityResult("üó∫Ô∏è Plan Your Journey","You need at least 5 gold for passage to another port, or buy a ship for free travel.");let t="<strong>Plan Your Journey:</strong><br><br>";e&&(t+=`<div style="background: #e8f5e8; border: 2px solid #27ae60; padding: 15px; margin-bottom: 15px; border-radius: 8px;">\n            ‚õµ <strong>Ship Travel Available!</strong><br>\n            You can sail your ${this.gameState.ownedShip.name} for FREE (faster travel, no passenger fees)\n        </div>`),[{id:"london",name:"London",cost:6,days:3,description:"England's largest port - starting point for many adventures, good dock work opportunities"},{id:"amsterdam",name:"Amsterdam",cost:8,days:3,description:"Dutch trading hub - competitive prices, financial services, and merchant opportunities"},{id:"lisbon",name:"Lisbon",cost:12,days:5,description:"Portuguese colonial gateway - exotic goods, exploration opportunities, New World connections"},{id:"bristol",name:"Bristol",cost:5,days:2,description:"Growing English port - colonial trade connections, ship building, friendly prices"}].forEach(a=>{if(a.id===this.gameState.currentLocation)return;const r=Math.max(1,a.days-1);let o="";e&&(o=`<button onclick="game.travelTo('${a.id}', 0, ${r})" style="margin: 5px; padding: 8px 12px; background: linear-gradient(145deg, #27ae60, #229954); color: white;">Sail Your Ship (${r} days, FREE)</button>`);const n=this.characterData.stats.money>=a.cost?`<button onclick="game.travelTo('${a.id}', ${a.cost}, ${a.days})" style="margin: 5px; padding: 8px 12px;">Book Passage (${a.cost} gold, ${a.days} days)</button>`:`<button disabled style="margin: 5px; padding: 8px 12px; opacity: 0.5;">Book Passage (${a.cost} gold)</button>`;t+=`<div style="border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px;">\n            <strong>${a.name}</strong><br>\n            ${a.description}<br><br>\n            ${o}${e?"<br>":""}${n}\n        </div>`}),this.showActivityResult("üó∫Ô∏è Plan Your Journey",t)}travelTo(e,t,a){let r=t,o=a,n="passenger";const s=this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation;if(s){r=0,o=Math.max(1,a-1),n="ship";const t=this.getCrewNavigationBonus(),s=Math.floor(o*t.timeReduction),i=o-this.applyShipSpecialBonuses(o,"travel_speed"),l=s+i;o=Math.max(1,o-l),this.tempNavReduction=s,this.tempShipReduction=i,this.tempRepairBonus=this.getCrewRepairBonus(),this.tempNavBonus=t,this.gameState.ownedShip.location=e;let c=Math.floor(2*Math.random())+1;c=Math.max(0,c-Math.floor(.3*this.tempRepairBonus)),this.gameState.ownedShip.condition-=c;let d=.06;if(d*=1-t.damageReduction,Math.random()<d){let e=Math.floor(8*Math.random())+5;e=Math.floor(e*(1-t.damageReduction)),this.gameState.ownedShip.condition-=e}this.gameState.ownedShip.condition=Math.max(0,this.gameState.ownedShip.condition)}this.characterData.stats.money-=r,this.gameState.currentLocation=e,console.log("About to advance time by",o,"days"),this.advanceTime(o),this.advanceTime(o);const i=s?["You navigate your own ship skillfully through calm waters.","A sudden storm tests your seamanship, but you weather it successfully.","You spot a merchant vessel and exchange friendly signals.","Your crew works efficiently, making excellent time.","You discover a favorable wind current that speeds your journey."]:["Your journey passes without incident. You arrive safely.","Rough seas delay your arrival, but you meet an interesting fellow passenger.","Fair winds speed your journey. You arrive ahead of schedule.","A merchant on board shares valuable trading advice with you.","Pirates are spotted in the distance, but your ship escapes unnoticed."],l=i[Math.floor(Math.random()*i.length)];let c=`You arrive in ${this.getLocationName(e)} after ${o} days.`;if(s){if(c+=`<br><br><strong>‚õµ Captain's Log - "${this.gameState.ownedShip.shipName}":</strong> ${l}`,this.tempNavReduction>0&&(c+=`<br><br><em>‚öì Skilled navigator reduced travel time by ${this.tempNavReduction} day(s)!</em>`),this.tempShipReduction>0){"speed_demon"===this.getShipSpecialAbility()&&(c+=`<br><em>üí® Racing Schooner's speed reduced travel time by ${this.tempShipReduction} day(s)!</em>`)}this.tempRepairBonus>0&&(c+="<br><em>üîß Ship's carpenter reduced wear and tear!</em>"),this.tempNavBonus&&this.tempNavBonus.damageReduction>0&&(c+="<br><em>üß≠ Expert navigation avoided dangerous weather!</em>"),this.gameState.ownedShip.condition<90&&(c+=`<br><br><em>‚ö†Ô∏è Ship condition: ${this.gameState.ownedShip.condition}% (consider repairs)</em>`),this.characterData.stats.navigation+=.2;const e=this.giveCrewExperience("travel",15);c+="<br><br><em>+0.2 Navigation skill</em>",e&&e.length>0&&(c+="<br><br><strong>üåü Crew Experience:</strong><br>",e.forEach(e=>{c+=`‚Ä¢ ${e}<br>`}))}else c+=`<br><br>${l}<br><br>Passage cost: ${t} gold`;this.showActivityResult("‚õµ Journey Complete",c),this.returnToLocation()}getLocationName(e){return{london:"London",amsterdam:"Amsterdam",lisbon:"Lisbon",bristol:"Bristol"}[e]||e}updateLocationDisplay(){console.log("Updating location to:",this.gameState.currentLocation),document.querySelectorAll(".location").forEach(e=>{e.classList.remove("active"),e.style.display="none"});const e=this.gameState.currentLocation+"Location",t=document.getElementById(e);console.log("Looking for element:",e,"Found:",t),t?(t.classList.add("active"),t.style.display="block"):console.error("Location element not found:",e),this.updateDisplay()}showActivityResult(e,t){document.getElementById("activityTitle").innerHTML=e,document.getElementById("activityContent").innerHTML=t,this.updateDisplay()}returnToLocation(){console.log("returnToLocation called");const e=document.getElementById("activityPanel"),t=document.getElementById("locationView");console.log("activityPanel:",e),console.log("locationView:",t),e?(console.log("Activity panel classes before:",e.classList.toString()),e.classList.add("hidden"),console.log("Activity panel classes after:",e.classList.toString())):console.log("ERROR: activityPanel not found!"),t?(console.log("Location view classes before:",t.classList.toString()),t.classList.remove("hidden"),console.log("Location view classes after:",t.classList.toString())):console.log("ERROR: locationView not found!"),this.updateLocationDisplay()}advanceTime(e){console.log(`=== ADVANCING TIME: ${e} days ===`);for(let t=0;t<e;t++){console.log(`Day ${t+1}: Checking for events...`),this.gameState.ownedShip&&this.gameState.ownedShip.namedCrew&&this.gameState.ownedShip.namedCrew.length>0&&this.checkCrewLoyaltyEvents(),this.gameState.ownedShip&&this.gameState.ownedShip.namedCrew&&this.gameState.ownedShip.condition<30&&this.gameState.ownedShip.namedCrew.forEach(e=>{e.loyalty=Math.max(0,e.loyalty-1)});const e=Math.random();console.log(`Random roll: ${e} (need < 0.15 for event)`),e<.15&&(console.log("TRIGGERED RANDOM EVENT!"),this.triggerRandomEvent()),t>0&&t%30==0&&this.processMonthlyEvents()}if(this.gameState.daysSinceBirth||(this.gameState.daysSinceBirth=0),this.gameState.daysSinceBirth+=e,this.gameState.daysSinceBirth>=365){const e=Math.floor(this.gameState.daysSinceBirth/365);this.gameState.daysSinceBirth=this.gameState.daysSinceBirth%365,this.characterData.age+=e,e>0&&setTimeout(()=>{this.showEmergencyEvent("üéÇ Birthday!",`You have turned ${this.characterData.age} years old!<br><br><em>Another year of adventure and experience...</em>`)},1e3)}this.gameState.totalDays||(this.gameState.totalDays=0),this.gameState.totalDays+=e;const t=Math.floor(this.gameState.totalDays/30);this.gameState.year=1740+Math.floor(t/12),this.gameState.month=t%12+1,console.log(`New date: Month ${this.gameState.month}, Year ${this.gameState.year}, Total days: ${this.gameState.totalDays}`),this.updateDisplay()}triggerRandomEvent(){console.log("=== TRIGGER RANDOM EVENT CALLED ===");const e=this.getAvailableEvents();console.log("Available events:",e),console.log("Number of events:",e.length);const t=this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation;if(console.log("Has ship at current location:",t),console.log("Owned ship:",this.gameState.ownedShip),console.log("Current location:",this.gameState.currentLocation),0===e.length)return void console.log("NO EVENTS AVAILABLE - RETURNING");const a=e[Math.floor(Math.random()*e.length)];console.log("Selected event:",a),this.executeEvent(a)}getAvailableEvents(){const e=[],t=this.gameState.ownedShip&&this.gameState.ownedShip.location===this.gameState.currentLocation;return e.push({id:"market_crash",weight:5},{id:"disease_outbreak",weight:3},{id:"political_intrigue",weight:8},{id:"lucky_find",weight:10}),t&&e.push({id:"pirate_attack",weight:12},{id:"storm_damage",weight:15},{id:"shipwreck_risk",weight:4},{id:"naval_press_gang",weight:6}),this.gameState.navalCareer&&this.gameState.navalCareer.enlisted&&e.push({id:"naval_emergency",weight:10},{id:"promotion_opportunity",weight:7}),"london"===this.gameState.currentLocation&&e.push({id:"royal_decree",weight:5}),e}executeEvent(e){const t={pirate_attack:()=>this.handlePirateAttack(),storm_damage:()=>this.handleStormDamage(),shipwreck_risk:()=>this.handleShipwreckRisk(),disease_outbreak:()=>this.handleDiseaseOutbreak(),market_crash:()=>this.handleMarketCrash(),naval_emergency:()=>this.handleNavalEmergency(),lucky_find:()=>this.handleLuckyFind(),political_intrigue:()=>this.handlePoliticalIntrigue(),naval_press_gang:()=>this.handlePressGang(),royal_decree:()=>this.handleRoyalDecree()}[e.id];t&&t()}handlePirateAttack(){if(!this.gameState.ownedShip)return;const e=this.gameState.ownedShip;if(!e.baseStats){const t={"Rowing Boat":{combat:5,defense:5,speed:15},Sloop:{combat:12,defense:8,speed:18},Brigantine:{combat:20,defense:15,speed:12}};e.baseStats=t[e.name]||{combat:10,defense:10,speed:10}}e.upgrades||(e.upgrades={cannons:0,armor:0,speed:0,storage:0}),this.combatState={round:1,playerHull:100,enemyHull:100,playerMorale:80,enemyMorale:80,range:"long",playerCannonsFired:!1,enemyCannonsFired:!1,playerAdvantage:!1,enemyAdvantage:!1},this.enemyShip=this.generateEnemyPirate(),this.startCombatRound()}generateEnemyPirate(){const e=[{name:"Scurvy Dog",hull:60,combat:15,tactics:"aggressive"},{name:"Sea Wolf",hull:80,combat:20,tactics:"balanced"},{name:"Dread Captain",hull:100,combat:25,tactics:"cunning"},{name:"Terror of the Seas",hull:120,combat:30,tactics:"legendary"}],t=e[Math.floor(Math.random()*e.length)];return{...t,originalHull:t.hull,cannons:Math.floor(3*Math.random())+1,crew:Math.floor(20*Math.random())+10}}startCombatRound(){const e=this.combatState,t=this.enemyShip;let a=`<strong>‚öîÔ∏è NAVAL BATTLE - Round ${e.round}</strong><br><br>`;a+='<div style="background: #1a1a1a; color: white; padding: 15px; margin-bottom: 15px; border-radius: 8px;">',a+=`<strong>üè¥‚Äç‚ò†Ô∏è Enemy: ${t.name}</strong><br>`,a+=`‚öîÔ∏è Combat Range: ${e.range.toUpperCase()}<br><br>`;const r=e.playerHull>70?"#28a745":e.playerHull>30?"#ffc107":"#dc3545",o=e.enemyHull>70?"#28a745":e.enemyHull>30?"#ffc107":"#dc3545";a+=`<strong>Your Ship "${this.gameState.ownedShip.shipName}":</strong><br>`,a+='<div style="background: #333; border-radius: 10px; padding: 5px; margin: 5px 0;">',a+=`<div style="background: ${r}; width: ${e.playerHull}%; height: 20px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">Hull: ${e.playerHull}%</div>`,a+="</div>",a+="<strong>Enemy Ship:</strong><br>",a+='<div style="background: #333; border-radius: 10px; padding: 5px; margin: 5px 0;">',a+=`<div style="background: ${o}; width: ${e.enemyHull}%; height: 20px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">Hull: ${e.enemyHull}%</div>`,a+="</div>",a+="</div>",a+=this.getCombatRoundDescription(),a+=this.getCombatOptions(),this.showEmergencyEvent("‚öîÔ∏è Naval Battle!",a)}getCombatRoundDescription(){const e=this.combatState,t=this.enemyShip;let a="<strong>Battle Report:</strong><br>";return 1===e.round?(a+=`The pirate ship "${t.name}" has spotted you and is closing for attack! `,"long"===e.range&&(a+="Both ships are at long range, cannons ready.<br><br>")):(e.playerAdvantage?a+="Your last action gave you the advantage! The enemy is reeling.<br>":e.enemyAdvantage?a+="The pirates gained the upper hand! They're pressing their attack.<br>":a+="Both ships exchange fire in a deadly dance of steel and gunpowder.<br>","close"===e.range?a+="The ships are now dangerously close - you can see the pirates' faces!<br>":"boarding"===e.range&&(a+="The ships are locked together! This is hand-to-hand combat now!<br>"),a+="<br>"),a}getCombatOptions(){const e=this.combatState,t=this.gameState.ownedShip;let a="<strong>Choose Your Tactics:</strong><br><br>";if("long"===e.range||"medium"===e.range){a+='<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>üî• CANNON BARRAGE</strong><br>",a+="Unleash your ship's firepower at the enemy.<br>";a+=`<strong>Firepower:</strong> ${t.baseStats.combat+8*t.upgrades.cannons}<br>`,t.upgrades.cannons>=2&&(a+="<em>Heavy cannons available!</em><br>"),a+="<button onclick=\"game.executeCombatAction('cannon_attack')\">FIRE CANNONS</button>",a+="</div>",a+='<div style="border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>‚õµ TACTICAL MANEUVER</strong><br>",a+="Use superior sailing to gain an advantage.<br>";a+=`<strong>Speed:</strong> ${t.baseStats.speed+4*t.upgrades.speed}<br>`,a+="<button onclick=\"game.executeCombatAction('maneuver')\">OUTMANEUVER</button>",a+="</div>",a+='<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>üõ°Ô∏è DEFENSIVE POSITION</strong><br>",a+="Angle your armor and prepare for their attack.<br>";a+=`<strong>Defense:</strong> ${t.baseStats.defense+6*t.upgrades.armor}<br>`,a+="<button onclick=\"game.executeCombatAction('defend')\">DEFENSIVE STANCE</button>",a+="</div>","medium"===e.range&&(a+='<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>‚ö° RAMMING SPEED</strong><br>",a+="Charge directly at the enemy ship!<br>",a+="<strong>Risk:</strong> High damage to both ships<br>",a+="<button onclick=\"game.executeCombatAction('ram')\">RAMMING SPEED!</button>",a+="</div>")}else"close"===e.range?(a+='<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>‚öîÔ∏è PREPARE TO BOARD</strong><br>",a+="Ready your crew for hand-to-hand combat!<br>",a+="<button onclick=\"game.executeCombatAction('prepare_boarding')\">BOARD THEM!</button>",a+="</div>",a+='<div style="border: 2px solid #6f42c1; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>üî´ POINT-BLANK CANNONS</strong><br>",a+="Devastating close-range cannon fire!<br>",a+="<button onclick=\"game.executeCombatAction('point_blank')\">POINT-BLANK FIRE!</button>",a+="</div>",a+='<div style="border: 2px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>üèÉ ATTEMPT ESCAPE</strong><br>",a+="Try to break away and flee!<br>",a+="<button onclick=\"game.executeCombatAction('escape')\">ATTEMPT ESCAPE</button>",a+="</div>"):"boarding"===e.range&&(a+='<div style="border: 2px solid #8b0000; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>‚öîÔ∏è FIGHT FIERCELY</strong><br>",a+="Press the attack with sword and pistol!<br>",a+="<button onclick=\"game.executeCombatAction('boarding_attack')\">FIGHT!</button>",a+="</div>",a+='<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>üõ°Ô∏è DEFENSIVE FIGHTING</strong><br>",a+="Fight carefully and protect your crew.<br>",a+="<button onclick=\"game.executeCombatAction('boarding_defend')\">FIGHT DEFENSIVELY</button>",a+="</div>",e.enemyHull<30&&(a+='<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>üè≥Ô∏è DEMAND SURRENDER</strong><br>",a+="Their ship is badly damaged - demand they yield!<br>",a+="<button onclick=\"game.executeCombatAction('demand_surrender')\">DEMAND SURRENDER</button>",a+="</div>"));return a}executeCombatAction(e){if(!this.combatState)return console.error("Combat state is null! Resetting combat..."),void this.hideEmergencyEvent();const t=this.combatState;this.gameState.ownedShip,this.enemyShip;let a="";switch(t.playerAdvantage=!1,t.enemyAdvantage=!1,e){case"cannon_attack":a=this.executeCannonsAttack();break;case"maneuver":a=this.executeManeuver();break;case"defend":a=this.executeDefend();break;case"ram":a=this.executeRam();break;case"prepare_boarding":a=this.executePrepareBording();break;case"point_blank":a=this.executePointBlank();break;case"escape":a=this.executeEscape();break;case"boarding_attack":a=this.executeBoardingAttack();break;case"boarding_defend":a=this.executeBoardingDefend();break;case"demand_surrender":a=this.executeDemandSurrender()}t.playerHull=Math.max(0,t.playerHull),t.enemyHull=Math.max(0,t.enemyHull),t.playerHull<=0?this.endCombat("defeat","Your ship is destroyed!"):t.enemyHull<=0?this.endCombat("victory","The enemy ship is sinking!"):(this.showEmergencyEvent("‚öîÔ∏è Combat Result",a),setTimeout(()=>{this.enemyTurn()},1500))}executeCannonsAttack(){const e=this.combatState,t=this.gameState.ownedShip,a=t.baseStats.combat+8*t.upgrades.cannons,r=this.getCrewCombatBonus(),o=this.getCrewLoyaltyBonus(),n=Math.floor((a+r)*o),s=.7*Math.random()+.3,i=Math.floor(n*s);e.enemyHull-=i;let l="<strong>üî• CANNON BARRAGE!</strong><br><br>";if(l+="Your cannons roar with thunder and flame!<br><br>",s>.8?(l+="<strong>EXCELLENT SHOOTING!</strong> Your gunners find their mark!<br>",e.playerAdvantage=!0):l+=s<.5?"Your shots mostly miss - the gunners need more practice!<br>":"Solid hits! Splinters fly from the enemy ship!<br>",l+=`<strong>Enemy ship damage: ${i} points</strong><br>`,r>0&&(l+=`<em>Skilled gunners: +${r} combat power!</em><br>`),1!==o){l+=`<em>Crew loyalty: ${Math.round(100*o)}% efficiency</em><br>`}return l+="<br>",t.upgrades.cannons>=3&&(l+="<em>Your heavy cannons devastate the enemy vessel!</em>"),l}executeManeuver(){const e=this.combatState,t=this.gameState.ownedShip,a=t.baseStats.speed+4*t.upgrades.speed;let r="<strong>‚õµ TACTICAL MANEUVER!</strong><br><br>";return Math.random()<a/40?(r+="Your superior seamanship pays off! You gain the weather gauge!<br><br>",e.playerAdvantage=!0,this.characterData.stats.navigation+=.1,r+="<strong>Advantage gained!</strong> Your next attack will be more effective.<br>",r+="<em>+0.1 Navigation skill</em>"):(r+="You attempt to outmaneuver the pirates, but they're experienced sailors too!<br><br>",r+="The enemy maintains their position. No advantage gained."),r}executeDefend(){const e=this.combatState,t=this.gameState.ownedShip,a=t.baseStats.defense+6*t.upgrades.armor;e.playerDefending=!0,e.defenseBonus=a;let r="<strong>üõ°Ô∏è DEFENSIVE POSITION!</strong><br><br>";return r+="You angle your ship to present the strongest armor and ready for their attack!<br><br>",r+=`<strong>Defense Rating: ${a}</strong><br>`,r+="<strong>Next enemy attack will be reduced!</strong>",t.upgrades.armor>=2&&(r+="<br><em>Your reinforced hull provides excellent protection!</em>"),r}executeRam(){const e=this.combatState,t=(this.gameState.ownedShip,Math.floor(40*Math.random())+20),a=Math.floor(.6*t);e.enemyHull-=t,e.playerHull-=a,e.range="close";let r="<strong>‚ö° RAMMING SPEED!</strong><br><br>";return r+='"RAMMING SPEED!" You drive your ship directly into the enemy!<br><br>',r+="CRASH! The ships collide in a tremendous impact!<br><br>",r+=`<strong>Enemy damage: ${t}</strong><br>`,r+=`<strong>Your damage: ${a}</strong><br><br>`,r+="<em>The ships are now locked together at close range!</em>",this.characterData.stats.leadership+=.2,r}executePrepareBoarding(){const e=this.combatState;e.range="boarding",e.playerAdvantage=!0;let t="<strong>‚öîÔ∏è PREPARE TO BOARD!</strong><br><br>";return t+='"All hands, prepare for boarding!" Your crew readies cutlasses and pistols!<br><br>',t+="Grappling hooks fly through the air, lashing the ships together!<br><br>",t+="<strong>BOARDING COMBAT ENGAGED!</strong><br>",t+="<em>Your crew has the initiative!</em>",'<strong>‚öîÔ∏è PREPARE TO BOARD!</strong><br><br>"All hands, prepare for boarding!" Your crew readies cutlasses and pistols!<br><br>Grappling hooks fly through the air, lashing the ships together!<br><br><strong>BOARDING COMBAT ENGAGED!</strong><br><em>Your crew has the initiative!</em>'}executePointBlank(){const e=this.combatState,t=this.gameState.ownedShip,a=1.5*(t.baseStats.combat+8*t.upgrades.cannons);e.enemyHull-=Math.floor(a);let r="<strong>üî´ POINT-BLANK CANNONS!</strong><br><br>";return r+="At this range, you can't miss! Your cannons tear through their hull!<br><br>",r+="BOOM! BOOM! BOOM! Devastating close-range firepower!<br><br>",r+=`<strong>Massive damage: ${Math.floor(a)} points!</strong><br><br>`,r+="<em>Splinters and debris fly everywhere!</em>",r}executeEscape(){const e=this.combatState,t=this.gameState.ownedShip,a=(t.baseStats.speed+4*t.upgrades.speed)/50;if(!(Math.random()<a)){let t="<strong>üèÉ ESCAPE ATTEMPT FAILED!</strong><br><br>";return t+="You try to break away, but the pirates pursue relentlessly!<br><br>",t+='"You can\'t escape us!" They close in for the kill!<br><br>',t+="<em>The enemy gains advantage from your failed escape!</em>",e.enemyAdvantage=!0,t}this.endCombat("escape","You successfully escape the pirates!")}executeBoardingAttack(){const e=this.combatState,t=10*this.characterData.stats.leadership+5*this.characterData.stats.seamanship,a=Math.floor(25*Math.random())+t/2;e.enemyHull-=a,e.playerHull-=Math.floor(15*Math.random())+5;let r="<strong>‚öîÔ∏è FIERCE MELEE COMBAT!</strong><br><br>";return r+="Steel rings against steel! Pistols crack in the salty air!<br><br>",r+="You lead your crew in vicious hand-to-hand fighting!<br><br>",r+="<strong>Enemy casualties inflicted!</strong><br>",r+="<strong>Some of your crew are wounded in the fight.</strong><br><br>",this.characterData.stats.leadership+=.1,"<strong>‚öîÔ∏è FIERCE MELEE COMBAT!</strong><br><br>Steel rings against steel! Pistols crack in the salty air!<br><br>You lead your crew in vicious hand-to-hand fighting!<br><br><strong>Enemy casualties inflicted!</strong><br><strong>Some of your crew are wounded in the fight.</strong><br><br>"}executeBoardingDefend(){this.combatState.playerDefending=!0;let e="<strong>üõ°Ô∏è DEFENSIVE FIGHTING!</strong><br><br>";return e+="You order your crew to fight smart - protect each other!<br><br>",e+='"Hold the line! Watch your mates\' backs!"<br><br>',e+="<strong>Reduced casualties for both sides.</strong><br>",e+="<em>Your crew appreciates your careful leadership.</em>",'<strong>üõ°Ô∏è DEFENSIVE FIGHTING!</strong><br><br>You order your crew to fight smart - protect each other!<br><br>"Hold the line! Watch your mates\' backs!"<br><br><strong>Reduced casualties for both sides.</strong><br><em>Your crew appreciates your careful leadership.</em>'}executeDemandSurrender(){const e=this.combatState,t=this.characterData.stats.social/10+(100-e.enemyHull)/100;if(!(Math.random()<t)){let t="<strong>üè≥Ô∏è SURRENDER REJECTED!</strong><br><br>";return t+='"NEVER!" screams the pirate captain. "Fight to the death!"<br><br>',t+="The pirates fight with desperate fury!<br><br>",t+="<em>Enemy morale increased by desperation!</em>",e.enemyAdvantage=!0,t}this.endCombat("surrender","The pirates surrender to your superior force!")}enemyTurn(){const e=this.combatState;this.enemyShip;let t=this.chooseEnemyAction(),a=this.executeEnemyAction(t);e.round++,this.showEmergencyEvent("üè¥‚Äç‚ò†Ô∏è Enemy Action",a),e.playerHull<=0?setTimeout(()=>{this.endCombat("defeat","Your ship is destroyed!")},3e3):e.enemyHull<=0?setTimeout(()=>{this.endCombat("victory","The enemy ship is sinking!")},3e3):setTimeout(()=>{this.startCombatRound()},2e3)}chooseEnemyAction(){const e=this.combatState,t=this.enemyShip;if("boarding"===e.range)return"boarding_attack";if(e.enemyHull<30&&Math.random()<.3)return"desperate_attack";if("close"===e.range&&"aggressive"===t.tactics)return Math.random()<.7?"point_blank":"ram_player";if("long"===e.range||"medium"===e.range){const e=["cannon_attack","maneuver","close_distance"];return e[Math.floor(Math.random()*e.length)]}return"cannon_attack"}executeEnemyAction(e){this.combatState,this.enemyShip;switch(e){case"cannon_attack":default:return this.enemyCannonAttack();case"maneuver":return this.enemyManeuver();case"close_distance":return this.enemyCloseDistance();case"ram_player":return this.enemyRamAttack();case"point_blank":return this.enemyPointBlank();case"boarding_attack":return this.enemyBoardingAttack();case"desperate_attack":return this.enemyDesperateAttack()}}enemyCannonAttack(){const e=this.combatState,t=this.enemyShip,a=Math.floor(t.combat*(.6+.4*Math.random()));let r=a;return e.playerDefending&&(r=Math.floor(.6*a),e.playerDefending=!1),e.playerHull-=r,`<strong>üî• Enemy Cannons Fire!</strong><br><br>The ${t.name} unleashes a devastating broadside!<br><br><strong>Your ship takes ${r} damage!</strong><br>Hull integrity: ${e.playerHull}%`}enemyManeuver(){const e=this.combatState;return Math.random()<.6?(e.enemyAdvantage=!0,"<strong>‚õµ Enemy Outmaneuvers You!</strong><br><br>The pirate ship gains the weather gauge!<br><br><strong>Enemy advantage gained!</strong>"):"<strong>‚õµ Enemy Maneuver Failed!</strong><br><br>The pirates attempt to outflank you but fail!<br><br>Your ship maintains position."}enemyCloseDistance(){const e=this.combatState;return"long"===e.range?e.range="medium":"medium"===e.range&&(e.range="close"),`<strong>üö¢ Enemy Closes Distance!</strong><br><br>The pirate ship sails aggressively toward you!<br><br><strong>Range is now: ${e.range.toUpperCase()}</strong>`}enemyRamAttack(){const e=this.combatState,t=this.enemyShip,a=Math.floor(35*Math.random())+15,r=Math.floor(.7*a);return e.playerHull-=a,e.enemyHull-=r,e.range="close",`<strong>üí• Enemy Ramming Attack!</strong><br><br>The ${t.name} charges at full speed!<br><br>CRASH! Both ships collide violently!<br><br><strong>You take ${a} damage!</strong><br><strong>Enemy takes ${r} damage!</strong><br><br>Range is now: CLOSE`}enemyPointBlank(){const e=this.combatState,t=this.enemyShip,a=Math.floor(1.4*t.combat);return e.playerHull-=a,`<strong>üíÄ Enemy Point-Blank Fire!</strong><br><br>The pirates unleash devastating close-range cannon fire!<br><br><strong>Your ship takes ${a} massive damage!</strong><br>Hull integrity: ${e.playerHull}%`}enemyBoardingAttack(){const e=this.combatState,t=(this.enemyShip,Math.floor(20*Math.random())+10);return e.playerHull-=t,`<strong>‚öîÔ∏è Pirates Board Your Ship!</strong><br><br>"Take no prisoners!" Cutlass-wielding pirates swarm aboard!<br><br><strong>Fierce hand-to-hand combat!</strong><br>Your ship takes ${t} damage in the melee!`}enemyDesperateAttack(){const e=this.combatState,t=this.enemyShip,a=Math.floor(1.6*t.combat),r=Math.floor(15*Math.random())+10;return e.playerHull-=a,e.enemyHull-=r,`<strong>üî• Desperate Pirate Attack!</strong><br><br>With their ship badly damaged, the pirates fight with nothing to lose!<br><br><strong>Massive damage exchange!</strong><br>You take ${a} damage!<br>Enemy takes ${r} damage from reckless tactics!`}endCombat(e,t){let a=`<strong>${t}</strong><br><br>`;const r=this.checkCrewDeaths("naval combat",.08),o=this.gameState.ownedShip.namedCrew&&this.gameState.ownedShip.namedCrew.some(e=>"surgeon"===e.specialty);if("victory"===e){const e=Math.floor(300*Math.random())+200;this.characterData.stats.money+=e;let t=0;if(this.isNavalMissionCombat){t=Math.floor(.5*e),this.characterData.stats.money+=t,this.gameState.navalCareer.reputation+=3;const a=this.gameState.navalCareer.experience;this.gameState.navalCareer.experience+=5,this.checkNavalPromotion(a,this.gameState.navalCareer.experience)}this.characterData.reputation.pirate-=2,this.characterData.reputation.crown+=1,this.characterData.stats.leadership+=.3;const n=Math.floor(15*Math.random())+5;this.gameState.ownedShip.condition-=n,this.gameState.ownedShip.condition=Math.max(0,this.gameState.ownedShip.condition);const s=this.giveCrewExperience("combat",25);a+=`<strong>‚öîÔ∏è VICTORY!</strong><br><br>You have defeated the pirates!<br><br><strong>Spoils of War:</strong><br>‚Ä¢ ${e} gold in pirate treasure<br>`,this.isNavalMissionCombat&&(a+=`‚Ä¢ ${t} gold naval bonus<br>‚Ä¢ +3 Naval reputation<br>‚Ä¢ +5 Naval experience<br>`),a+="‚Ä¢ +0.3 Leadership skill<br>‚Ä¢ +1 Crown reputation<br>‚Ä¢ -2 Pirate reputation (they fear you)<br><br>",s&&s.length>0&&(a+="<strong>üåü Crew Experience:</strong><br>",s.forEach(e=>{a+=`‚Ä¢ ${e}<br>`}),a+="<br>"),a+=this.getDeathReport(r,"combat",o),a+=`<strong>Battle Damage:</strong><br>‚Ä¢ Ship condition: ${this.gameState.ownedShip.condition}%<br><br><em>The seas remember those who stand against piracy!</em>`}else{if("defeat"===e)return void this.handlePirateDefeat(!0);"escape"===e&&(a+="<strong>üèÉ Successful Escape!</strong><br><br>You manage to break away from the pirates!<br><br>Your superior seamanship saves the day.<br><br><em>Sometimes discretion is the better part of valor.</em>",this.characterData.stats.navigation+=.2)}this.combatState=null,this.enemyShip=null,r&&r.length>0&&(this.criticalMessageActive=!0),this.showEmergencyEvent("‚öîÔ∏è Combat Complete",a),this.isNavalMissionCombat&&(this.isNavalMissionCombat=!1,setTimeout(()=>{const e=this.getAllNavalMissions().find(e=>e.id===this.currentNavalMission);this.processNavalMissionOutcome(e)},6e3))}resolvePirateFight(e,t){if(Math.random()<t/(t+e)){const e=Math.floor(300*Math.random())+200;this.characterData.stats.money+=e,this.characterData.reputation.pirate-=2,this.characterData.reputation.crown+=1,this.characterData.stats.leadership+=.3,this.gameState.ownedShip.condition-=Math.floor(15*Math.random())+5,this.gameState.ownedShip.condition=Math.max(0,this.gameState.ownedShip.condition),this.showEmergencyEvent("‚öîÔ∏è VICTORY!",`<strong>You defeated the pirates!</strong><br><br>Your crew fought bravely and the pirate ship is captured!<br><br><strong>Spoils of War:</strong><br>‚Ä¢ ${e} gold in pirate treasure<br>‚Ä¢ +0.3 Leadership skill<br>‚Ä¢ +1 Crown reputation (heroic deed)<br>‚Ä¢ -2 Pirate reputation (they fear you)<br><br><strong>Battle Damage:</strong><br>‚Ä¢ Ship condition: ${this.gameState.ownedShip.condition}%<br><br><em>"The seas remember those who stand against piracy!"</em>`)}else this.handlePirateDefeat(!0)}resolvePirateNegotiation(e,t){if(Math.random()<t/100){const e=Math.floor(50*Math.random())+50;this.characterData.stats.money>=e?(this.characterData.stats.money-=e,this.characterData.stats.social+=.2,this.showEmergencyEvent("ü§ù Negotiation Success",`You successfully negotiate with the pirates!<br><br>"Aye, you speak fair words, captain. We'll take our tribute and be on our way."<br><br><strong>Settlement:</strong><br>‚Ä¢ Paid ${e} gold tribute<br>‚Ä¢ No damage to ship or crew<br>‚Ä¢ +0.2 Social skill<br><br><em>Sometimes wisdom is worth more than valor.</em>`)):this.handlePirateDefeat(!1)}else this.showEmergencyEvent("üó£Ô∏è Negotiation Failed",'The pirate captain laughs at your words!<br><br>"You think you can bargain with us? Prepare to be boarded!"<br><br><em>The pirates attack with renewed fury...</em>'),setTimeout(()=>{this.handlePirateDefeat(!0)},3e3);setTimeout(()=>{this.hideEmergencyEvent()},6e3)}resolvePirateFlee(e,t){Math.random()<t/100?(this.gameState.ownedShip.condition-=Math.floor(8*Math.random())+2,this.characterData.stats.navigation+=.2,this.showEmergencyEvent("üèÉ Successful Escape!",'Your superior seamanship saves the day!<br><br>"Hard to port! All sail!" You expertly navigate treacherous waters and lose the pirates in a maze of reefs.<br><br><strong>Escape Results:</strong><br>‚Ä¢ Ship escaped safely<br>‚Ä¢ Minor wear from hard sailing<br>‚Ä¢ +0.2 Navigation skill<br><br><em>"Sometimes the better part of valor is discretion."</em>')):(this.showEmergencyEvent("‚ö†Ô∏è Caught While Fleeing!",'The pirates catch up to you!<br><br>"You cannot escape us so easily!" Your ship is overtaken and now you face them from a position of weakness.<br><br><em>The pirates board your vessel...</em>'),setTimeout(()=>{this.handlePirateDefeat(!0)},3e3)),setTimeout(()=>{this.hideEmergencyEvent()},6e3)}showCharacterSheet(){this.updateCharacterSheetContent(),document.getElementById("characterSheet").classList.remove("hidden")}hideCharacterSheet(){document.getElementById("characterSheet").classList.add("hidden")}showEmergencyEvent(e,t){this.criticalMessageActive?console.log("Critical message active, queuing new message"):(document.getElementById("emergencyTitle").innerHTML=e,document.getElementById("emergencyContent").innerHTML=t,document.getElementById("emergencyModal").classList.remove("hidden"))}hideEmergencyEvent(){document.getElementById("emergencyModal").classList.add("hidden"),this.criticalMessageActive=!1}handlePirateDefeat(e){const t=this.gameState.ownedShip,a=Math.floor(.6*this.getShipCargoCount()),r=Math.floor(.3*this.characterData.stats.money),o=Math.floor(40*Math.random())+20;this.characterData.stats.money-=r,t.condition-=o,t.condition=Math.max(0,t.condition),t.cargoHold&&Object.keys(t.cargoHold).forEach(e=>{t.cargoHold[e]=Math.floor(.4*t.cargoHold[e])}),this.characterData.reputation.pirate+=1;let n="<strong>üíÄ DEFEATED BY PIRATES!</strong><br><br>";0===t.condition?(n+=`Your ship "${t.shipName}" is destroyed! The pirates have sunk your vessel!<br><br>`,n+="<strong>TOTAL DISASTER:</strong><br>",n+="‚Ä¢ Ship completely destroyed<br>",n+="‚Ä¢ All cargo lost to the depths<br>",n+=`‚Ä¢ ${r} gold stolen<br>`,n+="‚Ä¢ You barely escape with your life<br><br>",n+="<em>You wash ashore, penniless and shipless. The pirate's laughter echoes in your ears...</em>",this.gameState.ownedShip=null):(n+="The pirates have ransacked your ship and left you broken!<br><br>",n+="<strong>Devastating Losses:</strong><br>",n+=`‚Ä¢ ${r} gold stolen<br>`,n+=`‚Ä¢ ${a} cargo units plundered<br>`,n+=`‚Ä¢ Ship condition: ${t.condition}% (severe damage)<br>`,n+="‚Ä¢ +1 Pirate reputation (marked as easy prey)<br><br>",n+='<em>"Next time bring more than words and wishes, landlubber!"</em>'),t&&t.namedCrew&&(t.namedCrew.forEach(e=>{e.loyalty=Math.max(0,e.loyalty-15)}),n+="<br><br><em>Crew morale plummets after the devastating defeat (-15 loyalty to all crew)</em>"),this.showEmergencyEvent("üíÄ Pirate Victory",n)}processMonthlyEvents(){if(this.gameState.bankAccount&&this.gameState.bankAccount.loan>0){const e=Math.floor(this.gameState.bankAccount.loan*this.gameState.bankAccount.loanInterestRate);this.gameState.bankAccount.loan+=e}if(this.gameState.bankAccount&&this.gameState.bankAccount.balance>0){const e=Math.floor(this.gameState.bankAccount.balance*this.gameState.bankAccount.depositInterestRate);this.gameState.bankAccount.balance+=e}if(this.gameState.ownedShip&&this.gameState.ownedShip.maintenanceCost){const e=this.gameState.ownedShip.maintenanceCost;if(this.characterData.stats.money-=e,this.gameState.navalCareer&&this.gameState.navalCareer.enlisted){const e=["Seaman","Able Seaman","Midshipman","Lieutenant","Commander","Captain","Admiral"],t=[10,15,20,30,45,70,100],a=Math.min(Math.floor(this.gameState.navalCareer.experience/10),e.length-1),r=t[a];this.characterData.stats.money+=r,setTimeout(()=>{this.showEmergencyEvent("‚öì Naval Salary",`<strong>Monthly pay from His Majesty's Navy</strong><br><br>Rank: ${e[a]}<br>Salary: ${r} gold<br>Total Funds: ${this.characterData.stats.money} gold<br><br><em>"Loyal service to the Crown is well rewarded."</em>`)},3e3)}setTimeout(()=>{this.showEmergencyEvent("‚öì Ship Maintenance",`<strong>Monthly ship maintenance for "${this.gameState.ownedShip.shipName}"</strong><br><br>Your ${this.gameState.ownedShip.name} requires regular maintenance to keep it in fighting condition.<br><br><strong>Maintenance Cost:</strong> ${e} gold<br><strong>Remaining Funds:</strong> ${this.characterData.stats.money} gold<br><br><em>High-end vessels require professional care and premium supplies.</em>`)},2e3)}}handleStormDamage(){if(!this.gameState.ownedShip)return;const e=this.gameState.ownedShip,t=Math.floor(3*Math.random())+1,a=15*t+Math.floor(10*Math.random());e.condition-=a,e.condition=Math.max(0,e.condition);let r=["Lightning Storm","Hurricane","Severe Gale"][t-1];this.characterData.stats.navigation+=.2;let o=`<strong>‚õàÔ∏è ${r}!</strong><br><br>`;if(o+=`Your ship "${e.shipName}" is caught in a violent storm!<br><br>`,o+="<strong>Storm Damage:</strong><br>",o+=`‚Ä¢ Ship condition: ${e.condition}% (-${a} damage)<br>`,o+="‚Ä¢ +0.2 Navigation skill (storm experience)<br><br>",0===e.condition?(o+="<em>Your ship is destroyed by the storm! You barely escape with your life...</em>",this.gameState.ownedShip=null):e.condition<30?o+="<em>Your ship is badly damaged and barely seaworthy. Find repairs immediately!</em>":o+="<em>You weather the storm, though your ship bears the scars of nature's fury.</em>",this.gameState.ownedShip&&this.gameState.ownedShip.namedCrew){const e=Math.floor(a/10);this.gameState.ownedShip.namedCrew.forEach(t=>{t.loyalty=Math.max(0,t.loyalty-e)}),e>0&&(o+=`<br><em>Crew morale drops from the dangerous conditions (-${e} loyalty)</em>`)}let n=this.checkCrewDeaths("storm",.04);const s=this.gameState.ownedShip.namedCrew&&this.gameState.ownedShip.namedCrew.some(e=>"surgeon"===e.specialty);o+=this.getDeathReport(n,"storm",s),n&&n.length>0&&(this.criticalMessageActive=!0),this.showEmergencyEvent("‚õàÔ∏è Storm at Sea!",o)}handleDiseaseOutbreak(){const e=["Scurvy","Ship Fever","Yellow Fever","Plague"],t=e[Math.floor(Math.random()*e.length)],a=Math.floor(3*Math.random())+1,r=20*a+Math.floor(30*Math.random());this.characterData.stats.money-=Math.min(r,this.characterData.stats.money);let o=`<strong>ü¶† ${t} Outbreak!</strong><br><br>`;o+="A deadly disease spreads through the port!<br><br>",1===a?(o+="<strong>Mild Outbreak:</strong><br>",o+=`‚Ä¢ Medical costs: ${r} gold<br>`,o+="‚Ä¢ You recover quickly<br><br>",o+="<em>You spend on medicine and rest, avoiding the worst effects.</em>"):2===a?(o+="<strong>Serious Outbreak:</strong><br>",o+=`‚Ä¢ Medical costs: ${r} gold<br>`,o+="‚Ä¢ Lost time recuperating<br><br>",o+="<em>You fall ill but survive with proper care and medicine.</em>",this.advanceTime(5)):(o+="<strong>Deadly Outbreak:</strong><br>",o+=`‚Ä¢ Medical costs: ${r} gold<br>`,o+="‚Ä¢ Serious health consequences<br><br>",this.characterData.stats.money<10?o+="<em>Without gold for medicine, you barely survive. This was nearly the end...</em>":o+="<em>Expensive medicine and weeks of recovery save your life.</em>",this.advanceTime(14)),this.showEmergencyEvent("ü¶† Disease Outbreak!",o)}handleMarketCrash(){const e=[{name:"Spice Market Collapse",affect:"spices"},{name:"Textile Industry Crisis",affect:"textiles"},{name:"Banking Panic",affect:"all"},{name:"War Embargo",affect:"weapons"}],t=e[Math.floor(Math.random()*e.length)],a=Math.floor(.15*this.characterData.stats.money);if(this.characterData.stats.money-=a,this.gameState.ownedShip&&this.gameState.ownedShip.cargoHold){const e=Math.floor(3*Math.random())+1;Object.keys(this.gameState.ownedShip.cargoHold).forEach(a=>{"all"!==t.affect&&a!==t.affect||(this.gameState.ownedShip.cargoHold[a]=Math.max(0,this.gameState.ownedShip.cargoHold[a]-e))})}let r=`<strong>üìâ ${t.name}!</strong><br><br>`;r+="Economic disaster strikes the trading markets!<br><br>",r+="<strong>Financial Losses:</strong><br>",r+=`‚Ä¢ ${a} gold lost in market panic<br>`,r+="‚Ä¢ Some cargo spoiled or devalued<br>",r+="‚Ä¢ Trading opportunities disrupted<br><br>",r+="<em>Markets are unpredictable - even experienced traders can lose fortunes overnight.</em>",this.showEmergencyEvent("üìâ Market Crash!",r)}handleLuckyFind(){const e=[{name:"Washed-up Treasure Chest",gold:[50,200]},{name:"Merchant's Lost Purse",gold:[20,80]},{name:"Valuable Artifact",gold:[100,300]},{name:"Royal Reward",gold:[30,150]}],t=e[Math.floor(Math.random()*e.length)],a=t.gold[0]+Math.floor(Math.random()*(t.gold[1]-t.gold[0]));this.characterData.stats.money+=a;let r=`<strong>‚ú® ${t.name}!</strong><br><br>`;r+="Fortune smiles upon you!<br><br>",r+="<strong>Lucky Discovery:</strong><br>",r+=`‚Ä¢ Found ${a} gold!<br>`,r+="‚Ä¢ No strings attached<br><br>",r+="<em>Sometimes the sea gives back what it has taken from others.</em>",this.showEmergencyEvent("‚ú® Lucky Find!",r),setTimeout(()=>this.hideEmergencyEvent(),4e3)}handlePoliticalIntrigue(){const e=["Spy Network Discovered","Royal Succession Crisis","Colonial Rebellion","Trade War Brewing"],t=e[Math.floor(Math.random()*e.length)],a=Math.floor(3*Math.random())-1;this.characterData.reputation.crown+=a;let r=`<strong>üïµÔ∏è ${t}!</strong><br><br>`;r+="Political tensions affect your standing!<br><br>",a>0?(r+="<strong>Positive Outcome:</strong><br>",r+=`‚Ä¢ +${a} Crown reputation<br>`,r+="‚Ä¢ Your loyalty is noted<br><br>",r+="<em>Your discretion and loyalty serve you well in these troubled times.</em>"):a<0?(r+="<strong>Negative Outcome:</strong><br>",r+=`‚Ä¢ ${a} Crown reputation<br>`,r+="‚Ä¢ Suspicion falls on you<br><br>",r+="<em>You find yourself on the wrong side of political maneuvering.</em>"):(r+="<strong>Neutral Outcome:</strong><br>",r+="‚Ä¢ No reputation change<br>",r+="‚Ä¢ You stay out of the affair<br><br>",r+="<em>Wisely, you avoid taking sides in dangerous political games.</em>"),this.showEmergencyEvent("üïµÔ∏è Political Intrigue!",r)}handlePressGang(){if(this.gameState.navalCareer&&this.gameState.navalCareer.enlisted){let e="<strong>‚öì Press Gang Recognition!</strong><br><br>";e+="Press gangs recognize your naval service and salute respectfully.<br><br>",e+='<em>"Carry on, sailor. The King\'s Navy respects its own."</em>',this.showEmergencyEvent("‚öì Naval Recognition!",e)}else{if(Math.random()<.3){this.gameState.navalCareer={enlisted:!0,rank:"Seaman",experience:0,missions_completed:0,prize_money:0,reputation:-1,pressed:!0},this.characterData.stats.seamanship+=.5,this.characterData.reputation.crown-=1;let e="<strong>‚öì Press Gang!</strong><br><br>";e+="Royal Navy press gangs seize you!<br><br>",e+="<strong>Forced Conscription:</strong><br>",e+="‚Ä¢ Impressed into naval service<br>",e+="‚Ä¢ Starting rank: Seaman<br>",e+="‚Ä¢ -1 Crown reputation (resentment)<br>",e+="‚Ä¢ +0.5 Seamanship (harsh training)<br><br>",e+='<em>"King\'s service awaits, willing or not!"</em>',this.showEmergencyEvent("‚öì Pressed into Service!",e)}else{const e=Math.floor(30*Math.random())+20;if(this.characterData.stats.money>=e){this.characterData.stats.money-=e;let t="<strong>‚öì Press Gang Avoided!</strong><br><br>";t+="Royal Navy press gangs try to seize you, but you escape!<br><br>",t+="<strong>Successful Evasion:</strong><br>",t+=`‚Ä¢ Bribed officials: ${e} gold<br>`,t+="‚Ä¢ Avoided forced naval service<br><br>",t+="<em>A few coins in the right hands keep you free.</em>",this.showEmergencyEvent("‚öì Press Gang Evaded!",t)}else{this.gameState.navalCareer={enlisted:!0,rank:"Seaman",experience:0,missions_completed:0,prize_money:0,reputation:-1,pressed:!0};let t="<strong>‚öì Press Gang Success!</strong><br><br>";t+="Without gold to bribe your way out, you're pressed into service!<br><br>",t+="<strong>Forced Naval Service:</strong><br>",t+=`‚Ä¢ Couldn't afford ${e} gold bribe<br>`,t+="‚Ä¢ Impressed into the Royal Navy<br><br>",t+="<em>The poor serve whether they wish it or not.</em>",this.showEmergencyEvent("‚öì Pressed into Service!",t)}}}}handleRoyalDecree(){const e=[{name:"New Trade Taxes",effect:"tax",value:50},{name:"Royal Bounty",effect:"reward",value:100},{name:"Military Conscription",effect:"military",value:0},{name:"Port Restrictions",effect:"restriction",value:0}],t=e[Math.floor(Math.random()*e.length)];let a=`<strong>üëë Royal Decree: ${t.name}!</strong><br><br>`;switch(a+="His Majesty has issued a new proclamation!<br><br>",t.effect){case"tax":this.characterData.stats.money-=t.value,a+="<strong>New Tax:</strong><br>",a+=`‚Ä¢ ${t.value} gold collected<br>`,a+="‚Ä¢ All subjects must pay<br><br>",a+='<em>"The Crown requires funds for the realm\'s defense."</em>';break;case"reward":this.characterData.stats.money+=t.value,this.characterData.reputation.crown+=1,a+="<strong>Royal Bounty:</strong><br>",a+=`‚Ä¢ ${t.value} gold awarded<br>`,a+="‚Ä¢ +1 Crown reputation<br><br>",a+='<em>"The Crown rewards loyal subjects generously."</em>';break;case"military":this.gameState.navalCareer&&this.gameState.navalCareer.enlisted?(this.characterData.stats.money+=25,a+="<strong>Military Service Bonus:</strong><br>",a+="‚Ä¢ 25 gold service bonus<br>",a+="‚Ä¢ Naval personnel rewarded<br><br>",a+='<em>"Those who serve the Crown are honored."</em>'):(a+="<strong>Conscription Call:</strong><br>",a+="‚Ä¢ Military service encouraged<br>",a+="‚Ä¢ Civilians urged to enlist<br><br>",a+='<em>"The Crown calls upon all able-bodied subjects."</em>')}this.showEmergencyEvent("üëë Royal Decree!",a)}handleNavalEmergency(){if(!this.gameState.navalCareer||!this.gameState.navalCareer.enlisted)return;const e=["Enemy Fleet Spotted","Urgent Supply Mission","Rescue Operation","Strategic Reconnaissance"],t=e[Math.floor(Math.random()*e.length)];if(Math.random()<.7){const e=Math.floor(50*Math.random())+30;this.characterData.stats.money+=e;const a=this.gameState.navalCareer.experience;this.gameState.navalCareer.experience+=2,this.checkNavalPromotion(a,this.gameState.navalCareer.experience),this.gameState.navalCareer.reputation+=1;const r=this.giveCrewExperience("combat",15);let o=`<strong>‚öì Naval Emergency: ${t}!</strong><br><br>`;o+="You respond to an urgent naval situation!<br><br>",o+="<strong>Mission Success:</strong><br>",o+=`‚Ä¢ ${e} gold reward<br>`,o+="‚Ä¢ +2 Naval experience<br>",o+="‚Ä¢ +1 Naval reputation<br><br>",r&&r.length>0&&(o+="<strong>üåü Crew Experience:</strong><br>",r.forEach(e=>{o+=`‚Ä¢ ${e}<br>`}),o+="<br>"),o+='<em>"Well done, sailor. The Navy counts on officers like you."</em>',this.showEmergencyEvent("‚öì Naval Success!",o)}else{this.gameState.navalCareer.reputation-=1;let e=`<strong>‚öì Naval Emergency: ${t}!</strong><br><br>`;e+="You respond to a naval emergency but things go poorly.<br><br>",e+="<strong>Mission Failure:</strong><br>",e+="‚Ä¢ -1 Naval reputation<br>",e+="‚Ä¢ No reward<br><br>",e+='<em>"The Navy expects better from its officers."</em>',this.showEmergencyEvent("‚öì Naval Setback!",e)}}handleShipwreckRisk(){if(!this.gameState.ownedShip)return;const e=this.gameState.ownedShip,t=e.condition<50?"high":e.condition<80?"medium":"low";let a=!1;if(a="high"===t?Math.random()<.3:"medium"===t?Math.random()<.1:Math.random()<.02,a){const t=Math.floor(.3*this.characterData.stats.money);this.characterData.stats.money=t,this.gameState.ownedShip=null;let a="<strong>üö¢üí• SHIPWRECK!</strong><br><br>";a+=`Your ship "${e.shipName}" breaks apart and sinks!<br><br>`,a+="<strong>Total Disaster:</strong><br>",a+="‚Ä¢ Ship completely lost<br>",a+="‚Ä¢ All cargo lost to the depths<br>",a+=`‚Ä¢ Most gold lost: ${this.characterData.stats.money-t} gold<br>`,a+=`‚Ä¢ You wash ashore with only ${t} gold<br><br>`,a+="<em>You barely survive, clinging to debris as your ship disappears beneath the waves...</em>",this.criticalMessageActive=!0,this.showEmergencyEvent("üö¢üí• SHIPWRECK!",a)}else{const t=Math.floor(20*Math.random())+10;e.condition-=t,e.condition=Math.max(0,e.condition),this.characterData.stats.navigation+=.3;let a="<strong>‚ö†Ô∏è Near Shipwreck!</strong><br><br>";a+=`Your ship "${e.shipName}" barely avoids disaster!<br><br>`,a+="<strong>Close Call:</strong><br>",a+=`‚Ä¢ Ship damage: -${t} condition<br>`,a+=`‚Ä¢ Current condition: ${e.condition}%<br>`,a+="‚Ä¢ +0.3 Navigation skill (experience)<br><br>",e.condition<30?a+="<em>Your ship is barely holding together! Find repairs immediately!</em>":a+="<em>Quick thinking and skilled seamanship save your vessel from destruction.</em>",this.showEmergencyEvent("‚ö†Ô∏è Shipwreck Avoided!",a)}}checkNavalPromotion(e,t){const a=["Seaman","Able Seaman","Midshipman","Lieutenant","Commander","Captain","Admiral"],r=[10,15,20,30,45,70,100],o=Math.min(Math.floor(e/10),a.length-1),n=Math.min(Math.floor(t/10),a.length-1);if(n>o){let e="<strong>üéñÔ∏è NAVAL PROMOTION!</strong><br><br>";e+=`Congratulations! You have been promoted to <strong>${a[n]}</strong>!<br><br>`,e+="<strong>New Benefits:</strong><br>",e+=`‚Ä¢ Monthly salary: ${r[n]} gold (+${r[n]-r[o]} increase)<br>`,e+=`‚Ä¢ Naval experience: ${t}<br>`,n>=2&&(e+="‚Ä¢ Access to medium-difficulty missions<br>"),n>=3&&(e+="‚Ä¢ Can command Privateer Vessels<br>"),n>=4&&(e+="‚Ä¢ Can command Ships of the Line<br>",e+="‚Ä¢ Eligible for fleet command missions<br>"),n>=5&&(e+="‚Ä¢ Can request honorable discharge with full pension<br>"),e+='<br><em>"Your dedication to His Majesty\'s service has been recognized!"</em>',setTimeout(()=>{this.showEmergencyEvent("üéñÔ∏è Naval Promotion!",e)},1e3)}}updateCharacterSheetContent(){let e=`\n        <h3>${this.characterData.name}</h3>\n        <p><strong>Background:</strong> ${this.getBackgroundName()}</p>\n        <p><strong>Traits:</strong> ${this.getTraitNames().join(", ")}</p>\n<p><strong>Age:</strong> ${this.characterData.age} years</p>\n<p><strong>Health:</strong> ${this.characterData.health}%</p>        \n        <h4>Skills:</h4>\n        <ul>\n            <li>Seamanship: ${this.characterData.stats.seamanship.toFixed(1)}</li>\n            <li>Trading: ${this.characterData.stats.trading.toFixed(1)}</li>\n            <li>Navigation: ${this.characterData.stats.navigation.toFixed(1)}</li>\n            <li>Leadership: ${this.characterData.stats.leadership.toFixed(1)}</li>\n            <li>Social: ${this.characterData.stats.social.toFixed(1)}</li>\n        </ul>\n        \n        <h4>Reputation:</h4>\n        <ul>\n            <li>Crown: ${this.characterData.reputation.crown}</li>\n            <li>Merchant: ${this.characterData.reputation.merchant}</li>\n            <li>Colonial: ${this.characterData.reputation.colonial}</li>\n            <li>Pirate: ${this.characterData.reputation.pirate}</li>\n        </ul>\n    `;if(this.gameState.ownedShip&&(e+=`\n            <h4>‚õµ Ship:</h4>\n            <ul>\n                <li><strong>Name:</strong> "${this.gameState.ownedShip.shipName}"</li>\n                <li><strong>Type:</strong> ${this.gameState.ownedShip.name}</li>\n                <li><strong>Condition:</strong> ${this.gameState.ownedShip.condition}%</li>\n                <li><strong>Location:</strong> ${this.getLocationName(this.gameState.ownedShip.location)}</li>\n                <li><strong>Cargo Capacity:</strong> ${this.gameState.ownedShip.cargo}</li>\n                <li><strong>Crew:</strong> ${this.gameState.ownedShip.crew}/${this.gameState.ownedShip.maxCrew}</li>\n            </ul>\n        `),this.gameState.navalCareer&&this.gameState.navalCareer.enlisted){const t=["Seaman","Able Seaman","Midshipman","Lieutenant","Commander","Captain","Admiral"];e+=`\n            <h4>‚öîÔ∏è Naval Career:</h4>\n            <ul>\n                <li><strong>Rank:</strong> ${t[Math.min(Math.floor(this.gameState.navalCareer.experience/10),t.length-1)]}</li>\n                <li><strong>Experience:</strong> ${this.gameState.navalCareer.experience}</li>\n                <li><strong>Missions:</strong> ${this.gameState.navalCareer.missions_completed}</li>\n                <li><strong>Prize Money:</strong> ${this.gameState.navalCareer.prize_money} gold</li>\n            </ul>\n        `}document.getElementById("characterSheetContent").innerHTML=e}getBackgroundName(){return{dockworker:"Poor Dock Worker",merchant:"Merchant's Son",noble:"Minor Noble",orphan:"Ship's Orphan"}[this.characterData.background]||"Unknown"}getTraitNames(){const e={quicklearner:"Quick Learner",bornsailor:"Born Sailor",silvertongue:"Silver Tongue",lucky:"Lucky",brave:"Brave",frugal:"Frugal"};return this.characterData.traits.map(t=>e[t]||t)}initializeTrading(){this.gameState.inventory||(this.gameState.inventory={}),this.gameState.personalInventoryLimit=5,this.marketPrices={london:{textiles:{buy:10,sell:8},tools:{buy:15,sell:12},books:{buy:5,sell:4},spices:{buy:25,sell:20},weapons:{buy:30,sell:25}},amsterdam:{textiles:{buy:12,sell:14},tools:{buy:18,sell:16},books:{buy:6,sell:7},spices:{buy:20,sell:22},weapons:{buy:35,sell:30}},lisbon:{textiles:{buy:14,sell:16},tools:{buy:20,sell:18},books:{buy:4,sell:5},spices:{buy:15,sell:18},weapons:{buy:25,sell:28}},bristol:{textiles:{buy:8,sell:10},tools:{buy:12,sell:14},books:{buy:7,sell:6},spices:{buy:30,sell:25},weapons:{buy:28,sell:26}}},this.goodsInfo={textiles:{name:"Textiles",description:"Fine cloth and fabrics"},tools:{name:"Tools",description:"Quality iron implements"},books:{name:"Books",description:"Literature and knowledge"},spices:{name:"Spices",description:"Exotic seasonings"},weapons:{name:"Weapons",description:"Swords and firearms"}}}getPersonalInventoryCount(){return Object.values(this.gameState.inventory).reduce((e,t)=>e+t,0)}getShipCargoCount(){return this.gameState.ownedShip&&this.gameState.ownedShip.cargoHold?Object.values(this.gameState.ownedShip.cargoHold).reduce((e,t)=>e+t,0):0}buyGoodToInventory(e,t){const a=document.getElementById(`qty_${e}`),r=parseInt(a.value)||1,o=t*r,n=this.getPersonalInventoryCount();if(n+r>this.gameState.personalInventoryLimit)alert(`You can only carry ${this.gameState.personalInventoryLimit} items total. You have ${n} items.`);else if(this.characterData.stats.money>=o){this.characterData.stats.money-=o,this.gameState.inventory[e]||(this.gameState.inventory[e]=0),this.gameState.inventory[e]+=r,this.characterData.stats.trading+=.1*r;const t=this.goodsInfo[e].name;this.showActivityResult("üéí Purchased to Inventory",`You bought ${r} ${t} for ${o} gold and stored them in your personal inventory.<br><br><em>+${(.1*r).toFixed(1)} Trading skill</em>`),setTimeout(()=>{this.visitMarket()},1500)}}buyGoodToShip(e,t){const a=document.getElementById(`qty_${e}`),r=parseInt(a.value)||1,o=t*r,n=this.getShipCargoCount(),s=this.getShipCargoCapacity();if(n+r>s)alert(`Your ship can only hold ${s} items total. It currently has ${n} items.`);else if(this.characterData.stats.money>=o){this.characterData.stats.money-=o,this.gameState.ownedShip.cargoHold||(this.gameState.ownedShip.cargoHold={}),this.gameState.ownedShip.cargoHold[e]||(this.gameState.ownedShip.cargoHold[e]=0),this.gameState.ownedShip.cargoHold[e]+=r,this.characterData.stats.trading+=.1*r;const t=this.goodsInfo[e].name;this.showActivityResult("üö¢ Loaded to Ship",`You bought ${r} ${t} for ${o} gold and loaded them onto your ship.<br><br><em>+${(.1*r).toFixed(1)} Trading skill</em>`),setTimeout(()=>{this.visitMarket()},1500)}}sellGood(e,t,a){"personal"===a?this.gameState.inventory[e]>0&&(this.gameState.inventory[e]--,this.characterData.stats.money+=t,0===this.gameState.inventory[e]&&delete this.gameState.inventory[e]):"ship"===a&&this.gameState.ownedShip.cargoHold[e]>0&&(this.gameState.ownedShip.cargoHold[e]--,this.characterData.stats.money+=t,0===this.gameState.ownedShip.cargoHold[e]&&delete this.gameState.ownedShip.cargoHold[e]),this.characterData.stats.trading+=.05,setTimeout(()=>{this.visitMarket()},1e3)}sellAllGood(e,t,a){let r=0;"personal"===a?(r=this.gameState.inventory[e]||0,r>0&&delete this.gameState.inventory[e]):"ship"===a&&(r=this.gameState.ownedShip.cargoHold[e]||0,r>0&&delete this.gameState.ownedShip.cargoHold[e]);const o=r*t;this.characterData.stats.money+=o,this.characterData.stats.trading+=.05*r;const n=this.goodsInfo[e].name;this.showActivityResult("üí∞ Bulk Sale Complete",`You sold ${r} ${n} for ${o} gold total.<br><br><em>+${(.05*r).toFixed(2)} Trading skill</em>`),setTimeout(()=>{this.visitMarket()},1500)}loadGameState(){console.log("Loading saved game...")}buyShip(e,t){console.log("buyShip called with:",e,t,"Player money:",this.characterData.stats.money,"Has ship:",this.gameState.ownedShip);const a={rowboat:{id:"rowboat",name:"Rowing Boat",cargo:2,crew:1,maxCrew:1,baseCombat:5,baseDefense:5,baseSpeed:15},sloop:{id:"sloop",name:"Sloop",cargo:10,crew:3,maxCrew:4,baseCombat:12,baseDefense:8,baseSpeed:18},brigantine:{id:"brigantine",name:"Brigantine",cargo:25,crew:8,maxCrew:12,baseCombat:20,baseDefense:15,baseSpeed:12},racing_schooner:{id:"racing_schooner",name:"Racing Schooner",cargo:8,crew:2,maxCrew:3,baseCombat:8,baseDefense:6,baseSpeed:25,specialAbility:"speed_demon"},dutch_fluyt:{id:"dutch_fluyt",name:"Dutch Fluyt",cargo:40,crew:6,maxCrew:8,baseCombat:8,baseDefense:10,baseSpeed:10,specialAbility:"cargo_master"},fast_frigate:{id:"fast_frigate",name:"Fast Frigate",cargo:15,crew:12,maxCrew:16,baseCombat:25,baseDefense:18,baseSpeed:22,specialAbility:"pirate_hunter",maintenanceCost:20},explorer_bark:{id:"explorer_bark",name:"Explorer's Bark",cargo:20,crew:10,maxCrew:14,baseCombat:15,baseDefense:20,baseSpeed:16,specialAbility:"exploration_master"},privateer_vessel:{id:"privateer_vessel",name:"Privateer Vessel",cargo:18,crew:15,maxCrew:20,baseCombat:30,baseDefense:22,baseSpeed:20,specialAbility:"privateer",requiresNavalRank:2,maintenanceCost:30},treasure_galleon:{id:"treasure_galleon",name:"Treasure Galleon",cargo:60,crew:25,maxCrew:35,baseCombat:28,baseDefense:25,baseSpeed:8,specialAbility:"treasure_ship",maintenanceCost:40},ship_of_line:{id:"ship_of_line",name:"Ship of the Line",cargo:30,crew:40,maxCrew:50,baseCombat:50,baseDefense:40,baseSpeed:6,specialAbility:"battle_fortress",requiresNavalRank:4,maintenanceCost:50}};if(this.characterData.stats.money>=t&&!this.gameState.ownedShip){if(a[e].requiresNavalRank){const t=a[e].requiresNavalRank,r=this.gameState.navalCareer,o=r&&r.enlisted?Math.min(Math.floor(r.experience/10),6):-1;if(o<t){const e=["Seaman","Able Seaman","Midshipman","Lieutenant","Commander","Captain","Admiral"];return void this.showActivityResult("‚öîÔ∏è Naval Rank Required",`This military vessel requires naval rank of ${e[t]} or higher.<br><br>Your current naval status: ${r&&r.enlisted?e[o]:"Civilian"}`)}}this.characterData.stats.money-=t;const r=prompt(`Name your new ${a[e].name}:`,`HMS ${this.characterData.name}'s Pride`),o=r&&r.trim()?r.trim():`HMS ${this.characterData.name}'s Pride`;this.gameState.ownedShip={...a[e],shipName:o,condition:100,location:this.gameState.currentLocation,cargoHold:{},namedCrew:[],upgrades:{cannons:0,armor:0,speed:0,storage:0},baseStats:{combat:a[e].baseCombat||10,defense:a[e].baseDefense||10,speed:a[e].baseSpeed||10,cargo:a[e].cargo}},this.showActivityResult("üéâ Ship Purchased!",`Congratulations! You are now the proud owner of "${this.gameState.ownedShip.shipName}"!<br><br>Ship Type: ${a[e].name}<br>Your ship is docked at the harbor, ready for trade and adventure.<br><br><strong>What changes:</strong><br>‚Ä¢ Faster travel (if you're at the same port as your ship)<br>‚Ä¢ Cargo space for bulk trading<br>‚Ä¢ Ability to hire crew<br>‚Ä¢ Access to more dangerous but profitable routes<br><br><em>+1 Social reputation (ship owners are respected!)</em>`),this.characterData.reputation.merchant+=1,setTimeout(()=>{this.visitShipyard()},3e3)}}calculateShipSellPrice(e){const t={"Rowing Boat":50,Sloop:500,"Racing Schooner":800,"Dutch Fluyt":1200,"Fast Frigate":1500,Brigantine:2e3,"Explorer's Bark":2500,"Privateer Vessel":3e3,"Treasure Galleon":4e3,"Ship of the Line":8e3}[e.name]||1e3;let a=Math.floor(.6*t);const r=e.condition/100;if(a=Math.floor(a*r),e.upgrades){a+=50*e.upgrades.cannons+40*e.upgrades.armor+30*e.upgrades.speed}return Math.max(10,a)}sellShip(e){const t=this.gameState.ownedShip;if(t.cargoHold&&Object.keys(t.cargoHold).length>0)return void this.showActivityResult("‚ö†Ô∏è Cannot Sell Ship","You cannot sell your ship while it has cargo aboard!<br><br><strong>Please first:</strong><br>‚Ä¢ Unload all cargo<br><br><em>The shipyard won't accept a ship with goods still aboard.</em>");const a=t.namedCrew?t.namedCrew.length:0;let r=`Are you sure you want to sell "${t.shipName}" for ${e} gold?`;if(a>0&&(r+=`\n\nYour ${a} crew members will be transferred to your crew roster and available for your next ship.`),confirm(r)){this.gameState.availableCrew||(this.gameState.availableCrew=[]),t.namedCrew&&t.namedCrew.length>0&&t.namedCrew.forEach(e=>{e.status="available",this.gameState.availableCrew.push(e)}),this.characterData.stats.money+=e,this.gameState.ownedShip=null;let r=`You have sold "${t.shipName}" for ${e} gold.<br><br><strong>Sale Complete:</strong><br>‚Ä¢ Received: ${e} gold<br>‚Ä¢ Current funds: ${this.characterData.stats.money} gold<br>`;a>0&&(r+=`‚Ä¢ ${a} crew members added to your roster<br>`),r+="<br><em>You are now without a ship. Your former crew will be available when you purchase a new vessel.</em>",this.showActivityResult("üí∞ Ship Sold!",r),setTimeout(()=>{this.visitShipyard()},3e3)}}manageShip(){const e=this.gameState.ownedShip;let t=`<strong>üö¢ Managing: "${e.shipName}"</strong><br><br>`;if(t+="<strong>Ship Status:</strong><br>",t+=`Location: ${this.getLocationName(e.location)}<br>`,t+=`Condition: ${e.condition}%<br>`,t+=`Crew: ${e.crew}/${e.maxCrew}<br>`,t+=`Cargo: ${this.getCargoAmount()}/${this.getShipCargoCapacity()}<br><br>`,e.condition<30&&e.namedCrew&&e.namedCrew.length>0&&(t+='<div style="background: #ffebee; border: 2px solid #f44336; padding: 10px; margin: 10px 0; border-radius: 8px;">',t+="<strong>‚ö†Ô∏è CREW MORALE WARNING!</strong><br>",t+="Your crew is losing loyalty due to the ship's terrible condition!<br>",t+="<em>(-1 loyalty per day until repairs are made)</em>",t+="</div>"),e.location===this.gameState.currentLocation){if(t+="<strong>Available Actions:</strong><br>",e.condition<100){const a=Math.floor(2*(100-e.condition));t+=(this.characterData.stats.money>=a?`<button onclick="game.repairShip(${a})">Repair Ship (${a} gold)</button>`:`<button disabled>Repair Ship (${a} gold)</button>`)+"<br>"}t+='<button onclick="game.loadCargo()">Load/Unload Cargo</button><br>',t+='<button onclick="game.hireCrew()">Manage Crew</button><br>',t+='<button onclick="game.upgradeShip()">Upgrade Ship</button><br>',t+='<button onclick="game.sailWithShip()">Sail to Another Port</button><br>'}else t+=`<em>Your ship is docked in ${this.getLocationName(e.location)}. Travel there to manage it.</em>`;this.showActivityResult("üö¢ Ship Management",t)}getCargoAmount(){const e=this.gameState.ownedShip.cargoHold;return Object.values(e).reduce((e,t)=>e+t,0)}getShipCargoCapacity(){const e=this.gameState.ownedShip;if(!e)return 0;let t=e.cargo;return"cargo_master"===e.specialAbility&&(t+=15),e.upgrades&&e.upgrades.storage&&(t+=5*e.upgrades.storage),t}repairShip(e){this.characterData.stats.money-=e,this.gameState.ownedShip.condition=100;const t=this.giveCrewExperience("repair",20);let a=`"${this.gameState.ownedShip.shipName}" has been fully repaired and is seaworthy once again!<br><br>Cost: ${e} gold`;t&&t.length>0&&(a+="<br><br><strong>üåü Crew Experience:</strong><br>",t.forEach(e=>{a+=`‚Ä¢ ${e}<br>`})),this.showActivityResult("üîß Ship Repaired",a),setTimeout(()=>{this.manageShip()},2e3)}loadCargo(){const e=this.gameState.ownedShip,t=this.getPersonalInventoryCount(),a=this.getShipCargoCount();let r=`<strong>üì¶ Cargo Transfer - "${this.gameState.ownedShip.shipName}"</strong><br><br>`;r+='<div style="background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px;">';const o=this.getShipCargoCapacity();r+=`<strong>Capacity:</strong> Personal ${t}/${this.gameState.personalInventoryLimit} | Ship ${a}/${o}`,r+="</div>",r+='<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">',r+="<div><h4>üì§ Load onto Ship</h4>";const n=Object.keys(this.gameState.inventory).length>0;n&&a<e.cargo?Object.keys(this.gameState.inventory).forEach(e=>{const t=this.gameState.inventory[e],n=this.goodsInfo[e].name;if(t>0){const s=Math.min(t,o-a);r+=`<div style="border: 1px solid #ccc; padding: 8px; margin: 5px 0;">\n                    <strong>${n}</strong> (Have: ${t})<br>\n                    <input type="number" id="transfer_to_ship_${e}" min="1" max="${s}" value="1" style="width: 60px; margin: 5px;">\n                    <button onclick="game.transferToShip('${e}')">Load</button>\n                </div>`}}):r+=n?"<p><em>Ship cargo hold is full.</em></p>":"<p><em>No personal goods to transfer.</em></p>",r+="</div>",r+="<div><h4>üì• Unload from Ship</h4>";const s=e.cargoHold&&Object.keys(e.cargoHold).length>0;s&&t<this.gameState.personalInventoryLimit?Object.keys(e.cargoHold).forEach(a=>{const o=e.cargoHold[a],n=this.goodsInfo[a].name;if(o>0){const e=Math.min(o,this.gameState.personalInventoryLimit-t);r+=`<div style="border: 1px solid #ccc; padding: 8px; margin: 5px 0;">\n                    <strong>${n}</strong> (Ship has: ${o})<br>\n                    <input type="number" id="transfer_from_ship_${a}" min="1" max="${e}" value="1" style="width: 60px; margin: 5px;">\n                    <button onclick="game.transferFromShip('${a}')">Unload</button>\n                </div>`}}):r+=s?"<p><em>Your personal inventory is full.</em></p>":"<p><em>No ship cargo to unload.</em></p>",r+="</div></div>",this.showActivityResult("üì¶ Cargo Management",r)}transferToShip(e){const t=document.getElementById(`transfer_to_ship_${e}`),a=parseInt(t.value)||1;if(this.gameState.inventory[e]>=a){this.gameState.inventory[e]-=a,0===this.gameState.inventory[e]&&delete this.gameState.inventory[e],this.gameState.ownedShip.cargoHold||(this.gameState.ownedShip.cargoHold={}),this.gameState.ownedShip.cargoHold[e]||(this.gameState.ownedShip.cargoHold[e]=0),this.gameState.ownedShip.cargoHold[e]+=a;const t=this.goodsInfo[e].name;this.showActivityResult("üì§ Cargo Loaded",`Transferred ${a} ${t} to your ship's cargo hold.`),setTimeout(()=>{this.loadCargo()},1500)}}transferFromShip(e){const t=document.getElementById(`transfer_from_ship_${e}`),a=parseInt(t.value)||1;if(this.gameState.ownedShip.cargoHold[e]>=a){this.gameState.ownedShip.cargoHold[e]-=a,0===this.gameState.ownedShip.cargoHold[e]&&delete this.gameState.ownedShip.cargoHold[e],this.gameState.inventory[e]||(this.gameState.inventory[e]=0),this.gameState.inventory[e]+=a;const t=this.goodsInfo[e].name;this.showActivityResult("üì• Cargo Unloaded",`Transferred ${a} ${t} to your personal inventory.`),setTimeout(()=>{this.loadCargo()},1500)}}hireCrew(){const e=this.gameState.ownedShip,t=e.maxCrew-e.crew;let a=`<strong>üë• Crew Management - "${e.shipName}"</strong><br><br>`;if(a+=`<strong>Current Crew:</strong> ${e.crew}/${e.maxCrew}<br><br>`,e.namedCrew&&e.namedCrew.length>0&&(a+="<strong>üåü Current Crew Members:</strong><br>",e.namedCrew.forEach(e=>{const t="‚òÖ".repeat(e.level);a+=`<div style="border: 1px solid #ccc; padding: 8px; margin: 5px 0; border-radius: 5px;">\n                <strong>${e.name}</strong> ${t}<br>\n                <em>${e.specialty.toUpperCase()}</em> | ${e.personality.trait} ${e.personality.background}<br>\n                Loyalty: ${e.loyalty}% | Experience: ${e.experience}<br>\n                <button onclick="game.viewCrewDetails('${e.name}')">View Details</button>\n            </div>`}),a+="<br>"),t>0){a+="<strong>üÜï Hire Crew:</strong><br>",a+=`Available positions: ${t}<br><br>`,this.gameState.availableCrew&&this.gameState.availableCrew.length>0&&(a+="<strong>üë• Your Former Crew (Free to rehire):</strong><br>",this.gameState.availableCrew.forEach((e,t)=>{const r="‚òÖ".repeat(e.level);a+=`<div style="border: 2px solid #28a745; padding: 10px; margin: 5px 0; border-radius: 5px; background: #f8fff8;">\n                <strong>${e.name}</strong> ${r}<br>\n                <em>${e.specialty.toUpperCase()}</em> | ${e.personality.trait} ${e.personality.background}<br>\n                Loyalty: ${e.loyalty}% | Experience: ${e.experience}<br>\n                <button onclick="game.rehireFormerCrew(${t})">Rehire ${e.name} (FREE)</button>\n            </div>`}),a+="<br>");const e=[];for(let a=0;a<Math.min(3,t+2);a++)e.push(this.generateCrewMember());e.forEach((e,t)=>{const r=20+5*e.level,o=this.characterData.stats.money>=r;let n="";Object.keys(e.skills).forEach(t=>{e.skills[t]>1&&(n+=`${t}: ${e.skills[t]} `)});const s=o?`<button onclick="game.hireNamedCrew(${t})">Hire (${r} gold)</button>`:`<button disabled>Hire (${r} gold)</button>`;a+=`<div style="border: 1px solid #28a745; padding: 10px; margin: 5px 0; border-radius: 5px;">\n                <strong>${e.name}</strong><br>\n                <em>${e.specialty.toUpperCase()}</em> | ${e.personality.trait} ${e.personality.background}<br>\n                <strong>Skills:</strong> ${n}<br>\n                Loyalty: ${e.loyalty}%<br>\n                ${s}\n            </div>`}),this.availableCrewForHire=e}else a+="<em>Your ship is at maximum crew capacity.</em><br><br>";this.showActivityResult("üë• Crew Management",a)}hireNamedCrew(e){const t=this.availableCrewForHire[e],a=20+5*t.level;this.characterData.stats.money>=a&&this.gameState.ownedShip.crew<this.gameState.ownedShip.maxCrew&&(this.characterData.stats.money-=a,this.gameState.ownedShip.crew++,this.gameState.ownedShip.namedCrew||(this.gameState.ownedShip.namedCrew=[]),this.gameState.ownedShip.namedCrew.push(t),this.showActivityResult("üéâ Crew Member Hired!",`Welcome aboard, ${t.name}!<br><br><strong>New Crew Member:</strong><br>‚Ä¢ Specialty: ${t.specialty.toUpperCase()}<br>‚Ä¢ Personality: ${t.personality.trait} ${t.personality.background}<br>‚Ä¢ Starting Loyalty: ${t.loyalty}%<br><br><em>"${this.getHiringQuote(t)}"</em>`),setTimeout(()=>{this.hireCrew()},3e3))}rehireFormerCrew(e){const t=this.gameState.availableCrew[e],a=this.gameState.ownedShip;a.crew<a.maxCrew&&(this.gameState.availableCrew.splice(e,1),a.crew++,a.namedCrew||(a.namedCrew=[]),a.namedCrew.push(t),this.showActivityResult("üéâ Crew Member Rehired!",`Welcome back, ${t.name}!<br><br><strong>Returning Crew Member:</strong><br>‚Ä¢ No hiring cost for former crew<br>‚Ä¢ All experience and skills retained<br>‚Ä¢ Loyalty: ${t.loyalty}%<br><br><em>"Good to be back aboard, Captain!"</em>`),setTimeout(()=>{this.hireCrew()},2500))}getShipSpecialAbility(){const e=this.gameState.ownedShip;return e?e.specialAbility:null}applyShipSpecialBonuses(e,t){const a=this.getShipSpecialAbility();if(!a)return e;switch(a){case"speed_demon":if("escape_chance"===t)return 1.8*e;if("travel_speed"===t)return Math.max(1,e-1);break;case"cargo_master":if("crew_wages"===t)return.5*e;break;case"pirate_hunter":if("pirate_bounty"===t)return 2*e;if("combat_vs_pirates"===t)return 1.3*e;break;case"exploration_master":if("expedition_success"===t)return 1.5*e;break;case"privateer":if("pirate_bounty"===t)return 2*e;if("crown_reputation"===t)return 1.5*e;break;case"treasure_ship":if("pirate_attraction"===t)return 2.5*e;break;case"battle_fortress":if("combat_power"===t)return 1.5*e;if("intimidation"===t)return 3*e}return e}getHiringQuote(e){const t={gunner:["Aye Captain, these cannons will sing under my care!","I'll make every shot count, sir!"],navigator:["I know these waters like the back of my hand, Captain.","Trust me to guide us true, sir."],cook:["The crew will eat well with me in the galley, Captain!","A well-fed crew is a loyal crew, sir!"],bosun:["I'll keep the crew in line and the ship shipshape!","Discipline and seamanship, that's my way!"],surgeon:["I'll keep the crew healthy and patch up battle wounds.","Medicine and surgery, at your service!"],carpenter:["This ship will stay afloat as long as I draw breath!","I'll keep her timbers strong, Captain!"]}[e.specialty]||["Ready to serve, Captain!"];return t[Math.floor(Math.random()*t.length)]}viewCrewDetails(e){const t=this.gameState.ownedShip.namedCrew.find(t=>t.name===e);if(!t)return;const a="‚òÖ".repeat(t.level),r=this.getExpForNextLevel(t.level)-t.experience,o=this.getTimeServed(t.joinedDate);let n=`<strong>üìã ${t.name} ${a}</strong><br><br>`;n+='<div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px;">',n+=`<strong>Specialty:</strong> ${t.specialty.toUpperCase()}<br>`,n+=`<strong>Level:</strong> ${t.level}/5<br>`,n+=`<strong>Experience:</strong> ${t.experience} (${r} to next level)<br>`,n+=`<strong>Loyalty:</strong> ${t.loyalty}%<br>`,n+=`<strong>Time Served:</strong> ${o}<br>`,n+="</div>",n+="<strong>üìà Skills:</strong><br>",Object.keys(t.skills).forEach(e=>{const a=t.skills[e],r="‚óè".repeat(a)+"‚óã".repeat(5-a);n+=`${e.toUpperCase()}: ${r} (${a}/5)<br>`}),n+="<br><strong>üé≠ Personality:</strong><br>",n+=`${t.personality.trait} ${t.personality.background}<br><br>`,t.achievements&&t.achievements.length>0&&(n+="<strong>üèÜ Recent Achievements:</strong><br>",t.achievements.slice(-3).forEach(e=>{n+=`‚Ä¢ ${e}<br>`})),n+='<br><div style="border: 2px solid #dc3545; padding: 10px; margin: 10px 0; border-radius: 8px; background: #ffebee;">',n+="<strong>‚ö†Ô∏è Crew Management</strong><br>",n+=`<button onclick="game.fireCrewMember('${t.name}')" style="background: #dc3545; color: white;">Fire ${t.name}</button>`,n+="<br><small><em>Warning: Firing crew members may anger the remaining crew</em></small>",n+="</div>",this.showActivityResult("üìã Crew Details",n)}getExpForNextLevel(e){return[0,100,250,500,1e3,2e3][e]||2e3}getTimeServed(e){const t=12*(this.gameState.year-e.year)+(this.gameState.month-e.month);if(t<1)return"New recruit";if(t<6)return`${t} months`;if(t<12)return"Half a year";const a=Math.floor(t/12),r=t%12;return 1===a?"1 year":`${a} years${r>0?`, ${r} months`:""}`}getCrewCombatBonus(){const e=this.gameState.ownedShip;if(!e||!e.namedCrew)return 0;let t=0;e.namedCrew.forEach(e=>{"gunner"===e.specialty&&(t+=3*e.skills.gunnery),"bosun"===e.specialty&&(t+=1.5*e.skills.seamanship)});let a=0;const r=this.getShipSpecialAbility();return"battle_fortress"===r?a+=15:"pirate_hunter"!==r&&"privateer"!==r||(a+=8),Math.floor(t+a)}getCrewNavigationBonus(){const e=this.gameState.ownedShip;if(!e||!e.namedCrew)return{timeReduction:0,damageReduction:0};let t=0,a=0;return e.namedCrew.forEach(e=>{"navigator"===e.specialty&&(t+=.1*e.skills.navigation,a+=.05*e.skills.navigation)}),{timeReduction:Math.min(t,.5),damageReduction:Math.min(a,.3)}}getCrewRepairBonus(){const e=this.gameState.ownedShip;if(!e||!e.namedCrew)return 0;let t=0;return e.namedCrew.forEach(e=>{"carpenter"===e.specialty&&(t+=.5*e.skills.repair)}),t}getCrewLoyaltyBonus(){const e=this.gameState.ownedShip;if(!e||!e.namedCrew||0===e.namedCrew.length)return 1;return.7+e.namedCrew.reduce((e,t)=>e+t.loyalty,0)/e.namedCrew.length/100*.4}checkCrewLoyaltyEvents(){const e=this.gameState.ownedShip;if(!e.namedCrew||0===e.namedCrew.length)return;const t=e.namedCrew.reduce((e,t)=>e+t.loyalty,0)/e.namedCrew.length;t<30&&Math.random()<.05?this.handleMutinyEvent():t<50&&Math.random()<.03?this.handleCrewDemands():e.namedCrew.forEach((e,t)=>{e.loyalty<25&&Math.random()<.02&&this.handleCrewAbandon(e,t)})}handleMutinyEvent(){const e=this.gameState.ownedShip,t=e.namedCrew.reduce((e,t)=>t.loyalty<e.loyalty?t:e);let a=`<strong>üè¥‚Äç‚ò†Ô∏è MUTINY ABOARD "${e.shipName}"!</strong><br><br>`;a+=`${t.name} leads a mutiny against your command!<br><br>`,a+='"We\'ve had enough of your leadership, Captain! Stand down or face the consequences!"<br><br>',a+="<strong>Choose your response:</strong><br><br>",a+='<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>‚öîÔ∏è FIGHT THE MUTINY</strong><br>",a+="Stand your ground and fight to regain control!<br>",a+="<em>Risk: Crew casualties, ship damage</em><br>",a+="<button onclick=\"game.resolveMutiny('fight')\">Fight for Command!</button>",a+="</div>",a+='<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>ü§ù NEGOTIATE</strong><br>",a+="Try to talk down the mutineers and address their grievances.<br>",a+="<em>Cost: Gold to improve conditions</em><br>",a+="<button onclick=\"game.resolveMutiny('negotiate')\">Hear Their Demands</button>",a+="</div>",this.characterData.stats.money>200&&(a+='<div style="border: 2px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px;">',a+="<strong>üè≥Ô∏è ABANDON SHIP</strong><br>",a+="Take what you can and abandon the ship to the mutineers.<br>",a+="<em>Lose ship but keep most of your gold</em><br>",a+="<button onclick=\"game.resolveMutiny('abandon')\">Abandon Ship</button>",a+="</div>"),this.criticalMessageActive=!0,this.showEmergencyEvent("üè¥‚Äç‚ò†Ô∏è Mutiny!",a)}handleCrewDemands(){const e=this.gameState.ownedShip,t=Math.floor(50*Math.random())+30;let a=`<strong>üò† Crew Unrest aboard "${e.shipName}"</strong><br><br>`;a+="Your crew is unhappy and making demands!<br><br>",a+='"Captain, we need better conditions! Better food, better pay, or we might start looking for a new ship!"<br><br>',a+="<strong>Their demands:</strong><br>",a+=`‚Ä¢ ${t} gold for improved provisions<br>`,a+="‚Ä¢ Promise of better treatment<br><br>";a+=this.characterData.stats.money>=t?`<button onclick="game.resolveCrewDemands(${t}, true)">Pay ${t} gold (Crew +15 Loyalty)</button><br>`:`<button disabled>Pay ${t} gold (You don't have enough!)</button><br>`,a+=`<button onclick="game.resolveCrewDemands(${t}, false)">Refuse Their Demands</button>`,this.showEmergencyEvent("üò† Crew Demands",a)}handleCrewAbandon(e,t){const a=this.gameState.ownedShip;a.namedCrew.splice(t,1),a.crew--,this.showEmergencyEvent("üö™ Crew Member Leaves",`<strong>${e.name} has abandoned ship!</strong><br><br>"I can't serve under these conditions anymore, Captain. I'm finding another ship."<br><br><strong>Consequences:</strong><br>‚Ä¢ Lost: ${e.name} (${e.specialty})<br>‚Ä¢ Crew count: ${a.crew}/${a.maxCrew}<br>‚Ä¢ Other crew members are concerned (-5 loyalty to all)<br><br><em>Low loyalty is driving away your experienced sailors...</em>`),a.namedCrew.forEach(e=>{e.loyalty=Math.max(0,e.loyalty-5)})}resolveMutiny(e){const t=this.gameState.ownedShip;if("fight"===e){if(Math.random()<.5+.1*this.characterData.stats.leadership){const e=Math.floor(2*Math.random())+1;t.crew=Math.max(1,t.crew-e),t.namedCrew=t.namedCrew.slice(e),t.condition-=Math.floor(15*Math.random())+10,t.namedCrew.forEach(e=>{e.loyalty=Math.min(100,e.loyalty+20)}),this.showEmergencyEvent("‚öîÔ∏è Mutiny Crushed!",`You successfully crush the mutiny through force!<br><br><strong>Consequences:</strong><br>‚Ä¢ ${e} mutineers killed or marooned<br>‚Ä¢ Ship damaged in the fighting (-${Math.floor(15*Math.random())+10} condition)<br>‚Ä¢ Surviving crew respects your strength (+20 loyalty)<br>‚Ä¢ Your reputation for harsh discipline spreads<br><br><em>"Let this be a lesson to anyone who questions my command!"</em>`),this.characterData.reputation.pirate+=1,this.characterData.stats.leadership+=.3}else{const e=Math.floor(.7*this.characterData.stats.money);this.characterData.stats.money-=e,this.gameState.ownedShip=null,this.showEmergencyEvent("üíÄ Mutiny Successful!",`The mutineers overpower you and seize control of the ship!<br><br><strong>Devastating Loss:</strong><br>‚Ä¢ Ship "${t.shipName}" seized by mutineers<br>‚Ä¢ ${e} gold stolen<br>‚Ä¢ You barely escape with your life<br>‚Ä¢ Marooned at the nearest port<br><br><em>"You should have treated us better, Captain. Now the ship is ours!"</em>`),this.characterData.reputation.merchant-=2}}else if("negotiate"===e){const e=Math.floor(100*Math.random())+80;this.characterData.stats.money>=e?(this.characterData.stats.money-=e,t.namedCrew.forEach(e=>{e.loyalty=Math.min(100,e.loyalty+25)}),this.showEmergencyEvent("ü§ù Mutiny Resolved!",`You successfully negotiate with the mutineers!<br><br><strong>Agreement Reached:</strong><br>‚Ä¢ Paid ${e} gold for better conditions<br>‚Ä¢ All crew loyalty restored (+25 to all)<br>‚Ä¢ Ship upgrades and better provisions<br>‚Ä¢ Your leadership skills improve<br><br><em>"We're glad you listened to our concerns, Captain. We'll serve you loyally."</em>`),this.characterData.stats.social+=.5,this.characterData.stats.leadership+=.3):(this.showEmergencyEvent("üí∏ Negotiation Failed!","You don't have enough gold to meet their demands!<br><br>\"If you can't provide for us, then you're not fit to be captain!\"<br><br><em>The mutiny escalates...</em>"),setTimeout(()=>{this.resolveMutiny("fight")},3e3))}else if("abandon"===e){const e=Math.floor(.8*this.characterData.stats.money);this.characterData.stats.money=e,this.gameState.ownedShip=null,this.showEmergencyEvent("üè≥Ô∏è Ship Abandoned!",`You wisely abandon the ship to the mutineers and escape!<br><br><strong>Strategic Retreat:</strong><br>‚Ä¢ Lost ship "${t.shipName}" to mutineers<br>‚Ä¢ Saved ${e} gold (80% of your wealth)<br>‚Ä¢ No casualties or violence<br>‚Ä¢ Live to sail another day<br><br><em>"Sometimes the wise captain knows when to cut losses."</em>`),this.characterData.stats.social+=.2}this.hideEmergencyEvent()}resolveCrewDemands(e,t){const a=this.gameState.ownedShip;t?(this.characterData.stats.money-=e,a.namedCrew.forEach(e=>{e.loyalty=Math.min(100,e.loyalty+15)}),this.showEmergencyEvent("‚úÖ Crew Satisfied!",`You meet your crew's demands and they're happy!<br><br><strong>Investment in Crew:</strong><br>‚Ä¢ Paid ${e} gold for better conditions<br>‚Ä¢ All crew loyalty increased (+15)<br>‚Ä¢ Improved morale and performance<br><br><em>"Thank you Captain! We'll serve you well!"</em>`)):(a.namedCrew.forEach(e=>{e.loyalty=Math.max(0,e.loyalty-10)}),this.showEmergencyEvent("üò† Crew Angry!","You refuse your crew's demands and they're furious!<br><br><strong>Consequences:</strong><br>‚Ä¢ All crew loyalty decreased (-10)<br>‚Ä¢ Risk of future unrest increases<br>‚Ä¢ Crew performance will suffer<br><br><em>\"Fine Captain, but don't expect us to be happy about it!\"</em>")),this.hideEmergencyEvent()}fireCrewMember(e){const t=this.gameState.ownedShip,a=t.namedCrew.findIndex(t=>t.name===e);if(-1===a)return;const r=t.namedCrew[a];t.namedCrew.splice(a,1),t.crew--;let o=0;o=r.loyalty>70?-8:r.loyalty<30?3:-3,t.namedCrew.forEach(e=>{e.loyalty=Math.max(0,Math.min(100,e.loyalty+o))});let n=`<strong>${r.name} has been dismissed from service!</strong><br><br>`;n+='"I understand, Captain. I\'ll find another ship."<br><br>',n+="<strong>Consequences:</strong><br>",n+=`‚Ä¢ Lost: ${r.name} (${r.specialty})<br>`,n+=`‚Ä¢ Crew count: ${t.crew}/${t.maxCrew}<br>`,o>0?(n+=`‚Ä¢ Remaining crew approves (+${o} loyalty)<br>`,n+='<em>"Good riddance! That one was nothing but trouble."</em>'):o<0?(n+=`‚Ä¢ Remaining crew disapproves (${o} loyalty)<br>`,n+=`<em>"Poor ${r.name}... we could be next."</em>`):n+="‚Ä¢ Remaining crew has mixed feelings<br>",this.showActivityResult("üö™ Crew Dismissed",n)}checkCrewDeaths(e,t){const a=this.gameState.ownedShip;if(!a||!a.namedCrew||0===a.namedCrew.length)return[];const r=a.namedCrew.some(e=>"surgeon"===e.specialty),o=r?a.namedCrew.find(e=>"surgeon"===e.specialty).skills.medicine:0;let n=t;n*=r?1-.15*o:2.5;const s=[];if(a.namedCrew.forEach((t,a)=>{const r=n+(t.level<2?.02:0);Math.random()<r&&s.push({name:t.name,specialty:t.specialty,index:a,cause:e})}),s.reverse().forEach(e=>{a.namedCrew.splice(e.index,1),a.crew--}),s.length>0){const e=8*s.length;a.namedCrew.forEach(t=>{t.loyalty=Math.max(0,t.loyalty-e)})}return s}getDeathReport(e,t,a){if(0===e.length)return"";let r='<br><br><div style="background: #2c2c2c; color: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #dc3545;">';return r+="<strong>üíÄ CASUALTIES</strong><br><br>",e.forEach(e=>{r+=`‚Ä¢ <strong>${e.name}</strong> (${e.specialty}) - killed by ${e.cause}<br>`}),r+="<br><strong>Impact:</strong><br>",r+=`‚Ä¢ ${e.length} crew member(s) lost<br>`,r+=`‚Ä¢ Surviving crew morale drops (-${8*e.length} loyalty)<br>`,!a&&e.length>0?r+='<br><em style="color: #ffcdd2;">‚öïÔ∏è A ship\'s surgeon could have saved some of these lives...</em>':a&&(r+='<br><em style="color: #c8e6c9;">‚öïÔ∏è Your surgeon\'s skill prevented even more casualties.</em>'),r+="</div>",r}giveCrewExperience(e,t=10){const a=this.gameState.ownedShip;if(!a||!a.namedCrew||0===a.namedCrew.length)return[];const r=[];return a.namedCrew.forEach(a=>{let o=t,n="";switch(e){case"combat":"gunner"===a.specialty&&(o*=2,n=" (gunnery specialty)");break;case"travel":"navigator"===a.specialty&&(o*=1.5,n=" (navigation specialty)");break;case"repair":"carpenter"===a.specialty&&(o*=2,n=" (carpentry specialty)");break;case"medical":"surgeon"===a.specialty&&(o*=2,n=" (medical specialty)")}"Ambitious"===a.personality.trait&&(o=Math.floor(1.2*o)),a.experience+=o,r.push(`${a.name}: +${o} exp${n}`);const s=this.checkCrewLevelUp(a);s&&(r[r.length-1]+=` ‚Üí LEVEL UP! Now Level ${s.newLevel}`)}),r}checkCrewLevelUp(e){const t=this.getExpForNextLevel(e.level);if(e.experience>=t&&e.level<5){const t=e.level;return e.level++,this.improveCrewSkills(e),e.loyalty=Math.min(100,e.loyalty+10),e.achievements||(e.achievements=[]),e.achievements.push(`Promoted to Level ${e.level}!`),{name:e.name,oldLevel:t,newLevel:e.level,specialty:e.specialty}}return null}improveCrewSkills(e){const t={gunner:"gunnery",navigator:"navigation",cook:"cooking",bosun:"seamanship",surgeon:"medicine",carpenter:"repair"}[e.specialty];t&&e.skills[t]<5&&e.skills[t]++,Object.keys(e.skills).forEach(a=>{a!==t&&Math.random()<.3&&e.skills[a]<5&&e.skills[a]++})}sailWithShip(){this.showActivityResult("‚õµ Sail Your Ship","<strong>Take command and sail to your destination.</strong><br><br><em>Ship sailing system coming soon...</em><br><br>For now, use the regular Travel option.")}upgradeShip(){const e=this.gameState.ownedShip;if(!e.baseStats){const t={"Rowing Boat":{combat:5,defense:5,speed:15,cargo:2},Sloop:{combat:12,defense:8,speed:18,cargo:10},Brigantine:{combat:20,defense:15,speed:12,cargo:25}};e.baseStats=t[e.name]||{combat:10,defense:10,speed:10,cargo:e.cargo}}e.upgrades||(e.upgrades={cannons:0,armor:0,speed:0,storage:0});let t=`<strong>‚öîÔ∏è Ship Upgrades - "${e.shipName}"</strong><br><br>`;t+='<div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px;">',t+="<strong>Current Ship Stats:</strong><br>",t+=`‚öîÔ∏è Combat Power: ${e.baseStats.combat+8*e.upgrades.cannons}<br>`,t+=`üõ°Ô∏è Defense Rating: ${e.baseStats.defense+6*e.upgrades.armor}<br>`,t+=`üí® Speed: ${e.baseStats.speed+4*e.upgrades.speed}<br>`,t+=`üì¶ Cargo Capacity: ${e.baseStats.cargo+5*e.upgrades.storage}<br>`,t+="</div>",t+="<strong>Available Upgrades:</strong><br><br>";const a=e.upgrades.cannons,r=200*(a+1),o=["No Cannons","Light Cannons","Medium Cannons","Heavy Cannons","MAX FIREPOWER"];if(t+='<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+=`<strong>‚öîÔ∏è Cannons</strong> - Level ${a}/3<br>`,t+=`Current: ${o[a]}<br>`,t+=`Combat Power: +${8*a}<br><br>`,a<3){const e=o[a+1];t+=this.characterData.stats.money>=r?`<button onclick="game.buyUpgrade('cannons', ${r})">Upgrade to ${e} (${r} gold)</button>`:`<button disabled>Upgrade to ${e} (${r} gold)</button>`}else t+="<em>Maximum firepower achieved!</em>";t+="</div>";const n=e.upgrades.armor,s=150*(n+1),i=["No Armor","Iron Plating","Reinforced Hull","Battle Armor","FORTRESS"];if(t+='<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+=`<strong>üõ°Ô∏è Armor</strong> - Level ${n}/3<br>`,t+=`Current: ${i[n]}<br>`,t+=`Defense Rating: +${6*n}<br><br>`,n<3){const e=i[n+1];t+=this.characterData.stats.money>=s?`<button onclick="game.buyUpgrade('armor', ${s})">Upgrade to ${e} (${s} gold)</button>`:`<button disabled>Upgrade to ${e} (${s} gold)</button>`}else t+="<em>Maximum protection achieved!</em>";t+="</div>";const l=e.upgrades.speed,c=100*(l+1),d=["Standard Sails","Fine Sails","Racing Sails","Storm Sails","WIND MASTER"];if(t+='<div style="border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px;">',t+=`<strong>üí® Speed</strong> - Level ${l}/3<br>`,t+=`Current: ${d[l]}<br>`,t+=`Speed Bonus: +${4*l}<br><br>`,l<3){const e=d[l+1];t+=this.characterData.stats.money>=c?`<button onclick="game.buyUpgrade('speed', ${c})">Upgrade to ${e} (${c} gold)</button>`:`<button disabled>Upgrade to ${e} (${c} gold)</button>`}else t+="<em>Maximum speed achieved!</em>";t+="</div>",this.showActivityResult("‚öîÔ∏è Ship Upgrades",t)}buyUpgrade(e,t){const a=this.gameState.ownedShip;if(this.characterData.stats.money>=t){this.characterData.stats.money-=t,a.upgrades[e]++,"storage"===e&&(a.cargo=a.baseStats.cargo+5*a.upgrades.storage);const r={cannons:["No Cannons","Light Cannons","Medium Cannons","Heavy Cannons"][a.upgrades.cannons],armor:["No Armor","Iron Plating","Reinforced Hull","Battle Armor"][a.upgrades.armor],speed:["Standard Sails","Fine Sails","Racing Sails","Storm Sails"][a.upgrades.speed],storage:["Standard Hold","Expanded Hold","Maximum Hold"][a.upgrades.storage]},o={cannons:`+${8*a.upgrades.cannons} Combat Power`,armor:`+${6*a.upgrades.armor} Defense Rating`,speed:`+${4*a.upgrades.speed} Speed`,storage:`+${5*a.upgrades.storage} Cargo Capacity`};this.showActivityResult("üîß Upgrade Complete!",`<strong>Ship upgrade successful!</strong><br><br>üí∞ Cost: ${t} gold<br>‚öîÔ∏è New Equipment: ${r[e]}<br>üìà Bonus: ${o[e]}<br><br><em>Your ship "${a.shipName}" is now more formidable!</em>`),setTimeout(()=>{this.upgradeShip()},3e3)}else alert(`You need ${t} gold for this upgrade!`)}joinExpedition(e){const t={african_coast:{name:"African Coast Survey",days:14,risk:.3,cost:50,rewards:{gold:[100,300],reputation:2},description:"Map the African coastline and establish trading posts",successRewards:{discoveredRoutes:["african_gold_route"],unlockedGoods:["ivory","gold_dust"],skills:{navigation:.5,leadership:.3}}},spice_route:{name:"New Spice Route",days:21,risk:.4,cost:100,rewards:{gold:[200,500],reputation:3},description:"Discover faster routes to the spice islands",successRewards:{discoveredRoutes:["fast_spice_route"],unlockedGoods:["rare_spices","silk"],skills:{navigation:.8,trading:.5}}},brazil_expedition:{name:"Brazil Interior",days:30,risk:.5,cost:200,rewards:{gold:[300,800],reputation:5},description:"Explore the Brazilian interior for gold and rare goods",successRewards:{discoveredRoutes:["brazil_interior"],unlockedGoods:["brazilian_gold","exotic_woods","sugar_cane"],skills:{leadership:1,navigation:.5},specialUnlock:"colonial_expansion"}}}[e];this.characterData.stats.money-=t.cost;if(Math.random()>t.risk){const a=t.rewards.gold[0],r=t.rewards.gold[1],o=Math.floor(a+.75*(r-a)+Math.random()*(r-a)*.25);this.characterData.stats.money+=o,this.gameState.explorationData.reputation+=t.rewards.reputation,this.gameState.explorationData.completedExpeditions.push(e);const n=t.successRewards;n.discoveredRoutes&&(this.gameState.explorationData.discoveredRoutes||(this.gameState.explorationData.discoveredRoutes=[]),n.discoveredRoutes.forEach(e=>{this.gameState.explorationData.discoveredRoutes.includes(e)||this.gameState.explorationData.discoveredRoutes.push(e)})),n.unlockedGoods&&(this.gameState.unlockedGoods||(this.gameState.unlockedGoods=[]),n.unlockedGoods.forEach(e=>{this.gameState.unlockedGoods.includes(e)||this.gameState.unlockedGoods.push(e)})),n.skills&&Object.keys(n.skills).forEach(e=>{this.characterData.stats[e]+=n.skills[e]}),n.specialUnlock&&(this.gameState.specialUnlocks||(this.gameState.specialUnlocks=[]),this.gameState.specialUnlocks.push(n.specialUnlock));let s=`Your ${t.name} expedition was successful!<br><br><strong>üí∞ Immediate Rewards:</strong><br>‚Ä¢ ${o} gold<br>‚Ä¢ +${t.rewards.reputation} exploration reputation<br><br>`;n.discoveredRoutes&&(s+="<strong>üó∫Ô∏è New Trade Routes:</strong><br>",n.discoveredRoutes.forEach(e=>{s+=`‚Ä¢ ${e.replace("_"," ").toUpperCase()}<br>`}),s+="<br>"),n.unlockedGoods&&(s+="<strong>üì¶ New Goods Available:</strong><br>",n.unlockedGoods.forEach(e=>{s+=`‚Ä¢ ${e.replace("_"," ").toUpperCase()}<br>`}),s+="<br>"),n.skills&&(s+="<strong>üìà Skill Improvements:</strong><br>",Object.keys(n.skills).forEach(e=>{s+=`‚Ä¢ +${n.skills[e]} ${e.toUpperCase()}<br>`}),s+="<br>"),"colonial_expansion"===n.specialUnlock&&(s+="<strong>üåé MAJOR DISCOVERY:</strong><br>‚Ä¢ Access to COLONIAL EXPANSION unlocked!<br>‚Ä¢ New World opportunities now available!<br><br>"),s+="<em>These discoveries will open new opportunities across the empire!</em>",this.showEmergencyEvent("üéâ Expedition Success!",s)}else{const e=Math.floor(.15*t.cost);this.showActivityResult("‚ö†Ô∏è Expedition Difficulties",`Your ${t.name} expedition encountered serious problems.<br><br><strong>Setbacks:</strong><br>‚Ä¢ Additional costs: ${e} gold<br>‚Ä¢ Equipment damaged, crew injuries<br>‚Ä¢ Some maps and supplies lost<br><br><strong>But not all is lost...</strong><br>‚Ä¢ +1 exploration reputation (experience gained)<br>‚Ä¢ +0.2 leadership skill (crisis management)<br><br><em>The crew returns with valuable experience despite the setbacks. Sometimes failure teaches more than success.</em>`),this.characterData.stats.money-=e,this.gameState.explorationData.reputation+=1,this.characterData.stats.leadership+=.2}this.advanceTime(t.days)}}window.addEventListener("DOMContentLoaded",()=>{window.game=new ColonialGame})</script></div></div></body></html>

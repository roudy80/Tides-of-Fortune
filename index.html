<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tides of Fortune</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}


/* Mobile combat interface improvements */
@media (max-width: 768px) {
    /* Combat action buttons - make them much easier to tap */
    .emergency-content div[style*="border: 2px solid #dc3545"] button,
    .emergency-content div[style*="border: 2px solid #007bff"] button,
    .emergency-content div[style*="border: 2px solid #28a745"] button,
    .emergency-content div[style*="border: 2px solid #ffc107"] button,
    .emergency-content div[style*="border: 2px solid #6f42c1"] button {
        width: 100%;
        padding: 18px 15px;
        margin: 8px 0;
        font-size: 1.1em;
        font-weight: bold;
        min-height: 50px;
        line-height: 1.3;
        text-align: center;
    }
    
    /* Combat info display */
    .emergency-content div[style*="background: #1a1a1a"] {
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        font-size: 0.95em;
    }
    
    /* Combat health bars on mobile */
    .emergency-content div[style*="background: #333"] {
        margin: 8px 0;
        font-size: 0.9em;
    }
    
    /* Combat choice containers */
    .emergency-content div[style*="border: 2px solid"] {
        padding: 12px;
        margin: 12px 0;
        border-radius: 8px;
    }
    
    /* Combat text readability */
    .emergency-content strong {
        font-size: 1.05em;
        display: block;
        margin-bottom: 5px;
    }
    
    /* Emergency modal combat spacing */
    .emergency-modal {
        padding: 10px;
    }
    
    .emergency-content {
        margin: 5px;
        max-height: 95vh;
        overflow-y: auto;
    }
}
        
body {
    font-family: 'Georgia', serif;
    background: linear-gradient(135deg, #2c3e50 0%, #3498db 50%, #2980b9 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Mobile text and readability improvements */
@media (max-width: 768px) {
    /* Base text improvements */
    body {
        font-size: 16px; /* Ensure minimum readable size */
    }
    
    /* Larger headers on mobile */
    h1 { font-size: 2.2em; }
    h2 { font-size: 1.8em; }
    h3 { font-size: 1.5em; }
    h4 { font-size: 1.3em; }
    
    /* Better line spacing for mobile reading */
    p, .location-description {
        line-height: 1.6;
        font-size: 1.05em;
    }
    
    /* Character sheet improvements */
    .character-info h3 {
        font-size: 1.2em;
        margin-bottom: 5px;
    }
    
    .stat {
        font-size: 1.0em;
        display: block;
        margin: 3px 0;
    }
    
    /* Activity card text */
    .activity-card h4 {
        font-size: 1.1em;
        margin-bottom: 6px;
    }
    
    .activity-card p {
        font-size: 0.95em;
        line-height: 1.4;
    }
}        


/* Mobile form and input improvements */
@media (max-width: 768px) {
    /* Better input fields for mobile */
    input[type="text"], input[type="number"] {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 12px 15px;
        min-height: 44px;
        border-radius: 8px;
        border: 2px solid #8b4513;
        width: 100%;
        max-width: 250px;
        margin: 8px 0;
        box-sizing: border-box;
    }
    
    /* Character creation improvements */
    #characterName {
        width: 100%;
        max-width: 300px;
        font-size: 16px;
        padding: 15px 20px;
    }
    
    /* Trade quantity inputs */
    input[id^="qty_"], input[id^="transfer_"], input[id^="depositAmount"], 
    input[id^="withdrawAmount"], input[id^="loanAmount"], input[id^="repayAmount"] {
        width: 80px;
        min-width: 60px;
        padding: 8px 12px;
        font-size: 16px;
        text-align: center;
    }
    
    /* Background and trait cards mobile */
    .background-options, .trait-options {
        grid-template-columns: 1fr; /* Single column on mobile */
        gap: 15px;
    }
    
    .background-card, .trait-card {
        padding: 15px;
        margin: 5px 0;
    }
    
    /* Action buttons mobile layout */
    .action-buttons {
        justify-content: center;
        width: 100%;
        flex-wrap: wrap;
    }
    
    .action-buttons button {
        flex: 1;
        min-width: 100px;
        font-size: 0.9em;
        padding: 8px 12px;
        margin: 3px;
    }
}


/* Mobile navigation and menu improvements */
@media (max-width: 768px) {
    /* Better title screen on mobile */
    #titleScreen {
        padding: 30px 20px;
        margin: 10px;
    }
    
    #titleScreen h1 {
        font-size: 2.2em;
        margin-bottom: 15px;
    }
    
    #titleScreen p {
        font-size: 1.2em;
        margin-bottom: 30px;
    }
    
    #titleScreen button {
        display: block;
        width: 100%;
        max-width: 250px;
        margin: 10px auto;
        padding: 15px 20px;
        font-size: 1.1em;
    }
    
    /* Ship upgrade grid mobile */
    .background-options, .trait-options {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    /* Ship management buttons */
    .shipyard button, .market button {
        display: block;
        width: 100%;
        margin: 8px 0;
        padding: 12px 15px;
    }
    
    /* Travel options mobile */
    .travel-destinations {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    /* Emergency modal mobile navigation */
    .emergency-content {
        margin: 5px;
    }
    
    .emergency-content button {
        width: 100%;
        margin: 8px 0;
        padding: 12px 15px;
        font-size: 1.0em;
    }
    
    /* Combat action buttons mobile */
    .emergency-content div[style*="border: 2px solid"] button {
        width: 100%;
        padding: 15px 20px;
        margin: 5px 0;
        font-size: 1.0em;
        font-weight: bold;
    }
}

        
        
#gameContainer {
    width: 90%;
    max-width: 800px;
    min-height: 600px;
}

/* Mobile game container optimization */
@media (max-width: 768px) {
    #gameContainer {
        width: 98%;
        max-width: none;
        min-height: calc(100vh - 20px);
        margin: 10px auto;
        overflow-x: hidden;
    }
    
    /* Game screen mobile */
    #gameScreen {
        min-height: calc(100vh - 40px);
        padding: 15px;
        margin: 0;
        border-radius: 10px;
    }
    
    /* Prevent horizontal scrolling */
    body {
        overflow-x: hidden;
    }
    
    /* Better mobile scrolling */
    .content-panel {
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* iOS smooth scrolling */
    }
}

/* Mobile combat interface improvements */
@media (max-width: 768px) {
    /* Combat action buttons - make them much easier to tap */
    .emergency-content div[style*="border: 2px solid #dc3545"] button,
    .emergency-content div[style*="border: 2px solid #007bff"] button,
    .emergency-content div[style*="border: 2px solid #28a745"] button,
    .emergency-content div[style*="border: 2px solid #ffc107"] button,
    .emergency-content div[style*="border: 2px solid #6f42c1"] button {
        width: 100%;
        padding: 18px 15px;
        margin: 8px 0;
        font-size: 1.1em;
        font-weight: bold;
        min-height: 50px;
        line-height: 1.3;
        text-align: center;
    }
    
    /* Combat info display */
    .emergency-content div[style*="background: #1a1a1a"] {
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        font-size: 0.95em;
    }
    
    /* Combat health bars on mobile */
    .emergency-content div[style*="background: #333"] {
        margin: 8px 0;
        font-size: 0.9em;
    }
    
    /* Combat choice containers */
    .emergency-content div[style*="border: 2px solid"] {
        padding: 12px;
        margin: 12px 0;
        border-radius: 8px;
    }
    
    /* Combat text readability */
    .emergency-content strong {
        font-size: 1.05em;
        display: block;
        margin-bottom: 5px;
    }
    
    /* Emergency modal combat spacing */
    .emergency-modal {
        padding: 10px;
    }
    
    .emergency-content {
        margin: 5px;
        max-height: 95vh;
        overflow-y: auto;
    }
}

/* Final mobile polish and edge cases */
@media (max-width: 768px) {
    /* Prevent text selection on game elements (better for touch) */
    .activity-card, .background-card, .trait-card, 
    .emergency-content, button, .status-bar {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Allow text selection only where needed */
    input, textarea, .modal-content p, .emergency-content p {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    /* Better button touch feedback */
    button:active, .activity-card:active, .background-card:active, .trait-card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    /* iOS Safari specific fixes */
    button, input {
        -webkit-appearance: none;
        border-radius: 8px; /* Override iOS default styling */
    }
    
    /* Prevent zoom on inputs (iOS) */
    input[type="text"], input[type="number"], select, textarea {
        font-size: 16px !important; /* Prevents zoom */
    }
    
    /* Better mobile scrolling */
    .emergency-content, .modal-content {
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
    }
    
    /* Hide mobile browser UI when scrolling */
    .screen.active {
        min-height: 100vh;
        min-height: -webkit-fill-available;
    }
    
    /* Better spacing for small screens */
    @media (max-height: 600px) {
        #gameContainer {
            min-height: calc(100vh - 10px);
        }
        
        .emergency-content, .modal-content {
            max-height: 95vh;
            padding: 10px;
        }
    }
}        

.screen {
    transition: opacity 0.5s ease;
}

.screen.hidden {
    display: none;
}

.screen.hidden {
    display: none;
}

.hidden {
    display: none !important;
}
        
.screen.active {
    display: block;
}

#titleScreen {
    text-align: center;
    background: linear-gradient(145deg, #f4f1e8 0%, #e8e1d3 100%);
    border: 3px solid #8b4513;
    border-radius: 15px;
    padding: 60px 40px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3);
    position: relative;
    overflow: hidden;
}

#titleScreen::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%23d4af37" opacity="0.1"/></svg>') repeat;
    animation: shimmer 20s linear infinite;
    pointer-events: none;
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%); }
    100% { transform: translateX(100%) translateY(100%); }
}

#titleScreen h1 {
    font-size: 3em;
    color: #2c3e50;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    font-weight: bold;
    letter-spacing: 2px;
}

#titleScreen p {
    font-size: 1.4em;
    color: #34495e;
    margin-bottom: 50px;
    font-style: italic;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

#titleScreen button {
    background: linear-gradient(145deg, #d4af37, #b8941f);
    border: 2px solid #8b7355;
    color: #2c3e50;
    font-size: 1.2em;
    font-weight: bold;
    padding: 15px 30px;
    margin: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Georgia', serif;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

#titleScreen button:hover {
    background: linear-gradient(145deg, #f1c40f, #d4af37);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

#titleScreen button:active {
    transform: translateY(0px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

#gameScreen {
    background: linear-gradient(145deg, #f4f1e8 0%, #e8e1d3 100%);
    border: 3px solid #8b4513;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    min-height: 600px;
}

.game-section {
    transition: opacity 0.3s ease;
}

.game-section.hidden {
    display: none;
}

.creation-step {
    text-align: center;
    padding: 20px;
}

.creation-step.hidden {
    display: none;
}

.creation-step h3 {
    color: #2c3e50;
    margin-bottom: 30px;
    font-size: 1.8em;
}

#characterName {
    padding: 12px 20px;
    font-size: 1.2em;
    border: 2px solid #8b4513;
    border-radius: 8px;
    margin-bottom: 20px;
    width: 300px;
    font-family: 'Georgia', serif;
}

.background-options, .trait-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.background-card, .trait-card {
    background: linear-gradient(145deg, #ffffff, #f0f0f0);
    border: 2px solid #8b4513;
    border-radius: 10px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.background-card:hover, .trait-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    border-color: #d4af37;
}

.background-card.selected, .trait-card.selected {
    background: linear-gradient(145deg, #f1c40f, #d4af37);
    border-color: #b8941f;
    color: #2c3e50;
}

.background-card h4, .trait-card h4 {
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 1.3em;
}

.background-card p, .trait-card p {
    color: #34495e;
    margin-bottom: 8px;
}

.background-card em {
    color: #7f8c8d;
    font-style: italic;
}

button {
    background: linear-gradient(145deg, #d4af37, #b8941f);
    border: 2px solid #8b7355;
    color: #2c3e50;
    font-size: 1.1em;
    font-weight: bold;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Georgia', serif;
    min-height: 44px; /* Apple's minimum touch target */
    min-width: 44px;
    touch-action: manipulation; /* Prevents zoom on double-tap */
}

/* Mobile-specific button improvements */
@media (max-width: 768px) {
    button {
        padding: 15px 20px;
        font-size: 1.0em;
        min-height: 48px; /* Larger for mobile */
        margin: 5px 2px; /* More spacing on mobile */
    }
}

button:hover:not(:disabled) {
    background: linear-gradient(145deg, #f1c40f, #d4af37);
    transform: translateY(-2px);
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}


/* Main Game Interface */
.status-bar {
    background: linear-gradient(145deg, #34495e, #2c3e50);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.character-info h3 {
    margin: 0 0 8px 0;
    font-size: 1.4em;
}

.stats-row {
    display: flex;
    gap: 25px;
}

.stat {
    font-size: 1.1em;
    font-weight: bold;
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .status-bar {
        flex-direction: column;
        gap: 10px;
    }
    
    .action-buttons {
        justify-content: center;
        width: 100%;
    }
    
    .action-buttons button {
        flex: 1;
        min-width: 100px;
        font-size: 0.8em;
        padding: 6px 12px;
    }
}

.action-buttons button {
    background: linear-gradient(145deg, #3498db, #2980b9);
    border: 1px solid #2574a9;
    color: white;
    padding: 8px 16px;
    font-size: 0.9em;
}

.action-buttons button:hover {
    background: linear-gradient(145deg, #5dade2, #3498db);
}

.main-content {
    display: flex;
    gap: 20px;
    min-height: 400px;
}

/* Mobile layout - stack vertically instead of side-by-side */
@media (max-width: 768px) {
    .main-content {
        flex-direction: column;
        gap: 10px;
        min-height: 300px;
    }
    
    .content-panel {
        min-height: 250px;
        padding: 15px; /* Reduce padding on mobile */
    }
    
    /* Make location activities grid mobile-friendly */
    .location-activities {
        grid-template-columns: 1fr; /* Single column on mobile */
        gap: 10px;
    }
    
    .activity-card {
        padding: 12px;
        margin: 5px 0;
        text-align: left; /* Better on mobile */
    }
    
    /* Status bar mobile improvements */
    .status-bar {
        flex-direction: column;
        gap: 10px;
        padding: 10px 15px;
    }
    
    .stats-row {
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
    }
}
        
.content-panel {
    flex: 1;
    background: rgba(255,255,255,0.1);
    border: 2px solid #8b4513;
    border-radius: 10px;
    padding: 20px;
}

.location h2 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.8em;
}

.location-description {
    color: #34495e;
    font-style: italic;
    margin-bottom: 25px;
    line-height: 1.5;
}

.location-activities {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.activity-card {
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    border: 2px solid #bdc3c7;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.activity-card:hover {
    transform: translateY(-3px);
    border-color: #d4af37;
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

.activity-card h4 {
    color: #2c3e50;
    margin-bottom: 8px;
    font-size: 1.2em;
}

.activity-card p {
    color: #7f8c8d;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.earnings {
    color: #27ae60;
    font-weight: bold;
    font-size: 0.9em;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background: linear-gradient(145deg, #f4f1e8 0%, #e8e1d3 100%);
    border: 3px solid #8b4513;
    border-radius: 15px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    color: #2c3e50;
}

.modal-content h2 {
    color: #2c3e50;
    margin-bottom: 20px;
    text-align: center;
}

.modal-content h4 {
    color: #2c3e50;
    margin-top: 15px;
    margin-bottom: 10px;
}

.modal-content ul {
    margin-bottom: 15px;
    margin-left: 0;
    padding-left: 20px;
    list-style-position: inside;
}

.modal-content li {
    margin-bottom: 5px;
    color: #34495e;
    padding-left: 5px;
    line-height: 1.4;
}  

/* Mobile modal improvements */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        padding: 15px;
        max-height: 90vh;
        margin: 10px;
        border-radius: 10px;
    }
    
    .emergency-content {
        width: 95%;
        padding: 15px;
        max-height: 90vh;
        border-radius: 10px;
    }
    
    /* Make close button bigger and easier to tap on mobile */
    .close {
        font-size: 2.5em;
        top: 5px;
        right: 10px;
        padding: 10px;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
}

.close {
    position: absolute;
    right: 15px;
    top: 15px;
    font-size: 2em;
    cursor: pointer;
    color: #8b4513;
}

.close:hover {
    color: #d4af37;
}        

.close:hover {
    color: #d4af37;
}

/* ADD THESE NEW LINES HERE: */
.location {
    display: none;
}

.location.active {
    display: block !important;
}

        /* Emergency Event Modal */
.emergency-modal {
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(139, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: emergencyPulse 2s infinite;
}

@keyframes emergencyPulse {
    0%, 100% { background-color: rgba(139, 0, 0, 0.8); }
    50% { background-color: rgba(220, 53, 69, 0.9); }
}

.emergency-content {
    background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 15px;
    border: 4px solid #dc3545;
    border-radius: 15px;
    width: 95%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    animation: shake 1s ease-in-out;
}

@keyframes shake {
    0%, 20%, 40%, 60%, 80%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
}

/* Loading Screen Styles */
#loadingScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 50%, #F0E68C 100%);
    transition: opacity 1s ease-out;
}

#loadingScreen.fade-out {
    opacity: 0;
    pointer-events: none;
}

.beach-scene {
    position: absolute;
    width: 100%;
    height: 100%;
    overflow: hidden;
}
        

.sky {
    position: absolute;
    top: 0;
    width: 100%;
    height: 60%;
    background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 40%, #F0E68C 100%);
}

.sun {
    position: absolute;
    top: 15%;
    right: 20%;
    width: 80px;
    height: 80px;
    background: radial-gradient(circle, #FFD700 0%, #FFA500 70%);
    border-radius: 50%;
    box-shadow: 0 0 30px #FFD700;
    animation: sunGlow 3s ease-in-out infinite alternate;
}

@keyframes sunGlow {
    0% { box-shadow: 0 0 30px #FFD700; }
    100% { box-shadow: 0 0 50px #FFD700, 0 0 80px #FFA500; }
}

.clouds {
    position: absolute;
    top: 0;
    width: 100%;
    height: 50%;
}

.cloud {
    position: absolute;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50px;
    opacity: 0.7;
}

.cloud::before,
.cloud::after {
    content: '';
    position: absolute;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50px;
}

.cloud1 {
    width: 60px;
    height: 20px;
    top: 20%;
    left: 10%;
    animation: cloudMove1 20s linear infinite;
}

.cloud1::before {
    width: 30px;
    height: 30px;
    top: -15px;
    left: 10px;
}

.cloud1::after {
    width: 40px;
    height: 25px;
    top: -10px;
    right: 10px;
}

.cloud2 {
    width: 80px;
    height: 25px;
    top: 10%;
    left: 60%;
    animation: cloudMove2 25s linear infinite;
}

.cloud2::before {
    width: 35px;
    height: 35px;
    top: -18px;
    left: 15px;
}

.cloud2::after {
    width: 45px;
    height: 30px;
    top: -12px;
    right: 15px;
}

.cloud3 {
    width: 70px;
    height: 22px;
    top: 30%;
    left: 80%;
    animation: cloudMove3 30s linear infinite;
}

.cloud3::before {
    width: 32px;
    height: 32px;
    top: -16px;
    left: 12px;
}

.cloud3::after {
    width: 42px;
    height: 28px;
    top: -11px;
    right: 12px;
}

@keyframes cloudMove1 {
    0% { transform: translateX(-100px); }
    100% { transform: translateX(calc(100vw + 100px)); }
}

@keyframes cloudMove2 {
    0% { transform: translateX(-120px); }
    100% { transform: translateX(calc(100vw + 120px)); }
}

@keyframes cloudMove3 {
    0% { transform: translateX(-110px); }
    100% { transform: translateX(calc(100vw + 110px)); }
}

.ocean {
    position: absolute;
    bottom: 30%;
    width: 100%;
    height: 40%;
    background: linear-gradient(to bottom, #4682B4 0%, #1E90FF 50%, #4169E1 100%);
    overflow: hidden;
}

.wave {
    position: absolute;
    width: 200%;
    height: 20px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
}

.wave1 {
    bottom: 60%;
    animation: waveMove 3s ease-in-out infinite;
}

.wave2 {
    bottom: 40%;
    animation: waveMove 4s ease-in-out infinite 0.5s;
}

.wave3 {
    bottom: 20%;
    animation: waveMove 3.5s ease-in-out infinite 1s;
}

@keyframes waveMove {
    0%, 100% { transform: translateX(-50%) translateY(0px); }
    50% { transform: translateX(-50%) translateY(-5px); }
}

.beach {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 30%;
    background: linear-gradient(to bottom, #F5DEB3 0%, #DEB887 100%);
}

.palm-tree {
    position: absolute;
    bottom: 25%;
    left: 15%;
    transform: scale(1.0);
    animation: treeSway 6s ease-in-out infinite;
    transform-origin: bottom center;
}

@keyframes treeSway {
    0%, 100% { transform: scale(1.0) rotate(0deg); }
    25% { transform: scale(1.0) rotate(2deg); }
    50% { transform: scale(1.0) rotate(0deg); }
    75% { transform: scale(1.0) rotate(-1deg); }
}

.trunk {
    width: 18px;
    height: 140px;
    background: linear-gradient(to right, 
        #8B4513 0%, 
        #CD853F 20%, 
        #8B4513 40%, 
        #A0522D 60%, 
        #8B4513 80%, 
        #654321 100%);
    border-radius: 12px 12px 6px 6px;
    position: relative;
    box-shadow: inset -3px 0 5px rgba(0,0,0,0.3);
}

.fronds {
    position: absolute;
    top: -15px;
    left: 50%;
    transform: translateX(-50%);
}

.coconuts {
    position: absolute;
    top: 5px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
}

.coconut {
    position: absolute;
    width: 12px;
    height: 16px;
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 50%, #654321 100%);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    box-shadow: inset -2px -2px 4px rgba(0,0,0,0.4), 2px 2px 4px rgba(0,0,0,0.3);
}

.coconut1 {
    top: -8px;
    left: -6px;
    animation: coconutSway1 6s ease-in-out infinite;
}

.coconut2 {
    top: -3px;
    left: 2px;
    animation: coconutSway2 6s ease-in-out infinite 0.5s;
}

.coconut3 {
    top: 2px;
    left: -10px;
    animation: coconutSway3 6s ease-in-out infinite 1s;
}

@keyframes coconutSway1 {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(3deg); }
}

@keyframes coconutSway2 {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(-2deg); }
}

@keyframes coconutSway3 {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(4deg); }
}

.frond {
    position: absolute;
    transform-origin: 10px center;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
}

.frond::before {
    content: '';
    position: absolute;
    width: 85px;
    height: 12px;
    background: linear-gradient(to right, 
        #228B22 0%, 
        #32CD32 30%, 
        #228B22 60%, 
        #006400 100%);
    border-radius: 0 30px 30px 0;
    clip-path: ellipse(90% 60% at 50% 50%);
}

.frond::after {
    content: '';
    position: absolute;
    width: 70px;
    height: 8px;
    top: 2px;
    left: 15px;
    background: linear-gradient(to right, 
        #32CD32 0%, 
        #90EE90 50%, 
        #228B22 100%);
    border-radius: 0 25px 25px 0;
    clip-path: ellipse(85% 70% at 50% 50%);
}

/* Front-facing fronds */
.frond1 {
    transform: rotate(-60deg);
    animation: frondSway1 5s ease-in-out infinite;
    z-index: 3;
}

.frond2 {
    transform: rotate(-30deg);
    animation: frondSway2 5.5s ease-in-out infinite 0.5s;
    z-index: 4;
}

.frond3 {
    transform: rotate(0deg);
    animation: frondSway3 6s ease-in-out infinite 1s;
    z-index: 5;
}

.frond4 {
    transform: rotate(30deg);
    animation: frondSway4 5.2s ease-in-out infinite 1.5s;
    z-index: 4;
}

.frond5 {
    transform: rotate(60deg);
    animation: frondSway5 5.8s ease-in-out infinite 2s;
    z-index: 3;
}



/* Back-facing fronds (behind tree) */
.frond7 {
    transform: rotate(120deg);
    animation: frondSway7 5.4s ease-in-out infinite 3s;
    z-index: 1;
    opacity: 0.7;
}

.frond8 {
    transform: rotate(150deg);
    animation: frondSway8 5.6s ease-in-out infinite 0.2s;
    z-index: 1;
    opacity: 0.6;
}

.frond9 {
    transform: rotate(180deg);
    animation: frondSway9 6.1s ease-in-out infinite 0.8s;
    z-index: 1;
    opacity: 0.5;
}

.frond10 {
    transform: rotate(210deg);
    animation: frondSway10 5.3s ease-in-out infinite 1.2s;
    z-index: 1;
    opacity: 0.6;
}

.frond11 {
    transform: rotate(240deg);
    animation: frondSway11 5.9s ease-in-out infinite 1.8s;
    z-index: 1;
    opacity: 0.7;
}

.frond12 {
    transform: rotate(270deg);
    animation: frondSway12 5.7s ease-in-out infinite 2.2s;
    z-index: 2;
}

@keyframes frondSway1 {
    0%, 100% { transform: rotate(-60deg) scale(1); }
    25% { transform: rotate(-55deg) scale(1.05); }
    50% { transform: rotate(-65deg) scale(0.98); }
    75% { transform: rotate(-58deg) scale(1.02); }
}

@keyframes frondSway2 {
    0%, 100% { transform: rotate(-30deg) scale(1); }
    25% { transform: rotate(-25deg) scale(1.03); }
    50% { transform: rotate(-35deg) scale(0.97); }
    75% { transform: rotate(-27deg) scale(1.01); }
}

@keyframes frondSway3 {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(5deg) scale(1.02); }
    50% { transform: rotate(-5deg) scale(0.99); }
    75% { transform: rotate(3deg) scale(1.01); }
}

@keyframes frondSway4 {
    0%, 100% { transform: rotate(30deg) scale(1); }
    25% { transform: rotate(35deg) scale(1.04); }
    50% { transform: rotate(25deg) scale(0.96); }
    75% { transform: rotate(32deg) scale(1.02); }
}

@keyframes frondSway5 {
    0%, 100% { transform: rotate(60deg) scale(1); }
    25% { transform: rotate(65deg) scale(1.03); }
    50% { transform: rotate(55deg) scale(0.98); }
    75% { transform: rotate(62deg) scale(1.01); }
}



@keyframes frondSway7 {
    0%, 100% { transform: rotate(120deg) scale(1); }
    25% { transform: rotate(125deg) scale(1.04); }
    50% { transform: rotate(115deg) scale(0.96); }
    75% { transform: rotate(122deg) scale(1.02); }
}

@keyframes frondSway8 {
    0%, 100% { transform: rotate(150deg) scale(1); }
    25% { transform: rotate(155deg) scale(1.02); }
    50% { transform: rotate(145deg) scale(0.98); }
    75% { transform: rotate(152deg) scale(1.01); }
}

@keyframes frondSway9 {
    0%, 100% { transform: rotate(180deg) scale(1); }
    25% { transform: rotate(185deg) scale(1.03); }
    50% { transform: rotate(175deg) scale(0.97); }
    75% { transform: rotate(182deg) scale(1.01); }
}

@keyframes frondSway10 {
    0%, 100% { transform: rotate(210deg) scale(1); }
    25% { transform: rotate(215deg) scale(1.02); }
    50% { transform: rotate(205deg) scale(0.98); }
    75% { transform: rotate(212deg) scale(1.01); }
}

@keyframes frondSway11 {
    0%, 100% { transform: rotate(240deg) scale(1); }
    25% { transform: rotate(245deg) scale(1.04); }
    50% { transform: rotate(235deg) scale(0.96); }
    75% { transform: rotate(242deg) scale(1.02); }
}

@keyframes frondSway12 {
    0%, 100% { transform: rotate(270deg) scale(1); }
    25% { transform: rotate(275deg) scale(1.03); }
    50% { transform: rotate(265deg) scale(0.97); }
    75% { transform: rotate(272deg) scale(1.01); }
}

.loading-content {
    position: relative;
    z-index: 10;
    text-align: center;
    color: white;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
}

.game-title {
    font-size: 3.5em;
    font-family: 'Georgia', serif;
    color: #FFD700;
    margin-bottom: 30px;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
    animation: titleGlow 2s ease-in-out infinite alternate;
}

@keyframes titleGlow {
    0% { text-shadow: 3px 3px 6px rgba(0,0,0,0.8), 0 0 20px #FFD700; }
    100% { text-shadow: 3px 3px 6px rgba(0,0,0,0.8), 0 0 30px #FFD700, 0 0 40px #FFA500; }
}

.loading-spinner {
    margin: 20px 0;
    display: flex;
    justify-content: center;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 4px solid #FFD700;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.3em;
    margin-bottom: 50px;
    font-style: italic;
    animation: loadingPulse 2s ease-in-out infinite;
}

.credits {
    position: absolute;
    bottom: -200px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
}

.producer {
    font-size: 1.4em;
    font-weight: bold;
    color: #FFD700;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.copyright {
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 5px;
}

.version {
    font-size: 0.8em;
    color: rgba(255, 255, 255, 0.7);
}

/* Mobile Loading Screen */
@media (max-width: 768px) {
    .game-title {
        font-size: 2.5em;
    }
    
    .sun {
        width: 60px;
        height: 60px;
        top: 10%;
        right: 15%;
    }
    
    .palm-tree {
        transform: scale(0.6);
        left: 10%;
    }
    
    .credits {
        bottom: -150px;
    }
}

@keyframes loadingPulse {
    0%, 100% { opacity: 0.7; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.05); }
}
</style>
        
    </style>
</head>
<body>

<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="beach-scene">
            <div class="sky"></div>
            <div class="sun"></div>
            <div class="clouds">
                <div class="cloud cloud1"></div>
                <div class="cloud cloud2"></div>
                <div class="cloud cloud3"></div>
            </div>
            <div class="ocean">
                <div class="wave wave1"></div>
                <div class="wave wave2"></div>
                <div class="wave wave3"></div>
            </div>
            <div class="beach"></div>
            <div class="palm-tree">
    <div class="trunk"></div>
    <div class="fronds">
        <div class="coconuts">
            <div class="coconut coconut1"></div>
            <div class="coconut coconut2"></div>
            <div class="coconut coconut3"></div>
        </div>
        <div class="frond frond1"></div>
        <div class="frond frond2"></div>
        <div class="frond frond3"></div>
        <div class="frond frond4"></div>
        <div class="frond frond5"></div>
        <div class="frond frond6"></div>
        <div class="frond frond7"></div>
        <div class="frond frond8"></div>
        <div class="frond frond10"></div>
        <div class="frond frond11"></div>
        <div class="frond frond12"></div>
    </div>
</div>
        </div>
        
        <div class="loading-content">
            <h1 class="game-title">Tides of Fortune</h1>
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
            <p class="loading-text">Setting sail...</p>
            
            <div class="credits">
                <p class="producer">WHC Productions</p>
                <p class="copyright">¬© 2025 WHC Productions. All rights reserved.</p>
                <p class="version">Version 2.5</p>
            </div>
        </div>
    </div>    
    <div id="gameContainer">
        <div id="titleScreen" class="screen active">
            <h1>Tides of Fortune</h1>
            <p>Build your fortune in the Age of Sail</p>
            <button id="newGameBtn">New Game</button>
            <button id="loadGameBtn">Load Game</button>
        </div>
        
        <div id="gameScreen" class="screen hidden">
            <div id="characterCreation" class="game-section active">
    <h2>Create Your Character</h2>
    
    <div class="creation-step" id="nameStep">
    <h3>Choose Your Name</h3>
    <input type="text" id="characterFirstName" placeholder="First name" maxlength="15" style="width: 140px; margin-right: 10px;">
    <input type="text" id="characterLastName" placeholder="Last name" maxlength="15" style="width: 140px;">
    <button onclick="game.nextCreationStep()">Continue</button>
</div>

    <div class="creation-step hidden" id="backgroundStep">
        <h3>Choose Your Background</h3>
        <div class="background-options">
            <div class="background-card" data-background="dockworker">
                <h4>Poor Dock Worker</h4>
                <p>Start with: 20 gold, high determination</p>
                <p><em>"I'll work my way up from nothing"</em></p>
            </div>
            <div class="background-card" data-background="merchant">
                <h4>Merchant's Son</h4>
                <p>Start with: 100 gold, trading knowledge</p>
                <p><em>"Father taught me the value of a good deal"</em></p>
            </div>
            <div class="background-card" data-background="noble">
                <h4>Minor Noble</h4>
                <p>Start with: 50 gold, social connections</p>
                <p><em>"My family name opens doors"</em></p>
            </div>
            <div class="background-card" data-background="orphan">
                <h4>Ship's Orphan</h4>
                <p>Start with: 10 gold, natural seamanship</p>
                <p><em>"The sea is my home"</em></p>
            </div>
            <div class="background-card" data-background="testing" id="testingBackground" style="display: none;">
    <h4>Rich Merchant (Testing)</h4>
    <p>Start with: 25,000 gold, all skills</p>
    <p><em>"Money is no object for testing"</em></p>
</div>
        </div>
    </div>

    <div class="creation-step hidden" id="traitStep">
        <h3>Choose Your Traits (Pick 2)</h3>
        <div class="trait-options">
            <div class="trait-card" data-trait="quicklearner">
                <h4>Quick Learner</h4>
                <p>Faster skill progression</p>
            </div>
            <div class="trait-card" data-trait="bornsailor">
                <h4>Born Sailor</h4>
                <p>Natural seamanship bonus</p>
            </div>
            <div class="trait-card" data-trait="silvertongue">
                <h4>Silver Tongue</h4>
                <p>Better negotiations and prices</p>
            </div>
            <div class="trait-card" data-trait="lucky">
                <h4>Lucky</h4>
                <p>More favorable random events</p>
            </div>
            <div class="trait-card" data-trait="brave">
                <h4>Brave</h4>
                <p>Better military/danger outcomes</p>
            </div>
            <div class="trait-card" data-trait="frugal">
                <h4>Frugal</h4>
                <p>Reduced living expenses</p>
            </div>
        </div>
        <button id="finishCreation" onclick="game.finishCharacterCreation()" disabled>Begin Your Journey</button>
    </div>
</div>

<div id="mainGame" class="game-section hidden">
    <!-- Character Status Bar -->
    <div class="status-bar">
        <div class="character-info">
            <h3 id="characterNameDisplay"></h3>
            <div class="stats-row">
                <span class="stat">üí∞ <span id="moneyDisplay">0</span> gold</span>
                <span class="stat">üìç <span id="locationDisplay">London</span></span>
                <span class="stat">üìÖ <span id="dateDisplay">January 1740</span></span>
            </div>
        </div>
        <div class="action-buttons">
            <button onclick="game.showCharacterSheet()">Character</button>
            <button onclick="game.showSaveSlotMenu()">Save Game</button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Location View -->
        <div id="locationView" class="content-panel">
            <div id="londonLocation" class="location active">
                <h2>üè∞ London Docks</h2>
                <p class="location-description">The bustling heart of England's maritime trade. Ships from across the empire dock here, bringing exotic goods and opportunities for those brave enough to seize them.</p>
                
                <div class="location-activities">
                    <div class="activity-card" onclick="game.startActivity('dockwork')">
                        <h4>‚öì Dock Work</h4>
                        <p>Hard labor loading ships</p>
                        <span class="earnings">Earn: 2-4 gold/day</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('tavern')">
                        <h4>üç∫ Visit Tavern</h4>
                        <p>Meet sailors and merchants</p>
                        <span class="earnings">Cost: 1 gold</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('shipyard')">
                        <h4>‚õµ Shipyard</h4>
                        <p>Buy ships and supplies</p>
                        <span class="earnings">Browse ships</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('market')">
                        <h4>üè™ Market</h4>
                        <p>Trade goods locally</p>
                        <span class="earnings">Buy/Sell goods</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('naval')">
                        <h4>‚öîÔ∏è Naval Office</h4>
                        <p>Seek military service</p>
                        <span class="earnings">Join the Navy</span>
                    </div>

<div class="activity-card" onclick="game.startActivity('property_market')">
    <h4>üèòÔ∏è Property Market</h4>
    <p>Buy residential property</p>
    <span class="earnings">Establish a home</span>
</div>
                    
                    <div class="activity-card" onclick="game.startActivity('travel')">
                        <h4>üó∫Ô∏è Travel</h4>
                        <p>Journey to other ports</p>
                        <span class="earnings">Explore Europe</span>
                    </div>
                    <div class="activity-card" onclick="game.startActivity('go_home')" id="goHomeCard_london" style="display: none;">
    <h4>üè† Go Home</h4>
    <p>Return to your residence</p>
    <span class="earnings">Family time</span>
</div>
                </div>
            </div>

            <div id="amsterdamLocation" class="location">
                <h2>üèõÔ∏è Amsterdam Harbor</h2>
                <p class="location-description">The wealthy Dutch trading center bustles with merchants from across Europe. The air smells of spices, and gold changes hands quickly in this commercial paradise.</p>
                
                <div class="location-activities">
                    <div class="activity-card" onclick="game.startActivity('dockwork')">
                        <h4>‚öì Dock Work</h4>
                        <p>Load Dutch merchant vessels</p>
                        <span class="earnings">Earn: 3-5 gold/day</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('tavern')">
                        <h4>üç∫ Visit Coffee House</h4>
                        <p>Meet Dutch traders and financiers</p>
                        <span class="earnings">Cost: 2 gold</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('market')">
                        <h4>üè™ Commodity Exchange</h4>
                        <p>Trade in the famous Dutch market</p>
                        <span class="earnings">Better prices</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('shipyard')">
                        <h4>‚õµ Dutch Shipyard</h4>
                        <p>Quality ships at fair prices</p>
                        <span class="earnings">Browse ships</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('banking')">
                        <h4>üè¶ Banking House</h4>
                        <p>Financial services and loans</p>
                        <span class="earnings">Manage money</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('travel')">
                        <h4>üó∫Ô∏è Travel</h4>
                        <p>Book passage elsewhere</p>
                        <span class="earnings">Explore Europe</span>
                    </div>
                    <div class="activity-card" onclick="game.startActivity('property_market')">
    <h4>üèòÔ∏è Property Market</h4>
    <p>Buy residential property</p>
    <span class="earnings">Establish a home</span>
</div>
                    <div class="activity-card" onclick="game.startActivity('go_home')" id="goHomeCard_london" style="display: none;">
    <h4>üè† Go Home</h4>
    <p>Return to your residence</p>
    <span class="earnings">Family time</span>
</div>
                </div>
            </div>

            <div id="lisbonLocation" class="location">
                <h2>üåÖ Lisbon Port</h2>
                <p class="location-description">Gateway to the Portuguese Empire, this sun-baked port thrums with tales of the New World. Ships laden with Brazilian gold and spices create opportunities for the bold.</p>
                
                <div class="location-activities">
                    <div class="activity-card" onclick="game.startActivity('dockwork')">
                        <h4>‚öì Dock Work</h4>
                        <p>Handle exotic colonial goods</p>
                        <span class="earnings">Earn: 2-6 gold/day</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('tavern')">
                        <h4>üç∫ Sailor's Tavern</h4>
                        <p>Hear tales of the New World</p>
                        <span class="earnings">Cost: 1 gold</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('market')">
                        <h4>üè™ Colonial Market</h4>
                        <p>Exotic goods from Brazil</p>
                        <span class="earnings">Rare items</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('exploration')">
                        <h4>üó∫Ô∏è Exploration Office</h4>
                        <p>Join expeditions to new lands</p>
                        <span class="earnings">High risk, high reward</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('shipyard')">
                        <h4>‚õµ Portuguese Shipyard</h4>
                        <p>Ocean-worthy exploration vessels</p>
                        <span class="earnings">Browse ships</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('travel')">
                        <h4>üó∫Ô∏è Travel</h4>
                        <p>Book passage elsewhere</p>
                        <span class="earnings">Explore Europe</span>
                    </div>
                    <div class="activity-card" onclick="game.startActivity('property_market')">
    <h4>üèòÔ∏è Property Market</h4>
    <p>Buy residential property</p>
    <span class="earnings">Establish a home</span>
</div>
                    <div class="activity-card" onclick="game.startActivity('go_home')" id="goHomeCard_london" style="display: none;">
    <h4>üè† Go Home</h4>
    <p>Return to your residence</p>
    <span class="earnings">Family time</span>
</div>
                </div>
            </div>

            <div id="bristolLocation" class="location">
                <h2>üö¢ Bristol Harbor</h2>
                <p class="location-description">A growing English port with strong ties to the American colonies. Tobacco ships arrive regularly, and there's talk of great fortunes to be made across the Atlantic.</p>
                
                <div class="location-activities">
                    <div class="activity-card" onclick="game.startActivity('dockwork')">
                        <h4>‚öì Dock Work</h4>
                        <p>Unload American tobacco</p>
                        <span class="earnings">Earn: 2-4 gold/day</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('tavern')">
                        <h4>üç∫ Colonial Tavern</h4>
                        <p>Meet colonial traders</p>
                        <span class="earnings">Cost: 1 gold</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('market')">
                        <h4>üè™ Tobacco Exchange</h4>
                        <p>Trade in colonial goods</p>
                        <span class="earnings">Colonial focus</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('passage')">
                        <h4>üö¢ New World Passage</h4>
                        <p>Book passage to America</p>
                        <span class="earnings">The big journey!</span>
                    </div>

<div class="activity-card" onclick="game.startActivity('hunt_pirates')">
    <h4>‚öîÔ∏è Hunt Pirates</h4>
    <p>Patrol trade routes for pirates</p>
    <span class="earnings">Ship required</span>
</div>
                    
                    <div class="activity-card" onclick="game.startActivity('shipyard')">
                        <h4>‚õµ Colonial Shipyard</h4>
                        <p>Ships built for Atlantic crossing</p>
                        <span class="earnings">Browse ships</span>
                    </div>
                    
                    <div class="activity-card" onclick="game.startActivity('travel')">
                        <h4>üó∫Ô∏è Travel</h4>
                        <p>Book passage elsewhere</p>
                        <span class="earnings">Explore Europe</span>
                    </div>
<div class="activity-card" onclick="game.startActivity('property_market')">
    <h4>üèòÔ∏è Property Market</h4>
    <p>Buy residential property</p>
    <span class="earnings">Establish a home</span>
</div>                    
                    <div class="activity-card" onclick="game.startActivity('go_home')" id="goHomeCard_london" style="display: none;">
    <h4>üè† Go Home</h4>
    <p>Return to your residence</p>
    <span class="earnings">Family time</span>
</div>
                </div>
            </div>
<!-- Add these new locations after bristolLocation -->

<div id="jamaicaLocation" class="location">
    <h2>üèùÔ∏è Port Royal, Jamaica</h2>
    <p class="location-description">The infamous "Wickedest City on Earth" - a bustling Caribbean port where pirates, merchants, and naval officers mix freely. Sugar plantations dot the island, and fortunes are made in rum and molasses.</p>
    
    <div class="location-activities">
        <div class="activity-card" onclick="game.startActivity('dockwork')">
            <h4>‚öì Dock Work</h4>
            <p>Load sugar and rum</p>
            <span class="earnings">Earn: 4-8 gold/day</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('tavern')">
            <h4>üç∫ Pirate's Den</h4>
            <p>Notorious tavern full of danger</p>
            <span class="earnings">Cost: 2 gold</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('market')">
            <h4>üè™ Sugar Exchange</h4>
            <p>Trade in Caribbean goods</p>
            <span class="earnings">Colonial profits</span>
        </div>
        <div class="activity-card" onclick="game.startActivity('shipyard')">
    <h4>‚õµ Shipyard</h4>
    <p>Buy and manage ships</p>
    <span class="earnings">Build your fleet</span>
</div>
        <div class="activity-card" onclick="game.startActivity('plantation_market')">
            <h4>üåæ Plantation Market</h4>
            <p>Buy and manage sugar plantations</p>
            <span class="earnings">Major investment</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('naval')">
            <h4>‚öîÔ∏è Naval Station</h4>
            <p>Caribbean fleet command</p>
            <span class="earnings">Colonial service</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('property_market')">
            <h4>üèòÔ∏è Colonial Property</h4>
            <p>Buy property in the New World</p>
            <span class="earnings">Tropical homes</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('travel')">
            <h4>üó∫Ô∏è Travel</h4>
            <p>Sail to other ports</p>
            <span class="earnings">Explore colonies</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('go_home')" id="goHomeCard_jamaica" style="display: none;">
            <h4>üè† Go Home</h4>
            <p>Return to your colonial residence</p>
            <span class="earnings">Family time</span>
        </div>
    </div>
</div>

<div id="charlestonLocation" class="location">
    <h2>üèõÔ∏è Charleston, Carolina</h2>
    <p class="location-description">An elegant colonial port city where rice and indigo create wealth for plantation owners. The aristocratic planters live in grand mansions while ships carry their goods to European markets.</p>
    
    <div class="location-activities">
        <div class="activity-card" onclick="game.startActivity('dockwork')">
            <h4>‚öì Dock Work</h4>
            <p>Handle rice and indigo</p>
            <span class="earnings">Earn: 3-6 gold/day</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('tavern')">
            <h4>üç∫ Gentleman's Club</h4>
            <p>Meet wealthy planters</p>
            <span class="earnings">Cost: 3 gold</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('market')">
            <h4>üè™ Rice Exchange</h4>
            <p>Trade in colonial staples</p>
            <span class="earnings">Agricultural wealth</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('plantation_market')">
            <h4>üåæ Plantation Market</h4>
            <p>Buy rice and indigo plantations</p>
            <span class="earnings">Southern wealth</span>
        </div>
        <div class="activity-card" onclick="game.startActivity('shipyard')">
    <h4>‚õµ Shipyard</h4>
    <p>Buy and manage ships</p>
    <span class="earnings">Build your fleet</span>
</div>
        <div class="activity-card" onclick="game.startActivity('property_market')">
            <h4>üèòÔ∏è Colonial Property</h4>
            <p>Grand colonial mansions</p>
            <span class="earnings">Elegant homes</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('travel')">
            <h4>üó∫Ô∏è Travel</h4>
            <p>Journey to other colonies</p>
            <span class="earnings">Colonial routes</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('go_home')" id="goHomeCard_charleston" style="display: none;">
            <h4>üè† Go Home</h4>
            <p>Return to your plantation home</p>
            <span class="earnings">Family time</span>
        </div>
    </div>
</div>

<div id="bostonLocation" class="location">
    <h2>‚õ™ Boston, Massachusetts</h2>
    <p class="location-description">A thriving Puritan port where merchants trade cod, lumber, and rum. The industrious colonists are growing wealthy through trade, though tensions with the Crown simmer beneath the surface.</p>
    
    <div class="location-activities">
        <div class="activity-card" onclick="game.startActivity('dockwork')">
            <h4>‚öì Dock Work</h4>
            <p>Load fish and lumber</p>
            <span class="earnings">Earn: 3-5 gold/day</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('tavern')">
            <h4>üç∫ Colonial Tavern</h4>
            <p>Meet merchant captains</p>
            <span class="earnings">Cost: 2 gold</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('market')">
            <h4>üè™ Fish Market</h4>
            <p>Trade in northern goods</p>
            <span class="earnings">Maritime trade</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('property_market')">
            <h4>üèòÔ∏è Colonial Property</h4>
            <p>Puritan-style homes</p>
            <span class="earnings">New England homes</span>
        </div>
        <div class="activity-card" onclick="game.startActivity('shipyard')">
    <h4>‚õµ Shipyard</h4>
    <p>Buy and manage ships</p>
    <span class="earnings">Build your fleet</span>
</div>
        <div class="activity-card" onclick="game.startActivity('travel')">
            <h4>üó∫Ô∏è Travel</h4>
            <p>Sail to other ports</p>
            <span class="earnings">Trade routes</span>
        </div>
        
        <div class="activity-card" onclick="game.startActivity('go_home')" id="goHomeCard_boston" style="display: none;">
            <h4>üè† Go Home</h4>
            <p>Return to your colonial home</p>
            <span class="earnings">Family time</span>
        </div>
    </div>
</div>

            
        </div>

        <!-- Activity Results Panel -->
        <div id="activityPanel" class="content-panel hidden">
            <h3 id="activityTitle">Activity</h3>
            <div id="activityContent">
                <!-- Activity content will be inserted here -->
            </div>
            <button onclick="game.smartReturn()">Return</button>
        </div>
    </div>

    <!-- Character Sheet Modal (hidden by default) -->
    <div id="characterSheet" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="game.hideCharacterSheet()">&times;</span>
            <h2>Character Sheet</h2>
            <div id="characterSheetContent">
                <!-- Character details will go here -->
            </div>
        </div>
    </div>
</div>

<!-- Emergency Event Modal -->
<div id="emergencyModal" class="emergency-modal hidden">
    <div class="emergency-content">
        <h2 id="emergencyTitle" style="color: #dc3545; text-align: center; margin-bottom: 20px;">EMERGENCY!</h2>
        <div id="emergencyContent">
            <!-- Emergency content will go here -->
        </div>
        <!-- NO DEFAULT CONTINUE BUTTON - buttons are added individually per event -->
    </div>
</div>
            

    <script>
        class ColonialGame {
    constructor() {
        this.gameState = {
            currentScreen: 'title',
            character: null,
            gameData: null
        };
        this.processingCombatAction = false; // Add in constructor
        
        // Alert queue system
        this.alertQueue = [];
        this.isShowingAlert = false;
        this.emergencyTimeout = null;
        this.processingCombatAction = false;  // ADD THIS LINE

        // Menu context system - prevents unexpected menu jumps
        this.currentContext = 'location';
        this.contextHistory = [];
        
        this.showLoadingScreen();
        this.initializeGame();
    }

showLoadingScreen() {
    console.log('Loading screen started');
    
    // Store reference to avoid 'this' context issues in minification
    const game = this;
    
    // Check if mobile device
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    if (isMobile) {
        console.log('Mobile detected - quick loading');
        // Very short delay for mobile, multiple fallbacks
        setTimeout(function() { game.hideLoadingScreen(); }, 100);
        setTimeout(function() { game.hideLoadingScreen(); }, 500);
        setTimeout(function() { game.hideLoadingScreen(); }, 1000);
    } else {
        // Normal loading for desktop
        const loadingTime = 2000 + Math.random() * 2000;
        setTimeout(function() { game.hideLoadingScreen(); }, loadingTime);
    }
}



  hideLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    const gameContainer = document.getElementById('gameContainer');
    
    if (loadingScreen) {
        loadingScreen.style.display = 'none';
    }
    
    if (gameContainer) {
        gameContainer.style.display = 'block';
    }
    
    console.log('Loading screen hidden, game container shown');
}
            

    initializeGame() {
    console.log('initializeGame method called');
    this.bindEvents();
    this.showScreen('titleScreen');
    console.log('initializeGame completed');
}

    bindEvents() {
    console.log('bindEvents method called');
    const newGameBtn = document.getElementById('newGameBtn');
    console.log('newGameBtn element:', newGameBtn);
    
    if (newGameBtn) {
        newGameBtn.addEventListener('click', () => {
            console.log('New Game button clicked - event listener working');
            this.startNewGame();
        });
    } else {
        console.error('newGameBtn element not found!');
    }
    
    document.getElementById('loadGameBtn').addEventListener('click', () => {
        this.showLoadSlotMenu();
    });
}

    showScreen(screenId) {
        // Hide all screens
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
            screen.classList.add('hidden');
        });

        // Show target screen
        const targetScreen = document.getElementById(screenId);
        targetScreen.classList.remove('hidden');
        targetScreen.classList.add('active');
    }

   startNewGame() {
    console.log('startNewGame method called');
    this.showScreen('gameScreen');
    console.log('Switched to game screen');
    
    // Initialize character data
    this.characterData = {
        name: '',
        background: null,
        traits: [],
        stats: {
            money: 0,
            seamanship: 0,
            trading: 0,
            navigation: 0,
            leadership: 0,
            social: 0
        },
        reputation: {
            crown: 0,
            merchant: 0,
            colonial: 0,
            pirate: 0
        }
    };
       this.gameState.totalDays = 0;
    console.log('Character data initialized');
    this.currentCreationStep = 'name';
    this.setupCharacterCreationEvents();
    console.log('Character creation events setup');
    
    // Show character creation screen
    document.getElementById('characterCreation').classList.remove('hidden');
    document.getElementById('mainGame').classList.add('hidden');
    console.log('Character creation screen should now be visible');
}


setupCharacterCreationEvents() {
    // Background selection
    document.querySelectorAll('.background-card').forEach(card => {
        card.addEventListener('click', () => {
            this.selectBackground(card.dataset.background, card);
        });
    });

    // Trait selection
    document.querySelectorAll('.trait-card').forEach(card => {
        card.addEventListener('click', () => {
            this.toggleTrait(card.dataset.trait, card);
        });
    });
}
    

    loadGame() {
    const savedGame = localStorage.getItem('colonialGameSave');
    if (savedGame) {
        const savedData = JSON.parse(savedGame);
        
        // Handle different save versions
        const version = savedData.version || "1.0";
        console.log('Loading save from version:', version);
        
        // Restore both gameState and characterData
        this.gameState = savedData.gameState || savedData; // Handle both old and new save formats
        this.characterData = savedData.characterData || savedData.character;
        
        // Make sure characterData exists
        if (!this.characterData) {
            alert('Save file is corrupted!');
            return;
        }
        
        this.showScreen('gameScreen');
        
        // Skip character creation, go straight to main game
        document.getElementById('characterCreation').classList.add('hidden');
        document.getElementById('mainGame').classList.remove('hidden');
        
        // Initialize trading system
        this.initializeTrading();
        
        // Backward compatibility for age system
        if (!this.characterData.age) {
            this.characterData.age = 18;
            this.characterData.birthYear = this.gameState.year - 18;
            this.characterData.health = 100;
            this.gameState.daysSinceBirth = 0;
        }

        // DEBUG: Check what we have
        console.log('After compatibility check:', this.characterData.age);
        console.log('Character data:', this.characterData);    
        
        // Update displays
        this.updateDisplay();
        this.updateLocationDisplay();
        
        console.log('Game loaded successfully from version:', version);
    } else {
        alert('No saved game found!');
    }
}

    

    saveGame() {
    const saveData = {
        version: "2.01", 
        gameState: this.gameState,
        characterData: this.characterData,
        savedDate: new Date().toISOString()
    };
    localStorage.setItem('colonialGameSave', JSON.stringify(saveData));
    alert('Game saved!');
}

showSaveSlotMenu() {
    let content = '<strong>üíæ Save Game</strong><br><br>';
    content += 'Choose a save slot:<br><br>';
    
    // Show existing saves
    for (let i = 1; i <= 5; i++) {
        const saveKey = `colonialGameSave_slot${i}`;
        const savedGame = localStorage.getItem(saveKey);
        
        if (savedGame) {
            const saveData = JSON.parse(savedGame);
            const saveInfo = this.getSaveInfo(saveData);
            content += `<div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 5px;">`;
            content += `<strong>Slot ${i}:</strong> ${saveInfo}<br>`;
            content += `<button onclick="game.saveToSlot(${i})" style="margin: 2px;">Overwrite</button>`;
            content += `<button onclick="game.loadFromSlot(${i})" style="margin: 2px;">Load</button>`;
            content += `<button onclick="game.deleteSlot(${i})" style="margin: 2px; background: #dc3545; color: white;">Delete</button>`;
            content += `</div>`;
        } else {
            content += `<div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 5px;">`;
            content += `<strong>Slot ${i}:</strong> <em>Empty</em><br>`;
            content += `<button onclick="game.saveToSlot(${i})" style="margin: 2px;">Save Here</button>`;
            content += `</div>`;
        }
    }
    
    // Create modal overlay instead of activity result
const modalHTML = `
    <div id="saveGameModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(145deg, #f4f1e8 0%, #e8e1d3 100%); border: 3px solid #8b4513; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">üíæ Save Game</h2>
            ${content}
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="document.getElementById('saveGameModal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>
`;

document.body.insertAdjacentHTML('beforeend', modalHTML);
}

getSaveInfo(saveData) {
    const char = saveData.characterData || saveData.character;
    const date = saveData.savedDate ? new Date(saveData.savedDate).toLocaleDateString() : 'Unknown date';
    return `${char.name} - ${char.stats.money} gold - ${date}`;
}

saveToSlot(slotNumber) {
    try {
        // Validate data before saving
        if (!this.characterData || !this.gameState) {
            throw new Error('Missing critical game data');
        }
        
        const saveKey = `colonialGameSave_slot${slotNumber}`;
        const saveData = {
            version: "2.19",
            gameState: this.gameState,
            characterData: this.characterData,
            savedDate: new Date().toISOString()
        };
        
        // Test if data can be serialized
        const testJson = JSON.stringify(saveData);
        if (testJson.length > 5000000) { // 5MB limit
            throw new Error('Save file too large');
        }
        
        localStorage.setItem(saveKey, testJson);
this.showEmergencyEvent('üíæ Save Successful', 
    `Game saved to slot ${slotNumber}!<br><br>` +
    `<div style="text-align: center; margin-top: 20px;">` +
    `<button onclick="game.hideEmergencyEvent()" style="background: linear-gradient(145deg, #d4af37, #b8941f); border: 2px solid #8b7355; color: #2c3e50; font-size: 1.1em; font-weight: bold; padding: 12px 25px; border-radius: 8px; cursor: pointer;">Continue</button>` +
    `</div>`);

// Close the save menu automatically after successful save
const saveModal = document.getElementById('saveGameModal');
if (saveModal) {
    saveModal.remove();
}
        
    } catch (error) {
        console.error('Save failed:', error);
        this.showEmergencyEvent('‚ùå Save Failed', 
            `Could not save to slot ${slotNumber}.<br><br>` +
            `<strong>Error:</strong> ${error.message}<br><br>` +
            `<strong>Possible fixes:</strong><br>` +
            `‚Ä¢ Clear browser data and try again<br>` +
            `‚Ä¢ Use a different save slot<br>` +
            `‚Ä¢ Export your game data manually`);
    }
}

loadFromSlot(slotNumber) {
    try {
        const saveKey = `colonialGameSave_slot${slotNumber}`;
        const savedGame = localStorage.getItem(saveKey);
        
        if (!savedGame) {
            throw new Error('Save file not found');
        }
        
        if (!confirm(`Load game from slot ${slotNumber}? Current progress will be lost!`)) {
            return; // User cancelled
        }
        
        const savedData = JSON.parse(savedGame);
        
        // Validate critical data exists
        if (!savedData.characterData && !savedData.character) {
            throw new Error('No character data in save file');
        }
        
        if (!savedData.gameState && !savedData) {
            throw new Error('No game state in save file');
        }
        
        this.gameState = savedData.gameState || savedData;
        this.characterData = savedData.characterData || savedData.character;
        
        this.showScreen('gameScreen');
        document.getElementById('characterCreation').classList.add('hidden');
        document.getElementById('mainGame').classList.remove('hidden');
        this.initializeTrading();
        
        // Backward compatibility for age system
        if (!this.characterData.age) {
            this.characterData.age = 18;
            this.characterData.birthYear = this.gameState.year - 18;
            this.characterData.health = 100;
            this.gameState.daysSinceBirth = 0;
        }

        this.updateDisplay();
        this.updateLocationDisplay();
        this.returnToLocation();
        
        this.showEmergencyEvent('‚úÖ Game Loaded', 
    `Successfully loaded from slot ${slotNumber}!<br><br>` +
    `<div style="text-align: center; margin-top: 20px;">` +
    `<button onclick="game.hideEmergencyEvent()" style="background: linear-gradient(145deg, #d4af37, #b8941f); border: 2px solid #8b7355; color: #2c3e50; font-size: 1.1em; font-weight: bold; padding: 12px 25px; border-radius: 8px; cursor: pointer;">Continue</button>` +
    `</div>`);
        
    } catch (error) {
        console.error('Load failed:', error);
        this.showEmergencyEvent('‚ùå Load Failed', 
            `Could not load from slot ${slotNumber}.<br><br>` +
            `<strong>Error:</strong> ${error.message}<br><br>` +
            `<strong>Possible causes:</strong><br>` +
            `‚Ä¢ Save file is corrupted<br>` +
            `‚Ä¢ Save file is from incompatible version<br>` +
            `‚Ä¢ Browser storage issue`);
    }
}

deleteSlot(slotNumber) {
    if (confirm(`Delete save slot ${slotNumber}? This cannot be undone!`)) {
        const saveKey = `colonialGameSave_slot${slotNumber}`;
        localStorage.removeItem(saveKey);
        alert(`Slot ${slotNumber} deleted.`);
        this.showSaveSlotMenu(); // Refresh the menu
    }
}

showLoadSlotMenu() {
    console.log('showLoadSlotMenu() called');
    
    // Check for old save first
    const oldSave = localStorage.getItem('colonialGameSave');
    if (oldSave) {
        if (confirm('Found old save format. Convert to new slot system?')) {
            localStorage.setItem('colonialGameSave_slot1', oldSave);
            localStorage.removeItem('colonialGameSave');
            alert('Save converted to Slot 1!');
        }
    }
    
    // Create load menu HTML
    let content = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: linear-gradient(145deg, #f4f1e8 0%, #e8e1d3 100%); border: 3px solid #8b4513; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%;">
                <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">üìÅ Load Game</h2>
                <p style="text-align: center; margin-bottom: 20px;">Choose a save slot to load:</p>
                <div id="loadSlots">
    `;
    
    let hasAnySaves = false;
    
    // Show existing saves
    for (let i = 1; i <= 5; i++) {
        const saveKey = `colonialGameSave_slot${i}`;
        const savedGame = localStorage.getItem(saveKey);
        
        if (savedGame) {
            hasAnySaves = true;
            const saveData = JSON.parse(savedGame);
            const saveInfo = this.getSaveInfo(saveData);
            content += `
                <div style="border: 1px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px; background: white;">
                    <strong>Slot ${i}:</strong> ${saveInfo}<br><br>
                    <button onclick="game.loadFromSlot(${i}); game.hideLoadMenu();" style="margin: 5px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Load This Save</button>
                    <button onclick="game.deleteSlotFromLoad(${i})" style="margin: 5px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Delete</button>
                </div>
            `;
        } else {
            content += `
                <div style="border: 1px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f8f9fa; opacity: 0.7;">
                    <strong>Slot ${i}:</strong> <em>Empty</em>
                </div>
            `;
        }
    }
    
    if (!hasAnySaves) {
        content += '<p style="text-align: center; font-style: italic;">No saved games found. Start a new game first!</p>';
    }
    
    content += `
                </div>
`;

// Check for autosave
const autoSave = localStorage.getItem('colonialGameSave_auto');
if (autoSave) {
    try {
        const autoSaveData = JSON.parse(autoSave);
        const autoSaveInfo = this.getSaveInfo(autoSaveData);
        content += `
            <div style="border: 2px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 8px; background: #fff3cd;">
                <strong>üíæ Auto-Save:</strong> ${autoSaveInfo}<br><br>
                <button onclick="game.loadAutoSave(); game.hideLoadMenu();" style="margin: 5px; padding: 8px 15px; background: #ffc107; color: #000; border: none; border-radius: 5px; cursor: pointer;">Load Auto-Save</button>
            </div>
        `;
    } catch (e) {
        console.error('Autosave corrupted:', e);
    }
}

content += `
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="game.hideLoadMenu()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Back to Title</button>
                </div>
            </div>
        </div>
    `;
    
    // Add to page
    document.body.insertAdjacentHTML('beforeend', content);
}

hideLoadMenu() {
    // Remove the load menu
    const loadMenu = document.querySelector('div[style*="position: fixed"]');
    if (loadMenu) {
        loadMenu.remove();
    }
}


loadAutoSave() {
    this.loadFromSpecificKey('colonialGameSave_auto', 'Auto-Save');
}

loadFromSpecificKey(saveKey, displayName) {
    try {
        const savedGame = localStorage.getItem(saveKey);
        if (!savedGame) {
            throw new Error('Save file not found');
        }
        
        const savedData = JSON.parse(savedGame);
        
        // Validate critical data exists
        if (!savedData.characterData && !savedData.character) {
            throw new Error('No character data in save file');
        }
        
        this.gameState = savedData.gameState || savedData;
        this.characterData = savedData.characterData || savedData.character;
        
        this.showScreen('gameScreen');
        document.getElementById('characterCreation').classList.add('hidden');
        document.getElementById('mainGame').classList.remove('hidden');
        this.initializeTrading();
        
        // Backward compatibility
        if (!this.characterData.age) {
            this.characterData.age = 18;
            this.characterData.birthYear = this.gameState.year - 18;
            this.characterData.health = 100;
            this.gameState.daysSinceBirth = 0;
        }

        this.updateDisplay();
        this.updateLocationDisplay();
        this.returnToLocation();
        
        this.showEmergencyEvent('‚úÖ Game Loaded', `Successfully loaded from ${displayName}!`);
        
    } catch (error) {
        console.error('Load failed:', error);
        this.showEmergencyEvent('‚ùå Load Failed', 
            `Could not load from ${displayName}.<br><br><strong>Error:</strong> ${error.message}`);
    }
}

    
deleteSlotFromLoad(slotNumber) {
    if (confirm(`Delete save slot ${slotNumber}? This cannot be undone!`)) {
        const saveKey = `colonialGameSave_slot${slotNumber}`;
        localStorage.removeItem(saveKey);
        this.hideLoadMenu();
        this.showLoadSlotMenu(); // Refresh the menu
    }
}
    

nextCreationStep() {
    const firstNameInput = document.getElementById('characterFirstName');
const lastNameInput = document.getElementById('characterLastName');
    if (firstNameInput.value.trim() === '' || lastNameInput.value.trim() === '') {
        alert('Please enter a name for your character');
        return;
    }
    
    // Make sure characterData exists
    if (!this.characterData) {
        console.error('characterData is undefined!');
        return;
    }
    
    this.characterData.firstName = firstNameInput.value.trim();
this.characterData.lastName = lastNameInput.value.trim();
this.characterData.name = `${this.characterData.firstName} ${this.characterData.lastName}`;

// Extract first and last name, and determine gender
const nameParts = this.characterData.name.split(' ');
this.characterData.firstName = nameParts[0];
this.characterData.lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : 'Smith'; // Default last name

// Simple gender detection (you can make this a choice later)
const maleNames = ['William', 'Thomas', 'John', 'James', 'Samuel', 'Robert', 'Henry', 'Charles', 'Edward', 'Benjamin'];
const femaleNames = ['Elizabeth', 'Mary', 'Catherine', 'Margaret', 'Anne', 'Sarah', 'Jane', 'Charlotte', 'Eleanor', 'Rebecca'];

if (maleNames.includes(this.characterData.firstName)) {
    this.characterData.gender = 'male';
} else if (femaleNames.includes(this.characterData.firstName)) {
    this.characterData.gender = 'female';
} else {
    // If name isn't in our list, ask or default to male
    this.characterData.gender = 'male'; // You can make this a prompt later
}
    
    // Hide name step, show background step
    document.getElementById('nameStep').classList.add('hidden');
    document.getElementById('backgroundStep').classList.remove('hidden');
    this.currentCreationStep = 'background';
}

selectBackground(backgroundType, cardElement) {
    // Remove previous selection
    document.querySelectorAll('.background-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Select new background
    cardElement.classList.add('selected');
    this.characterData.background = backgroundType;
    
    // Set starting stats based on background
    this.applyBackgroundStats(backgroundType);
    
    // Move to trait selection after short delay
    setTimeout(() => {
        document.getElementById('backgroundStep').classList.add('hidden');
        document.getElementById('traitStep').classList.remove('hidden');
        this.currentCreationStep = 'traits';
    }, 1000);
}

applyBackgroundStats(backgroundType) {
    const backgrounds = {
        dockworker: {
            money: 20,
            seamanship: 1,
            social: 2,
            reputation: { merchant: 1 }
        },
        merchant: {
            money: 100,
            trading: 2,
            social: 1,
            reputation: { merchant: 2 }
        },
        noble: {
            money: 50,
            social: 2,
            leadership: 1,
            reputation: { crown: 2 }
        },
        orphan: {
        money: 10,
        seamanship: 2,
        navigation: 1,
        reputation: { pirate: 1 }
    },
    testing: {
        money: 25000,
        seamanship: 3,
        trading: 3,
        navigation: 3,
        leadership: 3,
        social: 3,
        reputation: { merchant: 5, crown: 5, colonial: 5, pirate: 5 }
    }
    };
    
    const bg = backgrounds[backgroundType];
    this.characterData.stats.money = bg.money;
    this.characterData.stats.seamanship += bg.seamanship || 0;
    this.characterData.stats.trading += bg.trading || 0;
    this.characterData.stats.social += bg.social || 0;
    this.characterData.stats.leadership += bg.leadership || 0;
    this.characterData.stats.navigation += bg.navigation || 0;
    
    // Apply reputation bonuses
    Object.keys(bg.reputation || {}).forEach(rep => {
        this.characterData.reputation[rep] += bg.reputation[rep];
    });
}

toggleTrait(traitType, cardElement) {
    const isSelected = cardElement.classList.contains('selected');
    
    if (isSelected) {
        // Deselect trait
        cardElement.classList.remove('selected');
        this.characterData.traits = this.characterData.traits.filter(t => t !== traitType);
    } else {
        // Check if already have 2 traits
        if (this.characterData.traits.length >= 2) {
            alert('You can only choose 2 traits');
            return;
        }
        
        // Select trait
        cardElement.classList.add('selected');
        this.characterData.traits.push(traitType);
    }
    
    // Enable/disable finish button
    const finishBtn = document.getElementById('finishCreation');
    finishBtn.disabled = this.characterData.traits.length !== 2;
}

finishCharacterCreation() {
    // Apply trait bonuses
    this.applyTraitBonuses();
    
    // Set up initial game state
this.gameState.character = this.characterData;
// Add age system to character
this.characterData.age = 18; // Starting age
this.characterData.birthYear = this.gameState.year - 18; // Calculate birth year
this.characterData.health = 100;

// Initialize property system
this.gameState.ownedProperty = null; 


    // Marriage system initialization
this.characterData.marriageStatus = 'single'; // 'single', 'courting', 'married'
this.characterData.spouse = null;
this.characterData.relationshipProgress = 0; // For courtship tracking
this.characterData.potentialSpouses = []; // Met but not courting
    this.gameState.currentLocation = 'london';
this.gameState.phase = 'oldworld';
this.gameState.year = 1740; // Keep for compatibility but don't display
this.gameState.gameYear = 1; // New system starts at Year 1
this.gameState.month = 1;
    
    // Hide character creation, show main game
    document.getElementById('characterCreation').classList.add('hidden');
    document.getElementById('mainGame').classList.remove('hidden');
    
    this.startMainGame();
}

applyTraitBonuses() {
    const traitEffects = {
        quicklearner: { learning_bonus: 1.5 },
        bornsailor: { seamanship: 2 },
        silvertongue: { trading: 1, social: 1 },
        lucky: { luck_bonus: 1.2 },
        brave: { leadership: 1, courage_bonus: 1.5 },
        frugal: { expense_reduction: 0.8 }
    };
    
    this.characterData.traits.forEach(trait => {
        const effects = traitEffects[trait];
        Object.keys(effects).forEach(effect => {
            if (this.characterData.stats[effect] !== undefined) {
                this.characterData.stats[effect] += effects[effect];
            } else {
                // Special bonuses (like learning_bonus) stored separately
                this.characterData[effect] = effects[effect];
            }
        });
    });
}

startMainGame() {
    this.updateDisplay();
    this.initializeTrading();         
    console.log('Main game started with character:', this.characterData);
trackGameEvent('character_created', {
    background: this.characterData.background,
    starting_money: this.characterData.stats.money
});
        
}

updateDisplay() {
    // Comprehensive safety checks
    if (!this.characterData) {
        console.warn('No character data for display update');
        return;
    }
    
    if (!this.gameState) {
        console.error('Game state is corrupted, attempting recovery...');
        this.attemptGameStateRecovery();
        return;
    }
    
    // Ensure required properties exist
    if (!this.characterData.stats) {
        console.warn('Missing character stats, initializing defaults...');
        this.characterData.stats = {
            money: 0,
            seamanship: 0,
            trading: 0,
            navigation: 0,
            leadership: 0,
            social: 0
        };
    }
    
    // Update character info in status bar
    document.getElementById('characterNameDisplay').textContent = `${this.characterData.name} (Age ${this.characterData.age})`;
    document.getElementById('moneyDisplay').textContent = this.characterData.stats.money;
    document.getElementById('locationDisplay').textContent = this.gameState.currentLocation;
    document.getElementById('dateDisplay').textContent = this.getDateString();
}


attemptGameStateRecovery() {
    console.log('Attempting game state recovery...');
    
    // Try to restore from localStorage first
    const savedGame = localStorage.getItem('colonialGameSave_slot1');
    if (savedGame) {
        try {
            const savedData = JSON.parse(savedGame);
            this.gameState = savedData.gameState || savedData;
            this.characterData = savedData.characterData || savedData.character;
            
            console.log('Successfully recovered from save slot 1');
            this.showEmergencyEvent('üîß Game Recovered', 
                'The game encountered an error but was successfully restored from your last save!');
            this.updateDisplay();
            return;
        } catch (e) {
            console.error('Save file corrupted:', e);
        }
    }
    
    // If no save available, create minimal viable game state
    console.log('Creating emergency game state...');
    this.gameState = {
        currentScreen: 'title',
        currentLocation: 'london',
        phase: 'oldworld',
        year: 1740,
        month: 1,
        totalDays: 0
    };
    
    this.characterData = {
        name: 'Emergency Captain',
        age: 25,
        health: 100,
        stats: { money: 50, seamanship: 1, trading: 1, navigation: 1, leadership: 1, social: 1 },
        reputation: { crown: 0, merchant: 0, colonial: 0, pirate: 0 },
        background: 'dockworker',
        traits: ['brave', 'lucky']
    };
    
    this.showEmergencyEvent('‚ö†Ô∏è Emergency Recovery', 
        'The game encountered a serious error. You\'ve been given an emergency character to continue playing.<br><br>' +
        '<strong>We recommend:</strong><br>' +
        '‚Ä¢ Save your game immediately<br>' +
        '‚Ä¢ Check for any missing progress<br><br>' +
        '<em>Sorry for the inconvenience!</em>');
}


    
getDateString() {
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    
    if (!this.gameState.gameYear) {
        this.gameState.gameYear = 1; // Initialize for existing saves
    }
    
    return `Age ${this.characterData.age}, Year ${this.gameState.gameYear}, ${months[this.gameState.month - 1]}`;
}

// Activity System
startActivity(activityType) {
    try {
        console.log('startActivity called with:', activityType);
        
        // Validate game state before starting activity
        if (!this.characterData || !this.gameState) {
            throw new Error('Game state corrupted');
        }
        
        document.getElementById('locationView').classList.add('hidden');
        document.getElementById('activityPanel').classList.remove('hidden');
        
        switch(activityType) {
            case 'dockwork':
                this.dockWork();
                break;
            case 'tavern':
                this.visitTavern();
                break;
            case 'shipyard':
                this.visitShipyard();
                break;
            case 'market':
                this.visitMarket();
                break;
            case 'naval':
                this.visitNavalOffice();
                break;
            case 'exploration':
                this.visitExplorationOffice();
                break;
            case 'travel':
                this.planTravel();
                break;
            case 'banking':
                this.visitBankingHouse();
                break;
            case 'hunt_pirates':
                this.huntPirates();
                break;
            case 'go_home':
                this.goHome();
                break;
            case 'property_market':
                this.visitPropertyMarket();
                break;
            default:
    this.showActivityResult('Unknown Activity', 'This activity is not yet implemented.');
        }
        
    } catch (error) {
        console.error('Activity failed:', error);
        this.showActivityResult('‚ö†Ô∏è Activity Error', 
            `Something went wrong with this activity.<br><br>` +
            `<strong>Error:</strong> ${error.message}<br><br>` +
            `<em>Please try again or save your game and reload.</em>`);
    }
}

dockWork() {    
    const basePay = 2;
    const randomBonus = Math.floor(Math.random() * 3); // 0-2 bonus
    const totalPay = basePay + randomBonus;
    
    // Apply trait bonuses
    const finalPay = this.characterData.frugal ? Math.floor(totalPay * 1.2) : totalPay;
    
    this.characterData.stats.money += finalPay;
    this.characterData.stats.seamanship += 0.1;
    
    const results = [
        `You spend a hard day loading cargo ships. The foreman pays you ${finalPay} gold.`,
        `A merchant ship from the Indies needs quick unloading. You earn ${finalPay} gold for your efforts.`,
        `You help repair a damaged ship hull. The grateful captain gives you ${finalPay} gold.`,
        `Loading barrels of rum and sugar cane nets you ${finalPay} gold and some sailing knowledge.`
    ];
    
    const randomResult = results[Math.floor(Math.random() * results.length)];
    
    this.showActivityResult('‚öì Dock Work', randomResult + '<br><br><em>+0.1 Seamanship</em>');
this.advanceTimeSafely(1); // 1 day passes safely on land
}

visitTavern() {
// Check if player has potential spouses to visit in THIS port
const localSpouses = this.characterData.potentialSpouses ? 
    this.characterData.potentialSpouses.filter(spouse => spouse.metLocation === this.gameState.currentLocation) : [];

if (localSpouses.length > 0) {
    this.showPortSpecificRomance(localSpouses);
this.advanceTimeSafely(7) // NOT advanceSocialTime(7)  
    return;
}
    if (this.characterData.stats.money < 1) {
    this.showActivityResult('üç∫ The Sailor\'s Rest Tavern', 'You don\'t have enough money for a drink. The tavern keeper eyes you suspiciously.');
        this.advanceTimeSafely(7) // 7 days, no naval emergencies while drinking
    return;
}

// Show immediate tavern activities
let tavernContent = 'Welcome to the tavern! The air is thick with smoke and conversation.<br><br>';
tavernContent += '<strong>üé≤ Tavern Activities:</strong><br>';
tavernContent += '<button onclick="game.tavernGambling()">Gambling (10 gold)</button> ';
tavernContent += '<button onclick="game.tavernDancing()">Dancing (5 gold)</button> ';
tavernContent += '<button onclick="game.tavernFlirting()">Flirt with Locals (Free)</button><br><br>';
tavernContent += '<button onclick="game.haveDrinkAndEncounter()">Have a Drink and Mingle (1 gold)</button>';

this.showActivityResult('üç∫ The Sailor\'s Rest Tavern', tavernContent);
this.advanceQuickTime(1)
    return;
    
    this.characterData.stats.money -= 1;
    
    const encounters = [
        {
    title: 'Grizzled Captain',
    text: 'An old sea captain tells tales of the Caribbean sugar trade. "Aye, fortunes are made there, but the risks are high..."',
    bonus: { social: 0.1, knowledge: 'caribbean_routes' },
    bonusText: '+0.1 Social'
},
        
            {
    title: 'Merchant Trader',
    text: 'A well-dressed merchant mentions Amsterdam\'s competitive prices. "Smart traders know where to buy cheap and sell dear."',
    bonus: { trading: 0.1, social: 0.1 }
},
    
            {
    title: 'Naval Officer',
    text: 'A young naval officer speaks of opportunities for advancement. "The King\'s Navy rewards brave and capable men."',
    bonus: { social: 0.1, reputation: { crown: 1 } },
    bonusText: '+0.1 Social, +1 Crown Reputation'
},

            {
    title: 'Ship\'s Cook',
    text: 'A friendly cook shares stories of life at sea and offers practical advice about provisioning ships.',
    bonus: { seamanship: 0.1, navigation: 0.1 },
    bonusText: '+0.1 Seamanship, +0.1 Navigation'
},
{
    title: 'Charming Local',
    text: 'You meet an attractive and interesting person at the bar who seems quite taken with your tales of adventure.',
    bonus: { social: 0.1, social_event: 'potential_spouse' },
    bonusText: '+0.1 Social, Potential Romance'
},
{
    title: 'Merchant\'s Daughter',
    text: 'The daughter of a wealthy merchant family strikes up a conversation about trade and travel.',
    bonus: { social: 0.1, trading: 0.05, social_event: 'potential_spouse' },
    bonusText: '+0.1 Social, +0.05 Trading'
},
{
    title: 'Naval Officer\'s Sister',
    text: 'You\'re introduced to the sister of a naval officer. She\'s well-educated and from a respectable family.',
    bonus: { social: 0.1, reputation: { crown: 1 }, social_event: 'potential_spouse' },
    bonusText: '+0.1 Social, +1 Crown Reputation'
}        
];
    
    const encounter = encounters[Math.floor(Math.random() * encounters.length)];
    
    // Apply bonuses
    Object.keys(encounter.bonus).forEach(key => {
        if (key === 'reputation') {
            Object.keys(encounter.bonus.reputation).forEach(rep => {
                this.characterData.reputation[rep] += encounter.bonus.reputation[rep];
            });
        } else if (this.characterData.stats[key] !== undefined) {
            this.characterData.stats[key] += encounter.bonus[key];
        }
    });

// Marriage social bonus
if (this.characterData.marriageStatus === 'married') {
    this.characterData.stats.social += 0.05; // Small bonus for being married
}
    
// Handle special social events from specific encounters
if (encounter.bonus.social_event === 'potential_spouse' && this.characterData.marriageStatus === 'single') {
    // 60% chance to meet someone marriageable from this encounter
    if (Math.random() < 0.8) {
        this.generatePotentialSpouse(encounter.title);
    }
}

// Additional chance to meet someone on any tavern visit (if single)
if (this.characterData.marriageStatus === 'single' && Math.random() < 0.6) {
    this.generatePotentialSpouse('Charming Local');
}

// Initialize potential spouses array if it doesn't exist
if (!this.characterData.potentialSpouses) {
    this.characterData.potentialSpouses = [];
}
    
    let finalContent = `<br>${encounter.text}<br><br><em>Cost: 1 gold | ${encounter.bonusText}</em>`;

// Add social activities for everyone
finalContent += `<br><br><strong>üé≤ Additional Activities:</strong><br>`;
finalContent += `<button onclick="game.tavernGambling()">Gambling (10 gold)</button> `;
finalContent += `<button onclick="game.tavernDancing()">Dancing (5 gold)</button> `;
finalContent += `<button onclick="game.tavernFlirting()">Flirt with Locals (Free)</button><br>`;

if (this.characterData.marriageStatus === 'married') {
    finalContent += `<em style="color: #dc3545;">‚ö†Ô∏è Some activities may not please your spouse...</em>`;
}

this.showActivityResult('üç∫ The Sailor\'s Rest Tavern', finalContent);
}

tavernGambling() {
    if (this.characterData.stats.money < 10) {
        this.showActivityResult('üé≤ No Gambling Money', 'You need at least 10 gold to join the card game.');
this.advanceQuickTime(1)
    return;
    }
    
    this.characterData.stats.money -= 10;
    
    // 40% chance to win, 35% to break even, 25% to lose extra
    const roll = Math.random();
    
    if (roll < 0.4) {
        // Win!
        const winnings = Math.floor(Math.random() * 25) + 15; // 15-40 gold
        this.characterData.stats.money += winnings;
        this.characterData.stats.social += 0.2;
        
        this.showActivityResult('üé≤ Gambling Victory!', 
            `Lady Luck smiles upon you!<br><br>` +
            `<strong>Results:</strong><br>` +
            `‚Ä¢ Won ${winnings} gold!<br>` +
            `‚Ä¢ +0.2 Social skill (respect from other gamblers)<br><br>` +
            `<em>"Drinks are on the winner!"</em>`);
            
    } else if (roll < 0.75) {
        // Break even
        this.characterData.stats.money += 10; // Get original bet back
        
        this.showActivityResult('üé≤ Even Game', 
            `A tense evening of cards ends in a draw.<br><br>` +
            `<strong>Results:</strong><br>` +
            `‚Ä¢ Got your 10 gold back<br>` +
            `‚Ä¢ Gained experience but no profit<br><br>` +
            `<em>"Well played, but fortune favors no one tonight."</em>`);
            
    } else {
        // Lose extra
        const extraLoss = Math.floor(Math.random() * 15) + 5; // 5-20 gold extra
        this.characterData.stats.money -= extraLoss;
        
        this.showActivityResult('üé≤ Gambling Loss', 
            `The cards turn against you!<br><br>` +
            `<strong>Results:</strong><br>` +
            `‚Ä¢ Lost original 10 gold bet<br>` +
            `‚Ä¢ Lost additional ${extraLoss} gold<br>` +
            `‚Ä¢ Total loss: ${10 + extraLoss} gold<br><br>` +
            `<em>"The house always wins... eventually."</em>`);
    }
}

haveDrinkAndEncounter() {
    // This recreates the old tavern behavior
    this.characterData.stats.money -= 1;
    
    const encounters = [
        {
            title: 'Grizzled Captain',
            text: 'An old sea captain tells tales of the Caribbean sugar trade. "Aye, fortunes are made there, but the risks are high..."',
            bonus: { social: 0.1, knowledge: 'caribbean_routes' },
            bonusText: '+0.1 Social'
        },
        {
            title: 'Merchant Trader',
            text: 'A well-dressed merchant mentions Amsterdam\'s competitive prices. "Smart traders know where to buy cheap and sell dear."',
            bonus: { trading: 0.1, social: 0.1 }
        }
    ];
    
    const encounter = encounters[Math.floor(Math.random() * encounters.length)];
    
    // Apply bonuses
    Object.keys(encounter.bonus).forEach(key => {
        if (this.characterData.stats[key] !== undefined) {
            this.characterData.stats[key] += encounter.bonus[key];
        }
    });
    
    // Check for meeting someone new
    if (this.characterData.marriageStatus === 'single' && Math.random() < 0.4) {
        this.generatePotentialSpouse('Charming Local');
    }
    
    this.showActivityResult('üç∫ Tavern Encounter', encounter.text);
}

tavernDancing() {
    if (this.characterData.stats.money < 5) {
        this.showActivityResult('üíÉ No Dancing Money', 'You need 5 gold to join the dancing.');
this.advanceQuickTime(1)
    return;
    }
    
    this.characterData.stats.money -= 5;
    this.characterData.stats.social += 0.3;
    
    this.showActivityResult('üíÉ Dancing Fun!', 
        'You join the lively dancing and have a wonderful time!<br><br>' +
        '+0.3 Social skill<br><br>' +
        '<em>The music and movement lift your spirits.</em>');
}

tavernFlirting() {
    this.characterData.stats.social += 0.1;
    
    if (this.characterData.marriageStatus === 'married') {
        // Reduce spouse loyalty if married
        this.showActivityResult('üòè Risky Flirting', 
            'You flirt with the locals... hopefully word doesn\'t get back to your spouse!<br><br>' +
            '+0.1 Social skill<br><br>' +
            '<em>Some harmless fun, but marriage vows weigh on your mind.</em>');
    } else {
        this.showActivityResult('üòè Harmless Flirting', 
            'You charm the locals with your wit and stories!<br><br>' +
            '+0.1 Social skill<br><br>' +
            '<em>A single person can enjoy some innocent fun.</em>');
    }
}


buyDrinks(spouseIndex) {
    if (this.characterData.stats.money < 3) {
        this.showActivityResult('üíî Not Enough Gold', 'You need 3 gold to buy drinks.');
this.advanceQuickTime(1)
    return;
    }
    
    this.characterData.stats.money -= 3;
    const person = this.characterData.potentialSpouses[spouseIndex];
    person.timesMetWith = (person.timesMetWith || 1) + 1;
    
    this.characterData.stats.social += 0.2;
    
    this.showActivityResult('üçª Drinks and Conversation', 
        `You buy drinks for yourself and ${person.name}.<br><br>` +
        `The alcohol loosens tongues and you share stories and laughter.<br><br>` +
        `<strong>Relationship:</strong> ${this.getRelationshipLevel(person.timesMetWith)}<br>` +
        `<em>+0.2 Social skill</em>`);
}

inviteToRoom(spouseIndex) {
    if (this.characterData.stats.money < 10) {
        this.showActivityResult('üíî Not Enough Gold', 'You need 10 gold for a private room.');
this.advanceQuickTime(1)
    return;
    }
    
    this.characterData.stats.money -= 10;
    const person = this.characterData.potentialSpouses[spouseIndex];
    person.timesMetWith = (person.timesMetWith || 1) + 2; // Intimate activities count for more
    
    this.characterData.stats.social += 0.5;
    
    let content = `You and ${person.name} retire to a private room upstairs...<br><br>`;
    
    if (this.characterData.marriageStatus === 'married') {
        content += `<strong style="color: #dc3545;">‚ö†Ô∏è ADULTERY!</strong><br>`;
        content += `You spend intimate time together despite being married!<br><br>`;
        content += `<strong>Consequences:</strong><br>`;
        content += `‚Ä¢ Risk of scandal if discovered<br>`;
        content += `‚Ä¢ Guilt weighs on your conscience<br><br>`;
        // Could add spouse discovery mechanics later
    } else {
        content += `A passionate evening together deepens your connection significantly.<br><br>`;
        content += `<strong>Intimate Bond:</strong><br>`;
        content += `‚Ä¢ Your relationship grows much stronger<br>`;
        content += `‚Ä¢ Physical intimacy brings you closer<br><br>`;
    }
    
    content += `<strong>Relationship:</strong> ${this.getRelationshipLevel(person.timesMetWith)}<br>` +
               `<em>+0.5 Social skill</em>`;
    
    this.showActivityResult('üåô Private Time', content);
    this.advanceTimeSafely(1); // Advances the day
}            
        
goHome() {
    if (!this.gameState.ownedProperty) {
    this.showActivityResult('üè† No Home', 
        'You don\'t own any property yet!<br><br>' +
        'Visit the property market to purchase a home first.<br><br>' +
        '<em>A wanderer needs a place to call home.</em>');
this.advanceQuickTime(1)
    return;
        goHome
    }

// Backward compatibility - add rooms to old properties
if (!this.gameState.ownedProperty.rooms) {
    this.gameState.ownedProperty.rooms = this.getBaseRooms(this.gameState.ownedProperty.type);
    this.gameState.ownedProperty.totalValue = this.gameState.ownedProperty.purchasePrice;
}
    
    let content = `<strong>üè† Your ${this.gameState.ownedProperty.name}</strong><br><br>`;
    content += 'Welcome home! This is your private residence.<br><br>';
    
    if (this.characterData.marriageStatus === 'married') {
        content += '<strong>üë´ Family Activities:</strong><br>';
        content += '<button onclick="game.spendTimeWithSpouse()">Spend Evening with Spouse (2 gold)</button><br>';
        content += '<button onclick="game.giveSpouseGiftAtHome(\'simple\')">Give Simple Gift (10 gold)</button><br>';
        content += '<button onclick="game.giveSpouseGiftAtHome(\'expensive\')">Give Expensive Gift (50 gold)</button><br><br>';
    }
    
    content += '<strong>üè† Home Activities:</strong><br>';
content += '<button onclick="game.restAtHome()">Rest and Recuperate (Free)</button><br>';
content += '<button onclick="game.manageRooms()">Manage Rooms & Renovations</button><br>';
    content += '<button onclick="game.considerSelling()">Consider Selling Property</button><br>';

// Show current rooms
content += '<br><strong>üö™ Current Rooms:</strong><br>';
const property = this.gameState.ownedProperty;
if (property.rooms && property.rooms.length > 0) {
    property.rooms.forEach(room => {
        const roomName = room.replace('_', ' ').toUpperCase();
        content += `‚Ä¢ ${roomName}<br>`;
    });
} else {
    content += '<em>Basic rooms only</em><br>';
}

this.showActivityResult('üè† At Home', content);
// Fix scrolling issue
setTimeout(() => {
    const activityPanel = document.getElementById('activityPanel');
    if (activityPanel) {
        activityPanel.scrollTop = 0;
    }
}, 100);
}

restAtHome() {
    this.characterData.stats.seamanship += 0.1;
    this.characterData.stats.trading += 0.1;
    this.characterData.stats.navigation += 0.1;
    this.characterData.stats.leadership += 0.1;
    this.characterData.stats.social += 0.1;
    
    this.showActivityResult('üò¥ Well Rested', 
        'You spend a peaceful day at home, reading and relaxing.<br><br>' +
        '<strong>Benefits:</strong><br>' +
        '‚Ä¢ +0.1 to all skills (rest and study)<br>' +
        '‚Ä¢ Mental and physical recovery<br><br>' +
        '<em>There\'s nothing like the comfort of your own home.</em>');
    
    this.advanceTimeSafely(1);
}

spendTimeWithSpouse() {
    // Placeholder for now
    this.showActivityResult('üíï Family Time', 'Spouse interaction system coming soon...');
}

giveSpouseGiftAtHome(giftType) {
    // Placeholder for now  
    this.showActivityResult('üéÅ Gift Giving', 'Home gift system coming soon...');
}


manageRooms() {
    const property = this.gameState.ownedProperty;
    let content = `<strong>üî® Room Management - ${property.name}</strong><br><br>`;
    
    content += '<strong>üö™ Current Rooms:</strong><br>';
    property.rooms.forEach(room => {
        const roomName = room.replace('_', ' ').toUpperCase();
        content += `‚Ä¢ ${roomName}<br>`;
    });

    content += '<br><strong>üîß Available Renovations:</strong><br><br>';
    const propertyType = property.type;
const availableRooms = this.getAvailableRooms(propertyType, property.rooms);

if (availableRooms.length === 0) {
    content += '<em>No more renovations available for this property type.</em><br><br>';
    content += '<strong>üí° Tip:</strong> Consider upgrading to a larger property for more options!';
} else {
    availableRooms.forEach(room => {
        content += `<div style="border: 1px solid ${room.color}; padding: 10px; margin: 5px 0; border-radius: 5px;">
            <strong>${room.name}</strong> - ${room.cost} gold<br>
            ${room.description}<br>
            <button onclick="game.addRoom('${room.id}', ${room.cost})">${room.buttonText}</button>
        </div>`;
    });
}
    this.showActivityResult('üî® Room Management', content);
}

getAvailableRooms(propertyType, currentRooms) {
    const allRooms = [
        // Basic upgrades (all properties)
        { id: 'upgraded_kitchen', name: 'Upgrade Kitchen', cost: 50, description: 'Better cooking facilities', color: '#28a745', buttonText: 'Upgrade Kitchen', minProperty: 'cottage', requires: 'kitchen' },
        { id: 'guest_room', name: 'Guest Room', cost: 75, description: 'Rent to merchants (15 gold/month)', color: '#ffc107', buttonText: 'Add Guest Room', minProperty: 'cottage' },
        { id: 'garden', name: 'Garden', cost: 100, description: 'Reduces food costs, spouse happiness', color: '#28a745', buttonText: 'Plant Garden', minProperty: 'cottage' },
        
        // Townhouse and up
        { id: 'study', name: 'Study', cost: 100, description: 'Leadership training and planning', color: '#007bff', buttonText: 'Build Study', minProperty: 'townhouse' },
        { id: 'wine_cellar', name: 'Wine Cellar', cost: 125, description: 'Store valuables, social bonuses', color: '#6f42c1', buttonText: 'Build Wine Cellar', minProperty: 'townhouse' },
        { id: 'workshop', name: 'Workshop', cost: 150, description: 'Ship repairs and equipment crafting', color: '#dc3545', buttonText: 'Build Workshop', minProperty: 'townhouse' },
        
        // Manor only
        { id: 'library', name: 'Library', cost: 200, description: 'Navigation and trading knowledge', color: '#6f42c1', buttonText: 'Build Library', minProperty: 'manor' },
        { id: 'observatory', name: 'Observatory', cost: 250, description: 'Navigation training, weather prediction', color: '#17a2b8', buttonText: 'Build Observatory', minProperty: 'manor' },
        { id: 'dining_hall', name: 'Dining Hall', cost: 300, description: 'Host dinner parties, social connections', color: '#d4af37', buttonText: 'Build Dining Hall', minProperty: 'manor' },
        { id: 'small_guest_house', name: 'Small Guest House', cost: 400, description: 'Separate building (40 gold/month)', color: '#ffc107', buttonText: 'Build Guest House', minProperty: 'manor' }
    ];
    
    return allRooms.filter(room => {
        // Check property type requirement
        const propertyOrder = ['cottage', 'townhouse', 'manor'];
        const currentLevel = propertyOrder.indexOf(propertyType);
        const requiredLevel = propertyOrder.indexOf(room.minProperty);
        
        if (currentLevel < requiredLevel) return false;
        
        // Check if already built
        if (currentRooms.includes(room.id)) return false;
        
        // Check specific requirements
        if (room.requires && !currentRooms.includes(room.requires)) return false;
        
        return true;
    });
}


considerSelling() {
    const property = this.gameState.ownedProperty;
    const currentValue = property.totalValue;
    const salePrice = Math.floor(currentValue * 0.85); // Lose 15% on sale
    
    let content = `<strong>üèòÔ∏è Property Sale Consideration</strong><br><br>`;
    content += `You're considering selling your ${property.name}.<br><br>`;
    
    content += `<strong>üìä Property Details:</strong><br>`;
    content += `‚Ä¢ Original Purchase: ${property.purchasePrice} gold<br>`;
    content += `‚Ä¢ Current Value: ${currentValue} gold<br>`;
    content += `‚Ä¢ Sale Price: ${salePrice} gold<br><br>`;
    
    if (this.characterData.marriageStatus === 'married') {
        content += `<strong>‚ö†Ô∏è Family Impact:</strong><br>`;
        content += `‚Ä¢ Your spouse may be unhappy about losing the family home<br>`;
        content += `‚Ä¢ Children (if any) will lose their stable environment<br><br>`;
    }
    
    content += `<strong>üîÑ After Sale:</strong><br>`;
    content += `‚Ä¢ You'll need to find new housing<br>`;
    content += `‚Ä¢ Loss: ${currentValue - salePrice} gold in transaction costs<br><br>`;
    
    content += `<button onclick="game.sellProperty()">Confirm Sale (${salePrice} gold)</button><br>`;
    content += `<button onclick="game.goHome()">Keep Property</button>`;
    
    this.showActivityResult('üèòÔ∏è Property Sale', content);
}

sellProperty() {
    const property = this.gameState.ownedProperty;
    const salePrice = Math.floor(property.totalValue * 0.85);
    
    // Add money from sale
    this.characterData.stats.money += salePrice;
    
    // Family consequences
    let familyMessage = '';
    if (this.characterData.marriageStatus === 'married') {
        // Spouse unhappiness (could add spouse mood system later)
        familyMessage = `<br><br><strong>üë´ Family Reaction:</strong><br>Your spouse is concerned about the move but supports your decision.`;
    }
    
    // Remove property
    this.gameState.ownedProperty = null;
    
    this.showActivityResult('üí∞ Property Sold', 
    `You have successfully sold your ${property.name}!<br><br>` +
    `<strong>Sale Results:</strong><br>` +
    `‚Ä¢ Received: ${salePrice} gold<br>` +
    `‚Ä¢ Your funds: ${this.characterData.stats.money} gold<br><br>` +
    `You are now without a permanent residence and will need to find new housing.${familyMessage}<br><br>` +
    `<em>The property market awaits your next investment!</em><br><br>` +
    `<button onclick="game.returnToLocation()">Return to Town</button>`);

// Update home button visibility
this.updateGoHomeButton();
}

            

addRoom(roomType, cost) {
    const property = this.gameState.ownedProperty;
    
    if (this.characterData.stats.money < cost) {
        this.showActivityResult('üí∞ Not Enough Gold', `You need ${cost} gold for this renovation.`);
        return;
    }
    
    if (property.rooms.includes(roomType)) {
        this.showActivityResult('üî® Already Built', 'You already have this room!');
        return;
    }
    
    this.characterData.stats.money -= cost;
    property.rooms.push(roomType);
    property.totalValue += cost;
    
    const roomNames = {
        'upgraded_kitchen': 'Upgraded Kitchen',
        'study': 'Study',
        'library': 'Library', 
        'workshop': 'Workshop',
        'guest_room': 'Guest Room',
        'wine_cellar': 'Wine Cellar',
        'garden': 'Garden',
        'observatory': 'Observatory',
        'armory': 'Armory',
        'counting_house': 'Counting House',
        'music_room': 'Music Room',
        'servant_quarters': 'Servant Quarters',
        'warehouse': 'Private Warehouse',
        'vault': 'Vault',
        'master_bedroom': 'Master Bedroom Suite',
        'dining_hall': 'Dining Hall',
        'art_gallery': 'Art Gallery',
        'conservatory': 'Conservatory',
        'small_guest_house': 'Small Guest House',
        'large_guest_house': 'Large Guest House'
    };
    
    this.showActivityResult('üî® Renovation Complete!', 
        `${roomNames[roomType]} has been added to your home!<br><br>` +
        `Cost: ${cost} gold<br>` +
        `Property value increased to: ${property.totalValue} gold<br><br>` +
        `<em>Your home grows more impressive and functional!</em>`);
}

        
updateGoHomeButton() {
    // Hide all go home buttons
    ['london', 'amsterdam', 'lisbon', 'bristol'].forEach(location => {
        const button = document.getElementById(`goHomeCard_${location}`);
        if (button) button.style.display = 'none';
    });
    
    // Show button only in home location
    if (this.gameState.ownedProperty) {
        const homeButton = document.getElementById(`goHomeCard_${this.gameState.ownedProperty.location}`);
        if (homeButton) homeButton.style.display = 'block';
    }
}
    
visitPropertyMarket() {
    if (this.gameState.ownedProperty) {
        this.showActivityResult('üè† Already Own Property', 
            `You already own ${this.gameState.ownedProperty.name}!<br><br>` +
            'You can only own one residential property at a time.<br><br>' +
            '<em>Perhaps consider selling your current home first.</em>');
        return;
    }
    
    let content = '<strong>üèòÔ∏è London Property Market</strong><br><br>';
    content += 'Establish a proper home for yourself and future family.<br><br>';
    
    // Get properties based on current location
const properties = this.getAvailableProperties();
    
    properties.forEach(property => {
        const canAfford = this.characterData.stats.money >= property.price;
        const buttonHtml = canAfford ? 
            `<button onclick="game.buyProperty('${property.type}', '${property.name}', ${property.price})">Buy for ${property.price} gold</button>` :
            `<button disabled>Buy for ${property.price} gold</button>`;
            
        content += `<div style="border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px;">
            <strong>${property.name}</strong><br>
            ${property.description}<br>
            Monthly upkeep: ${property.type === 'cottage' ? '5' : property.type === 'townhouse' ? '15' : '25'} gold<br><br>
            ${buttonHtml}
        </div>`;
    });
    
    this.showActivityResult('üèòÔ∏è Property Market', content);
this.advanceQuickTime(1)
}            


getAvailableProperties() {
    const location = this.gameState.currentLocation;
    
    // European properties
    if (location === 'london' || location === 'amsterdam' || location === 'lisbon' || location === 'bristol') {
        return [
            { type: 'cottage', name: 'Modest Cottage', price: 200, description: 'Small but comfortable home for a growing family' },
            { type: 'townhouse', name: 'Townhouse', price: 800, description: 'Respectable middle-class residence with multiple rooms' },
            { type: 'manor', name: 'Country Manor', price: 2000, description: 'Grand estate befitting a successful merchant or naval officer' }
        ];
    }
    
    // Caribbean properties (Jamaica)
    if (location === 'jamaica') {
        return [
            { type: 'colonial_cottage', name: 'Tropical Cottage', price: 150, description: 'Simple colonial home with wide verandas for the Caribbean heat' },
            { type: 'plantation_house', name: 'Plantation House', price: 1200, description: 'Grand colonial mansion on elevated grounds with servant quarters' },
            { type: 'port_townhouse', name: 'Port Royal Townhouse', price: 600, description: 'Sturdy stone house near the harbor, built to withstand hurricanes' }
        ];
    }
    
    // Southern Colonial properties (Charleston)
    if (location === 'charleston') {
        return [
            { type: 'colonial_cottage', name: 'Carolina Cottage', price: 180, description: 'Charming colonial home with a garden suitable for the southern climate' },
            { type: 'rice_mansion', name: 'Rice Planter Mansion', price: 1500, description: 'Elegant mansion with columned porches, befitting wealthy planters' },
            { type: 'harbor_house', name: 'Harbor House', price: 700, description: 'Fine colonial residence overlooking Charleston\'s busy harbor' }
        ];
    }
    
    // Northern Colonial properties (Boston)
    if (location === 'boston') {
        return [
            { type: 'colonial_cottage', name: 'New England Cottage', price: 160, description: 'Practical colonial home built for harsh northern winters' },
            { type: 'merchant_house', name: 'Merchant\'s House', price: 900, description: 'Prosperous merchant residence with counting room and warehouse space' },
            { type: 'beacon_hill_mansion', name: 'Beacon Hill Mansion', price: 1800, description: 'Prestigious mansion for Boston\'s merchant elite' }
        ];
    }
    
    // Default European properties for any other location
    return [
        { type: 'cottage', name: 'Modest Cottage', price: 200, description: 'Small but comfortable home for a growing family' },
        { type: 'townhouse', name: 'Townhouse', price: 800, description: 'Respectable middle-class residence with multiple rooms' },
        { type: 'manor', name: 'Country Manor', price: 2000, description: 'Grand estate befitting a successful merchant or naval officer' }
    ];
}

            

buyProperty(propertyType, propertyName, price) {
    if (this.characterData.stats.money >= price && !this.gameState.ownedProperty) {
        this.characterData.stats.money -= price;
        
        this.gameState.ownedProperty = {
    type: propertyType,
    name: propertyName,
    purchasePrice: price,
    location: this.gameState.currentLocation,
    rooms: this.getBaseRooms(propertyType),
    totalValue: price
};
        
        // Social reputation bonus for homeownership
        this.characterData.reputation.merchant += 1;
        
        this.characterData.stats.social += 0.5;
        
        this.showActivityResult('üéâ Property Purchased!', 
            `Congratulations! You are now the proud owner of ${propertyName}!<br><br>` +
            `<strong>Property Details:</strong><br>` +
            `‚Ä¢ Location: ${this.getLocationName(this.gameState.currentLocation)}<br>` +
            `‚Ä¢ Monthly upkeep: ${propertyType === 'cottage' ? '5' : propertyType === 'townhouse' ? '15' : '25'} gold<br><br>` +
            `<strong>Benefits:</strong><br>` +
            `‚Ä¢ +1 Merchant reputation (property owner)<br>` +
            `‚Ä¢ +0.5 Social skill (established citizen)<br>` +
            `‚Ä¢ Can now propose marriage<br>` +
            `‚Ä¢ "Go Home" activities available<br><br>` +
            `<em>You now have a place to call your own!</em>`);
            
        setTimeout(() => {
    this.returnToLocation();
}, 4000);

// Update go home button visibility
this.updateGoHomeButton();
    }
}


visitPlantationMarket() {
    if (this.gameState.currentLocation === 'london' || this.gameState.currentLocation === 'amsterdam' || this.gameState.currentLocation === 'lisbon' || this.gameState.currentLocation === 'bristol') {
        this.showActivityResult('üåæ No Plantations Here', 
            'Plantations are only available in the New World colonies!');
        return;
    }
    
    let content = '<strong>üåæ Colonial Plantation Market</strong><br><br>';
    content += 'Invest in profitable plantation agriculture.<br><br>';
    
    // Show owned plantations
    if (this.gameState.ownedPlantations && this.gameState.ownedPlantations.length > 0) {
        content += '<strong>Your Plantations:</strong><br>';
        this.gameState.ownedPlantations.forEach(plantation => {
            content += `‚Ä¢ ${plantation.name} - ${plantation.type}<br>`;
        });
        content += '<br>';
    }
    
    // Available plantations
    const plantations = [
        { name: 'Small Sugar Plantation', type: 'sugar', price: 500, income: 20 },
        { name: 'Rice Plantation', type: 'rice', price: 400, income: 15 },
        { name: 'Tobacco Farm', type: 'tobacco', price: 600, income: 25 }
    ];
    
    content += '<strong>Available for Purchase:</strong><br><br>';
    plantations.forEach(plantation => {
        const canAfford = this.characterData.stats.money >= plantation.price;
        content += `<div style="border: 1px solid #8b4513; padding: 10px; margin: 5px 0;">
            <strong>${plantation.name}</strong><br>
            Monthly Income: ${plantation.income} gold<br>
            ${canAfford ? 
                `<button onclick="game.buyPlantation('${plantation.name}', '${plantation.type}', ${plantation.price}, ${plantation.income})">Buy for ${plantation.price} gold</button>` :
                `<button disabled>Buy for ${plantation.price} gold</button>`
            }
        </div>`;
    });
    
    this.showActivityResult('üåæ Plantation Market', content);
}

buyPlantation(name, type, price, income) {
    if (!this.gameState.ownedPlantations) {
        this.gameState.ownedPlantations = [];
    }
    
    this.characterData.stats.money -= price;
    this.gameState.ownedPlantations.push({
        name: name,
        type: type,
        location: this.gameState.currentLocation,
        income: income,
        purchasePrice: price
    });
    
    this.showActivityResult('üåæ Plantation Purchased!', 
        `You now own ${name}!<br><br>` +
        `Monthly income: ${income} gold<br>` +
        `Location: ${this.getLocationName(this.gameState.currentLocation)}`);
}

        
getBaseRooms(propertyType) {
    const baseRooms = {
        cottage: ['bedroom', 'kitchen'],
        townhouse: ['bedroom', 'kitchen', 'parlor'],
        manor: ['bedroom', 'kitchen', 'parlor', 'study']
    };
    
    return baseRooms[propertyType] || ['bedroom', 'kitchen'];
}
            
visitShipyard() {
    this.setContext('shipyard');
    console.log('visitShipyard() method called!');    
    const ships = [
    { 
        id: 'rowboat', 
        name: 'Rowing Boat', 
        price: 50, 
        cargo: 2, 
        crew: 1,
        guns: 0,
        speed: 15,
        oceanWorthy: false,
        description: 'Tiny vessel for coastal trading only. Limited to short routes.' 
    },
    { 
        id: 'sloop', 
        name: 'Sloop', 
        price: 500, 
        cargo: 10, 
        crew: 3,
        guns: 4,
        speed: 18,
        oceanWorthy: true,
        description: 'Small single-masted ship, good for coastal voyages and light trading.' 
    },
    { 
        id: 'racing_schooner',
        name: 'Racing Schooner',
        price: 800,
        cargo: 8,
        crew: 2,
        guns: 2,
        speed: 25,
        oceanWorthy: true,
        description: 'Lightning-fast vessel perfect for smuggling and quick escapes.',
        special: 'Can outrun most pirates'
    },
    { 
        id: 'dutch_fluyt',
        name: 'Dutch Fluyt',
        price: 1200,
        cargo: 40,
        crew: 6,
        guns: 6,
        speed: 10,
        oceanWorthy: true,
        description: 'Cargo specialist with massive holds and efficient crew requirements.',
        special: 'Half crew wages, +15 cargo'
    },
    { 
        id: 'fast_frigate',
        name: 'Fast Frigate',
        price: 1500,
        cargo: 15,
        crew: 12,
        guns: 20,
        speed: 22,
        oceanWorthy: true,
        description: 'Military-grade vessel built for speed and firepower.',
        special: 'Double pirate bounties',
        maintenance: '20 gold/month'
    },
    { 
        id: 'brigantine', 
        name: 'Brigantine', 
        price: 2000, 
        cargo: 25, 
        crew: 8,
        guns: 12,
        speed: 12,
        oceanWorthy: true,
        description: 'Two-masted vessel capable of ocean crossing and serious trade.' 
    },
    { 
        id: 'explorer_bark',
        name: 'Explorer\'s Bark',
        price: 2500,
        cargo: 20,
        crew: 10,
        guns: 10,
        speed: 16,
        oceanWorthy: true,
        description: 'Rugged exploration vessel built for discovering new routes.',
        special: '+50% expedition success'
    },
    { 
        id: 'privateer_vessel',
        name: 'Privateer Vessel',
        price: 3000,
        cargo: 18,
        crew: 15,
        guns: 24,
        speed: 20,
        oceanWorthy: true,
        description: 'Government-licensed warship for hunting pirates and enemies.',
        special: 'Double bounties, Crown backing',
        maintenance: '30 gold/month',
        requires: 'Naval Lieutenant rank'
    },
    { 
        id: 'treasure_galleon',
        name: 'Treasure Galleon',
        price: 4000,
        cargo: 60,
        crew: 25,
        guns: 18,
        speed: 8,
        oceanWorthy: true,
        description: 'Massive cargo vessel capable of enormous profits.',
        special: 'Huge cargo, attracts pirates',
        maintenance: '40 gold/month'
    },
    { 
        id: 'ship_of_line',
        name: 'Ship of the Line',
        price: 8000,
        cargo: 30,
        crew: 40,
        guns: 40,
        speed: 6,
        oceanWorthy: true,
        description: 'Ultimate warship that dominates any naval battle.',
        special: 'Unstoppable in combat',
        maintenance: '50 gold/month',
        requires: 'Naval Commander rank'
    }
];
    
let content = '<strong>‚õµ Shipyard</strong><br><br>';

// Add return button at the top
content += `<button onclick="game.smartReturn()" style="background: linear-gradient(145deg, #d4af37, #b8941f); border: 2px solid #8b7355; color: #2c3e50; font-size: 1em; font-weight: bold; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-bottom: 15px;">
    Return
</button><br><br>`;

content += '<strong>Ships Available for Purchase:</strong><br><br>';
    

    // Show fleet if player has ships
if (this.gameState.ownedShips && this.gameState.ownedShips.length > 0) {
    content += `<div style="background: #e8f5e8; border: 2px solid #27ae60; padding: 15px; margin: 10px 0; border-radius: 8px;">
    <strong>‚öì Your Fleet (${this.gameState.ownedShips.length} ships)</strong><br><br>`;
    
    this.gameState.ownedShips.forEach((ship, index) => {
        const isPrimary = this.gameState.ownedShip && ship.shipName === this.gameState.ownedShip.shipName;
        const sellPrice = this.calculateShipSellPrice(ship);
        
        content += `<div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0; background: ${isPrimary ? '#fff3cd' : 'white'};">
            <strong>${ship.shipName}</strong> ${isPrimary ? '(Primary)' : ''}<br>
            <em>Type: ${ship.name} | Location: ${ship.location}</em><br>
${ship.captain ? `Captain: ${ship.captain.name} (${ship.captain.specialty})` : 'No Captain'}<br>
            Cargo: ${ship.cargo} | Condition: ${ship.condition}%<br>
            
            <button onclick="game.manageSpecificShip(${index})">Manage Ship</button>
<button onclick="game.switchToPrimaryShip(${index})" style="background: #ffc107; color: black;">Make Primary</button>
${!ship.captain ? 
    `<button onclick="game.hireCaptain(${index})" style="background: #007bff; color: white;">Hire Captain</button> ` : 
    `<button onclick="game.manageCaptain(${index})" style="background: #28a745; color: white;">Manage Captain</button> `
}
            <button onclick="game.sellSpecificShip(${index}, ${sellPrice})" style="background: #dc3545; color: white;">Sell (${sellPrice} gold)</button>
        </div>`;
    });
    
    content += `</div><br>`;
}
    
    
    
    ships.forEach(ship => {
    const canAfford = this.characterData.stats.money >= ship.price;
    // Remove the hasShip restriction for multiple ship purchases
    
    let buttonHtml;
    if (canAfford) {
        buttonHtml = `<button onclick="game.buyShip('${ship.id}', ${ship.price})">Buy Ship (${ship.price} gold)</button>`;
    } else {
        buttonHtml = `<button disabled>Buy Ship (${ship.price} gold)</button>`;
    }
        
        content += `<div style="border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px;">
    <strong>${ship.name}</strong> - ${ship.price} gold<br>
    ${ship.description}<br>
    <strong>Specs:</strong> Cargo: ${ship.cargo} | Crew: ${ship.crew} | Guns: ${ship.guns} | Speed: ${ship.speed}<br>
    <strong>Ocean Worthy:</strong> ${ship.oceanWorthy ? '‚úÖ Yes (Can reach New World)' : '‚ùå No (European waters only)'}<br>`;

if (ship.special) {
    content += `<strong>Special:</strong> ${ship.special}<br>`;
}
if (ship.maintenance) {
    content += `<strong>Maintenance:</strong> ${ship.maintenance}<br>`;
}
if (ship.requires) {
    content += `<strong>Requires:</strong> ${ship.requires}<br>`;
}

content += `<br>${buttonHtml}</div>`;
    
        console.log(`Button HTML for ${ship.name}:`, buttonHtml); // ADD THIS LINE
    });
    
    // Use direct content update to avoid context change
document.getElementById('activityTitle').innerHTML = '‚õµ Shipyard';
document.getElementById('activityContent').innerHTML = content;
document.getElementById('locationView').classList.add('hidden');
document.getElementById('activityPanel').classList.remove('hidden');
this.updateDisplay();
}

huntPirates() {
    // Check if player has a ship at current location
    const hasShip = this.gameState.ownedShip && 
                   this.gameState.ownedShip.location === this.gameState.currentLocation;
    
    if (!hasShip) {
        this.showActivityResult('‚öîÔ∏è Pirate Hunting', 
            'You need your own ship in this port to hunt pirates!');
        return;
    }
    
    // Cost for supplies and crew wages
    const cost = 10;
    if (this.characterData.stats.money < cost) {
        this.showActivityResult('‚öîÔ∏è Pirate Hunting', 
            `You need ${cost} gold for supplies and crew wages to hunt pirates.`);
        return;
    }
    
    this.characterData.stats.money -= cost;
    
    // 60% chance to find pirates
    if (Math.random() < 0.6) {
        this.showActivityResult('üè¥‚Äç‚ò†Ô∏è Pirates Spotted!', 
            'Your patrol has found pirates terrorizing merchant ships!<br><br>' +
            '<em>Preparing for combat...</em>');
        
        setTimeout(() => {
            this.handlePirateAttack();
        }, 1000);
    } else {
        // No pirates found, but still gain some benefits
        let pay = Math.floor(Math.random() * 15) + 10; // 10-25 gold reward
        pay = Math.floor(this.applyShipSpecialBonuses(pay, 'pirate_bounty'));
        
        this.characterData.stats.money += pay;
this.characterData.stats.seamanship += 0.1;
this.characterData.reputation.crown += 1;

// Naval officer bonuses
if (this.gameState.navalCareer && this.gameState.navalCareer.enlisted) {
    const navalBonus = Math.floor(pay * 0.3); // 30% extra for naval officers
        this.characterData.stats.money += navalBonus;
        const oldExperience = this.gameState.navalCareer.experience;         this.gameState.navalCareer.experience += 2;
        this.checkNavalPromotion(oldExperience,                              this.gameState.navalCareer.experience);                              this.gameState.navalCareer.reputation += 1;
}
        
        let resultText = 'Your patrol finds no pirates today, but the Crown pays you for keeping the seas safe.<br><br>' +
    '<strong>Rewards:</strong><br>' +
    `‚Ä¢ ${pay} gold (Crown bounty)<br>`;

// Add naval bonuses to display
if (this.gameState.navalCareer && this.gameState.navalCareer.enlisted) {
    const navalBonus = Math.floor(pay * 0.3);
    resultText += `‚Ä¢ ${navalBonus} gold (naval officer bonus)<br>` +
                 `‚Ä¢ +2 Naval experience<br>` +
                 `‚Ä¢ +1 Naval reputation<br>`;
}

resultText += '‚Ä¢ +0.1 Seamanship<br>' +
             '‚Ä¢ +1 Crown reputation<br>';

        if (this.getShipSpecialAbility() === 'pirate_hunter') {
            resultText += '‚Ä¢ <em>Fast Frigate bonus: Double bounty!</em><br>';
        } else if (this.getShipSpecialAbility() === 'privateer') {
            resultText += '‚Ä¢ <em>Privateer license: Double bounty!</em><br>';
        }

        resultText += '<br><em>The merchants sleep safer knowing brave captains patrol these waters.</em>';
        
        this.showActivityResult('‚öîÔ∏è Patrol Complete', resultText);
    }
    
this.advanceQuickTime(1)
}

generateCrewMember(specialty = null) {
    const firstNames = [
        'William', 'Thomas', 'John', 'James', 'Samuel', 'Robert', 'Henry', 'Charles',
        'Edward', 'Benjamin', 'Jonathan', 'Daniel', 'Michael', 'Richard', 'Joseph',
        'Isaac', 'Jeremiah', 'Jacob', 'Abraham', 'Nathaniel'
    ];
    
    const lastNames = [
        'Blackwood', 'Saltwater', 'Ironside', 'Stormwind', 'Seahawk', 'Goldbeard',
        'Hartwell', 'Fairwind', 'Longshot', 'Swiftblade', 'Greystone', 'Redmane',
        'Whitecap', 'Thornberry', 'Wavecrest', 'Anchor', 'Compass', 'Crosswind'
    ];
    
    const specialties = ['gunner', 'navigator', 'cook', 'bosun', 'surgeon', 'carpenter'];
    const selectedSpecialty = specialty || specialties[Math.floor(Math.random() * specialties.length)];
    
    const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
    const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
    
    return {
        name: `${firstName} ${lastName}`,
        specialty: selectedSpecialty,
        level: 1,
        experience: 0,
        skills: {
            gunnery: selectedSpecialty === 'gunner' ? 3 : 1,
            seamanship: selectedSpecialty === 'bosun' ? 3 : 1,
            navigation: selectedSpecialty === 'navigator' ? 3 : 1,
            cooking: selectedSpecialty === 'cook' ? 3 : 1,
            medicine: selectedSpecialty === 'surgeon' ? 3 : 1,
            repair: selectedSpecialty === 'carpenter' ? 3 : 1
        },
        personality: this.generatePersonality(),
        loyalty: 50 + Math.floor(Math.random() * 30), // 50-80 starting loyalty
        joinedDate: { year: this.gameState.year, month: this.gameState.month }
    };
}


generatePotentialSpouse(encounterType) {
    // Initialize potential spouses array if it doesn't exist
    if (!this.characterData.potentialSpouses) {
        this.characterData.potentialSpouses = [];
    }
    // Cap at 3 potential spouses per port
    const currentPortSpouses = this.characterData.potentialSpouses ? 
        this.characterData.potentialSpouses.filter(spouse => spouse.metLocation === this.gameState.currentLocation) : [];
    
    if (currentPortSpouses.length >= 3) {
        return; // Don't add more at this port
    }
    const firstNames = {
        male: ['William', 'Thomas', 'James', 'Charles', 'Robert', 'Henry', 'Edward', 'Benjamin'],
        female: ['Elizabeth', 'Mary', 'Catherine', 'Margaret', 'Anne', 'Sarah', 'Jane', 'Charlotte']
    };
    
    const lastNames = ['Whitmore', 'Fairfax', 'Sterling', 'Ashworth', 'Blackwood', 'Pemberton', 'Halifax', 'Thornton'];
    
    const backgrounds = {
        'Charming Local': { background: 'tavern keeper\'s child', wealth: 'modest', reputation: 'local' },
        'Merchant\'s Daughter': { background: 'merchant family', wealth: 'wealthy', reputation: 'merchant' },
        'Naval Officer\'s Sister': { background: 'naval family', wealth: 'comfortable', reputation: 'crown' }
    };
    
    // Generate opposite gender spouse (traditional marriage)
const gender = this.characterData.gender === 'male' ? 'female' : 'male';
    const firstName = firstNames[gender][Math.floor(Math.random() * firstNames[gender].length)];
    const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
    
    const spouseData = backgrounds[encounterType];
    
    const potentialSpouse = {
        name: `${firstName} ${lastName}`,
        gender: gender,
        age: 18 + Math.floor(Math.random() * 8), // 18-25 years old
        background: spouseData.background,
        wealth: spouseData.wealth,
        reputation: spouseData.reputation,
        personality: this.generateSpousePersonality(),
        attractiveness: Math.floor(Math.random() * 5) + 1, // 1-5
        intelligence: Math.floor(Math.random() * 5) + 1,
        metLocation: this.gameState.currentLocation,
        timesMetWith: 1
   };
    
    // Check age compatibility (no more than 15 year age gap)
    const ageGap = Math.abs(this.characterData.age - potentialSpouse.age);
    if (ageGap > 15) {
        return; // Don't add this potential spouse
    }
    
    // Gender compatibility is already handled above when we set gender to opposite
    this.characterData.potentialSpouses.push(potentialSpouse);
    
    // Show meeting notification
    setTimeout(() => {
        this.showEmergencyEvent('üíï New Acquaintance', 
            `You've met ${potentialSpouse.name}, ${potentialSpouse.background}!<br><br>` +
            `They seem quite interesting and appear to enjoy your company.<br><br>` +
            `<em>Perhaps you'll meet again if you visit the tavern more often...</em>`);
    }, 500);
}

generateSpousePersonality() {
    const traits = ['Kind', 'Witty', 'Adventurous', 'Scholarly', 'Artistic', 'Practical', 'Spirited', 'Gentle'];
    const interests = ['reading', 'music', 'art', 'travel', 'business', 'society', 'nature', 'politics'];
    
    return {
        trait: traits[Math.floor(Math.random() * traits.length)],
        interest: interests[Math.floor(Math.random() * interests.length)]
    };
}            



        showCourtshipOptions() {
    let content = '';
    
    // Check if married first
    if (this.characterData.marriageStatus === 'married') {
        content = '<strong>üç∫ The Tavern - Marriage</strong><br><br>';
        content += `You are married to ${this.characterData.spouse.name}.<br><br>`;
        
        content += '<strong>üíï Spouse Activities:</strong><br><br>';
        content += `<div style="border: 1px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        content += `<button onclick="game.spendTimeWithSpouse()">Spend Evening Together (2 gold)</button><br>`;
        content += `<button onclick="game.giveSpouseGift('simple')">Give Gift (10 gold)</button><br>`;
        content += `<button onclick="game.giveSpouseGift('expensive')">Give Expensive Gift (50 gold)</button><br>`;
        content += `</div><br>`;
        
        content += '<strong>‚öñÔ∏è Legal Options:</strong><br><br>';
        content += `<div style="border: 1px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        content += `<button onclick="game.considerDivorce()" style="background: #dc3545; color: white;">Consider Divorce</button><br>`;
        content += `<small><em>Warning: Divorce carries serious social and financial consequences</em></small>`;
        content += `</div>`;
        
    } else {
        // Single people see potential spouses
        content = '<strong>üç∫ The Tavern - Social Connections</strong><br><br>';
        content += 'You have some acquaintances here who might enjoy your company.<br><br>';
        
        // Show potential spouses
        content += '<strong>üíï People You\'ve Met:</strong><br><br>';
        
        this.characterData.potentialSpouses.forEach((person, index) => {
            const relationshipLevel = this.getRelationshipLevel(person.timesMetWith || 1);
            
            content += `<div style="border: 1px solid #d4af37; padding: 15px; margin: 10px 0; border-radius: 8px; background: #fffef7;">`;
            content += `<strong>${person.name}</strong> (Age ${person.age})<br>`;
            content += `${person.personality.trait} ${person.background}<br>`;
            content += `Relationship: ${relationshipLevel}<br>`;
            content += `Times Met: ${person.timesMetWith || 1}<br><br>`;
            
            // Courtship options based on relationship level
            if (person.timesMetWith < 3) {
                content += `<button onclick="game.spendTimeWith(${index})">Spend Time Together (1 gold)</button>`;
            } else if (person.timesMetWith < 6) {
                content += `<button onclick="game.spendTimeWith(${index})">Spend Time Together (1 gold)</button><br>`;
                content += `<button onclick="game.giveGift(${index}, 'simple')">Give Simple Gift (5 gold)</button>`;
            } else {
                content += `<button onclick="game.spendTimeWith(${index})">Spend Time Together (1 gold)</button><br>`;
                content += `<button onclick="game.giveGift(${index}, 'simple')">Give Simple Gift (5 gold)</button><br>`;
                content += `<button onclick="game.giveGift(${index}, 'expensive')">Give Expensive Gift (20 gold)</button><br>`;
                
                if (person.timesMetWith >= 8) {
                    content += `<button onclick="game.proposeMarriage(${index})" style="background: #d4af37; color: #2c3e50; font-weight: bold;">Propose Marriage</button>`;
                }
            }
            content += `</div>`;
        });
    }
    
    content += '<br><button onclick="game.visitTavernNormally()">Just Have a Drink</button>';
    
    this.showActivityResult('üç∫ The Tavern', content);
}

visitTavernNormally() {
    // Temporarily clear potential spouses to trigger normal tavern visit
    const tempSpouses = this.characterData.potentialSpouses;
    this.characterData.potentialSpouses = [];
    this.visitTavern();
    this.characterData.potentialSpouses = tempSpouses;
}

spendTimeWith(spouseIndex) {
    // Chat is free but gives small social bonus
    const person = this.characterData.potentialSpouses[spouseIndex];
    person.timesMetWith = (person.timesMetWith || 1) + 1;
    
    this.characterData.stats.social += 0.1;
    
    const activities = [
        'walk through the market',
        'share stories over drinks',
        'attend a local festival', 
        'take a stroll by the harbor',
        'visit the local church'
    ];
    
    const activity = activities[Math.floor(Math.random() * activities.length)];
    
    this.showActivityResult('üíï Time Well Spent', 
        `You and ${person.name} ${activity}.<br><br>` +
        `You're getting to know each other better!<br><br>` +
        `<strong>Relationship:</strong> ${this.getRelationshipLevel(person.timesMetWith)}<br>` +
        `<em>+0.1 Social skill (free activity)</em>`);
}


getRelationshipLevel(timesMet) {
    if (timesMet <= 1) return 'Acquaintance';
    if (timesMet <= 3) return 'Friend';
    if (timesMet <= 6) return 'Close Friend';
    if (timesMet <= 8) return 'Romantic Interest';
    return 'Deep Affection';
}


                                
giveGift(spouseIndex, giftType) {
    const costs = { simple: 5, expensive: 20 };
    const cost = costs[giftType];
    
    if (this.characterData.stats.money < cost) {
        this.showActivityResult('üíî Not Enough Gold', `You need ${cost} gold for this gift.`);
        return;
    }
    
    this.characterData.stats.money -= cost;
    const person = this.characterData.potentialSpouses[spouseIndex];
    
    const simpleGifts = ['flowers', 'a book of poetry', 'fine handkerchief', 'small jewelry', 'bottle of wine'];
    const expensiveGifts = ['gold necklace', 'silk dress', 'rare perfume', 'silver mirror', 'expensive jewelry set'];
    
    const gifts = giftType === 'simple' ? simpleGifts : expensiveGifts;
    const gift = gifts[Math.floor(Math.random() * gifts.length)];
    
    // Gifts significantly boost relationship
    const boost = giftType === 'simple' ? 1 : 3;
    person.timesMetWith = (person.timesMetWith || 1) + boost;
    
    // Some gifts boost your social reputation
    if (giftType === 'expensive') {
        this.characterData.stats.social += 0.2;
        this.characterData.reputation.merchant += 1;
    }
    
    let reaction = '';
    if (person.timesMetWith >= 8) {
        reaction = `${person.name} is deeply touched by your generosity and seems quite fond of you.`;
    } else if (person.timesMetWith >= 5) {
        reaction = `${person.name} is delighted with the gift and clearly enjoys your company.`;
    } else {
        reaction = `${person.name} appreciates your thoughtful gesture.`;
    }
    
    this.showActivityResult('üéÅ Gift Given', 
        `You present ${person.name} with ${gift}.<br><br>` +
        `${reaction}<br><br>` +
        `<strong>Relationship:</strong> ${this.getRelationshipLevel(person.timesMetWith)}<br>` +
        (giftType === 'expensive' ? `<em>+0.2 Social skill, +1 Merchant reputation</em>` : ''));
}


showPortSpecificRomance(localSpouses) {
    let content = '<strong>üç∫ The Tavern - Local Connections</strong><br><br>';
    content += `You recognize some familiar faces from ${this.getLocationName(this.gameState.currentLocation)}...<br><br>`;
    
    localSpouses.forEach((person, index) => {
        const relationshipLevel = this.getRelationshipLevel(person.timesMetWith || 1);
        const globalIndex = this.characterData.potentialSpouses.indexOf(person);
        
        content += `<div style="border: 1px solid #d4af37; padding: 15px; margin: 10px 0; border-radius: 8px; background: #fffef7;">`;
        content += `<strong>${person.name}</strong> (Age ${person.age})<br>`;
        content += `${person.personality.trait} ${person.background}<br>`;
        content += `Relationship: ${relationshipLevel}<br><br>`;
        
        // Basic activities
content += `<button onclick="game.spendTimeWith(${globalIndex})">Chat Together (Free)</button> `;
content += `<button onclick="game.buyDrinks(${globalIndex})">Buy Drinks (3 gold)</button><br>`;

// Gift giving based on relationship level
if (person.timesMetWith >= 3) {
    content += `<button onclick="game.giveGift(${globalIndex}, 'simple')">Give Simple Gift (5 gold)</button> `;
}
if (person.timesMetWith >= 5) {
    content += `<button onclick="game.giveGift(${globalIndex}, 'expensive')">Give Expensive Gift (20 gold)</button><br>`;
    content += `<button onclick="game.inviteToRoom(${globalIndex})">Invite to Your Room (10 gold, advances day)</button><br>`;
}
        
        // Marriage option
        if (person.timesMetWith >= 8 && this.characterData.marriageStatus === 'single') {
            content += `<button onclick="game.proposeMarriage(${globalIndex})" style="background: #d4af37; color: #2c3e50; font-weight: bold;">Propose Marriage</button>`;
        }
        
        content += `</div>`;
    });
    
    content += '<br><strong>üé≤ Tavern Activities:</strong><br>';
    content += '<button onclick="game.tavernGambling()">Gambling (10 gold)</button><br><br>';
    content += '<button onclick="game.visitTavernNormally()">Just Have a Regular Drink</button>';
    
    this.showActivityResult('üç∫ The Tavern', content);
}
            
proposeMarriage(spouseIndex) {
    
// Prevent married people from proposing
if (this.characterData.marriageStatus === 'married') {
    this.showActivityResult('üíç Already Married!', 
        `You are already married to ${this.characterData.spouse.name}!<br><br>` +
        `<em>One spouse at a time in the 18th century!</em>`);
    return;
}

// Require home ownership for marriage
if (!this.gameState.ownedProperty) {
    this.showActivityResult('üè† Home Required!', 
        `You need to establish a home before you can propose marriage!<br><br>` +
        `A respectable spouse expects you to provide proper housing.<br><br>` +
        `<em>Visit the property market to purchase a home first.</em>`);
    return;
}
            
    const person = this.characterData.potentialSpouses[spouseIndex];
    
    // Calculate acceptance chance based on relationship, wealth, and reputation
    let acceptanceChance = 0.3; // Base 30%
    
    // Relationship bonus
    acceptanceChance += (person.timesMetWith - 8) * 0.1; // +10% per meeting above 8
    
    // Wealth requirements based on their background
    const wealthRequirements = {
        'modest': 100,
        'comfortable': 300,
        'wealthy': 500
    };
    
    const requiredWealth = wealthRequirements[person.wealth] || 200;
    if (this.characterData.stats.money >= requiredWealth) {
        acceptanceChance += 0.3; // +30% if you meet wealth requirements
    } else {
        acceptanceChance -= 0.2; // -20% if you don't
    }
    
    // Reputation bonuses
    if (person.reputation === 'merchant' && this.characterData.reputation.merchant >= 3) {
        acceptanceChance += 0.2;
    } else if (person.reputation === 'crown' && this.characterData.reputation.crown >= 3) {
        acceptanceChance += 0.2;
    }
    
    // Social skill bonus
    acceptanceChance += this.characterData.stats.social * 0.05;
    
    // Cap at 95%
    acceptanceChance = Math.min(0.95, acceptanceChance);
    
    if (Math.random() < acceptanceChance) {
        // Acceptance!
        this.characterData.marriageStatus = 'married';
        // Handle traditional naming conventions
let marriedSpouse = { ...person };

// If player is male and spouse is female, wife takes husband's last name
if (this.characterData.gender === 'male' && person.gender === 'female') {
    const spouseFirstName = marriedSpouse.name.split(' ')[0];
    marriedSpouse.name = `${spouseFirstName} ${this.characterData.lastName}`;
    marriedSpouse.maidenName = person.name; // Keep track of original name
} 
// If player is female and spouse is male, player takes husband's last name
else if (this.characterData.gender === 'female' && person.gender === 'male') {
    const playerFirstName = this.characterData.firstName;
    const spouseLastName = marriedSpouse.name.split(' ').slice(1).join(' ');
    
    // Update player's name and lastName
    this.characterData.name = `${playerFirstName} ${spouseLastName}`;
    this.characterData.lastName = spouseLastName;
    this.characterData.maidenName = `${playerFirstName} ${this.characterData.lastName}`; // Keep original
}

this.characterData.spouse = {
    ...marriedSpouse,
    marriageDate: { year: this.gameState.year, month: this.gameState.month }
};

// Initialize children system
this.characterData.children = [];
        
        // Remove from potential spouses
        this.characterData.potentialSpouses.splice(spouseIndex, 1);
        
        // Marriage benefits
        this.characterData.stats.social += 1;
        this.characterData.reputation.merchant += 2;
        
        // Wedding costs
        const weddingCost = Math.floor(Math.random() * 100) + 50;
        this.characterData.stats.money -= weddingCost;
        
        // Add naming convention note if applicable
        let namingNote = '';
        if (this.characterData.gender === 'male' && person.gender === 'female') {
            namingNote = `<br><br><em>${person.name.split(' ')[0]} is now ${marriedSpouse.name}</em>`;
        } else if (this.characterData.gender === 'female' && person.gender === 'male') {
            namingNote = `<br><br><em>You are now ${this.characterData.name}</em>`;
        }
        
        this.showEmergencyEvent('üíç Marriage!', 
            `${person.name} accepts your proposal!<br><br>` +
            `<strong>üéâ CONGRATULATIONS!</strong><br><br>` +
            `You are now married to ${marriedSpouse.name}!<br><br>` +
            `<strong>Wedding Arrangements:</strong><br>` +
            `‚Ä¢ Wedding cost: ${weddingCost} gold<br>` +
            `‚Ä¢ +1 Social skill<br>` +
            `‚Ä¢ +2 Merchant reputation<br><br>` +
            `<strong>Marriage Benefits:</strong><br>` +
            `‚Ä¢ Monthly allowance from spouse's family<br>` +
            `‚Ä¢ Improved social standing<br>` +
            `‚Ä¢ Potential for children<br><br>` +
            `<em>"I accept! Let's build a life together!"</em>${namingNote}`);
    } else {
        // Rejection
        this.showActivityResult('üíî Proposal Declined', 
            `${person.name} gently declines your proposal.<br><br>` +
            `"I'm honored, but I don't think we're quite ready for marriage yet. Perhaps we need more time to know each other."<br><br>` +
            `<strong>Suggestions:</strong><br>` +
            `‚Ä¢ Spend more time together<br>` +
            `‚Ä¢ Improve your wealth and reputation<br>` +
            `‚Ä¢ Give more thoughtful gifts<br><br>` +
            `<em>Don't give up! Love takes patience and effort.</em>`);
    }
}        


getMarriageLength(marriageDate) {
    const monthsMarried = (this.gameState.year - marriageDate.year) * 12 + (this.gameState.month - marriageDate.month);
    
    if (monthsMarried < 1) return 'Newlyweds';
    if (monthsMarried < 6) return `${monthsMarried} months`;
    if (monthsMarried < 12) return 'About a year';
    
    const years = Math.floor(monthsMarried / 12);
    const remainingMonths = monthsMarried % 12;
    
    if (years === 1) {
        return remainingMonths === 0 ? '1 year' : `1 year, ${remainingMonths} months`;
    } else {
        return remainingMonths === 0 ? `${years} years` : `${years} years, ${remainingMonths} months`;
    }
}

processChildrenEvents() {
    const spouse = this.characterData.spouse;
    
    // Age children first
    if (this.characterData.children && this.characterData.children.length > 0) {
        this.characterData.children.forEach(child => {
            child.ageInMonths++;
            
            // Check for age milestones
            if (child.ageInMonths === 12) {
                child.stage = 'toddler';
            } else if (child.ageInMonths === 60) { // 5 years
                child.stage = 'child';
            } else if (child.ageInMonths === 156) { // 13 years
                child.stage = 'teenager';
            } else if (child.ageInMonths === 216) { // 18 years
                child.stage = 'adult';
            }
        });
    }
    
    // Check for new children (only if wife is under 40)
    let femaleAge;
    if (this.characterData.gender === 'female') {
        femaleAge = this.characterData.age;
    } else {
        femaleAge = spouse.age;
    }
    
    // Only have children if the woman is under 40
    if (femaleAge < 40) {
        // Base 8% chance per month, modified by factors
        let childChance = 0.08;
        
        // Reduce chance if already have many children
        const currentChildren = this.characterData.children ? this.characterData.children.length : 0;
        if (currentChildren >= 3) {
            childChance *= 0.5; // 50% reduced chance after 3 children
        }
        
        // Age affects fertility
        if (femaleAge > 35) {
            childChance *= 0.6; // Reduced chance after 35
        }
        
        if (Math.random() < childChance) {
            this.createNewChild();
        }
    }
}

createNewChild() {
    const spouse = this.characterData.spouse;
    const childCount = this.characterData.children ? this.characterData.children.length : 0;
    
    // Generate child
    const firstNames = {
        male: ['William', 'Thomas', 'James', 'Charles', 'Robert', 'Henry', 'Edward', 'Benjamin', 'Samuel', 'Jonathan'],
        female: ['Elizabeth', 'Mary', 'Catherine', 'Margaret', 'Anne', 'Sarah', 'Jane', 'Charlotte', 'Eleanor', 'Rebecca']
    };
    
    const gender = Math.random() < 0.5 ? 'male' : 'female';

// Ask player to name the child
const genderText = gender === 'male' ? 'son' : 'daughter';
const suggestedNames = firstNames[gender].slice(0, 3).join(', '); // Show 3 suggestions
let firstName = prompt(
    `üçº Your ${genderText} needs a name!\n\nSuggested names: ${suggestedNames}\n\nWhat would you like to name your ${genderText}?`,
    firstNames[gender][0] // Default to first name in list
);

// Validate the name
if (!firstName || firstName.trim() === '') {
    firstName = firstNames[gender][0]; // Use default if empty
} else {
    firstName = firstName.trim();
}

const child = {
    name: `${firstName} ${this.characterData.lastName}`,
    firstName: firstName,
        gender: gender,
        ageInMonths: 0,
        stage: 'baby', // baby, toddler, child, teenager, adult
        birthDate: { year: this.gameState.year, month: this.gameState.month },
        personality: this.generateChildPersonality(),
        skills: { seamanship: 0, trading: 0, navigation: 0, leadership: 0, social: 0 }
    };
    
    if (!this.characterData.children) {
        this.characterData.children = [];
    }
    
    this.characterData.children.push(child);
    
    // Show birth announcement
    setTimeout(() => {
        this.showEmergencyEvent('üë∂ New Baby!', 
            `<strong>üéâ Congratulations!</strong><br><br>` +
            `${spouse.name} has given birth to a healthy baby ${gender === 'male' ? 'boy' : 'girl'}!<br><br>` +
            `<strong>üë∂ ${child.name}</strong><br>` +
            `Born: ${this.getDateString()}<br><br>` +
            `Your family is growing! This ${gender === 'male' ? 'son' : 'daughter'} will grow up to potentially help with your business or join your crew.<br><br>` +
            `<em>"A new chapter begins for the ${this.characterData.lastName} family!"</em>`);
    }, 5000); // Show after allowance notification
}

generateChildPersonality() {
    const traits = ['Adventurous', 'Studious', 'Brave', 'Clever', 'Kind', 'Ambitious', 'Artistic', 'Practical'];
    return {
        trait: traits[Math.floor(Math.random() * traits.length)],
        aptitude: Math.random() < 0.3 ? 'high' : Math.random() < 0.6 ? 'average' : 'low'
    };
}
         
generatePersonality() {
    const traits = [
        'Brave', 'Cautious', 'Cheerful', 'Grumpy', 'Loyal', 'Ambitious',
        'Steady', 'Hothead', 'Wise', 'Young', 'Veteran', 'Lucky',
        'Unlucky', 'Quiet', 'Talkative', 'Disciplined'
    ];
    
    const backgrounds = [
        'former naval sailor', 'merchant marine veteran', 'dock worker',
        'fisherman\'s son', 'escaped apprentice', 'reformed pirate',
        'coastal trader', 'ship carpenter', 'tavern brawler'
    ];
    
    return {
        trait: traits[Math.floor(Math.random() * traits.length)],
        background: backgrounds[Math.floor(Math.random() * backgrounds.length)]
    };
}

    
visitMarket() {
    this.setContext('market');
    const currentPrices = this.getLocationMarketPrices();
    const locationName = this.getLocationName(this.gameState.currentLocation);
    
    let content = '<strong>ü™ô Market</strong><br><br>';

// Add return button at the top
content += `<button onclick="game.smartReturn()" style="background: linear-gradient(145deg, #d4af37, #b8941f); border: 2px solid #8b7355; color: #2c3e50; font-size: 1em; font-weight: bold; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-bottom: 15px;">
    Return
</button><br><br>`;
    
    
    // Show inventory status
    const personalItems = this.getPersonalInventoryCount();
    content += `<div style="background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px;">`;
    content += `<strong>üì¶ Your Carrying Capacity:</strong> ${personalItems}/${this.gameState.personalInventoryLimit}<br>`;
    
    if (this.gameState.ownedShip && this.gameState.ownedShip.location === this.gameState.currentLocation) {
        const shipCargo = this.getShipCargoCount();
        content += `<strong>üö¢ "${this.gameState.ownedShip.shipName}" Cargo:</strong> ${shipCargo}/${this.gameState.ownedShip.cargo}`;
    }
    content += `</div>`;
    
    content += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
    
    // Buy section
    content += '<div><h4>üõí Buy Goods</h4>';
    Object.keys(currentPrices).forEach(good => {
        const info = this.goodsInfo[good];
        const price = currentPrices[good].buy;
        const canAfford = this.characterData.stats.money >= price;
        const hasSpace = personalItems < this.gameState.personalInventoryLimit;
        const hasShipSpace = this.gameState.ownedShip && 
            this.gameState.ownedShip.location === this.gameState.currentLocation &&
            this.getShipCargoCount() < this.getShipCargoCapacity();
        
        content += `<div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0;">
            <strong>${info.name}</strong> - ${price} gold each<br>
            <small>${info.description}</small><br>`;
        
        if (canAfford) {
            content += `<input type="number" id="qty_${good}" min="1" max="${Math.floor(this.characterData.stats.money / price)}" value="1" style="width: 60px; margin: 5px;"><br>`;
            
            if (hasSpace) {
                content += `<button onclick="game.buyGoodToInventory('${good}', ${price})" style="margin: 2px;">Buy to Inventory</button>`;
            }
            if (hasShipSpace) {
                content += `<button onclick="game.buyGoodToShip('${good}', ${price})" style="margin: 2px;">Buy to Ship</button>`;
            }
            if (!hasSpace && !hasShipSpace) {
                content += '<em>No storage space available</em>';
            }
        } else {
            content += `<button disabled>Buy (${price} gold)</button>`;
        }
        
        content += '</div>';
    });
    content += '</div>';
    
    // Sell section
    content += '<div><h4>üí∞ Sell Goods</h4>';
    
    // Personal inventory
    content += '<strong>From Personal Inventory:</strong><br>';
    const hasPersonalGoods = Object.keys(this.gameState.inventory).length > 0;
    
    if (hasPersonalGoods) {
        Object.keys(this.gameState.inventory).forEach(good => {
            const quantity = this.gameState.inventory[good];
            const info = this.goodsInfo[good];
            const price = currentPrices[good] ? currentPrices[good].sell : 0;
            
            if (quantity > 0) {
                content += `<div style="border: 1px solid #ccc; padding: 8px; margin: 3px 0;">
                    <strong>${info.name}</strong> (${quantity}) - ${price} gold each<br>
                    <button onclick="game.sellGood('${good}', ${price}, 'personal')">Sell 1</button>
                    <button onclick="game.sellAllGood('${good}', ${price}, 'personal')">Sell All</button>
                </div>`;
            }
        });
    } else {
        content += '<p><em>No personal goods to sell.</em></p>';
    }
    
    // Ship cargo (if ship is present)
    if (this.gameState.ownedShip && this.gameState.ownedShip.location === this.gameState.currentLocation) {
        content += '<br><strong>From Ship Cargo:</strong><br>';
        const hasShipGoods = Object.keys(this.gameState.ownedShip.cargoHold || {}).length > 0;
        
        if (hasShipGoods) {
            Object.keys(this.gameState.ownedShip.cargoHold).forEach(good => {
                const quantity = this.gameState.ownedShip.cargoHold[good];
                const info = this.goodsInfo[good];
                const price = currentPrices[good] ? currentPrices[good].sell : 0;
                
                if (quantity > 0) {
                    content += `<div style="border: 1px solid #ccc; padding: 8px; margin: 3px 0;">
                        <strong>${info.name}</strong> (${quantity}) - ${price} gold each<br>
                        <button onclick="game.sellGood('${good}', ${price}, 'ship')">Sell 1</button>
                        <button onclick="game.sellAllGood('${good}', ${price}, 'ship')">Sell All</button>
                    </div>`;
                }
            });
        } else {
            content += '<p><em>No ship cargo to sell.</em></p>';
        }
    }
    
    content += '</div></div>';
    
    this.showActivityResult('üè™ Market', content);
this.advanceTimeSafely(7) // No naval emergencies while shopping
}


buyGoodBulk(good, price) {
    const qtyInput = document.getElementById(`qty_${good}`);
    const quantity = parseInt(qtyInput.value) || 1;
    const totalCost = price * quantity;
    
    if (this.characterData.stats.money >= totalCost) {
        this.characterData.stats.money -= totalCost;
        
        if (!this.gameState.inventory[good]) {
            this.gameState.inventory[good] = 0;
        }
        this.gameState.inventory[good] += quantity;
        
        // Trading skill increase (more for bulk purchases)
        this.characterData.stats.trading += 0.1 * quantity;
        
        const goodName = this.goodsInfo[good].name;
        this.showActivityResult('üõí Bulk Purchase Complete', 
            `You bought ${quantity} ${goodName} for ${totalCost} gold total.<br><br><em>+${(0.1 * quantity).toFixed(1)} Trading skill</em>`);
        
        setTimeout(() => {
            this.visitMarket();
        }, 1500);
    }
}    
    

visitNavalOffice() {
    // Initialize naval career if not present
    if (!this.gameState.navalCareer) {
        this.gameState.navalCareer = {
            enlisted: false,
            rank: null,
            experience: 0,
            missions_completed: 0,
            prize_money: 0,
            current_mission: null,
            reputation: 0
        };
    }
    
    const naval = this.gameState.navalCareer;
    // Fix for destroyed ship during mission bug
if (naval.current_mission && (!this.gameState.ownedShip || this.gameState.ownedShip.condition <= 0)) {
    console.log('Clearing stuck naval mission - ship destroyed');
    naval.current_mission = null;
    // Player gets partial mission failure consequence
    naval.reputation = Math.max(0, naval.reputation - 2);
}
    let content = '<strong>‚öîÔ∏è His Majesty\'s Naval Recruitment Office</strong><br><br>';
    
    if (!naval.enlisted) {
        // Not in the Navy yet - recruitment
        content += 'A stern officer in naval uniform looks you over carefully.<br><br>';
        content += '"The Royal Navy offers opportunities for advancement to men of courage and skill. Are you prepared to serve King and Country?"<br><br>';
        
        content += '<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px;">';
        content += '<strong>Naval Service Benefits:</strong><br>';
        content += '‚Ä¢ Regular pay (based on rank)<br>';
        content += '‚Ä¢ Prize money from captured enemy ships<br>';
        content += '‚Ä¢ Access to military vessels<br>';
        content += '‚Ä¢ Rapid skill development<br>';
        content += '‚Ä¢ Crown reputation and social standing<br>';
        content += '</div>';
        
        content += '<strong>Entry Requirements:</strong><br>';
        if (this.characterData.stats.seamanship >= 1) {
            content += '‚úÖ Seamanship: ' + this.characterData.stats.seamanship.toFixed(1) + '/1.0<br>';
        } else {
            content += '‚ùå Seamanship: ' + this.characterData.stats.seamanship.toFixed(1) + '/1.0 (Need more experience)<br>';
        }
        
        if (this.characterData.reputation.crown >= 0) {
            content += '‚úÖ No criminal record<br><br>';
        } else {
            content += '‚ùå Criminal record prevents enlistment<br><br>';
        }
        
        const canEnlist = this.characterData.stats.seamanship >= 1 && this.characterData.reputation.crown >= 0;
        
        if (canEnlist) {
            content += '<button onclick="game.enlistInNavy()">Enlist in the Royal Navy</button>';
        } else {
            content += '<em>Return when you meet the requirements.</em>';
        }
        
    } else {
        // Already in the Navy - show career status and missions
        const ranks = ['Seaman', 'Able Seaman', 'Midshipman', 'Lieutenant', 'Commander', 'Captain', 'Admiral'];
        const rankIndex = Math.min(this.getNavalRankFromExperience(naval.experience), ranks.length - 1);
        const currentRank = ranks[rankIndex];
        
        content += `Welcome back, ${currentRank} ${this.characterData.name}!<br><br>`;
        
        // Show naval status
        content += '<div style="background: #e8f4f8; padding: 15px; margin: 10px 0; border-radius: 8px; border: 2px solid #3498db;">';
        content += `<strong>‚öì Naval Career Status</strong><br>`;
        content += `Rank: ${currentRank}<br>`;
        content += `Experience: ${naval.experience}<br>`;
        content += `Missions Completed: ${naval.missions_completed}<br>`;
        content += `Total Prize Money Earned: ${naval.prize_money} gold<br>`;
        content += `Naval Reputation: ${naval.reputation}<br>`;
        content += '</div>';
        
        if (naval.current_mission) {
            content += '<div style="background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 8px; border: 2px solid #ffc107;">';
            content += '<strong>üö¢ Current Mission</strong><br>';
            content += `${naval.current_mission.name}<br>`;
            content += `Status: ${naval.current_mission.status}<br>`;
            content += '</div>';
        } else {
            // Show available missions
            content += '<strong>üìã Available Naval Missions:</strong><br><br>';
            content += this.generateNavalMissions(rankIndex);
        }
        
        content += '<br><button onclick="game.requestNavalLeave()">Request Shore Leave</button>';
    }
    
    this.showActivityResult('‚öîÔ∏è Naval Recruitment Office', content);
this.advanceQuickTime(1)
}

enlistInNavy() {
    this.gameState.navalCareer.enlisted = true;
    this.gameState.navalCareer.rank = 'Seaman';
    this.gameState.navalCareer.experience = 0;
    
    // Initial naval bonuses
    this.characterData.stats.seamanship += 0.5;
    this.characterData.stats.leadership += 0.3;
    this.characterData.reputation.crown += 2;
    
    // Starting naval pay
    this.characterData.stats.money += 25; // Enlistment bonus
    
    this.showActivityResult('üéâ Welcome to the Royal Navy!', 
        `Congratulations! You have been sworn in as a Seaman in His Majesty\'s Royal Navy.<br><br>` +
        `<strong>Immediate Benefits:</strong><br>` +
        `‚Ä¢ +25 gold enlistment bonus<br>` +
        `‚Ä¢ +0.5 Seamanship skill<br>` +
        `‚Ä¢ +0.3 Leadership skill<br>` +
        `‚Ä¢ +2 Crown reputation<br><br>` +
        `<strong>Your Naval Career Begins:</strong><br>` +
        `‚Ä¢ Report to Naval Office for missions<br>` +
        `‚Ä¢ Earn experience through successful missions<br>` +
        `‚Ä¢ Advance through the ranks for better pay and ships<br>` +
        `‚Ä¢ Prize money from captured enemy vessels<br><br>` +
        `<em>"God save the King! May your service bring glory to the Empire!"</em>`);
    
    setTimeout(() => {
        this.visitNavalOffice();
    }, 6000);
}
    

generateNavalMissions(rankIndex) {
        const missions = this.getAllNavalMissions();
    
    // Filter missions by rank and show appropriate ones
    const availableMissions = missions.filter(mission => 
        rankIndex >= mission.requirements.rank && 
        !this.gameState.navalCareer.current_mission
    );
    
    let content = '';
    
    if (availableMissions.length === 0) {
        content = '<em>No missions available at your current rank. Continue serving to advance!</em>';
    } else {
availableMissions.forEach(mission => {
            const riskLevel = mission.difficulty;
            const riskColor = {
                'Easy': '#28a745',
                'Medium': '#ffc107', 
                'Hard': '#fd7e14',
                'Very Hard': '#dc3545',
                'Legendary': '#6f42c1'
            }[riskLevel];
            
            content += `<div style="border: 2px solid ${riskColor}; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
            content += `<strong>${mission.name}</strong> <span style="color: ${riskColor}; font-weight: bold;">[${mission.difficulty}]</span><br>`;
            content += `${mission.description}<br><br>`;
            content += `<strong>Mission Details:</strong><br>`;
            content += `‚Ä¢ Duration: ${mission.duration} days<br>`;
            content += `‚Ä¢ Base Pay: ${mission.rewards.pay} gold<br>`;
            content += `‚Ä¢ Experience: +${mission.rewards.experience}<br>`;
            content += `‚Ä¢ Reputation: +${mission.rewards.reputation}<br>`;
            if (mission.rewards.prize_chance) {
                content += `‚Ä¢ Prize Money Chance: ${(mission.rewards.prize_chance * 100).toFixed(0)}%<br>`;
            }
            content += `<br><button onclick="game.acceptNavalMission('${mission.id}')">Accept Mission</button>`;
            content += `</div>`;
        });
    }
    
    return content;
}


acceptNavalMission(missionId) {
    // Prevent multiple clicks
    if (this.gameState.navalCareer.current_mission) {
        return; // Already on a mission
    }
    
    const missions = this.getAllNavalMissions();
    const mission = missions.find(m => m.id === missionId);
    
    this.gameState.navalCareer.current_mission = {
        ...mission,
        status: 'In Progress',
        start_date: { year: this.gameState.year, month: this.gameState.month }
    };
    
    this.showActivityResult('‚öîÔ∏è Mission Accepted', 
        `You have accepted the mission: <strong>${mission.name}</strong><br><br>` +
        `Duration: ${mission.duration} days<br>` +
        `Difficulty: ${mission.difficulty}<br><br>` +
        `Your ship departs immediately. May fair winds and good fortune be with you!<br><br>` +
        `<em>Mission results will be available when you return...</em>`);
    
    // Advance time for mission duration
    this.advanceRegularTime(mission.duration);
    
    // Process mission outcome after delay
    // Start interactive mission events
setTimeout(() => {
    this.startMissionEvents(mission);
}, 500);
}


getAllNavalMissions() {
    return [
        // Seaman/Able Seaman missions (rank 0-1)
        {
            id: 'patrol_duty',
            name: 'Coastal Patrol',
            description: 'Patrol the English coast for smugglers and pirates',
            duration: 7,
            difficulty: 'Easy',
            requirements: { rank: 0 },
            rewards: { experience: 3, pay: 15, reputation: 1 },
            risks: { low_damage: 0.1 }
        },
        {
            id: 'merchant_escort',
            name: 'Merchant Escort',
            description: 'Escort a merchant convoy through pirate-infested waters',
            duration: 10,
            difficulty: 'Easy',
            requirements: { rank: 0 },
            rewards: { experience: 4, pay: 20, reputation: 2 },
            risks: { pirate_encounter: 0.3, low_damage: 0.2 }
        },
        
        // Midshipman missions (rank 2+)
        {
            id: 'blockade_runner',
            name: 'Blockade Duty',
            description: 'Maintain naval blockade against enemy ports',
            duration: 14,
            difficulty: 'Medium',
            requirements: { rank: 2 },
            rewards: { experience: 8, pay: 40, reputation: 3, prize_chance: 0.4 },
            risks: { combat: 0.4, medium_damage: 0.3 }
        },
        {
            id: 'pirate_hunt',
            name: 'Pirate Hunter',
            description: 'Hunt down notorious pirates in the Caribbean',
            duration: 21,
            difficulty: 'Medium',
            requirements: { rank: 2 },
            rewards: { experience: 12, pay: 60, reputation: 5, prize_chance: 0.6 },
            risks: { combat: 0.6, medium_damage: 0.4 }
        },
        
        // Lieutenant/Commander missions (rank 3-4)
        {
            id: 'enemy_raid',
            name: 'Enemy Port Raid',
            description: 'Lead a daring raid on an enemy colonial port',
            duration: 28,
            difficulty: 'Hard',
            requirements: { rank: 3 },
            rewards: { experience: 18, pay: 100, reputation: 8, prize_chance: 0.8 },
            risks: { combat: 0.7, high_damage: 0.5, casualties: 0.3 }
        },
        {
            id: 'treasure_fleet',
            name: 'Spanish Treasure Fleet',
            description: 'Intercept the Spanish treasure fleet from the Americas',
            duration: 35,
            difficulty: 'Very Hard',
            requirements: { rank: 4 },
            rewards: { experience: 25, pay: 200, reputation: 12, prize_chance: 0.9, treasure_bonus: 500 },
            risks: { combat: 0.8, high_damage: 0.6, casualties: 0.4 }
        },
        
        // Captain/Admiral missions (rank 5-6)
        {
            id: 'fleet_command',
            name: 'Fleet Command',
            description: 'Command a squadron in a major naval battle',
            duration: 42,
            difficulty: 'Legendary',
            requirements: { rank: 5 },
            rewards: { experience: 35, pay: 400, reputation: 20, prize_chance: 1.0, promotion_chance: 0.3 },
            risks: { major_combat: 0.9, ship_loss: 0.2, heavy_casualties: 0.5 }
        },
      // Add these to the end of your missions array in getAllNavalMissions():
{
    id: 'squadron_patrol',
    name: 'Squadron Patrol Command',
    description: 'Command a squadron of 3 ships on anti-piracy patrol',
    duration: 21,
    difficulty: 'Hard',
    requirements: { rank: 4 }, // Commander
    rewards: { experience: 20, pay: 150, reputation: 10, prize_chance: 0.7, fleet_bonus: 100 },
    risks: { combat: 0.6, medium_damage: 0.3, squadron_risk: 0.2 }
},
{
    id: 'blockade_command',
    name: 'Blockade Fleet Command',
    description: 'Lead a blockade of enemy ports with 5 ships',
    duration: 28,
    difficulty: 'Very Hard',
    requirements: { rank: 5 }, // Captain
    rewards: { experience: 30, pay: 250, reputation: 15, prize_chance: 0.8, strategic_bonus: 200 },
    risks: { combat: 0.7, medium_damage: 0.4, political_risk: 0.3 }
},
{
    id: 'grand_fleet_battle',
    name: 'Grand Fleet Battle',
    description: 'Lead the main battle line in a massive fleet engagement',
    duration: 35,
    difficulty: 'Legendary',
    requirements: { rank: 6 }, // Admiral only
    rewards: { experience: 50, pay: 500, reputation: 25, prize_chance: 1.0, promotion_chance: 0.5, historic_bonus: 1000 },
    risks: { major_combat: 0.8, ship_loss: 0.3, heavy_casualties: 0.6, political_risk: 0.2 }
}  
    ];
}
    

    
processNavalMissionOutcome(mission, forceSuccess = null) {
    const naval = this.gameState.navalCareer;
    // If combat already determined the outcome, use that result
    // Safety check for rapid clicking after mission completion
if (!naval || naval.experience === undefined || naval.experience === null) {
    console.warn('Naval career data incomplete, reinitializing...');
    this.gameState.navalCareer = {
        enlisted: false,
        rank: null,
        experience: 0,
        missions_completed: 0,
        prize_money: 0,
        current_mission: null,
        reputation: 0
    };
    naval = this.gameState.navalCareer;
}
if (forceSuccess !== null) {
    this.displayMissionResults(mission, forceSuccess);
    return;
}
    
    // Calculate success based on player skills and mission difficulty
    let successChance = 0.7; // Base 70% success rate
    
    // Skill bonuses
    successChance += this.characterData.stats.seamanship * 0.05;
    successChance += this.characterData.stats.leadership * 0.05;
    successChance += this.characterData.stats.navigation * 0.03;
    
    // Experience bonus
    successChance += naval.experience * 0.01;
    
    // Ship condition bonus (if player has ship)
    if (this.gameState.ownedShip) {
        successChance += (this.gameState.ownedShip.condition / 100) * 0.1;
    }
    
    // Difficulty penalty
    const difficultyPenalty = {
        'Easy': 0,
        'Medium': -0.1,
        'Hard': -0.2,
        'Very Hard': -0.3,
        'Legendary': -0.4
    }[mission.difficulty];
    successChance += difficultyPenalty;
    
    const success = Math.random() < Math.max(0.2, Math.min(0.95, successChance));
    
    this.displayMissionResults(mission, success);
}

requestNavalLeave() {
    const naval = this.gameState.navalCareer;
    
    let content = '<strong>üèñÔ∏è Request Shore Leave</strong><br><br>';
    content += '"What type of leave are you requesting, officer?"<br><br>';
    
    // Different types of leave based on rank and service
    const ranks = ['Seaman', 'Able Seaman', 'Midshipman', 'Lieutenant', 'Commander', 'Captain', 'Admiral'];
    const rankIndex = Math.min(this.getNavalRankFromExperience(naval.experience), ranks.length - 1);
    const currentRank = ranks[rankIndex];
    
    content += '<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px;">';
    content += `<strong>Your Status:</strong> ${currentRank}<br>`;
    content += `Naval Experience: ${naval.experience}<br>`;
    content += `Missions Completed: ${naval.missions_completed}<br>`;
    content += '</div>';
    
    // Short Leave (always available)
    content += '<div style="border: 1px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">';
    content += '<strong>üåä Short Shore Leave</strong> (7 days)<br>';
    content += 'Brief leave for personal business and rest.<br>';
    content += '‚Ä¢ Return to civilian activities temporarily<br>';
    content += '‚Ä¢ Naval career remains active<br>';
    content += '‚Ä¢ No penalty to naval status<br><br>';
    content += '<button onclick="game.takeShoreLeave(7)">Request Short Leave</button>';
    content += '</div>';
    
    // Extended Leave (requires good standing)
    if (naval.missions_completed >= 3 && naval.reputation >= 5) {
        content += '<div style="border: 1px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">';
        content += '<strong>üèñÔ∏è Extended Shore Leave</strong> (30 days)<br>';
        content += 'Extended leave for major personal affairs.<br>';
        content += '‚Ä¢ Longer break from naval duties<br>';
        content += '‚Ä¢ Small reputation penalty (-1)<br>';
        content += '‚Ä¢ Requires good service record<br><br>';
        content += '<button onclick="game.takeShoreLeave(30)">Request Extended Leave</button>';
        content += '</div>';
    } else {
        content += '<div style="border: 1px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px; opacity: 0.6;">';
        content += '<strong>üèñÔ∏è Extended Shore Leave</strong> (30 days)<br>';
        content += '<em>Requires: 3+ missions completed and 5+ naval reputation</em><br>';
        content += '</div>';
    }
    
    // Medical Leave (if player ship is damaged)
    if (this.gameState.ownedShip && this.gameState.ownedShip.condition < 70) {
        content += '<div style="border: 1px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">';
        content += '<strong>üè• Medical/Repair Leave</strong> (14 days)<br>';
        content += 'Leave to repair your vessel and recover from injuries.<br>';
        content += '‚Ä¢ Ship condition automatically improved<br>';
        content += '‚Ä¢ Health and morale restoration<br>';
        content += '‚Ä¢ No reputation penalty<br><br>';
        content += '<button onclick="game.takeMedicalLeave()">Request Medical Leave</button>';
        content += '</div>';
    }
    
    // Honorable Discharge (high rank only)
    if (rankIndex >= 4) { // Commander or higher
        content += '<div style="border: 2px solid #6f42c1; padding: 15px; margin: 10px 0; border-radius: 8px;">';
        content += '<strong>üéñÔ∏è Request Honorable Discharge</strong><br>';
        content += 'Leave naval service with full honors.<br>';
        content += '‚Ä¢ Retain all naval benefits and reputation<br>';
        content += '‚Ä¢ Receive pension based on rank and service<br>';
        content += '‚Ä¢ Can re-enlist later if desired<br>';
        content += '‚Ä¢ Special "Naval Veteran" status<br><br>';
        content += '<button onclick="game.requestDischarge()">Request Discharge</button>';
        content += '</div>';
    }
    
    this.showActivityResult('üèñÔ∏è Naval Leave Options', content);
}


displayMissionResults(mission, success) {
    const naval = this.gameState.navalCareer;
    
    // Clear current mission
    naval.current_mission = null;
    naval.missions_completed++;
    
    // Declare oldExperience ONCE at the top
    const oldExperience = naval.experience;
    
    let resultText = `<strong>‚öîÔ∏è Mission Complete: ${mission.name}</strong><br><br>`;
    
    if (success) {
        // Success!
        this.characterData.stats.money += mission.rewards.pay;
        
        // Base mission experience scaled by difficulty
        let missionExperience = 1; // Base for Easy missions
        if (mission.difficulty === 'Medium') missionExperience = 2;
        if (mission.difficulty === 'Hard') missionExperience = 3;
        if (mission.difficulty === 'Very Hard') missionExperience = 4;
        if (mission.difficulty === 'Legendary') missionExperience = 5;
        
        naval.experience += missionExperience;
        naval.reputation += mission.rewards.reputation;
        
        resultText += `<strong>üéâ MISSION SUCCESS!</strong><br><br>`;
        resultText += `<strong>Rewards:</strong><br>`;
        resultText += `‚Ä¢ ${mission.rewards.pay} gold<br>`;
        resultText += `‚Ä¢ +${missionExperience} naval experience<br>`;
        resultText += `‚Ä¢ +${mission.rewards.reputation} naval reputation<br>`;
        
        // Prize money chance
        if (mission.rewards.prize_chance && Math.random() < mission.rewards.prize_chance) {
            const prizeMoney = Math.floor(Math.random() * 200) + 100;
            this.characterData.stats.money += prizeMoney;
            resultText += `‚Ä¢ ${prizeMoney} gold prize money!<br>`;
        }
        
        // Special bonuses
        if (mission.rewards.treasure_bonus) {
            this.characterData.stats.money += mission.rewards.treasure_bonus;
            resultText += `‚Ä¢ ${mission.rewards.treasure_bonus} gold treasure bonus!<br>`;
        }
        
        resultText += `<br><em>"Well done! The Admiralty is pleased with your service."</em>`;
        
    } else {
        // Failure
        const partialPay = Math.floor(mission.rewards.pay * 0.3);
        this.characterData.stats.money += partialPay;
        naval.experience += 1;
        naval.reputation -= 1;
        
        resultText += `<strong>‚ö†Ô∏è MISSION DIFFICULTIES</strong><br><br>`;
        resultText += `Your mission encountered serious problems.<br><br>`;
        resultText += `<strong>Partial Compensation:</strong><br>`;
        resultText += `‚Ä¢ ${partialPay} gold (partial pay)<br>`;
        resultText += `‚Ä¢ +1 naval experience (lessons learned)<br>`;
        resultText += `‚Ä¢ -1 naval reputation<br><br>`;
        resultText += `<em>"The Navy expects better results, officer."</em>`;
    }
    
    // Check for promotion ONCE at the end
    this.checkNavalPromotion(oldExperience, naval.experience);
    
    this.showEmergencyEvent('‚öîÔ∏è Naval Mission Report', resultText);
}


startMissionEvents(mission) {
    // Different mission types have different events
    switch(mission.id) {
        case 'patrol_duty':
            this.coastalPatrolEvent(mission);
            break;
        case 'merchant_escort':
            this.merchantEscortEvent(mission);
            break;
        case 'pirate_hunt':
            this.navalPirateHuntEvent(mission);
            break;
        default:
            this.genericMissionEvent(mission);
    }
}

coastalPatrolEvent(mission) {
    let content = `<strong>üåä Coastal Patrol - Day ${Math.floor(mission.duration / 2)}</strong><br><br>`;
    content += `Your ship patrols the English coast, watching for smugglers and pirates.<br><br>`;
    content += `Suddenly, your lookout shouts: "Ship on the horizon, Captain! Looks suspicious!"<br><br>`;
    content += `<strong>What are your orders?</strong><br><br>`;
    
    content += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>‚öîÔ∏è PURSUE AND ENGAGE</strong><br>`;
    content += `Chase down the suspicious vessel!<br>`;
    content += `<em>Risk: Combat, ship damage | Reward: Prize money, reputation</em><br>`;
    content += `<button onclick="game.coastalPatrolChoice('pursue', '${mission.id}')">Full speed ahead!</button>`;
    content += `</div>`;
    
    content += `<div style="border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üîç CAREFUL INVESTIGATION</strong><br>`;
    content += `Approach cautiously and demand identification.<br>`;
    content += `<em>Lower risk but smaller rewards</em><br>`;
    content += `<button onclick="game.coastalPatrolChoice('investigate', '${mission.id}')">Signal them to stop</button>`;
    content += `</div>`;
    
    content += `<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üìã CONTINUE PATROL</strong><br>`;
    content += `Too distant to engage - continue regular patrol.<br>`;
    content += `<em>Safe but no bonus rewards</em><br>`;
    content += `<button onclick="game.coastalPatrolChoice('continue', '${mission.id}')">Maintain course</button>`;
    content += `</div>`;
    
    this.showEmergencyEvent('üåä Naval Patrol Decision', content);
}

merchantEscortEvent(mission) {
    let content = `<strong>üö¢ Merchant Escort - Mid-Journey</strong><br><br>`;
    content += `You're escorting a valuable merchant convoy when pirates attack!<br><br>`;
    content += `"Three pirate ships approaching from the starboard bow!" shouts your navigator.<br><br>`;
    content += `<strong>Battle stations! What are your orders?</strong><br><br>`;
    
    content += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
content += `<strong>‚öîÔ∏è FIGHT THE PIRATES</strong><br>`;
content += `One pirate ship attacks the convoy!<br>`;
content += `<em>Protect the merchants!</em><br>`;
content += `<button onclick="game.navalMissionCombat('${mission.id}')">Battle stations!</button>`;
content += `</div>`;
    
    content += `<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üõ°Ô∏è DEFENSIVE FORMATION</strong><br>`;
    content += `Form up around the merchants and wait for them to attack.<br>`;
    content += `<em>Safer but pirates may escape with some cargo</em><br>`;
    content += `<button onclick="game.merchantEscortChoice('defend', '${mission.id}')">Protect the convoy!</button>`;
    content += `</div>`;
    
    this.showEmergencyEvent('üè¥‚Äç‚ò†Ô∏è Pirates Attack Convoy!', content);
}

navalPirateHuntEvent(mission) {
    let content = `<strong>üè¥‚Äç‚ò†Ô∏è Pirate Hunt - Target Sighted!</strong><br><br>`;
    content += `Your mission has led you to a notorious pirate captain!<br><br>`;
    content += `"That's the 'Bloody Revenge' - one of the most wanted ships in these waters!"<br><br>`;
    content += `<strong>This could make your career... or end it.</strong><br><br>`;
    
    content += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>‚öîÔ∏è ATTACK IMMEDIATELY</strong><br>`;
    content += `Strike fast before they can escape or call for help!<br>`;
    content += `<em>Full pirate combat with naval bonuses</em><br>`;
    content += `<button onclick="game.navalMissionCombat('${mission.id}')">Attack! For King and Country!</button>`;
    content += `</div>`;
    
    this.showEmergencyEvent('üè¥‚Äç‚ò†Ô∏è Notorious Pirate Spotted!', content);
}


coastalPatrolChoice(choice, missionId) {
    const mission = this.getAllNavalMissions().find(m => m.id === missionId);
    let resultText = '';
    
    if (choice === 'pursue') {
        // 60% chance of finding smugglers/pirates
        if (Math.random() < 0.6) {
            resultText = `<strong>‚öîÔ∏è Smugglers Caught!</strong><br><br>` +
                `Your aggressive pursuit pays off! You've caught a smuggling vessel red-handed.<br><br>` +
                `<strong>Bonus Rewards:</strong><br>` +
                `‚Ä¢ +50 gold (confiscated contraband)<br>` +
                `‚Ä¢ +2 Naval reputation<br>` +
                `‚Ä¢ +0.2 Leadership skill<br><br>` +
                `<em>The Admiralty will be pleased with your initiative!</em>`;
            
            this.characterData.stats.money += 50;
            this.gameState.navalCareer.reputation += 2;
            this.characterData.stats.leadership += 0.2;
        } else {
            resultText = `<strong>‚ö†Ô∏è False Alarm</strong><br><br>` +
                `The ship was just a legitimate merchant - your aggressive pursuit causes a diplomatic incident.<br><br>` +
                `<strong>Consequences:</strong><br>` +
                `‚Ä¢ -1 Naval reputation<br>` +
                `‚Ä¢ Formal reprimand<br><br>` +
                `<em>"More caution next time, officer."</em>`;
            
            this.gameState.navalCareer.reputation -= 1;
        }
    } else if (choice === 'investigate') {
        // 40% chance of finding something, but smaller rewards
        if (Math.random() < 0.4) {
            resultText = `<strong>üîç Suspicious Cargo Found</strong><br><br>` +
                `Your careful investigation reveals minor contraband.<br><br>` +
                `<strong>Modest Rewards:</strong><br>` +
                `‚Ä¢ +20 gold<br>` +
                `‚Ä¢ +1 Naval reputation<br><br>` +
                `<em>Steady police work - the backbone of naval service.</em>`;
            
            this.characterData.stats.money += 20;
            this.gameState.navalCareer.reputation += 1;
        } else {
            resultText = `<strong>‚úÖ Legitimate Vessel</strong><br><br>` +
                `Your investigation reveals the ship is completely legitimate.<br><br>` +
                `No rewards, but no problems either. You continue your patrol professionally.`;
        }
    } else {
        resultText = `<strong>üìã Patrol Continued</strong><br><br>` +
            `You maintain your regular patrol route without incident.<br><br>` +
            `Sometimes the most important naval work is simply showing the flag.`;
    }
    
    this.showEmergencyEvent('üåä Patrol Result', resultText);
    
    // Complete mission after 3 seconds
    this.hideEmergencyEvent();
// Force success if we caught smugglers, otherwise normal calculation
const forceSuccess = choice === 'pursue' && resultText.includes('Smugglers Caught!');
this.processNavalMissionOutcome(mission, forceSuccess || null);
}

merchantEscortChoice(choice, missionId) {
    const mission = this.getAllNavalMissions().find(m => m.id === missionId);
    
    if (choice === 'defend') {
        const success = Math.random() < 0.7; // 70% success for defensive action
        
        let resultText = '';
        if (success) {
            resultText = `<strong>üõ°Ô∏è Convoy Protected!</strong><br><br>` +
                `Your defensive formation works! The pirates can't break through your screen.<br><br>` +
                `<strong>Success:</strong><br>` +
                `‚Ä¢ All merchant ships safe<br>` +
                `‚Ä¢ +30 gold bonus from grateful merchants<br>` +
                `‚Ä¢ +1 Naval reputation<br><br>` +
                `<em>"Thank you, Captain! Our cargo is safe because of you!"</em>`;
            
            this.characterData.stats.money += 30;
            this.gameState.navalCareer.reputation += 1;
        } else {
            resultText = `<strong>‚ö†Ô∏è Partial Success</strong><br><br>` +
                `The pirates manage to capture one merchant ship before fleeing.<br><br>` +
                `<strong>Mixed Results:</strong><br>` +
                `‚Ä¢ 2 of 3 ships saved<br>` +
                `‚Ä¢ +10 gold (reduced payment)<br>` +
                `‚Ä¢ Mission still counts as success<br><br>` +
                `<em>You did your best under difficult circumstances.</em>`;
            
            this.characterData.stats.money += 10;
        }
        
        this.showEmergencyEvent('üö¢ Escort Mission Result', resultText);
    }
}

navalMissionCombat(missionId) {
    // Store mission ID for after combat
    this.currentNavalMission = missionId;
    
    // Set naval combat flag for bonuses
    this.isNavalMissionCombat = true;
    
    // Clear any existing combat state first
    this.combatState = null;
    this.enemyShip = null;
    
    console.log('Starting naval mission combat for:', missionId);
    
    // Start the full pirate combat system
    this.hideEmergencyEvent();
    this.handlePirateAttack();
}

genericMissionEvent(mission) {
    let content = `<strong>‚öîÔ∏è ${mission.name} - Critical Moment</strong><br><br>`;
    content += `Your mission reaches a crucial decision point.<br><br>`;
    content += `<strong>How do you proceed?</strong><br><br>`;
    
    content += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>‚öîÔ∏è AGGRESSIVE APPROACH</strong><br>`;
    content += `Take bold action to ensure mission success.<br>`;
    content += `<em>Higher risk, higher reward</em><br>`;
    content += `<button onclick="game.genericMissionChoice('aggressive', '${mission.id}')">Bold Action</button>`;
    content += `</div>`;
    
    content += `<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üõ°Ô∏è CAUTIOUS APPROACH</strong><br>`;
    content += `Proceed carefully to minimize risks.<br>`;
    content += `<em>Safer but smaller rewards</em><br>`;
    content += `<button onclick="game.genericMissionChoice('cautious', '${mission.id}')">Careful Planning</button>`;
    content += `</div>`;
    
    this.showEmergencyEvent('‚öîÔ∏è Mission Decision', content);
}

genericMissionChoice(choice, missionId) {
    const mission = this.getAllNavalMissions().find(m => m.id === missionId);
    
    if (choice === 'aggressive') {
        const success = Math.random() < 0.6; // 60% success for aggressive
        
        if (success) {
            const bonus = Math.floor(mission.rewards.pay * 0.5);
            this.characterData.stats.money += bonus;
            this.gameState.navalCareer.reputation += 2;
            
            this.showEmergencyEvent('üéâ Bold Success!', 
                `Your aggressive tactics pay off handsomely!<br><br>` +
                `<strong>Bonus Rewards:</strong><br>` +
                `‚Ä¢ +${bonus} gold bonus<br>` +
                `‚Ä¢ +2 Naval reputation<br><br>` +
                `<em>"Outstanding initiative, officer!"</em>`);
        } else {
            this.gameState.navalCareer.reputation -= 1;
            this.showEmergencyEvent('‚ö†Ô∏è Risky Gamble Failed', 
                `Your bold approach backfires and causes complications.<br><br>` +
                `<strong>Setback:</strong><br>` +
                `‚Ä¢ -1 Naval reputation<br>` +
                `‚Ä¢ Mission still completes but with reduced rewards<br><br>` +
                `<em>Sometimes caution is the better part of valor.</em>`);
        }
    } else {
        this.showEmergencyEvent('‚úÖ Steady Progress', 
            `Your careful approach ensures solid, reliable success.<br><br>` +
            `<strong>Reliable Results:</strong><br>` +
            `‚Ä¢ Mission completed safely<br>` +
            `‚Ä¢ Standard rewards earned<br><br>` +
            `<em>Professional naval service at its finest.</em>`);
    }
    
    setTimeout(() => {
        this.hideEmergencyEvent();
        // Force success if the choice succeeded
const forceSuccess = choice === 'aggressive' ? resultText.includes('Bold Success!') : true;
this.processNavalMissionOutcome(mission, forceSuccess);
    }, 4000);
}

    

    
takeShoreLeave(days) {
    const naval = this.gameState.navalCareer;
    
    if (days === 30) {
        naval.reputation -= 1; // Small penalty for extended leave
    }
    
this.advanceRegularTime(mission.duration);
    
    let resultText = `<strong>üèñÔ∏è Shore Leave Granted</strong><br><br>`;
    resultText += `Your commanding officer approves your ${days}-day shore leave.<br><br>`;
    resultText += `"Take the time you need, ${this.getCurrentNavalRank()}. The Navy will be here when you return."<br><br>`;
    
    if (days === 7) {
        resultText += `<strong>Short Leave Benefits:</strong><br>`;
        resultText += `‚Ä¢ Rest and relaxation (+0.1 to all skills)<br>`;
        resultText += `‚Ä¢ No naval obligations for ${days} days<br>`;
        
        // Small skill bonus for rest
        this.characterData.stats.seamanship += 0.1;
        this.characterData.stats.trading += 0.1;
        this.characterData.stats.navigation += 0.1;
        this.characterData.stats.leadership += 0.1;
        this.characterData.stats.social += 0.1;
        
    } else if (days === 30) {
        resultText += `<strong>Extended Leave:</strong><br>`;
        resultText += `‚Ä¢ ${days} days of freedom<br>`;
        resultText += `‚Ä¢ -1 naval reputation (absence noted)<br>`;
        resultText += `‚Ä¢ Significant time for personal projects<br>`;
    }
    
    resultText += `<br><em>You are now free to pursue civilian activities. Return to any Naval Office when ready to resume service.</em>`;
    
    this.showActivityResult('üèñÔ∏è Leave Approved', resultText);
}

takeMedicalLeave() {
    const naval = this.gameState.navalCareer;
    
this.advanceRegularTime(mission.duration);
    
    // Repair ship
    if (this.gameState.ownedShip) {
        this.gameState.ownedShip.condition = Math.min(100, this.gameState.ownedShip.condition + 30);
    }
    
    // Health bonuses
    this.characterData.stats.seamanship += 0.2;
    this.characterData.stats.leadership += 0.2;
    
    this.showActivityResult('üè• Medical Leave Complete', 
        `Your 14-day medical leave has restored your health and repaired your vessel.<br><br>` +
        `<strong>Recovery Benefits:</strong><br>` +
        `‚Ä¢ Ship condition improved by 30 points<br>` +
        `‚Ä¢ +0.2 Seamanship (rest and recovery)<br>` +
        `‚Ä¢ +0.2 Leadership (reflection on command)<br>` +
        `‚Ä¢ No reputation penalty<br><br>` +
        `<em>You return to service refreshed and ready for duty.</em>`);
}

requestDischarge() {
    const naval = this.gameState.navalCareer;
    const ranks = ['Seaman', 'Able Seaman', 'Midshipman', 'Lieutenant', 'Commander', 'Captain', 'Admiral'];
    const rankIndex = Math.min(this.getNavalRankFromExperience(naval.experience), ranks.length - 1);
    const currentRank = ranks[rankIndex];
    
    // Calculate pension based on rank and service
    const pensionGold = (rankIndex + 1) * 50 + naval.missions_completed * 10;
    
    this.characterData.stats.money += pensionGold;
    this.characterData.reputation.crown += 5; // Veteran status
    
    // Mark as veteran
    naval.veteran = true;
    naval.discharge_rank = currentRank;
    naval.enlisted = false;
    // Mark as veteran with ship purchase benefits
naval.veteran = true;
naval.discharge_rank = currentRank;
naval.enlisted = false;
naval.veteranShipDiscount = 0.3; // 30% discount on ships
naval.veteranDiscountUsed = false; // Track if they've used their benefit
    
    this.showActivityResult('üéñÔ∏è Honorable Discharge Granted', 
        `After distinguished service, you have been granted an honorable discharge from the Royal Navy.<br><br>` +
        `<strong>Final Service Record:</strong><br>` +
        `‚Ä¢ Final Rank: ${currentRank}<br>` +
        `‚Ä¢ Missions Completed: ${naval.missions_completed}<br>` +
        `‚Ä¢ Total Experience: ${naval.experience}<br>` +
        `‚Ä¢ Naval Reputation: ${naval.reputation}<br><br>` +
        `<strong>Veteran Benefits:</strong><br>` +
        `‚Ä¢ Naval pension: ${pensionGold} gold<br>` +
        `‚Ä¢ +5 Crown reputation (veteran status)<br>` +
        `‚Ä¢ May re-enlist at previous rank<br>` +
        `‚Ä¢ Access to veteran merchant opportunities<br><br>` +
        `<em>"Your service to the Crown has been exemplary. May fair winds follow you in civilian life."</em>`);
}

getCurrentNavalRank() {
    const ranks = ['Seaman', 'Able Seaman', 'Midshipman', 'Lieutenant', 'Commander', 'Captain', 'Admiral'];
    const rankIndex = Math.min(this.getNavalRankFromExperience(this.gameState.navalCareer.experience), ranks.length - 1);
    return ranks[rankIndex];
}
    
    
visitBankingHouse() {
    // Initialize banking if not present
    if (!this.gameState.bankAccount) {
        this.gameState.bankAccount = {
            balance: 0,
            loan: 0,
            loanInterestRate: 0.05,
            depositInterestRate: 0.02
        };
    }    
    const bank = this.gameState.bankAccount;
    const playerMoney = this.characterData.stats.money;
    
    let content = '<strong>üè¶ Amsterdam Banking House</strong><br><br>';
    content += '"Welcome to the most trusted financial institution in Europe!"<br><br>';
    
    // Account status
    content += '<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px;">';
    content += `<strong>Account Status:</strong><br>`;
    content += `Bank Balance: ${bank.balance} gold<br>`;
    content += `Cash on Hand: ${playerMoney} gold<br>`;
    if (bank.loan > 0) {
        content += `Outstanding Loan: ${bank.loan} gold (${(bank.loanInterestRate * 100).toFixed(1)}% monthly interest)<br>`;
    }
    content += '</div>';
    
    // Deposit/Withdraw
    content += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">';
    
    // Deposit section
    content += '<div><h4>üí∞ Deposit Gold</h4>';
    if (playerMoney > 0) {
        content += '<p>Store your gold safely and earn 2% monthly interest.</p>';
        content += `<input type="number" id="depositAmount" min="1" max="${playerMoney}" value="${Math.min(100, playerMoney)}" style="width: 80px; margin: 5px;"> gold<br>`;
        content += '<button onclick="game.depositGold()">Deposit</button>';
    } else {
        content += '<p><em>You have no gold to deposit.</em></p>';
    }
    content += '</div>';
    
    // Withdraw section
    content += '<div><h4>üè¶ Withdraw Gold</h4>';
    if (bank.balance > 0) {
        content += '<p>Withdraw your stored gold anytime.</p>';
        content += `<input type="number" id="withdrawAmount" min="1" max="${bank.balance}" value="${Math.min(100, bank.balance)}" style="width: 80px; margin: 5px;"> gold<br>`;
        content += '<button onclick="game.withdrawGold()">Withdraw</button>';
    } else {
        content += '<p><em>No gold in your account.</em></p>';
    }
    content += '</div></div>';
    
    // Loan section
    content += '<h4>üìú Loans & Credit</h4>';
    if (bank.loan === 0) {
        content += '<p>Need capital for a big investment? We offer loans up to 1,000 gold.</p>';
        content += '<input type="number" id="loanAmount" min="50" max="1000" step="50" value="200" style="width: 80px; margin: 5px;"> gold<br>';
        content += '<button onclick="game.takeLoan()">Request Loan (5% monthly interest)</button>';
    } else {
        content += `<p>You have an outstanding loan of ${bank.loan} gold.</p>`;
        const minPayment = Math.min(bank.loan, playerMoney);
        if (minPayment > 0) {
            content += `<input type="number" id="repayAmount" min="1" max="${minPayment}" value="${minPayment}" style="width: 80px; margin: 5px;"> gold<br>`;
            content += '<button onclick="game.repayLoan()">Repay Loan</button>';
        } else {
            content += '<p><em>You need gold to repay your loan.</em></p>';
        }
    }
    
    this.showActivityResult('üè¶ Banking Services', content);
this.advanceQuickTime(1)
}


depositGold() {
    const amount = parseInt(document.getElementById('depositAmount').value) || 0;
    
    if (amount > 0 && amount <= this.characterData.stats.money) {
        this.characterData.stats.money -= amount;
        this.gameState.bankAccount.balance += amount;
        
        this.showActivityResult('üí∞ Deposit Complete', 
            `You deposited ${amount} gold into your account.<br><br>` +
            `New account balance: ${this.gameState.bankAccount.balance} gold<br>` +
            `Cash remaining: ${this.characterData.stats.money} gold`);
        
        setTimeout(() => {
            this.visitBankingHouse();
        }, 2000);
    } else {
        alert('Invalid deposit amount!');
    }
}

withdrawGold() {
    const amount = parseInt(document.getElementById('withdrawAmount').value) || 0;
    
    if (amount > 0 && amount <= this.gameState.bankAccount.balance) {
        this.characterData.stats.money += amount;
        this.gameState.bankAccount.balance -= amount;
        
        this.showActivityResult('üè¶ Withdrawal Complete', 
            `You withdrew ${amount} gold from your account.<br><br>` +
            `Account balance: ${this.gameState.bankAccount.balance} gold<br>` +
            `Cash on hand: ${this.characterData.stats.money} gold`);
        
        setTimeout(() => {
            this.visitBankingHouse();
        }, 2000);
    } else {
        alert('Invalid withdrawal amount!');
    }
}

takeLoan() {
    const amount = parseInt(document.getElementById('loanAmount').value) || 0;
    
    if (amount >= 50 && amount <= 1000 && this.gameState.bankAccount.loan === 0) {
        this.characterData.stats.money += amount;
        this.gameState.bankAccount.loan = amount;
        
        this.showActivityResult('üìú Loan Approved', 
            `The bank has approved your loan of ${amount} gold!<br><br>` +
            `You now have ${this.characterData.stats.money} gold in cash.<br>` +
            `Monthly interest: ${(amount * this.gameState.bankAccount.loanInterestRate).toFixed(1)} gold`);
        
        setTimeout(() => {
            this.visitBankingHouse();
        }, 2500);
    } else {
        alert('Invalid loan amount or you already have a loan!');
    }
}

repayLoan() {
    const amount = parseInt(document.getElementById('repayAmount').value) || 0;
    
    if (amount > 0 && amount <= this.characterData.stats.money && amount <= this.gameState.bankAccount.loan) {
        this.characterData.stats.money -= amount;
        this.gameState.bankAccount.loan -= amount;
        
        this.showActivityResult('üí≥ Loan Payment', 
            `You repaid ${amount} gold towards your loan.<br><br>` +
            `Remaining loan: ${this.gameState.bankAccount.loan} gold<br>` +
            `Cash remaining: ${this.characterData.stats.money} gold`);
        
        setTimeout(() => {
            this.visitBankingHouse();
        }, 2000);
    } else {
        alert('Invalid repayment amount!');
    }
}
    
    visitExplorationOffice() {
    // Initialize exploration if not present
    if (!this.gameState.explorationData) {
        this.gameState.explorationData = {
            completedExpeditions: [],
            discoveredRoutes: [],
            reputation: 0
        };
this.advanceQuickTime(1)
    }
    
    const hasShip = this.gameState.ownedShip && 
                   this.gameState.ownedShip.location === this.gameState.currentLocation;
    
    let content = '<strong>üó∫Ô∏è Portuguese Exploration Office</strong><br><br>';
    content += '"Portugal leads the world in maritime exploration. Join our expeditions to unknown lands!"<br><br>';
    
    if (!hasShip) {
        content += '<div style="background: #ffebee; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #f44336;">';
        content += '<strong>‚ö†Ô∏è Ship Required</strong><br>You need your own ship in this port to join expeditions.';
        content += '</div>';
        this.showActivityResult('üó∫Ô∏è Exploration Office', content);
        return;
    }
    
    // Show reputation
    content += `<div style="background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px;">`;
    content += `<strong>Exploration Reputation:</strong> ${this.gameState.explorationData.reputation}<br>`;
    content += `<strong>Completed Expeditions:</strong> ${this.gameState.explorationData.completedExpeditions.length}`;
    content += `</div>`;
    
    // Available expeditions
    content += '<strong>Available Expeditions:</strong><br><br>';
    
    const expeditions = [
        {
            id: 'african_coast',
            name: 'African Coast Survey',
            days: 14,
            risk: 0.3,
            cost: 50,
            rewards: { gold: [100, 300], reputation: 2 },
            description: 'Map the African coastline and establish trading posts',
            requirements: { reputation: 0 }
        },
        {
            id: 'spice_route',
            name: 'New Spice Route',
            days: 21,
            risk: 0.4,
            cost: 100,
            rewards: { gold: [200, 500], reputation: 3 },
            description: 'Discover faster routes to the spice islands',
            requirements: { reputation: 2 }
        },
        {
            id: 'brazil_expedition',
            name: 'Brazil Interior',
            days: 30,
            risk: 0.5,
            cost: 200,
            rewards: { gold: [300, 800], reputation: 5 },
            description: 'Explore the Brazilian interior for gold and rare goods',
            requirements: { reputation: 5 }
        }
    ];
    
    expeditions.forEach(exp => {
        const canAfford = this.characterData.stats.money >= exp.cost;
        const hasReputation = this.gameState.explorationData.reputation >= exp.requirements.reputation;
        const alreadyCompleted = this.gameState.explorationData.completedExpeditions.includes(exp.id);
        
        let buttonHtml;
        if (alreadyCompleted) {
            buttonHtml = '<em>Expedition completed</em>';
        } else if (!hasReputation) {
            buttonHtml = `<em>Requires ${exp.requirements.reputation} reputation</em>`;
        } else if (!canAfford) {
            buttonHtml = `<button disabled>Join Expedition (${exp.cost} gold)</button>`;
        } else {
            buttonHtml = `<button onclick="game.joinExpedition('${exp.id}')">Join Expedition (${exp.cost} gold)</button>`;
        }
        
        const riskText = `${(exp.risk * 100).toFixed(0)}% risk`;
        const rewardText = `${exp.rewards.gold[0]}-${exp.rewards.gold[1]} gold`;
        
        content += `<div style="border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px;">
            <strong>${exp.name}</strong> (${exp.days} days)<br>
            ${exp.description}<br>
            <strong>Risk:</strong> ${riskText} | <strong>Reward:</strong> ${rewardText}<br><br>
            ${buttonHtml}
        </div>`;
    });
    
    this.showActivityResult('üó∫Ô∏è Exploration Office', content);
    }


planTravel() {
    const hasShip = this.gameState.ownedShip && 
                   this.gameState.ownedShip.location === this.gameState.currentLocation;
    
    if (!hasShip && this.characterData.stats.money < 5) {
        this.showActivityResult('üó∫Ô∏è Plan Your Journey', 'You need at least 5 gold for passage to another port, or buy a ship for free travel.');
        return;
    }



        
   // Get realistic travel times based on actual location distances
const getTravelTime = (from, to) => {
    const travelTimes = {
        // European routes (shorter)
        'london-amsterdam': 4,
        'london-lisbon': 8, 
        'london-bristol': 2,
        'amsterdam-lisbon': 6,
        'amsterdam-bristol': 5,
        'lisbon-bristol': 9,
        
        // Transatlantic routes (much longer)
        'london-jamaica': 35,
        'london-charleston': 32,
        'london-boston': 28,
        'amsterdam-jamaica': 38,
        'amsterdam-charleston': 35,
        'amsterdam-boston': 30,
        'lisbon-jamaica': 25,
        'lisbon-charleston': 30,
        'lisbon-boston': 33,
        'bristol-jamaica': 33,
        'bristol-charleston': 30,
        'bristol-boston': 26,
        
        // Caribbean/Colonial routes (medium)
        'jamaica-charleston': 8,
        'jamaica-boston': 12,
        'charleston-boston': 6
    };
    
    // Try both directions
    const key1 = `${from}-${to}`;
    const key2 = `${to}-${from}`;
    
    return travelTimes[key1] || travelTimes[key2] || 15; // Default 15 days
};

const destinations = [
    { 
        id: 'london', 
        name: 'London', 
        cost: 8, 
        days: getTravelTime(this.gameState.currentLocation, 'london'),
        description: 'England\'s largest port - starting point for many adventures, good dock work opportunities' 
    },
    { 
        id: 'amsterdam', 
        name: 'Amsterdam', 
        cost: 10, 
        days: getTravelTime(this.gameState.currentLocation, 'amsterdam'),
        description: 'Dutch trading hub - competitive prices, financial services, and merchant opportunities' 
    },
    { 
        id: 'lisbon', 
        name: 'Lisbon', 
        cost: 12, 
        days: getTravelTime(this.gameState.currentLocation, 'lisbon'),
        description: 'Portuguese colonial gateway - exotic goods, exploration opportunities, New World connections' 
    },
    { 
        id: 'bristol', 
        name: 'Bristol', 
        cost: 6, 
        days: getTravelTime(this.gameState.currentLocation, 'bristol'),
        description: 'Growing English port - colonial trade connections, ship building, friendly prices' 
    },
    { 
        id: 'jamaica', 
        name: 'Port Royal, Jamaica', 
        cost: 25, 
        days: getTravelTime(this.gameState.currentLocation, 'jamaica'),
        description: 'Caribbean sugar colony - dangerous but profitable, pirates and plantations',
        requiresNewWorld: true
    },
    { 
        id: 'charleston', 
        name: 'Charleston, Carolina', 
        cost: 20, 
        days: getTravelTime(this.gameState.currentLocation, 'charleston'),
        description: 'Southern rice colony - elegant planters and agricultural wealth',
        requiresNewWorld: true
    },
    { 
        id: 'boston', 
        name: 'Boston, Massachusetts', 
        cost: 18, 
        days: getTravelTime(this.gameState.currentLocation, 'boston'),
        description: 'Northern trading colony - fish, lumber, and merchant opportunities',
        requiresNewWorld: true
    }
    ];
    
    let content = '<strong>Plan Your Journey:</strong><br><br>';
    
    if (hasShip) {
        content += `<div style="background: #e8f5e8; border: 2px solid #27ae60; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
            ‚õµ <strong>Ship Travel Available!</strong><br>
            You can sail your ${this.gameState.ownedShip.name} for FREE (faster travel, no passenger fees)
        </div>`;
    }
    
   // Filter destinations based on New World access
const availableDestinations = destinations.filter(dest => {
    // Always show European locations
    if (!dest.requiresNewWorld) return true;
    
    // Check if New World is unlocked
    return this.isNewWorldUnlocked();
});

availableDestinations.forEach(dest => {
        if (dest.id === this.gameState.currentLocation) return; // Don't show current location
        
        const shipDays = Math.max(1, dest.days - 1);
        let buttonHtml = '';
        
        if (hasShip) {
            buttonHtml = `<button onclick="game.travelTo('${dest.id}', 0, ${shipDays})" style="margin: 5px; padding: 8px 12px; background: linear-gradient(145deg, #27ae60, #229954); color: white;">Sail Your Ship (${shipDays} days, FREE)</button>`;
        }
        
        const canAfford = this.characterData.stats.money >= dest.cost;
        const passengerButton = canAfford ? 
            `<button onclick="game.travelTo('${dest.id}', ${dest.cost}, ${dest.days})" style="margin: 5px; padding: 8px 12px;">Book Passage (${dest.cost} gold, ${dest.days} days)</button>` :
            `<button disabled style="margin: 5px; padding: 8px 12px; opacity: 0.5;">Book Passage (${dest.cost} gold)</button>`;
        
        content += `<div style="border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px;">
            <strong>${dest.name}</strong><br>
            ${dest.description}<br><br>
            ${buttonHtml}${hasShip ? '<br>' : ''}${passengerButton}
        </div>`;
    });
    
    this.showActivityResult('üó∫Ô∏è Plan Your Journey', content);
}

travelTo(destinationId, cost, days) {
    let finalCost = cost;
    let finalDays = days;
    let travelMethod = 'passenger';
    
    const hasShip = this.gameState.ownedShip && 
                   this.gameState.ownedShip.location === this.gameState.currentLocation;
    
    if (hasShip) {
    // Ship travel is free but requires time
    finalCost = 0;
    finalDays = Math.max(1, days - 1);
    travelMethod = 'ship';
    
    // Apply crew navigation bonuses
    const navBonus = this.getCrewNavigationBonus();
    const navTimeReduction = Math.floor(finalDays * navBonus.timeReduction);

    // Apply ship speed bonuses
    const shipSpeedBonus = this.applyShipSpecialBonuses(finalDays, 'travel_speed');
    const shipTimeReduction = finalDays - shipSpeedBonus;

    // Apply all time reductions
    const totalTimeReduction = navTimeReduction + shipTimeReduction;
    finalDays = Math.max(1, finalDays - totalTimeReduction);
    
    // Store these for later display
this.tempNavReduction = navTimeReduction;
this.tempShipReduction = shipTimeReduction;
this.tempRepairBonus = this.getCrewRepairBonus();
this.tempNavBonus = navBonus; // Store the navBonus for later use
    
    // Move ship with player
    this.gameState.ownedShip.location = destinationId;
    
    // Constant wear from journey - reduced by carpenter skill
    let constantWear = Math.floor(Math.random() * 2) + 1;
    constantWear = Math.max(0, constantWear - Math.floor(this.tempRepairBonus * 0.3));
    
    this.gameState.ownedShip.condition -= constantWear;
    
    // Random damage events (storms, accidents, etc.) - reduced by navigator skill
    let damageChance = 0.06;
    damageChance *= (1 - navBonus.damageReduction);
    
    if (Math.random() < damageChance) {
        let damage = Math.floor(Math.random() * 8) + 5;
        damage = Math.floor(damage * (1 - navBonus.damageReduction));
        this.gameState.ownedShip.condition -= damage;
    }
    
    // Keep condition above 0
    this.gameState.ownedShip.condition = Math.max(0, this.gameState.ownedShip.condition);
}
    
    this.characterData.stats.money -= finalCost;
    this.gameState.currentLocation = destinationId;
    console.log('About to advance time by', finalDays, 'days');
this.advanceRegularTime(finalDays);

    
    
    // Different travel events based on method
    const passengerEvents = [
        'Your journey passes without incident. You arrive safely.',
        'Rough seas delay your arrival, but you meet an interesting fellow passenger.',
        'Fair winds speed your journey. You arrive ahead of schedule.',
        'A merchant on board shares valuable trading advice with you.',
        'Pirates are spotted in the distance, but your ship escapes unnoticed.'
    ];
    
    const shipEvents = [
        'You navigate your own ship skillfully through calm waters.',
        'A sudden storm tests your seamanship, but you weather it successfully.',
        'You spot a merchant vessel and exchange friendly signals.',
        'Your crew works efficiently, making excellent time.',
        'You discover a favorable wind current that speeds your journey.'
    ];
    
    const events = hasShip ? shipEvents : passengerEvents;
    const event = events[Math.floor(Math.random() * events.length)];
    
    let resultText = `You arrive in ${this.getLocationName(destinationId)} after ${finalDays} days.`;
    
    if (hasShip) {
    resultText += `<br><br><strong>‚õµ Captain's Log - "${this.gameState.ownedShip.shipName}":</strong> ${event}`;
    
    // Show bonuses that were applied
if (this.tempNavReduction > 0) {
    resultText += `<br><br><em>‚öì Skilled navigator reduced travel time by ${this.tempNavReduction} day(s)!</em>`;
}
if (this.tempShipReduction > 0) {
    const ability = this.getShipSpecialAbility();
    if (ability === 'speed_demon') {
        resultText += `<br><em>üí® Racing Schooner's speed reduced travel time by ${this.tempShipReduction} day(s)!</em>`;
    }
}
if (this.tempRepairBonus > 0) {
    resultText += `<br><em>üîß Ship's carpenter reduced wear and tear!</em>`;
}
    if (this.tempNavBonus && this.tempNavBonus.damageReduction > 0) {
    resultText += `<br><em>üß≠ Expert navigation avoided dangerous weather!</em>`;
}
    
    if (this.gameState.ownedShip.condition < 90) {
        resultText += `<br><br><em>‚ö†Ô∏è Ship condition: ${this.gameState.ownedShip.condition}% (consider repairs)</em>`;
    }
    
    // Give crew experience
    this.characterData.stats.navigation += 0.2;
    const expGains = this.giveCrewExperience('travel', 15);
    
    resultText += `<br><br><em>+0.2 Navigation skill</em>`;
    if (expGains && expGains.length > 0) {
        resultText += `<br><br><strong>üåü Crew Experience:</strong><br>`;
        expGains.forEach(gain => {
            resultText += `‚Ä¢ ${gain}<br>`;
        });
    }
} else {
        resultText += `<br><br>${event}<br><br>Passage cost: ${cost} gold`;
    }
    
    this.showActivityResult('‚õµ Journey Complete', resultText);

// Remove the automatic return - let player click the return button when ready
}



isNewWorldUnlocked() {
    // Check various ways to unlock New World
    
    // 1. Naval rank of Lieutenant or higher
    if (this.gameState.navalCareer && this.gameState.navalCareer.enlisted) {
        const rankIndex = Math.min(this.getNavalRankFromExperience(this.gameState.navalCareer.experience), 6);
        if (rankIndex >= 3) return true; // Lieutenant+
    }
    
    // 2. Completed certain exploration expeditions
    if (this.gameState.completedExpeditions && this.gameState.completedExpeditions.includes('new_world_survey')) {
        return true;
    }
    
    // 3. Have significant wealth (can afford passage)
    if (this.characterData.stats.money >= 500) return true;
    
    // 4. Have ocean-worthy ship
    if (this.gameState.ownedShip && this.gameState.ownedShip.oceanWorthy !== false) {
        return true;
    }
    
    return false;
}


    
getLocationName(locationId) {
    const names = {
        london: 'London',
        amsterdam: 'Amsterdam', 
        lisbon: 'Lisbon',
        bristol: 'Bristol',
        jamaica: 'Port Royal, Jamaica',    // ADD THESE THREE LINES
    charleston: 'Charleston, Carolina',
    boston: 'Boston, Massachusetts'
    };
    return names[locationId] || locationId;
}

updateLocationDisplay() {
    console.log('Updating location to:', this.gameState.currentLocation); // Debug line
    
    // Hide all locations
    document.querySelectorAll('.location').forEach(loc => {
        loc.classList.remove('active');
        loc.style.display = 'none';
    });
    
    // Show current location
    const locationId = this.gameState.currentLocation + 'Location';
    const currentLoc = document.getElementById(locationId);
    
    console.log('Looking for element:', locationId, 'Found:', currentLoc); // Debug line
    
    if (currentLoc) {
        currentLoc.classList.add('active');
        currentLoc.style.display = 'block';
    } else {
        console.error('Location element not found:', locationId);
    }
    
    this.updateDisplay();
this.updateGoHomeButton();
}


visitPlantationMarket() {
    if (this.gameState.currentLocation === 'london' || this.gameState.currentLocation === 'amsterdam' || this.gameState.currentLocation === 'lisbon' || this.gameState.currentLocation === 'bristol') {
        this.showActivityResult('üåæ No Plantations Here', 
            'Plantations are only available in the New World colonies!<br><br>' +
            'Travel to Jamaica, Charleston, or other colonial ports to invest in plantations.<br><br>' +
            '<em>The real money is made across the Atlantic...</em>');
        return;
    }

    let content = '<strong>üåæ Colonial Plantation Market</strong><br><br>';
    content += 'Invest in profitable plantation agriculture and build your colonial empire!<br><br>';
    
    // Show current plantations if any
    if (this.gameState.ownedPlantations && this.gameState.ownedPlantations.length > 0) {
        content += '<strong>üìä Your Plantations:</strong><br>';
        this.gameState.ownedPlantations.forEach((plantation, index) => {
            const monthlyProfit = this.calculatePlantationProfit(plantation);
            content += `‚Ä¢ ${plantation.name} (${plantation.type}): ${monthlyProfit} gold/month<br>`;
        });
        content += '<br>';
    }
    
    // Available plantations based on location
    const availablePlantations = this.getAvailablePlantations();
    
    content += '<strong>üè™ Available Plantations:</strong><br><br>';
    
    availablePlantations.forEach(plantation => {
        const canAfford = this.characterData.stats.money >= plantation.price;
        const monthlyEstimate = Math.floor(plantation.baseProfit * 0.8) + '-' + Math.floor(plantation.baseProfit * 1.2);
        
        const buttonHtml = canAfford ? 
            `<button onclick="game.buyPlantation('${plantation.id}')">Buy for ${plantation.price} gold</button>` :
            `<button disabled>Buy for ${plantation.price} gold (Need more money)</button>`;
            
        content += `<div style="border: 1px solid #8B4513; padding: 15px; margin: 10px 0; border-radius: 8px; background: #FFF8DC;">
            <strong>${plantation.name}</strong><br>
            ${plantation.description}<br>
            <strong>Crop:</strong> ${plantation.type}<br>
            <strong>Estimated Monthly Profit:</strong> ${monthlyEstimate} gold<br>
            <strong>Workers:</strong> ${plantation.workers} laborers<br><br>
            ${buttonHtml}
        </div>`;
    });
    
    this.showActivityResult('üåæ Plantation Market', content);
    this.advanceQuickTime(1);
}

getAvailablePlantations() {
    const location = this.gameState.currentLocation;
    
    if (location === 'jamaica') {
        return [
            {
                id: 'small_sugar',
                name: 'Small Sugar Estate', 
                price: 800,
                type: 'Sugar',
                baseProfit: 60,
                workers: 20,
                description: 'A modest sugar plantation with established cane fields'
            },
            {
                id: 'large_sugar',
                name: 'Large Sugar Plantation',
                price: 2000, 
                type: 'Sugar',
                baseProfit: 150,
                workers: 50,
                description: 'Major sugar estate with extensive fields and processing facilities'
            },
            {
                id: 'rum_distillery',
                name: 'Rum Distillery Estate',
                price: 1500,
                type: 'Rum',
                baseProfit: 120,
                workers: 30,
                description: 'Sugar plantation with rum distilling operation - higher profits'
            }
        ];
    } else if (location === 'charleston') {
        return [
            {
                id: 'rice_plantation',
                name: 'Rice Plantation',
                price: 1200,
                type: 'Rice', 
                baseProfit: 80,
                workers: 35,
                description: 'Profitable rice fields in the Carolina lowlands'
            },
            {
                id: 'indigo_farm',
                name: 'Indigo Farm',
                price: 900,
                type: 'Indigo',
                baseProfit: 70,
                workers: 25,
                description: 'Indigo cultivation for valuable blue dye export'
            },
            {
                id: 'mixed_estate',
                name: 'Mixed Agricultural Estate',
                price: 2500,
                type: 'Mixed',
                baseProfit: 180,
                workers: 60,
                description: 'Large estate producing rice, indigo, and livestock'
            }
        ];
    } else {
        return [
            {
                id: 'tobacco_farm',
                name: 'Tobacco Plantation',
                price: 1000,
                type: 'Tobacco',
                baseProfit: 90,
                workers: 30,
                description: 'Tobacco cultivation for European export markets'
            }
        ];
    }
}


buyPlantation(plantationId) {
    const availablePlantations = this.getAvailablePlantations();
    const plantation = availablePlantations.find(p => p.id === plantationId);
    
    if (!plantation || this.characterData.stats.money < plantation.price) {
        this.showActivityResult('‚ùå Cannot Purchase', 'Insufficient funds or plantation not available.');
        return;
    }
    
    // Initialize plantations array if needed
    if (!this.gameState.ownedPlantations) {
        this.gameState.ownedPlantations = [];
    }
    
    // Deduct cost
    this.characterData.stats.money -= plantation.price;
    
    // Add plantation to owned list
    const newPlantation = {
        ...plantation,
        location: this.gameState.currentLocation,
        purchaseDate: { year: this.gameState.year, month: this.gameState.month },
        condition: 100,
        efficiency: 1.0,
        lastHarvest: { year: this.gameState.year, month: this.gameState.month }
    };
    
    this.gameState.ownedPlantations.push(newPlantation);
    
    // Increase colonial reputation
    this.characterData.reputation.colonial += 3;
    this.characterData.stats.social += 0.5;
    
    this.showActivityResult('üéâ Plantation Purchased!', 
    `Congratulations! You are now the owner of ${plantation.name}!<br><br>` +
    `<strong>Plantation Details:</strong><br>` +
    `‚Ä¢ Location: ${this.getLocationName(this.gameState.currentLocation)}<br>` +
    `‚Ä¢ Crop: ${plantation.type}<br>` +
    `‚Ä¢ Workers: ${plantation.workers} laborers<br>` +
    `‚Ä¢ Expected Monthly Profit: ${plantation.baseProfit} gold<br><br>` +
    `<strong>Benefits:</strong><br>` +
    `‚Ä¢ +3 Colonial reputation<br>` +
    `‚Ä¢ +0.5 Social skill (plantation owner status)<br>` +
    `‚Ä¢ Monthly income from agricultural exports<br><br>` +
    `<em>Your colonial empire begins to grow!</em><br><br>` +
    `<button onclick="game.visitPlantationMarket()">Return to Plantation Market</button>`);
}

calculatePlantationProfit(plantation) {
    let profit = plantation.baseProfit;
    
    // Apply efficiency multiplier
    profit *= plantation.efficiency;
    
    // Apply condition modifier
    profit *= (plantation.condition / 100);
    
    // Random market fluctuations (¬±20%)
    const marketVariation = 0.8 + (Math.random() * 0.4);
    profit *= marketVariation;
    
    return Math.floor(profit);
}


            
showActivityResult(title, content) {
    // Set context to activity result
    this.setContext('activity_result');
    
    document.getElementById('activityTitle').innerHTML = title;
    document.getElementById('activityContent').innerHTML = content;
    this.updateDisplay(); // Refresh money/stats display
}

setContext(newContext) {
    // Save previous context to history (but avoid duplicates)
    if (this.currentContext && this.currentContext !== newContext) {
        // Don't add duplicate entries to history
        const lastContext = this.contextHistory[this.contextHistory.length - 1];
        if (lastContext !== this.currentContext) {
            this.contextHistory.push(this.currentContext);
        }
    }
    
    // Don't change to activity_result if we're already in one - prevents spam
    if (newContext === 'activity_result' && this.currentContext === 'activity_result') {
        console.log('Ignoring duplicate activity_result context');
        return;
    }
    
    this.currentContext = newContext;
    console.log('Context changed to:', newContext);
}

returnToPreviousContext() {
    if (this.contextHistory.length > 0) {
        const previousContext = this.contextHistory.pop();
        this.currentContext = previousContext;
        console.log('Returned to context:', previousContext);
        
        // Navigate based on context - temporarily disable context setting
const oldSetContext = this.setContext;
this.setContext = () => {}; // Disable context changes temporarily

switch(previousContext) {
    case 'shipyard':
        this.visitShipyard();
        break;
    case 'upgrades':
        this.upgradeShip();
        break;
    case 'crew_management':
    this.hireCrew();
    break;
case 'ship_management':
    this.visitShipyard();
    break;
case 'market':
    this.visitMarket();
    break;
    default:
        this.returnToLocation();
}

// Restore context setting
this.setContext = oldSetContext;
}
}

    
smartReturn() {
    // Simple return logic - goes to location unless in specific deep menus
    const deepMenus = ['upgrades', 'crew_management', 'ship_management'];
    
    if (deepMenus.includes(this.currentContext)) {
        // If in a deep ship menu, go back to shipyard
        this.visitShipyard();
    } else {
        // Otherwise, always go back to location
        this.returnToLocation();
    }
    
    // Clear the context history to prevent confusion
    this.contextHistory = [];
}


    
returnToLocation() {
    this.setContext('location');
    console.log('returnToLocation called');
    
    const activityPanel = document.getElementById('activityPanel');
    const locationView = document.getElementById('locationView');
    
    console.log('activityPanel:', activityPanel);
    console.log('locationView:', locationView);
    
    if (activityPanel) {
        console.log('Activity panel classes before:', activityPanel.classList.toString());
        activityPanel.classList.add('hidden');
        console.log('Activity panel classes after:', activityPanel.classList.toString());
    } else {
        console.log('ERROR: activityPanel not found!');
    }
    
    if (locationView) {
        console.log('Location view classes before:', locationView.classList.toString());
        locationView.classList.remove('hidden');
        console.log('Location view classes after:', locationView.classList.toString());
    } else {
        console.log('ERROR: locationView not found!');
    }
    
    this.updateLocationDisplay();
}

advanceTime(days) {
    console.log(`=== ADVANCING TIME: ${days} days ===`);
    
    // Process each day for potential events
    for (let day = 0; day < days; day++) {
        console.log(`Day ${day + 1}: Checking for events...`);
        
        // Check for crew loyalty events first (if you have a ship)
        if (this.gameState.ownedShip && this.gameState.ownedShip.namedCrew && this.gameState.ownedShip.namedCrew.length > 0) {
            this.checkCrewLoyaltyEvents();
        }

        // Daily loyalty loss from poor ship condition
        if (this.gameState.ownedShip && this.gameState.ownedShip.namedCrew && this.gameState.ownedShip.condition < 30) {
            this.gameState.ownedShip.namedCrew.forEach(member => {
                member.loyalty = Math.max(0, member.loyalty - 1);
            });
        }

        // Check for random events only on the final day of an activity period
        if (day === days - 1) { // Only check on the last day of the period
            const randomRoll = Math.random();
            console.log(`Random roll: ${randomRoll} (need < 0.15 for event)`);

            if (randomRoll < 0.15 && !this.gameState.navalCareer?.current_mission) {
                console.log("TRIGGERED RANDOM EVENT!");
                this.triggerRandomEvent();
            }
        }
        
        // Monthly processes (skip day 0 to avoid triggering on every travel)
        if (day > 0 && day % 30 === 0) {
            this.processMonthlyEvents();
        }
    } // END OF DAILY LOOP
    
    // AFTER the daily loop: Process captain contracts (only once per time advance)
    if (this.gameState.ownedShips) {
        this.gameState.ownedShips.forEach(ship => {
            if (ship.captain && ship.captain.contract > 0) {
                console.log(`DEBUG: Ship ${ship.shipName}, Captain ${ship.captain.name}, Contract was ${ship.captain.contract}, decrementing by ${days} days`);
                ship.captain.contract -= days;
                
                // Handle contract expiration with grace period
                if (ship.captain.contract <= 0 && !ship.captain.graceWarning) {
                    // Start 7-day grace period
                    ship.captain.graceWarning = true;
                    ship.captain.graceDays = 7;
                    this.showEmergencyEvent('‚ö†Ô∏è Contract Warning', 
                        `Captain ${ship.captain.name} on "${ship.shipName}" is demanding contract renewal!<br><br>` +
                        `You have 7 days to renew the contract or the captain will leave.`);
                } else if (ship.captain.graceWarning) {
                    ship.captain.graceDays -= days;
                    if (ship.captain.graceDays <= 0) {
                        this.showEmergencyEvent('üëã Captain Departed', 
                            `Captain ${ship.captain.name} has left "${ship.shipName}" due to expired contract!`);
                        ship.captain = null;
                    }
                }
            }
        });
    }

// Update total days first
this.gameState.totalDays += days;
        
  // Check for completed automated missions (after totalDays is updated)
const completedMissions = this.checkAutomatedMissions();

// Check if we should show monthly events this cycle
const shouldShowMonthlyReport = days >= 30 || (this.gameState.totalDays % 30 === 0);

if (completedMissions.length > 0) {
    if (shouldShowMonthlyReport) {
        // Pass mission results to monthly report to combine them
        setTimeout(() => {
            this.processMonthlyEvents(completedMissions);
        }, 1000);
    } else {
        // Show mission results separately
        this.showMissionResults(completedMissions);
    }
} else if (shouldShowMonthlyReport) {
    // Show monthly report without mission results
    setTimeout(() => {
        this.processMonthlyEvents([]);
    }, 1000);
}

        
    // Age progression - check for birthdays
    if (!this.gameState.daysSinceBirth) {
        this.gameState.daysSinceBirth = 0;
    }
    this.gameState.daysSinceBirth += days;
    
    // Check if a year has passed (365 days)
    if (this.gameState.daysSinceBirth >= 365) {
        const yearsAged = Math.floor(this.gameState.daysSinceBirth / 365);
        this.gameState.daysSinceBirth = this.gameState.daysSinceBirth % 365;
        
        this.characterData.age += yearsAged;
        
        // Show birthday message for first year aged
        if (yearsAged > 0) {
            setTimeout(() => {
                this.showEmergencyEvent('üéÇ Birthday!', 
                    `You have turned ${this.characterData.age} years old!<br><br>` +
                    `<em>Another year of adventure and experience...</em>`);
            }, 1000);
        }
    }
    
    // FIXED: Proper day accumulation
    if (!this.gameState.totalDays) {
        this.gameState.totalDays = 0;
    }
    
    // Convert total days to year/month
    const totalMonths = Math.floor(this.gameState.totalDays / 30);
    this.gameState.year = 1740 + Math.floor(totalMonths / 12); // Keep for compatibility
    this.gameState.gameYear = 1 + Math.floor(totalMonths / 12); // New display system
    this.gameState.month = (totalMonths % 12) + 1;
    
    console.log(`New date: Month ${this.gameState.month}, Year ${this.gameState.year}, Total days: ${this.gameState.totalDays}`);
    
    this.updateDisplay();

    // Auto-save every 10 days to prevent data loss
    if (this.gameState.totalDays && this.gameState.totalDays % 10 === 0) {
        this.autoSave();
    }
}

advanceQuickTime(periods) {
    // For daily activities - each period = 1 week
    this.advanceTime(periods * 7);
}

advanceRegularTime(days) {
    // For missions/expeditions - keep normal time scale
    this.advanceTime(days);
}


        
advanceTimeSafely(days) {
    console.log(`=== SAFELY ADVANCING TIME: ${days} days ===`);
    
    // Same time advancement without dangerous random events
    if (!this.gameState.totalDays) {
        this.gameState.totalDays = 0;
    }
    
    this.gameState.totalDays += days;

 // Auto-save every 10 days to prevent data loss
if (this.gameState.totalDays && this.gameState.totalDays % 10 === 0) {
    this.autoSave();
}       

 // Check for completed automated missions  
this.checkAutomatedMissions();       
    
    // Convert total days to year/month
    const totalMonths = Math.floor(this.gameState.totalDays / 30);
    this.gameState.year = 1740 + Math.floor(totalMonths / 12);
    this.gameState.month = (totalMonths % 12) + 1;
    
    console.log(`New date: Month ${this.gameState.month}, Year ${this.gameState.year}, Total days: ${this.gameState.totalDays}`);
    
    // Age progression (same as normal)
    if (!this.gameState.daysSinceBirth) {
        this.gameState.daysSinceBirth = 0;
    }
    this.gameState.daysSinceBirth += days;
    if (this.gameState.daysSinceBirth >= 365) {
        const yearsAged = Math.floor(this.gameState.daysSinceBirth / 365);
        this.gameState.daysSinceBirth = this.gameState.daysSinceBirth % 365;
        this.characterData.age += yearsAged;
    }
    
    // Monthly processes only (no dangerous random events)
    if (days >= 30) {
        this.processMonthlyEvents();
    }
    
    this.updateDisplay();
    
    // Auto-save still works
    if (this.gameState.totalDays && this.gameState.totalDays % 10 === 0) {
        this.autoSave();
    }
}



        

autoSave() {
    try {
        // Only auto-save if we have valid data
        if (!this.characterData || !this.gameState) {
            console.warn('Skipping auto-save: missing game data');
            return;
        }
        
        const autoSaveData = {
            version: "2.25",
            gameState: this.gameState,
            characterData: this.characterData,
            savedDate: new Date().toISOString(),
            autoSave: true
        };
        
        localStorage.setItem('colonialGameSave_auto', JSON.stringify(autoSaveData));
        
        // Show brief notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            background: #28a745; color: white; padding: 10px 15px;
            border-radius: 5px; font-size: 0.9em; opacity: 0.9;
        `;
        notification.textContent = 'üíæ Auto-saved';
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 2000);
        
    } catch (error) {
        console.error('Auto-save failed:', error);
        // Don't show error to user - auto-save failures shouldn't interrupt gameplay
    }
}
    

triggerRandomEvent() {
    console.log("=== TRIGGER RANDOM EVENT CALLED ===");
    
    const events = this.getAvailableEvents();
    console.log("Available events:", events);
    console.log("Number of events:", events.length);
    
    const hasShip = this.gameState.ownedShip && 
                   this.gameState.ownedShip.location === this.gameState.currentLocation;
    console.log("Has ship at current location:", hasShip);
    console.log("Owned ship:", this.gameState.ownedShip);
    console.log("Current location:", this.gameState.currentLocation);
    
    if (events.length === 0) {
        console.log("NO EVENTS AVAILABLE - RETURNING");
        return;
    }
    
    const event = events[Math.floor(Math.random() * events.length)];
    console.log("Selected event:", event);
    this.executeEvent(event);
}

getAvailableEvents() {
    const events = [];
    const hasShip = this.gameState.ownedShip && 
                   this.gameState.ownedShip.location === this.gameState.currentLocation;
    
    // Universal events (can happen anywhere)
    events.push(
        { id: 'market_crash', weight: 5 },
        { id: 'disease_outbreak', weight: 3 },
        { id: 'political_intrigue', weight: 8 },
        { id: 'lucky_find', weight: 10 }
    );
    
    // Ship-specific events
    if (hasShip) {
        events.push(
            { id: 'pirate_attack', weight: 12 },
            { id: 'storm_damage', weight: 15 },
            { id: 'shipwreck_risk', weight: 4 },
            { id: 'naval_press_gang', weight: 6 }
        );
    }
    
    // Naval career events
    if (this.gameState.navalCareer && this.gameState.navalCareer.enlisted) {
        events.push(
            { id: 'naval_emergency', weight: 10 },
            { id: 'promotion_opportunity', weight: 7 }
        );
    }
    
    // Location-specific events
    if (this.gameState.currentLocation === 'london') {
        events.push({ id: 'royal_decree', weight: 5 });
    }
    
    return events;
}

executeEvent(eventData) {
    const events = {
        pirate_attack: () => this.handlePirateAttack(),
        storm_damage: () => this.handleStormDamage(),
        shipwreck_risk: () => this.handleShipwreckRisk(),
        disease_outbreak: () => this.handleDiseaseOutbreak(),
        market_crash: () => this.handleMarketCrash(),
        naval_emergency: () => this.handleNavalEmergency(),
        lucky_find: () => this.handleLuckyFind(),
        political_intrigue: () => this.handlePoliticalIntrigue(),
        naval_press_gang: () => this.handlePressGang(),
        royal_decree: () => this.handleRoyalDecree()
    };
    
    const eventHandler = events[eventData.id];
    if (eventHandler) {
        eventHandler();
    }
}

handlePirateAttack() {
    if (!this.gameState.ownedShip) return;
    
    const ship = this.gameState.ownedShip;
    
    // Initialize combat state
    this.combatState = {
    round: 1,
    playerHull: this.gameState.ownedShip.condition, // Use actual ship condition
    enemyHull: 100,
        playerMorale: 80,
        enemyMorale: 80,
        range: 'long',
        playerCannonsFired: false,
        enemyCannonsFired: false,
        playerAdvantage: false,
        enemyAdvantage: false
    };
    
    // Generate enemy pirate ship
    this.enemyShip = {
        name: 'Sea Wolf',
        hull: 80,
        originalHull: 80,
        combat: 20,
        tactics: 'balanced',
        cannons: 2,
        crew: 15
    };
    
    // Force show combat interface immediately
    console.log('Forcing combat interface to show');
    this.startCombatRound();
}

generateEnemyPirate() {
    const pirateTypes = [
        { name: 'Scurvy Dog', hull: 60, combat: 15, tactics: 'aggressive' },
        { name: 'Sea Wolf', hull: 80, combat: 20, tactics: 'balanced' },
        { name: 'Dread Captain', hull: 100, combat: 25, tactics: 'cunning' },
        { name: 'Terror of the Seas', hull: 120, combat: 30, tactics: 'legendary' }
    ];
    
    const baseType = pirateTypes[Math.floor(Math.random() * pirateTypes.length)];
    
    return {
        ...baseType,
        originalHull: baseType.hull,
        cannons: Math.floor(Math.random() * 3) + 1,
        crew: Math.floor(Math.random() * 20) + 10
    };
}

startCombatRound() {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    // Reset for player turn
    this.pendingEnemyTurn = false;
    this.processingCombatAction = false;
    
    let content = `<strong>‚öîÔ∏è NAVAL BATTLE - Round ${combat.round}</strong><br><br>`;
    
    // Battle situation
    content += `<div style="background: #1a1a1a; color: white; padding: 15px; margin-bottom: 15px; border-radius: 8px;">`;
    content += `<strong>üè¥‚Äç‚ò†Ô∏è Enemy: ${enemy.name}</strong><br>`;
    content += `‚öîÔ∏è Combat Range: ${combat.range.toUpperCase()}<br><br>`;
    
    // Ship status bars
    const playerHullColor = combat.playerHull > 70 ? '#28a745' : combat.playerHull > 30 ? '#ffc107' : '#dc3545';
    const enemyHullColor = combat.enemyHull > 70 ? '#28a745' : combat.enemyHull > 30 ? '#ffc107' : '#dc3545';
    
    content += `<strong>Your Ship "${this.gameState.ownedShip.shipName}":</strong><br>`;
    content += `<div style="background: #333; border-radius: 10px; padding: 5px; margin: 5px 0;">`;
    content += `<div style="background: ${playerHullColor}; width: ${combat.playerHull}%; height: 20px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">Hull: ${combat.playerHull}%</div>`;
    content += `</div>`;
    
    content += `<strong>Enemy Ship:</strong><br>`;
    content += `<div style="background: #333; border-radius: 10px; padding: 5px; margin: 5px 0;">`;
    content += `<div style="background: ${enemyHullColor}; width: ${combat.enemyHull}%; height: 20px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">Hull: ${combat.enemyHull}%</div>`;
    content += `</div>`;
    content += `</div>`;
    
    // Round description based on range and situation
    content += this.getCombatRoundDescription();
    
    // Tactical options based on current situation
const combatOptions = this.getCombatOptions();
console.log('Combat options generated:', combatOptions.substring(0, 300));
content += combatOptions;
    
    // Just use the emergency event system - no duplicate modals!
this.showEmergencyEvent('‚öîÔ∏è Naval Battle!', content);
}

        

getCombatRoundDescription() {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    let desc = `<strong>Battle Report:</strong><br>`;
    
    if (combat.round === 1) {
        desc += `The pirate ship "${enemy.name}" has spotted you and is closing for attack! `;
        if (combat.range === 'long') {
            desc += `Both ships are at long range, cannons ready.<br><br>`;
        }
    } else {
        // Describe previous round results
        if (combat.playerAdvantage) {
            desc += `Your last action gave you the advantage! The enemy is reeling.<br>`;
        } else if (combat.enemyAdvantage) {
            desc += `The pirates gained the upper hand! They're pressing their attack.<br>`;
        } else {
            desc += `Both ships exchange fire in a deadly dance of steel and gunpowder.<br>`;
        }
        
        if (combat.range === 'close') {
            desc += `The ships are now dangerously close - you can see the pirates' faces!<br>`;
        } else if (combat.range === 'boarding') {
            desc += `The ships are locked together! This is hand-to-hand combat now!<br>`;
        }
        desc += `<br>`;
    }
    
    return desc;
}

getCombatOptions() {
    const combat = this.combatState;
    const ship = this.gameState.ownedShip;
    
    let options = `<strong>Choose Your Tactics:</strong><br><br>`;
    
    if (combat.range === 'long' || combat.range === 'medium') {
        // Cannon combat options
        options += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        options += `<strong>üî• CANNON BARRAGE</strong><br>`;
        options += `Unleash your ship's firepower at the enemy.<br>`;
        const cannonPower = ship.baseStats.combat + (ship.upgrades.cannons * 8);
        options += `<strong>Firepower:</strong> ${cannonPower}<br>`;
        if (ship.upgrades.cannons >= 2) {
            options += `<em>Heavy cannons available!</em><br>`;
        }
        options += `<button id="combat_cannon" onclick="game.disableAllCombatButtons(); game.executeCombatAction('cannon_attack')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">üî• FIRE CANNONS!</button>`;
        options += `</div>`;
        
        options += `<div style="border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        options += `<strong>‚õµ TACTICAL MANEUVER</strong><br>`;
        options += `Use superior sailing to gain an advantage.<br>`;
        const speed = ship.baseStats.speed + (ship.upgrades.speed * 4);
        options += `<strong>Speed:</strong> ${speed}<br>`;
        options += `<button id="combat_maneuver" onclick="game.disableAllCombatButtons(); game.executeCombatAction('maneuver')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">‚õµ OUTMANEUVER!</button>`;

        options += `</div>`;
        
        options += `<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        options += `<strong>üõ°Ô∏è DEFENSIVE POSITION</strong><br>`;
        options += `Angle your armor and prepare for their attack.<br>`;
        const armor = ship.baseStats.defense + (ship.upgrades.armor * 6);
        options += `<strong>Defense:</strong> ${armor}<br>`;
        options += `<button id="combat_defend" onclick="game.disableAllCombatButtons(); game.executeCombatAction('defend')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">üõ°Ô∏è DEFENSIVE STANCE!</button>`;

        options += `</div>`;
        
        if (combat.range === 'medium') {
            options += `<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
            options += `<strong>‚ö° RAMMING SPEED</strong><br>`;
            options += `Charge directly at the enemy ship!<br>`;
            options += `<strong>Risk:</strong> High damage to both ships<br>`;
            options += `<button id="combat_ram" onclick="game.disableAllCombatButtons(); game.executeCombatAction('ram')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">‚ö° RAMMING SPEED!</button>`;

            options += `</div>`;
        }
    } else if (combat.range === 'close') {
        // Close combat options
        options += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        options += `<strong>‚öîÔ∏è PREPARE TO BOARD</strong><br>`;
        options += `Ready your crew for hand-to-hand combat!<br>`;
        options += `<button id="combat_board" onclick="game.disableAllCombatButtons(); game.executeCombatAction('prepare_boarding')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">‚öîÔ∏è BOARD THEM!</button>`;

        options += `</div>`;
        
        options += `<div style="border: 2px solid #6f42c1; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        options += `<strong>üî´ POINT-BLANK CANNONS</strong><br>`;
        options += `Devastating close-range cannon fire!<br>`;
        options += `<button id="combat_pointblank" onclick="game.disableAllCombatButtons(); game.executeCombatAction('point_blank')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">üî´ POINT-BLANK FIRE!</button>`;

        options += `</div>`;
        
        options += `<div style="border: 2px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        options += `<strong>üèÉ ATTEMPT ESCAPE</strong><br>`;
        options += `Try to break away and flee!<br>`;
        options += `<button id="combat_escape" onclick="game.disableAllCombatButtons(); game.executeCombatAction('escape')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">üèÉ ATTEMPT ESCAPE!</button>`;

        options += `</div>`;
    } else if (combat.range === 'boarding') {
        // Boarding combat
        options += `<div style="border: 2px solid #8b0000; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        options += `<strong>‚öîÔ∏è FIGHT FIERCELY</strong><br>`;
        options += `Press the attack with sword and pistol!<br>`;
        options += `<button id="combat_fight" onclick="game.disableAllCombatButtons(); game.executeCombatAction('boarding_attack')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">‚öîÔ∏è FIGHT!</button>`;

        options += `</div>`;
        
        options += `<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        options += `<strong>üõ°Ô∏è DEFENSIVE FIGHTING</strong><br>`;
        options += `Fight carefully and protect your crew.<br>`;
        options += `<button id="combat_defend_board" onclick="game.disableAllCombatButtons(); game.executeCombatAction('boarding_defend')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">üõ°Ô∏è FIGHT DEFENSIVELY!</button>`;

        options += `</div>`;
        
        if (combat.enemyHull < 30) {
            options += `<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
            options += `<strong>üè≥Ô∏è DEMAND SURRENDER</strong><br>`;
            options += `Their ship is badly damaged - demand they yield!<br>`;
            options += `<button id="combat_surrender" onclick="game.disableAllCombatButtons(); game.executeCombatAction('demand_surrender')" style="width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; margin-top: 10px; cursor: pointer;">üè≥Ô∏è DEMAND SURRENDER!</button>`;

            options += `</div>`;
        }
    }
    
    return options;
}

disableAllCombatButtons() {
    // Disable all combat buttons to prevent multiple clicks
    const buttons = document.querySelectorAll('#emergencyContent button');
    buttons.forEach(button => {
        button.disabled = true;
        button.style.opacity = '0.5';
        button.style.cursor = 'not-allowed';
    });
}
            

executeCombatAction(action) {
    // Prevent multiple rapid clicks
    if (this.processingCombatAction) {
        console.log('Combat action already processing, ignoring click');
        return;
    }
    this.processingCombatAction = true;
    
    // Hide the current combat display immediately
    this.hideEmergencyEvent();
    
    const combat = this.combatState;
    const ship = this.gameState.ownedShip;
    const enemy = this.enemyShip;
    
    if (!combat || !enemy) {
        console.error('Combat state missing, ending combat');
        this.processingCombatAction = false;
        this.endCombat('escape', 'Combat error - you escape in the confusion!');
        return;
    }
    
    // ... rest of existing function stays the same ...
    
    let resultText = '';
    
    // Reset advantages
    combat.playerAdvantage = false;
    combat.enemyAdvantage = false;
    
    switch(action) {
        case 'cannon_attack':
            resultText = this.executeCannonsAttack();
            break;
        case 'maneuver':
            resultText = this.executeManeuver();
            break;
        case 'defend':
            resultText = this.executeDefend();
            break;
        case 'ram':
            resultText = this.executeRam();
            break;
        case 'prepare_boarding':
            resultText = this.executePrepareBoarding();
            break;
        case 'point_blank':
            resultText = this.executePointBlank();
            break;
        case 'escape':
            resultText = this.executeEscape();
            break;
        case 'boarding_attack':
            resultText = this.executeBoardingAttack();
            break;
        case 'boarding_defend':
            resultText = this.executeBoardingDefend();
            break;
        case 'demand_surrender':
            resultText = this.executeDemandSurrender();
            break;
    }
    
    // Update combat state
    combat.playerHull = Math.max(0, combat.playerHull);
    combat.enemyHull = Math.max(0, combat.enemyHull);
    
    // Check for combat end
    if (combat.playerHull <= 0) {
        this.endCombat('defeat', 'Your ship is destroyed!');
        return;
    }
    
    if (combat.enemyHull <= 0) {
        this.endCombat('victory', 'The enemy ship is sinking!');
        return;
    }
    
    // DON'T reset the flag here - wait until results are shown
// Immediately process enemy turn and combine results
setTimeout(() => {
    this.processEnemyTurnAndShowResults(resultText);
}, 300); // Shorter delay for snappier feel
}


disableAllCombatButtons() {
    // Disable all combat buttons to prevent multiple clicks
    const buttons = document.querySelectorAll('#emergencyContent button');
    buttons.forEach(button => {
        button.disabled = true;
        button.style.opacity = '0.5';
        button.style.cursor = 'not-allowed';
    });
}



processEnemyTurnAndShowResults(playerResultText) {
    // Safety check
    if (!this.combatState || !this.enemyShip) {
        console.error('Invalid combat state in processEnemyTurnAndShowResults');
        return;
    }
    
    // Get enemy action
    const enemyAction = this.chooseEnemyAction();
    const enemyResultText = this.executeEnemyAction(enemyAction);
    
    // Update combat round
    this.combatState.round++;
    
    // Check for combat end conditions
    if (this.combatState.playerHull <= 0) {
        this.endCombat('defeat', 'Your ship is destroyed!');
        return;
    }
    if (this.combatState.enemyHull <= 0) {
        this.endCombat('victory', 'The enemy ship is sinking!');
        return;
    }
    
    // Combine both actions into one display
    let combinedResult = `<strong>‚öîÔ∏è COMBAT ROUND ${this.combatState.round - 1} RESULTS</strong><br><br>`;
    
    // Player action
    combinedResult += `<div style="border-left: 4px solid #28a745; padding-left: 15px; margin-bottom: 15px;">`;
    combinedResult += `<strong>YOUR ACTION:</strong><br>`;
    combinedResult += playerResultText;
    combinedResult += `</div>`;
    
    // Enemy action
    combinedResult += `<div style="border-left: 4px solid #dc3545; padding-left: 15px; margin-bottom: 15px;">`;
    combinedResult += `<strong>ENEMY RESPONSE:</strong><br>`;
    combinedResult += enemyResultText;
    combinedResult += `</div>`;
    
    // Current status
    combinedResult += `<div style="background: #1a1a1a; color: white; padding: 10px; margin: 15px 0; border-radius: 8px;">`;
    combinedResult += `<strong>Battle Status:</strong><br>`;
    combinedResult += `Your Hull: ${this.combatState.playerHull}% | Enemy Hull: ${this.combatState.enemyHull}%<br>`;
    combinedResult += `Combat Range: ${this.combatState.range.toUpperCase()}`;
    combinedResult += `</div>`;
    
    // Continue button
    combinedResult += `<div style="text-align: center; margin-top: 20px;">`;
    combinedResult += `<button onclick="game.startNextRound()" style="background: linear-gradient(145deg, #d4af37, #b8941f); border: 2px solid #8b7355; color: #2c3e50; font-size: 1.1em; font-weight: bold; padding: 12px 25px; border-radius: 8px; cursor: pointer;">Continue to Round ${this.combatState.round}</button>`;
    combinedResult += `</div>`;
    
    // Show combined results
    this.showEmergencyEvent('‚öîÔ∏è Combat Results', combinedResult);
    
    // NOW reset the processing flag after everything is shown
    this.processingCombatAction = false;
}


        
continueToNextRound() {
    console.log('Continue to next round clicked');
    this.pendingNextRound = false;
    this.startCombatRound();
}

            
executeCannonsAttack() {
    const combat = this.combatState;
    const ship = this.gameState.ownedShip;
    
    const baseCombat = ship.baseStats.combat + (ship.upgrades.cannons * 8);
const crewBonus = this.getCrewCombatBonus();
const loyaltyMultiplier = this.getCrewLoyaltyBonus();
const cannonPower = Math.floor((baseCombat + crewBonus) * loyaltyMultiplier);
    const accuracy = Math.random() * 0.7 + 0.3; // 30-100% accuracy
    
    const damage = Math.floor(cannonPower * accuracy);
    combat.enemyHull -= damage;
    
    let result = `<strong>üî• CANNON BARRAGE!</strong><br><br>`;
    result += `Your cannons roar with thunder and flame!<br><br>`;
    
    if (accuracy > 0.8) {
        result += `<strong>EXCELLENT SHOOTING!</strong> Your gunners find their mark!<br>`;
        combat.playerAdvantage = true;
    } else if (accuracy < 0.5) {
        result += `Your shots mostly miss - the gunners need more practice!<br>`;
    } else {
        result += `Solid hits! Splinters fly from the enemy ship!<br>`;
    }
    
    result += `<strong>Enemy ship damage: ${damage} points</strong><br>`;
if (crewBonus > 0) {
    result += `<em>Skilled gunners: +${crewBonus} combat power!</em><br>`;
}
if (loyaltyMultiplier !== 1.0) {
    const loyaltyPercent = Math.round(loyaltyMultiplier * 100);
    result += `<em>Crew loyalty: ${loyaltyPercent}% efficiency</em><br>`;
}
result += `<br>`;
    
    if (ship.upgrades.cannons >= 3) {
        result += `<em>Your heavy cannons devastate the enemy vessel!</em>`;
    }
    
    return result;
}

executeManeuver() {
    const combat = this.combatState;
    const ship = this.gameState.ownedShip;
    
    const speed = ship.baseStats.speed + (ship.upgrades.speed * 4);
    const success = Math.random() < (speed / 40); // Higher speed = better chance
    
    let result = `<strong>‚õµ TACTICAL MANEUVER!</strong><br><br>`;
    
    if (success) {
        result += `Your superior seamanship pays off! You gain the weather gauge!<br><br>`;
        combat.playerAdvantage = true;
        
        // Gain tactical advantage for next round
        this.characterData.stats.navigation += 0.1;
        
        result += `<strong>Advantage gained!</strong> Your next attack will be more effective.<br>`;
        result += `<em>+0.1 Navigation skill</em>`;
    } else {
        result += `You attempt to outmaneuver the pirates, but they're experienced sailors too!<br><br>`;
        result += `The enemy maintains their position. No advantage gained.`;
    }
    
    return result;
}

executeDefend() {
    const combat = this.combatState;
    const ship = this.gameState.ownedShip;
    
    const armor = ship.baseStats.defense + (ship.upgrades.armor * 6);
    
    // Set up defense for enemy turn
    combat.playerDefending = true;
    combat.defenseBonus = armor;
    
    let result = `<strong>üõ°Ô∏è DEFENSIVE POSITION!</strong><br><br>`;
    result += `You angle your ship to present the strongest armor and ready for their attack!<br><br>`;
    result += `<strong>Defense Rating: ${armor}</strong><br>`;
    result += `<strong>Next enemy attack will be reduced!</strong>`;
    
    if (ship.upgrades.armor >= 2) {
        result += `<br><em>Your reinforced hull provides excellent protection!</em>`;
    }
    
    return result;
}

executeRam() {
    const combat = this.combatState;
    const ship = this.gameState.ownedShip;
    
    const ramDamage = Math.floor(Math.random() * 40) + 20;
    const playerDamage = Math.floor(ramDamage * 0.6); // Player takes less damage
    
    combat.enemyHull -= ramDamage;
    combat.playerHull -= playerDamage;
    combat.range = 'close';
    
    let result = `<strong>‚ö° RAMMING SPEED!</strong><br><br>`;
    result += `"RAMMING SPEED!" You drive your ship directly into the enemy!<br><br>`;
    result += `CRASH! The ships collide in a tremendous impact!<br><br>`;
    result += `<strong>Enemy damage: ${ramDamage}</strong><br>`;
    result += `<strong>Your damage: ${playerDamage}</strong><br><br>`;
    result += `<em>The ships are now locked together at close range!</em>`;
    
    this.characterData.stats.leadership += 0.2;
    
    return result;
}

executePrepareBoarding() {
    const combat = this.combatState;
    
    combat.range = 'boarding';
    combat.playerAdvantage = true;
    
    let result = `<strong>‚öîÔ∏è PREPARE TO BOARD!</strong><br><br>`;
    result += `"All hands, prepare for boarding!" Your crew readies cutlasses and pistols!<br><br>`;
    result += `Grappling hooks fly through the air, lashing the ships together!<br><br>`;
    result += `<strong>BOARDING COMBAT ENGAGED!</strong><br>`;
    result += `<em>Your crew has the initiative!</em>`;
    
    return result;
}

executePointBlank() {
    const combat = this.combatState;
    const ship = this.gameState.ownedShip;
    
    const damage = (ship.baseStats.combat + (ship.upgrades.cannons * 8)) * 1.5; // 50% bonus at point blank
    combat.enemyHull -= Math.floor(damage);
    
    let result = `<strong>üî´ POINT-BLANK CANNONS!</strong><br><br>`;
    result += `At this range, you can't miss! Your cannons tear through their hull!<br><br>`;
    result += `BOOM! BOOM! BOOM! Devastating close-range firepower!<br><br>`;
    result += `<strong>Massive damage: ${Math.floor(damage)} points!</strong><br><br>`;
    result += `<em>Splinters and debris fly everywhere!</em>`;
    
    return result;
}

executeEscape() {
    const combat = this.combatState;
    const ship = this.gameState.ownedShip;
    
    const speed = ship.baseStats.speed + (ship.upgrades.speed * 4);
    const escapeChance = speed / 50; // Higher speed = better escape chance
    
    if (Math.random() < escapeChance) {
        this.endCombat('escape', 'You successfully escape the pirates!');
        return;
    } else {
        let result = `<strong>üèÉ ESCAPE ATTEMPT FAILED!</strong><br><br>`;
        result += `You try to break away, but the pirates pursue relentlessly!<br><br>`;
        result += `"You can't escape us!" They close in for the kill!<br><br>`;
        result += `<em>The enemy gains advantage from your failed escape!</em>`;
        
        combat.enemyAdvantage = true;
        return result;
    }
}

executeBoardingAttack() {
    const combat = this.combatState;
    
    const playerPower = this.characterData.stats.leadership * 10 + this.characterData.stats.seamanship * 5;
    const damage = Math.floor(Math.random() * 25) + playerPower/2;
    
    combat.enemyHull -= damage;
    combat.playerHull -= Math.floor(Math.random() * 15) + 5; // Take some damage too
    
    let result = `<strong>‚öîÔ∏è FIERCE MELEE COMBAT!</strong><br><br>`;
    result += `Steel rings against steel! Pistols crack in the salty air!<br><br>`;
    result += `You lead your crew in vicious hand-to-hand fighting!<br><br>`;
    result += `<strong>Enemy casualties inflicted!</strong><br>`;
    result += `<strong>Some of your crew are wounded in the fight.</strong><br><br>`;
    
    this.characterData.stats.leadership += 0.1;
    
    return result;
}

executeBoardingDefend() {
    const combat = this.combatState;
    
    combat.playerDefending = true;
    
    let result = `<strong>üõ°Ô∏è DEFENSIVE FIGHTING!</strong><br><br>`;
    result += `You order your crew to fight smart - protect each other!<br><br>`;
    result += `"Hold the line! Watch your mates' backs!"<br><br>`;
    result += `<strong>Reduced casualties for both sides.</strong><br>`;
    result += `<em>Your crew appreciates your careful leadership.</em>`;
    
    return result;
}

executeDemandSurrender() {
    const combat = this.combatState;
    const social = this.characterData.stats.social;
    
    const surrenderChance = (social / 10) + (100 - combat.enemyHull) / 100;
    
    if (Math.random() < surrenderChance) {
        this.endCombat('surrender', 'The pirates surrender to your superior force!');
        return;
    } else {
        let result = `<strong>üè≥Ô∏è SURRENDER REJECTED!</strong><br><br>`;
        result += `"NEVER!" screams the pirate captain. "Fight to the death!"<br><br>`;
        result += `The pirates fight with desperate fury!<br><br>`;
        result += `<em>Enemy morale increased by desperation!</em>`;
        
        combat.enemyAdvantage = true;
        return result;
    }
}



startNextRound() {
    console.log('Starting next combat round');
    this.hideEmergencyEvent();
    
    // Brief pause before showing next round
    setTimeout(() => {
        this.startCombatRound();
    }, 300);
}

                                                        
            
chooseEnemyAction() {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    // Enemy AI based on tactics and situation
    if (combat.range === 'boarding') {
        return 'boarding_attack';
    }
    
    if (combat.enemyHull < 30 && Math.random() < 0.3) {
        return 'desperate_attack';
    }
    
    if (combat.range === 'close' && enemy.tactics === 'aggressive') {
        return Math.random() < 0.7 ? 'point_blank' : 'ram_player';
    }
    
    if (combat.range === 'long' || combat.range === 'medium') {
        const actions = ['cannon_attack', 'maneuver', 'close_distance'];
        return actions[Math.floor(Math.random() * actions.length)];
    }
    
    return 'cannon_attack'; // default
}            


executeEnemyAction(action) {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    switch(action) {
        case 'cannon_attack':
            return this.enemyCannonAttack();
        case 'maneuver':
            return this.enemyManeuver();
        case 'close_distance':
            return this.enemyCloseDistance();
        case 'ram_player':
            return this.enemyRamAttack();
        case 'point_blank':
            return this.enemyPointBlank();
        case 'boarding_attack':
            return this.enemyBoardingAttack();
        case 'desperate_attack':
            return this.enemyDesperateAttack();
        default:
            return this.enemyCannonAttack();
    }
}
    
enemyCannonAttack() {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    const damage = Math.floor(enemy.combat * (0.6 + Math.random() * 0.4));
    let finalDamage = damage;
    
    // Check if player is defending
    if (combat.playerDefending) {
        finalDamage = Math.floor(damage * 0.6);
        combat.playerDefending = false;
    }
    
    combat.playerHull -= finalDamage;
    
    return `<strong>üî• Enemy Cannons Fire!</strong><br><br>` +
           `The ${enemy.name} unleashes a devastating broadside!<br><br>` +
           `<strong>Your ship takes ${finalDamage} damage!</strong><br>` +
           `Hull integrity: ${combat.playerHull}%`;
}

enemyManeuver() {
    const combat = this.combatState;
    
    if (Math.random() < 0.6) {
        combat.enemyAdvantage = true;
        return `<strong>‚õµ Enemy Outmaneuvers You!</strong><br><br>` +
               `The pirate ship gains the weather gauge!<br><br>` +
               `<strong>Enemy advantage gained!</strong>`;
    } else {
        return `<strong>‚õµ Enemy Maneuver Failed!</strong><br><br>` +
               `The pirates attempt to outflank you but fail!<br><br>` +
               `Your ship maintains position.`;
    }
}

enemyCloseDistance() {
    const combat = this.combatState;
    
    if (combat.range === 'long') {
        combat.range = 'medium';
    } else if (combat.range === 'medium') {
        combat.range = 'close';
    }
    
    return `<strong>üö¢ Enemy Closes Distance!</strong><br><br>` +
           `The pirate ship sails aggressively toward you!<br><br>` +
           `<strong>Range is now: ${combat.range.toUpperCase()}</strong>`;
}


enemyRamAttack() {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    const ramDamage = Math.floor(Math.random() * 35) + 15;
    const enemyDamage = Math.floor(ramDamage * 0.7); // Enemy takes more damage
    
    combat.playerHull -= ramDamage;
    combat.enemyHull -= enemyDamage;
    combat.range = 'close';
    
    return `<strong>üí• Enemy Ramming Attack!</strong><br><br>` +
           `The ${enemy.name} charges at full speed!<br><br>` +
           `CRASH! Both ships collide violently!<br><br>` +
           `<strong>You take ${ramDamage} damage!</strong><br>` +
           `<strong>Enemy takes ${enemyDamage} damage!</strong><br><br>` +
           `Range is now: CLOSE`;
}

enemyPointBlank() {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    const damage = Math.floor(enemy.combat * 1.4); // 40% bonus at point blank
    combat.playerHull -= damage;
    
    return `<strong>üíÄ Enemy Point-Blank Fire!</strong><br><br>` +
           `The pirates unleash devastating close-range cannon fire!<br><br>` +
           `<strong>Your ship takes ${damage} massive damage!</strong><br>` +
           `Hull integrity: ${combat.playerHull}%`;
}

enemyBoardingAttack() {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    const damage = Math.floor(Math.random() * 20) + 10;
    combat.playerHull -= damage;
    
    return `<strong>‚öîÔ∏è Pirates Board Your Ship!</strong><br><br>` +
           `"Take no prisoners!" Cutlass-wielding pirates swarm aboard!<br><br>` +
           `<strong>Fierce hand-to-hand combat!</strong><br>` +
           `Your ship takes ${damage} damage in the melee!`;
}

enemyDesperateAttack() {
    const combat = this.combatState;
    const enemy = this.enemyShip;
    
    const damage = Math.floor(enemy.combat * 1.6); // Big damage but enemy takes damage too
    const enemyDamage = Math.floor(Math.random() * 15) + 10;
    
    combat.playerHull -= damage;
    combat.enemyHull -= enemyDamage;
    
    return `<strong>üî• Desperate Pirate Attack!</strong><br><br>` +
           `With their ship badly damaged, the pirates fight with nothing to lose!<br><br>` +
           `<strong>Massive damage exchange!</strong><br>` +
           `You take ${damage} damage!<br>` +
           `Enemy takes ${enemyDamage} damage from reckless tactics!`;
}
    
endCombat(result, message) {
    // Ensure we can always end combat, even in error states
    if (!this.combatState) {
        this.combatState = { playerHull: 50, enemyHull: 0 }; // Create minimal state
    }
    if (!this.enemyShip) {
        this.enemyShip = { name: 'Unknown Enemy' }; // Create minimal enemy
    }
    
    let content = `<strong>${message}</strong><br><br>`;
    
    // Check for crew casualties in all combat scenarios (MOVED TO TOP)
    const casualties = this.checkCrewDeaths('naval combat', 0.08);
    const hasSurgeon = this.gameState.ownedShip.namedCrew && 
        this.gameState.ownedShip.namedCrew.some(member => member.specialty === 'surgeon');
    
    if (result === 'victory') {
        const treasure = Math.floor(Math.random() * 300) + 200;
        this.characterData.stats.money += treasure;
        
        // Naval mission combat bonuses
        let navalBonus = 0;
        if (this.isNavalMissionCombat) {
            navalBonus = Math.floor(treasure * 0.5); // 50% bonus for naval missions
            this.characterData.stats.money += navalBonus;
            this.gameState.navalCareer.reputation += 3;
            const oldExperience = this.gameState.navalCareer.experience;
            this.gameState.navalCareer.experience += 2;
            this.checkNavalPromotion(oldExperience, this.gameState.navalCareer.experience);
        }
        
        this.characterData.reputation.pirate -= 2;
        this.characterData.reputation.crown += 1;
        this.characterData.stats.leadership += 0.3;
        
        // Ship damage from battle
        const battleDamage = Math.floor(Math.random() * 15) + 5;
        this.gameState.ownedShip.condition -= battleDamage;
        this.gameState.ownedShip.condition = Math.max(0, this.gameState.ownedShip.condition);
        
        // Give crew combat experience
        const expGains = this.giveCrewExperience('combat', 25);

        content += `<strong>‚öîÔ∏è VICTORY!</strong><br><br>` +
                  `You have defeated the pirates!<br><br>` +
                  `<strong>Spoils of War:</strong><br>` +
                  `‚Ä¢ ${treasure} gold in pirate treasure<br>`;

        // Add naval mission bonuses
        if (this.isNavalMissionCombat) {
            content += `‚Ä¢ ${navalBonus} gold naval bonus<br>` +
                      `‚Ä¢ +3 Naval reputation<br>` +
                      `‚Ä¢ +5 Naval experience<br>`;
        }

        content += `‚Ä¢ +0.3 Leadership skill<br>` +
                  `‚Ä¢ +1 Crown reputation<br>` +
                  `‚Ä¢ -2 Pirate reputation (they fear you)<br><br>`;

        if (expGains && expGains.length > 0) {
            content += `<strong>üåü Crew Experience:</strong><br>`;
            expGains.forEach(gain => {
                content += `‚Ä¢ ${gain}<br>`;
            });
            content += `<br>`;
        }
        
        // Add death report if there were casualties
        content += this.getDeathReport(casualties, 'combat', hasSurgeon);
        
        content += `<strong>Battle Damage:</strong><br>` +
                  `‚Ä¢ Ship condition: ${this.gameState.ownedShip.condition}%<br><br>` +
                  `<em>The seas remember those who stand against piracy!</em>`;
    } else if (result === 'defeat') {
        this.handlePirateDefeat(true);
        return;
    } else if (result === 'escape') {
        content += `<strong>üèÉ Successful Escape!</strong><br><br>` +
                  `You manage to break away from the pirates!<br><br>` +
                  `Your superior seamanship saves the day.<br><br>` +
                  `<em>Sometimes discretion is the better part of valor.</em>`;
        this.characterData.stats.navigation += 0.2;
    }
    
    // Clear combat state and processing flags
this.combatState = null;
this.enemyShip = null;
this.processingCombatAction = false;

// Mark as critical if there were casualties
if (casualties && casualties.length > 0) {
    this.criticalMessageActive = true;
}

// Add a proper continue button that handles naval missions correctly
if (this.isNavalMissionCombat) {
    content += `<div style="text-align: center; margin-top: 20px;">`;
    content += `<button onclick="game.completeNavalMissionCombat()" style="background: linear-gradient(145deg, #d4af37, #b8941f); border: 2px solid #8b7355; color: #2c3e50; font-size: 1.1em; font-weight: bold; padding: 12px 25px; border-radius: 8px; cursor: pointer;">Continue</button>`;
    content += `</div>`;
} else {
    content += `<div style="text-align: center; margin-top: 20px;">`;
    content += `<button onclick="game.hideEmergencyEvent()" style="background: linear-gradient(145deg, #d4af37, #b8941f); border: 2px solid #8b7355; color: #2c3e50; font-size: 1.1em; font-weight: bold; padding: 12px 25px; border-radius: 8px; cursor: pointer;">Continue</button>`;
    content += `</div>`;
}

this.showEmergencyEvent('‚öîÔ∏è Combat Complete', content);
}


completeNavalMissionCombat() {
    console.log('Completing naval mission combat');
    
    // Hide the combat complete message
    this.hideEmergencyEvent();
    
    // Process naval mission outcome
    if (this.isNavalMissionCombat && this.currentNavalMission) {
        const mission = this.getAllNavalMissions().find(m => m.id === this.currentNavalMission);
        if (mission) {
            // Determine success based on combat result
            const missionSuccess = this.combatState && this.combatState.playerHull > 0;
            
            // Clear flags BEFORE showing results
            this.isNavalMissionCombat = false;
            this.currentNavalMission = null;
            
            // Show mission results after a brief delay
setTimeout(() => {
    this.processNavalMissionOutcome(mission, missionSuccess);
}, 500);
        }
    }
}


            

resolvePirateFight(pirateStrength, playerStrength) {
    const success = Math.random() < (playerStrength / (playerStrength + pirateStrength));
    
    if (success) {
        // Victory!
        const treasure = Math.floor(Math.random() * 300) + 200;
        this.characterData.stats.money += treasure;
        this.characterData.reputation.pirate -= 2; // Pirates fear you
        this.characterData.reputation.crown += 1; // Crown approves
        this.characterData.stats.leadership += 0.3;
        
        // Minor ship damage from battle
        this.gameState.ownedShip.condition -= Math.floor(Math.random() * 15) + 5;
        this.gameState.ownedShip.condition = Math.max(0, this.gameState.ownedShip.condition);
        
        this.showEmergencyEvent('‚öîÔ∏è VICTORY!', 
            `<strong>You defeated the pirates!</strong><br><br>` +
            `Your crew fought bravely and the pirate ship is captured!<br><br>` +
            `<strong>Spoils of War:</strong><br>` +
            `‚Ä¢ ${treasure} gold in pirate treasure<br>` +
            `‚Ä¢ +0.3 Leadership skill<br>` +
            `‚Ä¢ +1 Crown reputation (heroic deed)<br>` +
            `‚Ä¢ -2 Pirate reputation (they fear you)<br><br>` +
            `<strong>Battle Damage:</strong><br>` +
            `‚Ä¢ Ship condition: ${this.gameState.ownedShip.condition}%<br><br>` +
            `<em>"The seas remember those who stand against piracy!"</em>`);
    } else {
        // Defeat!
        this.handlePirateDefeat(true);
    }
    
    // Remove timeout - let player dismiss manually
}

resolvePirateNegotiation(pirateStrength, successChance) {
    const success = Math.random() < (successChance / 100);
    
    if (success) {
        const tribute = Math.floor(Math.random() * 50) + 50;
        if (this.characterData.stats.money >= tribute) {
            this.characterData.stats.money -= tribute;
            this.characterData.stats.social += 0.2;
            
            this.showEmergencyEvent('ü§ù Negotiation Success', 
                `You successfully negotiate with the pirates!<br><br>` +
                `"Aye, you speak fair words, captain. We'll take our tribute and be on our way."<br><br>` +
                `<strong>Settlement:</strong><br>` +
                `‚Ä¢ Paid ${tribute} gold tribute<br>` +
                `‚Ä¢ No damage to ship or crew<br>` +
                `‚Ä¢ +0.2 Social skill<br><br>` +
                `<em>Sometimes wisdom is worth more than valor.</em>`);
        } else {
            this.handlePirateDefeat(false);
        }
    } else {
        this.showEmergencyEvent('üó£Ô∏è Negotiation Failed', 
            `The pirate captain laughs at your words!<br><br>` +
            `"You think you can bargain with us? Prepare to be boarded!"<br><br>` +
            `<em>The pirates attack with renewed fury...</em>`);
        
        setTimeout(() => {
            this.handlePirateDefeat(true);
        }, 6000);
    }
}

resolvePirateFlee(pirateStrength, successChance) {
    const success = Math.random() < (successChance / 100);
    
    if (success) {
        this.gameState.ownedShip.condition -= Math.floor(Math.random() * 8) + 2;
        this.characterData.stats.navigation += 0.2;
        
        this.showEmergencyEvent('üèÉ Successful Escape!', 
            `Your superior seamanship saves the day!<br><br>` +
            `"Hard to port! All sail!" You expertly navigate treacherous waters and lose the pirates in a maze of reefs.<br><br>` +
            `<strong>Escape Results:</strong><br>` +
            `‚Ä¢ Ship escaped safely<br>` +
            `‚Ä¢ Minor wear from hard sailing<br>` +
            `‚Ä¢ +0.2 Navigation skill<br><br>` +
            `<em>"Sometimes the better part of valor is discretion."</em>`);
    } else {
        this.showEmergencyEvent('‚ö†Ô∏è Caught While Fleeing!', 
            `The pirates catch up to you!<br><br>` +
            `"You cannot escape us so easily!" Your ship is overtaken and now you face them from a position of weakness.<br><br>` +
            `<em>The pirates board your vessel...</em>`);
        
        setTimeout(() => {
            this.handlePirateDefeat(true);
        }, 6000);
    }
}



getNavalRankFromExperience(experience) {
    // Safety check for undefined/null values
    if (experience === undefined || experience === null || isNaN(experience)) {
        return 0; // Default to Seaman rank
    }
    // Realistic naval career progression - early ranks come quickly, admiral takes decades
    // Seaman: 0-10 experience (quick start)
    // Able Seaman: 11-25 experience (few months service)
    // Midshipman: 26-50 experience (1-2 years, officer training)
    // Lieutenant: 51-120 experience (2-5 years, junior officer)
    // Commander: 121-250 experience (5-12 years, seasoned officer)
    // Captain: 251-450 experience (12-20 years, ship command)
    // Admiral: 451+ experience (20+ years, fleet command)
    
    if (experience <= 10) return 0;        // Seaman
    if (experience <= 25) return 1;        // Able Seaman  
    if (experience <= 50) return 2;        // Midshipman
    if (experience <= 120) return 3;       // Lieutenant
    if (experience <= 250) return 4;       // Commander
    if (experience <= 450) return 5;       // Captain
    return 6;                              // Admiral
}
        
    
// Character Sheet Functions
showCharacterSheet() {
    console.log('About to show character creation');
    console.log('Character creation method called');
    this.updateCharacterSheetContent();
    document.getElementById('characterSheet').classList.remove('hidden');
}

hideCharacterSheet() {
    document.getElementById('characterSheet').classList.add('hidden');
}


showEmergencyEvent(title, content, hideButton = false) {
    // Add to queue
    this.alertQueue.push({ title, content, hideButton, timestamp: Date.now() });
    
    // If not currently showing an alert, start showing them
    if (!this.isShowingAlert) {
        this.showNextAlert();
    }
}

showNextAlert() {
    if (this.alertQueue.length === 0) {
        this.isShowingAlert = false;
        return;
    }
    
    this.isShowingAlert = true;
    const alert = this.alertQueue.shift();
    
    // Show queue indicator if more alerts are waiting
    let queueIndicator = '';
    if (this.alertQueue.length > 0) {
        queueIndicator = `<div style="position: absolute; top: 10px; right: 50px; background: #ffc107; color: #000; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; font-weight: bold;">+${this.alertQueue.length} more</div>`;
    }
    
    // Auto-add Continue button UNLESS the content already has a button or hideButton is true
    let finalContent = alert.content + queueIndicator;
    
    // Check if content already has a button or if we should hide it
    if (!alert.hideButton && !finalContent.includes('<button')) {
        finalContent += `<div style="text-align: center; margin-top: 20px;">
            <button onclick="game.hideEmergencyEvent()" style="background: linear-gradient(145deg, #d4af37, #b8941f); border: 2px solid #8b7355; color: #2c3e50; font-size: 1.1em; font-weight: bold; padding: 12px 25px; border-radius: 8px; cursor: pointer;">Continue</button>
        </div>`;
    }
    
    document.getElementById('emergencyTitle').innerHTML = alert.title;
    document.getElementById('emergencyContent').innerHTML = finalContent;
    document.getElementById('emergencyModal').classList.remove('hidden');
}

hideEmergencyEvent() {
    document.getElementById('emergencyModal').classList.add('hidden');
    this.criticalMessageActive = false; // Clear the flag when manually dismissed
    
    // Show next alert in queue after a brief delay
    setTimeout(() => {
        this.showNextAlert();
    }, 300); // Short delay so user can see the transition
}


handlePirateDefeat(isViolent) {
    const ship = this.gameState.ownedShip;
    
    // Calculate losses
    const cargoStolen = Math.floor(this.getShipCargoCount() * 0.6); // 60% of cargo stolen
    const goldStolen = Math.floor(this.characterData.stats.money * 0.3); // 30% of gold stolen
    const shipDamage = Math.floor(Math.random() * 40) + 20; // 20-60 damage
    
    // Apply losses
    this.characterData.stats.money -= goldStolen;
    ship.condition -= shipDamage;
    ship.condition = Math.max(0, ship.condition);
    
    // Clear most cargo
    if (ship.cargoHold) {
        Object.keys(ship.cargoHold).forEach(good => {
            ship.cargoHold[good] = Math.floor(ship.cargoHold[good] * 0.4); // Keep only 40%
        });
    }
    
    // Reputation damage
    this.characterData.reputation.pirate += 1; // Pirates think you're weak
    
    let resultText = `<strong>üíÄ DEFEATED BY PIRATES!</strong><br><br>`;
    
    if (ship.condition === 0) {
        resultText += `Your ship "${ship.shipName}" is destroyed! The pirates have sunk your vessel!<br><br>`;
        resultText += `<strong>TOTAL DISASTER:</strong><br>`;
        resultText += `‚Ä¢ Ship completely destroyed<br>`;
        resultText += `‚Ä¢ All cargo lost to the depths<br>`;
        resultText += `‚Ä¢ ${goldStolen} gold stolen<br>`;
        resultText += `‚Ä¢ You barely escape with your life<br><br>`;
        resultText += `<em>You wash ashore, penniless and shipless. The pirate's laughter echoes in your ears...</em>`;
        
        // Remove the ship
        this.gameState.ownedShip = null;
    } else {
        resultText += `The pirates have ransacked your ship and left you broken!<br><br>`;
        resultText += `<strong>Devastating Losses:</strong><br>`;
        resultText += `‚Ä¢ ${goldStolen} gold stolen<br>`;
        resultText += `‚Ä¢ ${cargoStolen} cargo units plundered<br>`;
        resultText += `‚Ä¢ Ship condition: ${ship.condition}% (severe damage)<br>`;
        resultText += `‚Ä¢ +1 Pirate reputation (marked as easy prey)<br><br>`;
        resultText += `<em>"Next time bring more than words and wishes, landlubber!"</em>`;
   }

// Major defeat severely hurts crew loyalty
if (ship && ship.namedCrew) {
    ship.namedCrew.forEach(member => {
        member.loyalty = Math.max(0, member.loyalty - 15);
    });
    resultText += `<br><br><em>Crew morale plummets after the devastating defeat (-15 loyalty to all crew)</em>`;
}

this.showEmergencyEvent('üíÄ Pirate Victory', resultText);
}

    

processMonthlyEvents(completedMissions = []) {
    let monthlyReport = [];
    let totalIncome = 0;
    let totalExpenses = 0;
    
    // Handle monthly economic changes, loan interest, etc.
    if (this.gameState.bankAccount && this.gameState.bankAccount.loan > 0) {
        const interest = Math.floor(this.gameState.bankAccount.loan * this.gameState.bankAccount.loanInterestRate);
        this.gameState.bankAccount.loan += interest;
        totalExpenses += interest;
        monthlyReport.push(`<span style="color: #dc3545;">‚Ä¢ Loan Interest: -${interest} gold</span>`);
    }
    
    if (this.gameState.bankAccount && this.gameState.bankAccount.balance > 0) {
        // Prevent interest farming - track last interest payment
        if (!this.gameState.bankAccount.lastInterestMonth) {
            this.gameState.bankAccount.lastInterestMonth = 0;
        }
        
        const currentMonth = (this.gameState.year - 1740) * 12 + this.gameState.month;
        if (currentMonth > this.gameState.bankAccount.lastInterestMonth) {
            const interest = Math.floor(this.gameState.bankAccount.balance * this.gameState.bankAccount.depositInterestRate);
            this.gameState.bankAccount.balance += interest;
            this.gameState.bankAccount.lastInterestMonth = currentMonth;
            totalIncome += interest;
            monthlyReport.push(`<span style="color: #28a745;">‚Ä¢ Bank Interest: +${interest} gold</span>`);
        }
    }

    // Ship maintenance costs for ALL ships
    let totalShipMaintenance = 0;
    if (this.gameState.ownedShips && this.gameState.ownedShips.length > 0) {
        this.gameState.ownedShips.forEach(ship => {
            if (ship.maintenanceCost) {
                const cost = ship.maintenanceCost;
                totalShipMaintenance += cost;
                this.characterData.stats.money -= cost;
            }
        });
        
        if (totalShipMaintenance > 0) {
            totalExpenses += totalShipMaintenance;
            monthlyReport.push(`<span style="color: #dc3545;">‚Ä¢ Ship Maintenance (${this.gameState.ownedShips.length} ships): -${totalShipMaintenance} gold</span>`);
        }
    }

    // Captain salaries for ALL ships
    let totalCaptainSalaries = 0;
    if (this.gameState.ownedShips && this.gameState.ownedShips.length > 0) {
        this.gameState.ownedShips.forEach(ship => {
            if (ship.captain && ship.captain.salary) {
                const salary = ship.captain.salary;
                totalCaptainSalaries += salary;
                this.characterData.stats.money -= salary;
            }
        });
        
        if (totalCaptainSalaries > 0) {
            totalExpenses += totalCaptainSalaries;
            monthlyReport.push(`<span style="color: #dc3545;">‚Ä¢ Captain Salaries: -${totalCaptainSalaries} gold</span>`);
        }
    }

    // Property maintenance costs
    if (this.gameState.ownedProperty) {
        const propertyCosts = {
            cottage: 5,
            townhouse: 15,
            manor: 25
        };
        
        const cost = propertyCosts[this.gameState.ownedProperty.type] || 10;
        this.characterData.stats.money -= cost;
        totalExpenses += cost;
        monthlyReport.push(`<span style="color: #dc3545;">‚Ä¢ Property Maintenance: -${cost} gold</span>`);
    }        

    // Naval salary payments
    if (this.gameState.navalCareer && this.gameState.navalCareer.enlisted) {
        const ranks = ['Seaman', 'Able Seaman', 'Midshipman', 'Lieutenant', 'Commander', 'Captain', 'Admiral'];
        const salaries = [10, 15, 20, 30, 45, 70, 100];
        
        const rankIndex = Math.min(this.getNavalRankFromExperience(this.gameState.navalCareer.experience), ranks.length - 1);
        const salary = salaries[rankIndex];
        
        this.characterData.stats.money += salary;
        totalIncome += salary;
        monthlyReport.push(`<span style="color: #28a745;">‚Ä¢ Naval Salary (${ranks[rankIndex]}): +${salary} gold</span>`);
    }
    
    // Room benefits
    if (this.gameState.ownedProperty && this.gameState.ownedProperty.rooms) {
        const rooms = this.gameState.ownedProperty.rooms;
        let roomIncome = 0;
        
        if (rooms.includes('guest_room')) {
            roomIncome += 15;
        }
        if (rooms.includes('small_guest_house')) {
            roomIncome += 40;
        }
        if (rooms.includes('garden')) {
            roomIncome += 5;
        }
        if (rooms.includes('wine_cellar')) {
            roomIncome += 3;
        }
        
        if (roomIncome > 0) {
            this.characterData.stats.money += roomIncome;
            totalIncome += roomIncome;
            monthlyReport.push(`<span style="color: #28a745;">‚Ä¢ Property Income: +${roomIncome} gold</span>`);
        }
    }

    // Plantation income
    if (this.gameState.ownedPlantations && this.gameState.ownedPlantations.length > 0) {
        let totalPlantationIncome = 0;
        
        this.gameState.ownedPlantations.forEach(plantation => {
            const monthlyProfit = this.calculatePlantationProfit(plantation);
            totalPlantationIncome += monthlyProfit;
        });
        
        if (totalPlantationIncome > 0) {
            this.characterData.stats.money += totalPlantationIncome;
            totalIncome += totalPlantationIncome;
            monthlyReport.push(`<span style="color: #28a745;">‚Ä¢ Plantation Income: +${totalPlantationIncome} gold</span>`);
        }
    }

    // Marriage allowance
    if (this.characterData.marriageStatus === 'married' && this.characterData.spouse) {
        const spouse = this.characterData.spouse;
        let allowance = 0;

        switch(spouse.wealth) {
            case 'modest': allowance = 15; break;
            case 'comfortable': allowance = 30; break;
            case 'wealthy': allowance = 50; break;
            default: allowance = 20;
        }
        
        if (spouse.reputation === 'merchant') allowance += 10;
        if (spouse.reputation === 'crown') allowance += 5;
        
        this.characterData.stats.money += allowance;
        totalIncome += allowance;
        monthlyReport.push(`<span style="color: #28a745;">‚Ä¢ Family Support: +${allowance} gold</span>`);
    }

    // Children events for married couples
    if (this.characterData.marriageStatus === 'married' && this.characterData.spouse) {
        this.processChildrenEvents();
    }

    // Show consolidated monthly report (only if there are transactions)
    if (monthlyReport.length > 0) {
        const netChange = totalIncome - totalExpenses;
        const netColor = netChange >= 0 ? '#28a745' : '#dc3545';
        const netSign = netChange >= 0 ? '+' : '';
        
        let reportContent = `<strong>üìä Monthly Financial Report</strong><br><br>`;
        reportContent += `<strong>Transactions:</strong><br>`;
        reportContent += monthlyReport.join('<br>');
        reportContent += `<br><br><strong>Summary:</strong><br>`;
        reportContent += `‚Ä¢ Total Income: <span style="color: #28a745;">+${totalIncome} gold</span><br>`;
        reportContent += `‚Ä¢ Total Expenses: <span style="color: #dc3545;">-${totalExpenses} gold</span><br>`;
        reportContent += `‚Ä¢ Net Change: <span style="color: ${netColor};">${netSign}${netChange} gold</span><br><br>`;
        // Add mission results if any
if (completedMissions.length > 0) {
    let totalMissionProfit = 0;
    reportContent += `<br><strong>üö¢ Completed Missions:</strong><br>`;
    
    completedMissions.forEach(mission => {
        totalMissionProfit += mission.profit;
        reportContent += `‚Ä¢ ${mission.shipName}: ${mission.missionType} (+${mission.profit} gold)`;
        if (mission.specialtyBonus) reportContent += ` <em>(Specialty!)</em>`;
        reportContent += `<br>`;
    });
    
    totalIncome += totalMissionProfit;
    reportContent += `<strong>Total Mission Profits: +${totalMissionProfit} gold</strong><br>`;
}

reportContent += `<br><strong>Current Funds: ${this.characterData.stats.money} gold</strong><br><br>`;
reportContent += `<em>"Time passes, and the ledgers tell their tale..."</em>`;
        
        setTimeout(() => {
            this.showEmergencyEvent('üìä Monthly Report', reportContent);
        }, 1000);
    }
}
            


buyPlantation(plantationId) {
    const availablePlantations = this.getAvailablePlantations();
    const plantation = availablePlantations.find(p => p.id === plantationId);
    
    if (!plantation || this.characterData.stats.money < plantation.price) {
        this.showActivityResult('‚ùå Cannot Purchase', 'Insufficient funds or plantation not available.');
        return;
    }
    
    // Initialize plantations array if needed
    if (!this.gameState.ownedPlantations) {
        this.gameState.ownedPlantations = [];
    }
    
    // Deduct cost
    this.characterData.stats.money -= plantation.price;
    
    // Add plantation to owned list
    const newPlantation = {
        ...plantation,
        location: this.gameState.currentLocation,
        purchaseDate: { year: this.gameState.year, month: this.gameState.month },
        condition: 100,
        efficiency: 1.0,
        lastHarvest: { year: this.gameState.year, month: this.gameState.month }
    };
    
    this.gameState.ownedPlantations.push(newPlantation);
    
    // Increase colonial reputation
    this.characterData.reputation.colonial += 3;
    this.characterData.stats.social += 0.5;
    
    this.showActivityResult('üéâ Plantation Purchased!', 
        `Congratulations! You are now the owner of ${plantation.name}!<br><br>` +
        `<strong>Plantation Details:</strong><br>` +
        `‚Ä¢ Location: ${this.getLocationName(this.gameState.currentLocation)}<br>` +
        `‚Ä¢ Crop: ${plantation.type}<br>` +
        `‚Ä¢ Workers: ${plantation.workers} laborers<br>` +
        `‚Ä¢ Expected Monthly Profit: ${plantation.baseProfit} gold<br><br>` +
        `<strong>Benefits:</strong><br>` +
        `‚Ä¢ +3 Colonial reputation<br>` +
        `‚Ä¢ +0.5 Social skill (plantation owner status)<br>` +
        `‚Ä¢ Monthly income from agricultural exports<br><br>` +
        `<em>Your colonial empire begins to grow!</em>`);
        
    
}

calculatePlantationProfit(plantation) {
    let profit = plantation.baseProfit;
    
    // Apply efficiency multiplier
    profit *= plantation.efficiency;
    
    // Apply condition modifier
    profit *= (plantation.condition / 100);
    
    // Random market fluctuations (¬±20%)
    const marketVariation = 0.8 + (Math.random() * 0.4);
    profit *= marketVariation;
    
    return Math.floor(profit);
}


        
        
handleStormDamage() {
    if (!this.gameState.ownedShip) return;
    
    const ship = this.gameState.ownedShip;
    const stormSeverity = Math.floor(Math.random() * 3) + 1; // 1-3
    const damage = stormSeverity * 15 + Math.floor(Math.random() * 10);
    
    ship.condition -= damage;
    ship.condition = Math.max(0, ship.condition);
    
    let stormType = ['Lightning Storm', 'Hurricane', 'Severe Gale'][stormSeverity - 1];
    
    this.characterData.stats.navigation += 0.2; // Learn from experience
    
    let content = `<strong>‚õàÔ∏è ${stormType}!</strong><br><br>`;
    content += `Your ship "${ship.shipName}" is caught in a violent storm!<br><br>`;
    content += `<strong>Storm Damage:</strong><br>`;
    content += `‚Ä¢ Ship condition: ${ship.condition}% (-${damage} damage)<br>`;
    content += `‚Ä¢ +0.2 Navigation skill (storm experience)<br><br>`;
    
    if (ship.condition === 0) {
        content += `<em>Your ship is destroyed by the storm! You barely escape with your life...</em>`;
        this.gameState.ownedShip = null;
    } else if (ship.condition < 30) {
        content += `<em>Your ship is badly damaged and barely seaworthy. Find repairs immediately!</em>`;
    } else {
        content += `<em>You weather the storm, though your ship bears the scars of nature's fury.</em>`;
    }
    
    // Storm reduces crew loyalty if ship takes heavy damage
if (this.gameState.ownedShip && this.gameState.ownedShip.namedCrew) {
    const loyaltyLoss = Math.floor(damage / 10); // 1 loyalty per 10 damage
    this.gameState.ownedShip.namedCrew.forEach(member => {
        member.loyalty = Math.max(0, member.loyalty - loyaltyLoss);
    });
    
    if (loyaltyLoss > 0) {
        content += `<br><em>Crew morale drops from the dangerous conditions (-${loyaltyLoss} loyalty)</em>`;
    }
}

// Check for crew casualties in storm
let stormCasualties = this.checkCrewDeaths('storm', 0.04); // 4% base death chance in storms
const hasSurgeon = this.gameState.ownedShip.namedCrew && 
    this.gameState.ownedShip.namedCrew.some(member => member.specialty === 'surgeon');

// Add death report if there were casualties
content += this.getDeathReport(stormCasualties, 'storm', hasSurgeon);

// Mark as critical if there were casualties
if (stormCasualties && stormCasualties.length > 0) {
    this.criticalMessageActive = true;
}

this.showEmergencyEvent('‚õàÔ∏è Storm at Sea!', content);
}
        
handleDiseaseOutbreak() {
    const diseases = ['Scurvy', 'Ship Fever', 'Yellow Fever', 'Plague'];
    const disease = diseases[Math.floor(Math.random() * diseases.length)];
    const severity = Math.floor(Math.random() * 3) + 1;
    
    const goldLoss = severity * 20 + Math.floor(Math.random() * 30);
    this.characterData.stats.money -= Math.min(goldLoss, this.characterData.stats.money);
    
    let content = `<strong>ü¶† ${disease} Outbreak!</strong><br><br>`;
    content += `A deadly disease spreads through the port!<br><br>`;
    
    if (severity === 1) {
        content += `<strong>Mild Outbreak:</strong><br>`;
        content += `‚Ä¢ Medical costs: ${goldLoss} gold<br>`;
        content += `‚Ä¢ You recover quickly<br><br>`;
        content += `<em>You spend on medicine and rest, avoiding the worst effects.</em>`;
    } else if (severity === 2) {
        content += `<strong>Serious Outbreak:</strong><br>`;
        content += `‚Ä¢ Medical costs: ${goldLoss} gold<br>`;
        content += `‚Ä¢ Lost time recuperating<br><br>`;
        content += `<em>You fall ill but survive with proper care and medicine.</em>`;
this.advanceRegularTime(7); // 1 week recovery time
    } else {
        content += `<strong>Deadly Outbreak:</strong><br>`;
        content += `‚Ä¢ Medical costs: ${goldLoss} gold<br>`;
        content += `‚Ä¢ Serious health consequences<br><br>`;
        if (this.characterData.stats.money < 10) {
            content += `<em>Without gold for medicine, you barely survive. This was nearly the end...</em>`;
        } else {
            content += `<em>Expensive medicine and weeks of recovery save your life.</em>`;
        }
this.advanceRegularTime(14); // 2 weeks recovery time for serious illness
    }
    
    this.showEmergencyEvent('ü¶† Disease Outbreak!', content);
}

handleMarketCrash() {
    const crashTypes = [
        { name: 'Spice Market Collapse', affect: 'spices' },
        { name: 'Textile Industry Crisis', affect: 'textiles' },
        { name: 'Banking Panic', affect: 'all' },
        { name: 'War Embargo', affect: 'weapons' }
    ];
    
    const crash = crashTypes[Math.floor(Math.random() * crashTypes.length)];
    // Cap losses to make them reasonable
const maxLoss = 500; // Never lose more than 500 gold
const percentageLoss = Math.floor(this.characterData.stats.money * 0.08); // Reduced to 8%
const goldLoss = Math.min(maxLoss, percentageLoss);
    
    // Give player a choice instead of automatic loss
content = `<strong>üìâ ${crash.name}!</strong><br><br>`;
content += `<strong>How do you respond?</strong><br><br>`;

content += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
content += `<strong>üí∏ TAKE THE LOSS</strong><br>`;
content += `Accept the market crash and lose ${goldLoss} gold.<br>`;
content += `<button onclick="game.resolveMarketCrash('accept', ${goldLoss})">Accept Loss</button>`;
content += `</div>`;

if (this.characterData.stats.money >= goldLoss * 1.5) {
    const hedgeCost = Math.floor(goldLoss * 0.6);
    content += `<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üõ°Ô∏è HEDGE YOUR INVESTMENTS</strong><br>`;
    content += `Pay ${hedgeCost} gold to protect against the worst losses.<br>`;
    content += `<button onclick="game.resolveMarketCrash('hedge', ${hedgeCost})">Pay ${hedgeCost} gold</button>`;
    content += `</div>`;
}

content += `<div style="border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
content += `<strong>üìà RIDE IT OUT</strong><br>`;
content += `Take a smaller immediate loss but risk future problems.<br>`;
content += `<button onclick="game.resolveMarketCrash('wait', ${Math.floor(goldLoss * 0.4)})">Risk It</button>`;
content += `</div>`;

this.showEmergencyEvent('üìâ Market Crisis!', content);
    
    let content = `<strong>üìâ ${crash.name}!</strong><br><br>`;
    content += `Economic disaster strikes the trading markets!<br><br>`;
    content += `<strong>Financial Losses:</strong><br>`;
    content += `‚Ä¢ ${goldLoss} gold lost in market panic<br>`;
    content += `‚Ä¢ Some cargo spoiled or devalued<br>`;
    content += `‚Ä¢ Trading opportunities disrupted<br><br>`;
    content += `<em>Markets are unpredictable - even experienced traders can lose fortunes overnight.</em>`;
    
    this.showEmergencyEvent('üìâ Market Crash!', content);
}



resolveMarketCrash(choice, amount) {
    if (choice === 'accept') {
        this.characterData.stats.money -= amount;
        this.showEmergencyEvent('üí∏ Market Loss', 
            `You accept the market crash and lose ${amount} gold.<br><br>` +
            `Sometimes the wise investor knows when to cut losses.<br><br>` +
            `<em>Remaining funds: ${this.characterData.stats.money} gold</em>`);
    } else if (choice === 'hedge') {
        this.characterData.stats.money -= amount;
        this.characterData.stats.trading += 0.3;
        this.showEmergencyEvent('üõ°Ô∏è Smart Investment', 
            `You hedge your investments for ${amount} gold.<br><br>` +
            `Your quick thinking prevents larger losses!<br><br>` +
            `<strong>Benefits:</strong><br>` +
            `‚Ä¢ Avoided larger losses<br>` +
            `‚Ä¢ +0.3 Trading skill<br><br>` +
            `<em>Experience teaches valuable lessons about market protection.</em>`);
    } else if (choice === 'wait') {
        this.characterData.stats.money -= amount;
        // 30% chance of additional problems later
        if (Math.random() < 0.3) {
            setTimeout(() => {
                const additionalLoss = Math.floor(amount * 0.5);
                this.characterData.stats.money -= additionalLoss;
                this.showEmergencyEvent('üìâ Market Continues Falling', 
                    `The market crisis worsens! Additional loss: ${additionalLoss} gold.`);
            }, 5000);
        }
        this.showEmergencyEvent('üìà Riding the Storm', 
            `You take a smaller immediate loss of ${amount} gold.<br><br>` +
            `Time will tell if this was the right choice...<br><br>` +
            `<em>Sometimes patience pays off, sometimes it doesn't.</em>`);
    }
}

        

handleLuckyFind() {
    const finds = [
        { name: 'Washed-up Treasure Chest', gold: [50, 200] },
        { name: 'Merchant\'s Lost Purse', gold: [20, 80] },
        { name: 'Valuable Artifact', gold: [100, 300] },
        { name: 'Royal Reward', gold: [30, 150] }
    ];
    
    const find = finds[Math.floor(Math.random() * finds.length)];
    const goldGain = find.gold[0] + Math.floor(Math.random() * (find.gold[1] - find.gold[0]));
    
    this.characterData.stats.money += goldGain;
    
    let content = `<strong>‚ú® ${find.name}!</strong><br><br>`;
    content += `Fortune smiles upon you!<br><br>`;
    content += `<strong>Lucky Discovery:</strong><br>`;
    content += `‚Ä¢ Found ${goldGain} gold!<br>`;
    content += `‚Ä¢ No strings attached<br><br>`;
    content += `<em>Sometimes the sea gives back what it has taken from others.</em>`;
    
    this.showEmergencyEvent('‚ú® Lucky Find!', content);
}

handlePoliticalIntrigue() {
    const intrigues = [
        'Spy Network Discovered',
        'Royal Succession Crisis', 
        'Colonial Rebellion',
        'Trade War Brewing'
    ];
    
    const intrigue = intrigues[Math.floor(Math.random() * intrigues.length)];
    const repChange = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
    
    this.characterData.reputation.crown += repChange;
    
    let content = `<strong>üïµÔ∏è ${intrigue}!</strong><br><br>`;
    content += `Political tensions affect your standing!<br><br>`;
    
    if (repChange > 0) {
        content += `<strong>Positive Outcome:</strong><br>`;
        content += `‚Ä¢ +${repChange} Crown reputation<br>`;
        content += `‚Ä¢ Your loyalty is noted<br><br>`;
        content += `<em>Your discretion and loyalty serve you well in these troubled times.</em>`;
    } else if (repChange < 0) {
        content += `<strong>Negative Outcome:</strong><br>`;
        content += `‚Ä¢ ${repChange} Crown reputation<br>`;
        content += `‚Ä¢ Suspicion falls on you<br><br>`;
        content += `<em>You find yourself on the wrong side of political maneuvering.</em>`;
    } else {
        content += `<strong>Neutral Outcome:</strong><br>`;
        content += `‚Ä¢ No reputation change<br>`;
        content += `‚Ä¢ You stay out of the affair<br><br>`;
        content += `<em>Wisely, you avoid taking sides in dangerous political games.</em>`;
    }
    
    this.showEmergencyEvent('üïµÔ∏è Political Intrigue!', content);
}

handlePressGang() {
    if (!this.gameState.navalCareer || !this.gameState.navalCareer.enlisted) {
        const forced = Math.random() < 0.3; // 30% chance of being forced
        
        if (forced) {
            this.gameState.navalCareer = {
                enlisted: true,
                rank: 'Seaman',
                experience: 0,
                missions_completed: 0,
                prize_money: 0,
                reputation: -1,
                pressed: true
            };
            
            this.characterData.stats.seamanship += 0.5;
            this.characterData.reputation.crown -= 1;
            
            let content = `<strong>‚öì Press Gang!</strong><br><br>`;
            content += `Royal Navy press gangs seize you!<br><br>`;
            content += `<strong>Forced Conscription:</strong><br>`;
            content += `‚Ä¢ Impressed into naval service<br>`;
            content += `‚Ä¢ Starting rank: Seaman<br>`;
            content += `‚Ä¢ -1 Crown reputation (resentment)<br>`;
            content += `‚Ä¢ +0.5 Seamanship (harsh training)<br><br>`;
            content += `<em>"King's service awaits, willing or not!"</em>`;
            
            this.showEmergencyEvent('‚öì Pressed into Service!', content);
        } else {
            const bribeCost = Math.floor(Math.random() * 30) + 20;
            
            if (this.characterData.stats.money >= bribeCost) {
                this.characterData.stats.money -= bribeCost;
                
                let content = `<strong>‚öì Press Gang Avoided!</strong><br><br>`;
                content += `Royal Navy press gangs try to seize you, but you escape!<br><br>`;
                content += `<strong>Successful Evasion:</strong><br>`;
                content += `‚Ä¢ Bribed officials: ${bribeCost} gold<br>`;
                content += `‚Ä¢ Avoided forced naval service<br><br>`;
                content += `<em>A few coins in the right hands keep you free.</em>`;
                
                this.showEmergencyEvent('‚öì Press Gang Evaded!', content);
            } else {
                // Forced service due to lack of funds
                this.gameState.navalCareer = {
                    enlisted: true,
                    rank: 'Seaman',
                    experience: 0,
                    missions_completed: 0,
                    prize_money: 0,
                    reputation: -1,
                    pressed: true
                };
                
                let content = `<strong>‚öì Press Gang Success!</strong><br><br>`;
                content += `Without gold to bribe your way out, you're pressed into service!<br><br>`;
                content += `<strong>Forced Naval Service:</strong><br>`;
                content += `‚Ä¢ Couldn't afford ${bribeCost} gold bribe<br>`;
                content += `‚Ä¢ Impressed into the Royal Navy<br><br>`;
                content += `<em>The poor serve whether they wish it or not.</em>`;
                
                this.showEmergencyEvent('‚öì Pressed into Service!', content);
            }
        }
    } else {
        // Already in navy - different event
        let content = `<strong>‚öì Press Gang Recognition!</strong><br><br>`;
        content += `Press gangs recognize your naval service and salute respectfully.<br><br>`;
        content += `<em>"Carry on, sailor. The King's Navy respects its own."</em>`;
        
        this.showEmergencyEvent('‚öì Naval Recognition!', content);
    }
    
}

handleRoyalDecree() {
    const decrees = [
        { name: 'New Trade Taxes', effect: 'tax', value: 50 },
        { name: 'Royal Bounty', effect: 'reward', value: 100 },
        { name: 'Military Conscription', effect: 'military', value: 0 },
        { name: 'Port Restrictions', effect: 'restriction', value: 0 }
    ];
    
    const decree = decrees[Math.floor(Math.random() * decrees.length)];
    
    let content = `<strong>üëë Royal Decree: ${decree.name}!</strong><br><br>`;
    content += `His Majesty has issued a new proclamation!<br><br>`;
    
    switch (decree.effect) {
        case 'tax':
            this.characterData.stats.money -= decree.value;
            content += `<strong>New Tax:</strong><br>`;
            content += `‚Ä¢ ${decree.value} gold collected<br>`;
            content += `‚Ä¢ All subjects must pay<br><br>`;
            content += `<em>"The Crown requires funds for the realm's defense."</em>`;
            break;
            
        case 'reward':
            this.characterData.stats.money += decree.value;
            this.characterData.reputation.crown += 1;
            content += `<strong>Royal Bounty:</strong><br>`;
            content += `‚Ä¢ ${decree.value} gold awarded<br>`;
            content += `‚Ä¢ +1 Crown reputation<br><br>`;
            content += `<em>"The Crown rewards loyal subjects generously."</em>`;
            break;
            
        case 'military':
            if (this.gameState.navalCareer && this.gameState.navalCareer.enlisted) {
                this.characterData.stats.money += 25;
                content += `<strong>Military Service Bonus:</strong><br>`;
                content += `‚Ä¢ 25 gold service bonus<br>`;
                content += `‚Ä¢ Naval personnel rewarded<br><br>`;
                content += `<em>"Those who serve the Crown are honored."</em>`;
            } else {
                content += `<strong>Conscription Call:</strong><br>`;
                content += `‚Ä¢ Military service encouraged<br>`;
                content += `‚Ä¢ Civilians urged to enlist<br><br>`;
                content += `<em>"The Crown calls upon all able-bodied subjects."</em>`;
            }
            break;
    }
    
    this.showEmergencyEvent('üëë Royal Decree!', content);
}

handleNavalEmergency() {
    if (!this.gameState.navalCareer || !this.gameState.navalCareer.enlisted) return;
    
    const emergencies = [
        'Enemy Fleet Spotted',
        'Urgent Supply Mission', 
        'Rescue Operation',
        'Strategic Reconnaissance'
    ];
    
    const emergency = emergencies[Math.floor(Math.random() * emergencies.length)];
    const success = Math.random() < 0.7; // 70% success rate
    
    if (success) {
        const reward = Math.floor(Math.random() * 50) + 30;
        this.characterData.stats.money += reward;
        const oldExperience = this.gameState.navalCareer.experience;        this.gameState.navalCareer.experience += 1;
        this.checkNavalPromotion(oldExperience, this.gameState.navalCareer.experience);        this.gameState.navalCareer.reputation += 1;
        const expGains = this.giveCrewExperience('combat', 15);        
        let content = `<strong>‚öì Naval Emergency: ${emergency}!</strong><br><br>`;
        content += `You respond to an urgent naval situation!<br><br>`;
        content += `<strong>Mission Success:</strong><br>`;
        content += `‚Ä¢ ${reward} gold reward<br>`;
        content += `‚Ä¢ +2 Naval experience<br>`;
        content += `‚Ä¢ +1 Naval reputation<br><br>`;

if (expGains && expGains.length > 0) {
    content += `<strong>üåü Crew Experience:</strong><br>`;
    expGains.forEach(gain => {
        content += `‚Ä¢ ${gain}<br>`;
    });
    content += `<br>`;
}

content += `<em>"Well done, sailor. The Navy counts on officers like you."</em>`;
        
        this.showEmergencyEvent('‚öì Naval Success!', content);
    } else {
        this.gameState.navalCareer.reputation -= 1;
        
        let content = `<strong>‚öì Naval Emergency: ${emergency}!</strong><br><br>`;
        content += `You respond to a naval emergency but things go poorly.<br><br>`;
        content += `<strong>Mission Failure:</strong><br>`;
        content += `‚Ä¢ -1 Naval reputation<br>`;
        content += `‚Ä¢ No reward<br><br>`;
        content += `<em>"The Navy expects better from its officers."</em>`;
        
        this.showEmergencyEvent('‚öì Naval Setback!', content);
    }
    
}

handleShipwreckRisk() {
    if (!this.gameState.ownedShip) return;
    
    const ship = this.gameState.ownedShip;
    const riskLevel = ship.condition < 50 ? 'high' : ship.condition < 80 ? 'medium' : 'low';
    
    let wrecked = false;
    if (riskLevel === 'high') {
        wrecked = Math.random() < 0.3; // 30% chance
    } else if (riskLevel === 'medium') {
        wrecked = Math.random() < 0.1; // 10% chance  
    } else {
        wrecked = Math.random() < 0.02; // 2% chance
    }
    
    if (wrecked) {
        // Total shipwreck
        const goldSaved = Math.floor(this.characterData.stats.money * 0.3);
        this.characterData.stats.money = goldSaved;
        this.gameState.ownedShip = null;
        
        let content = `<strong>üö¢üí• SHIPWRECK!</strong><br><br>`;
        content += `Your ship "${ship.shipName}" breaks apart and sinks!<br><br>`;
        content += `<strong>Total Disaster:</strong><br>`;
        content += `‚Ä¢ Ship completely lost<br>`;
        content += `‚Ä¢ All cargo lost to the depths<br>`;
        content += `‚Ä¢ Most gold lost: ${this.characterData.stats.money - goldSaved} gold<br>`;
        content += `‚Ä¢ You wash ashore with only ${goldSaved} gold<br><br>`;
        content += `<em>You barely survive, clinging to debris as your ship disappears beneath the waves...</em>`;
        
// Shipwreck is always critical
this.criticalMessageActive = true;
this.showEmergencyEvent('üö¢üí• SHIPWRECK!', content);    } else {
        // Near miss
        const damage = Math.floor(Math.random() * 20) + 10;
        ship.condition -= damage;
        ship.condition = Math.max(0, ship.condition);
        
        this.characterData.stats.navigation += 0.3;
        
        let content = `<strong>‚ö†Ô∏è Near Shipwreck!</strong><br><br>`;
        content += `Your ship "${ship.shipName}" barely avoids disaster!<br><br>`;
        content += `<strong>Close Call:</strong><br>`;
        content += `‚Ä¢ Ship damage: -${damage} condition<br>`;
        content += `‚Ä¢ Current condition: ${ship.condition}%<br>`;
        content += `‚Ä¢ +0.3 Navigation skill (experience)<br><br>`;
        
        if (ship.condition < 30) {
            content += `<em>Your ship is barely holding together! Find repairs immediately!</em>`;
        } else {
            content += `<em>Quick thinking and skilled seamanship save your vessel from destruction.</em>`;
        }
        
        this.showEmergencyEvent('‚ö†Ô∏è Shipwreck Avoided!', content);
    }
    
}



checkNavalPromotion(oldExperience, newExperience) {
    const ranks = ['Seaman', 'Able Seaman', 'Midshipman', 'Lieutenant', 'Commander', 'Captain', 'Admiral'];
    const salaries = [10, 15, 20, 30, 45, 70, 100];
    
   const oldRankIndex = Math.min(this.getNavalRankFromExperience(oldExperience), ranks.length - 1);
const newRankIndex = Math.min(this.getNavalRankFromExperience(newExperience), ranks.length - 1);
    
    if (newRankIndex > oldRankIndex) {
        // Promotion occurred!
        const newRank = ranks[newRankIndex];
        const newSalary = salaries[newRankIndex];
        const salaryIncrease = salaries[newRankIndex] - salaries[oldRankIndex];
        
        let content = `<strong>üéñÔ∏è NAVAL PROMOTION!</strong><br><br>`;
        content += `Congratulations! You have been promoted to <strong>${newRank}</strong>!<br><br>`;
        content += `<strong>New Benefits:</strong><br>`;
        content += `‚Ä¢ Monthly salary: ${newSalary} gold (+${salaryIncrease} increase)<br>`;
        content += `‚Ä¢ Naval experience: ${newExperience}<br>`;
        
        // Add rank-specific benefits
        if (newRankIndex >= 2) { // Midshipman+
            content += `‚Ä¢ Access to medium-difficulty missions<br>`;
        }
        if (newRankIndex >= 3) { // Lieutenant+
            content += `‚Ä¢ Can command Privateer Vessels<br>`;
        }
        if (newRankIndex >= 4) { // Commander+
            content += `‚Ä¢ Can command Ships of the Line<br>`;
            content += `‚Ä¢ Eligible for fleet command missions<br>`;
        }
        if (newRankIndex >= 5) { // Captain+
            content += `‚Ä¢ Can request honorable discharge with full pension<br>`;
        }
        
        content += `<br><em>"Your dedication to His Majesty's service has been recognized!"</em>`;
        
        // Show promotion with special styling
        setTimeout(() => {
            this.showEmergencyEvent('üéñÔ∏è Naval Promotion!', content);
        }, 1000);
    }
}            
        
updateCharacterSheetContent() {

    
// Add enhanced marriage status
let marriageText = '';
if (this.characterData.marriageStatus === 'married' && this.characterData.spouse) {
    const spouse = this.characterData.spouse;
    const marriageLength = this.getMarriageLength(spouse.marriageDate);
    marriageText = `
        <h4>üíï Marriage:</h4>
        <ul>
            <li><strong>Spouse:</strong> ${spouse.name} (Age ${spouse.age})</li>
            <li><strong>Background:</strong> ${spouse.background}</li>
            <li><strong>Personality:</strong> ${spouse.personality.trait}, loves ${spouse.personality.interest}</li>
            <li><strong>Married:</strong> ${marriageLength}</li>
            <li><strong>Family Wealth:</strong> ${spouse.wealth}</li>
        </ul>
    `;
} else if (this.characterData.marriageStatus === 'courting') {
    marriageText = `<p><strong>Relationship Status:</strong> Courting</p>`;
} else {
    marriageText = `<p><strong>Relationship Status:</strong> Single</p>`;
}
    
    let content = `
        <h3>${this.characterData.name}</h3>
        <p><strong>Background:</strong> ${this.getBackgroundName()}</p>
        <p><strong>Traits:</strong> ${this.getTraitNames().join(', ')}</p>
<p><strong>Age:</strong> ${this.characterData.age} years</p>
<p><strong>Health:</strong> ${this.characterData.health}%</p>
${marriageText}
        <h4>Skills:</h4>
        <ul>
            <li>Seamanship: ${this.characterData.stats.seamanship.toFixed(1)}</li>
            <li>Trading: ${this.characterData.stats.trading.toFixed(1)}</li>
            <li>Navigation: ${this.characterData.stats.navigation.toFixed(1)}</li>
            <li>Leadership: ${this.characterData.stats.leadership.toFixed(1)}</li>
            <li>Social: ${this.characterData.stats.social.toFixed(1)}</li>
        </ul>
        
        <h4>Reputation:</h4>
        <ul>
            <li>Crown: ${this.characterData.reputation.crown}</li>
            <li>Merchant: ${this.characterData.reputation.merchant}</li>
            <li>Colonial: ${this.characterData.reputation.colonial}</li>
            <li>Pirate: ${this.characterData.reputation.pirate}</li>
        </ul>
    `;
    
    // ADD THIS NEW SHIP SECTION:
    if (this.gameState.ownedShip) {
        content += `
            <h4>‚õµ Ship:</h4>
            <ul>
                <li><strong>Name:</strong> "${this.gameState.ownedShip.shipName}"</li>
                <li><strong>Type:</strong> ${this.gameState.ownedShip.name}</li>
                <li><strong>Condition:</strong> ${this.gameState.ownedShip.condition}%</li>
                <li><strong>Location:</strong> ${this.getLocationName(this.gameState.ownedShip.location)}</li>
                <li><strong>Cargo Capacity:</strong> ${this.gameState.ownedShip.cargo}</li>
                <li><strong>Crew:</strong> ${this.gameState.ownedShip.crew}/${this.gameState.ownedShip.maxCrew}</li>
            </ul>
        `;
    }
    
    // ADD NAVAL CAREER IF APPLICABLE:
    if (this.gameState.navalCareer && this.gameState.navalCareer.enlisted) {
        const ranks = ['Seaman', 'Able Seaman', 'Midshipman', 'Lieutenant', 'Commander', 'Captain', 'Admiral'];
        const rankIndex = Math.min(this.getNavalRankFromExperience(this.gameState.navalCareer.experience), ranks.length - 1);
        
        content += `
            <h4>‚öîÔ∏è Naval Career:</h4>
            <ul>
                <li><strong>Rank:</strong> ${ranks[rankIndex]}</li>
                <li><strong>Experience:</strong> ${this.gameState.navalCareer.experience}</li>
                <li><strong>Missions:</strong> ${this.gameState.navalCareer.missions_completed}</li>
                <li><strong>Prize Money:</strong> ${this.gameState.navalCareer.prize_money} gold</li>
            </ul>
        `;
    }
    
    document.getElementById('characterSheetContent').innerHTML = content;
}

getBackgroundName() {
    const names = {
        dockworker: 'Poor Dock Worker',
        merchant: 'Merchant\'s Son',
        noble: 'Minor Noble',
        orphan: 'Ship\'s Orphan'
    };
    return names[this.characterData.background] || 'Unknown';
}

getTraitNames() {
    const names = {
        quicklearner: 'Quick Learner',
        bornsailor: 'Born Sailor',
        silvertongue: 'Silver Tongue',
        lucky: 'Lucky',
        brave: 'Brave',
        frugal: 'Frugal'
    };
    return this.characterData.traits.map(trait => names[trait] || trait);
}

// ADD ALL THE TRADING METHODS HERE:
initializeTrading() {
    // Player inventory
    if (!this.gameState.inventory) {
        this.gameState.inventory = {};
    }
    
    // Player carrying capacity (personal inventory limit)
    this.gameState.personalInventoryLimit = 5;
    
    // Market prices by location
    this.marketPrices = {
    london: {
        textiles: { buy: 10, sell: 8 },
        tools: { buy: 15, sell: 12 },
        books: { buy: 5, sell: 4 },
        spices: { buy: 25, sell: 20 },
        weapons: { buy: 30, sell: 25 }
    },
    amsterdam: {
        textiles: { buy: 14, sell: 12 },
        tools: { buy: 18, sell: 16 },
        books: { buy: 7, sell: 6 },
        spices: { buy: 22, sell: 20 },
        weapons: { buy: 35, sell: 30 }
    },
    lisbon: {
        textiles: { buy: 16, sell: 14 },
        tools: { buy: 20, sell: 18 },
        books: { buy: 5, sell: 4 },
        spices: { buy: 18, sell: 15 },
        weapons: { buy: 28, sell: 25 }
    },
    bristol: {
        textiles: { buy: 10, sell: 8 },
        tools: { buy: 14, sell: 12 },
        books: { buy: 7, sell: 6 },
        spices: { buy: 30, sell: 25 },
        weapons: { buy: 28, sell: 26 }
    }
};
    
    // Goods descriptions
    this.goodsInfo = {
    textiles: { name: 'Textiles', description: 'Fine cloth and fabrics' },
    tools: { name: 'Tools', description: 'Quality iron implements' },
    weapons: { name: 'Weapons', description: 'Swords and firearms' },
    sugar: { name: 'Sugar', description: 'Caribbean sugar cane' },
    tobacco: { name: 'Tobacco', description: 'Virginia tobacco leaves' },
    rum: { name: 'Rum', description: 'Caribbean rum spirits' }
};
}

getPersonalInventoryCount() {
    return Object.values(this.gameState.inventory).reduce((total, quantity) => total + quantity, 0);
}

getShipCargoCount() {
    if (!this.gameState.ownedShip || !this.gameState.ownedShip.cargoHold) {
        return 0;
    }
    return Object.values(this.gameState.ownedShip.cargoHold).reduce((total, quantity) => total + quantity, 0);
}

buyGoodToInventory(good, price) {
    const qtyInput = document.getElementById(`qty_${good}`);
    const quantity = parseInt(qtyInput.value) || 1;
    const totalCost = price * quantity;
    const currentItems = this.getPersonalInventoryCount();
    
    if (currentItems + quantity > this.gameState.personalInventoryLimit) {
        alert(`You can only carry ${this.gameState.personalInventoryLimit} items total. You have ${currentItems} items.`);
        return;
    }
    
    if (this.characterData.stats.money >= totalCost) {
            this.characterData.stats.money -= totalCost;
            
            if (!this.gameState.inventory[good]) {
                this.gameState.inventory[good] = 0;
            }
            this.gameState.inventory[good] += quantity;
            
            this.characterData.stats.trading += 0.1 * quantity;
            
            const goodName = this.goodsInfo[good].name;
            this.showActivityResult('üéí Purchased to Inventory', 
                `You bought ${quantity} ${goodName} for ${totalCost} gold and stored them in your personal inventory.<br><br><em>+${(0.1 * quantity).toFixed(1)} Trading skill</em>`);
            
            setTimeout(() => {
                this.visitMarket();
            }, 1500);
        }
    }
        
    buyGoodToShip(good, price) {
        const qtyInput = document.getElementById(`qty_${good}`);
        const quantity = parseInt(qtyInput.value) || 1;
        const totalCost = price * quantity;
        const currentShipCargo = this.getShipCargoCount();
    
    const shipCapacity = this.getShipCargoCapacity();
if (currentShipCargo + quantity > shipCapacity) {
    alert(`Your ship can only hold ${shipCapacity} items total. It currently has ${currentShipCargo} items.`);
    return;
}
    
    if (this.characterData.stats.money >= totalCost) {
        this.characterData.stats.money -= totalCost;
        
        if (!this.gameState.ownedShip.cargoHold) {
            this.gameState.ownedShip.cargoHold = {};
        }
        if (!this.gameState.ownedShip.cargoHold[good]) {
            this.gameState.ownedShip.cargoHold[good] = 0;
        }
        this.gameState.ownedShip.cargoHold[good] += quantity;
        
        this.characterData.stats.trading += 0.1 * quantity;
        
        const goodName = this.goodsInfo[good].name;
        this.showActivityResult('üö¢ Loaded to Ship', 
            `You bought ${quantity} ${goodName} for ${totalCost} gold and loaded them onto your ship.<br><br><em>+${(0.1 * quantity).toFixed(1)} Trading skill</em>`);
        
        setTimeout(() => {
            this.visitMarket();
        }, 1500);
    }
}
        

sellGood(good, price, source) {
    if (source === 'personal') {
        if (this.gameState.inventory[good] > 0) {
            this.gameState.inventory[good]--;
            this.characterData.stats.money += price;
            
            if (this.gameState.inventory[good] === 0) {
                delete this.gameState.inventory[good];
            }
        }
    } else if (source === 'ship') {
        if (this.gameState.ownedShip.cargoHold[good] > 0) {
            this.gameState.ownedShip.cargoHold[good]--;
            this.characterData.stats.money += price;
            
            if (this.gameState.ownedShip.cargoHold[good] === 0) {
                delete this.gameState.ownedShip.cargoHold[good];
            }
        }
    }
    
    this.characterData.stats.trading += 0.05;
    trackGameEvent('trade_completed', {
    action: 'sell',
    good_type: good,
    quantity: 1,
    price_per_unit: price,
    total_value: price,
    source: source
});
    
    setTimeout(() => {
        this.visitMarket();
    }, 1000);
}

sellAllGood(good, price, source) {
    let quantity = 0;
    
    if (source === 'personal') {
        quantity = this.gameState.inventory[good] || 0;
        if (quantity > 0) {
            delete this.gameState.inventory[good];
        }
    } else if (source === 'ship') {
        quantity = this.gameState.ownedShip.cargoHold[good] || 0;
        if (quantity > 0) {
            delete this.gameState.ownedShip.cargoHold[good];
        }
    }
    
    const totalEarnings = quantity * price;
    this.characterData.stats.money += totalEarnings;
    this.characterData.stats.trading += 0.05 * quantity;
    trackGameEvent('trade_completed', {
    action: 'sell_all',
    good_type: good,
    quantity: quantity,
    price_per_unit: price,
    total_value: totalEarnings,
    source: source
});
    
    const goodName = this.goodsInfo[good].name;
    this.showActivityResult('üí∞ Bulk Sale Complete',
        `You sold ${quantity} ${goodName} for ${totalEarnings} gold total.<br><br><em>+${(0.05 * quantity).toFixed(2)} Trading skill</em>`);
    
    setTimeout(() => {
        this.visitMarket();
    }, 1500);
}
    
loadGameState() {
    // We'll add this later
    console.log('Loading saved game...');
}


buyShip(shipId, price) {
    try {
        console.log('buyShip called with:', shipId, price, 'Player money:', this.characterData.stats.money, 'Has ship:', this.gameState.ownedShip);
        
        // Validate inputs
        if (!shipId || price < 0) {
            throw new Error('Invalid ship data');
        }
        
        if (!this.characterData || !this.characterData.stats) {
            throw new Error('Character data corrupted');
        }
        
        if (this.characterData.stats.money < price) {
            throw new Error('Insufficient funds');
        }
        
        // Allow multiple ships (remove the restriction)
// if (this.gameState.ownedShip) {
//     throw new Error('Already own a ship');
// }
    
    const shipData = {
    rowboat: { 
        id: 'rowboat', 
        name: 'Rowing Boat', 
        cargo: 2, 
        crew: 1, 
        maxCrew: 1,
        baseCombat: 5,
        baseDefense: 5,
        baseSpeed: 15
    },
    sloop: { 
        id: 'sloop', 
        name: 'Sloop', 
        cargo: 10, 
        crew: 3, 
        maxCrew: 4,
        baseCombat: 12,
        baseDefense: 8,
        baseSpeed: 18
    },
    brigantine: { 
        id: 'brigantine', 
        name: 'Brigantine', 
        cargo: 25, 
        crew: 8, 
        maxCrew: 12,
        baseCombat: 20,
        baseDefense: 15,
        baseSpeed: 12
    },
    racing_schooner: {
        id: 'racing_schooner',
        name: 'Racing Schooner',
        cargo: 8,
        crew: 2,
        maxCrew: 3,
        baseCombat: 8,
        baseDefense: 6,
        baseSpeed: 25,
        specialAbility: 'speed_demon'
    },
    dutch_fluyt: {
        id: 'dutch_fluyt',
        name: 'Dutch Fluyt',
        cargo: 40,
        crew: 6,
        maxCrew: 8,
        baseCombat: 8,
        baseDefense: 10,
        baseSpeed: 10,
        specialAbility: 'cargo_master'
    },
    fast_frigate: {
        id: 'fast_frigate',
        name: 'Fast Frigate',
        cargo: 15,
        crew: 12,
        maxCrew: 16,
        baseCombat: 25,
        baseDefense: 18,
        baseSpeed: 22,
        specialAbility: 'pirate_hunter',
        maintenanceCost: 20
    },
    explorer_bark: {
        id: 'explorer_bark',
        name: 'Explorer\'s Bark',
        cargo: 20,
        crew: 10,
        maxCrew: 14,
        baseCombat: 15,
        baseDefense: 20,
        baseSpeed: 16,
        specialAbility: 'exploration_master'
    },
    privateer_vessel: {
        id: 'privateer_vessel',
        name: 'Privateer Vessel',
        cargo: 18,
        crew: 15,
        maxCrew: 20,
        baseCombat: 30,
        baseDefense: 22,
        baseSpeed: 20,
        specialAbility: 'privateer',
        requiresNavalRank: 2,
        maintenanceCost: 30
    },
    treasure_galleon: {
        id: 'treasure_galleon',
        name: 'Treasure Galleon',
        cargo: 60,
        crew: 25,
        maxCrew: 35,
        baseCombat: 28,
        baseDefense: 25,
        baseSpeed: 8,
        specialAbility: 'treasure_ship',
        maintenanceCost: 40
    },
    ship_of_line: {
        id: 'ship_of_line',
        name: 'Ship of the Line',
        cargo: 30,
        crew: 40,
        maxCrew: 50,
        baseCombat: 50,
        baseDefense: 40,
        baseSpeed: 6,
        specialAbility: 'battle_fortress',
        requiresNavalRank: 4,
        maintenanceCost: 50
    },
     // Add these after your existing ships in the shipData object:
crown_frigate: {
    id: 'crown_frigate',
    name: 'Crown Frigate',
    cargo: 25,
    crew: 30,
    maxCrew: 40,
    baseCombat: 45,
    baseDefense: 35,
    baseSpeed: 18,
    specialAbility: 'royal_ship',
    requiresNavalRank: 4, // Commander
    crownProvided: true,
    crownSubsidy: 0.8, // 80% covered by Crown
    basePrice: 1200,
    maintenanceCost: 25
},
crown_ship_of_line: {
    id: 'crown_ship_of_line',
    name: 'Crown Ship of the Line',
    cargo: 35,
    crew: 50,
    maxCrew: 65,
    baseCombat: 65,
    baseDefense: 50,
    baseSpeed: 12,
    specialAbility: 'flagship',
    requiresNavalRank: 5, // Captain
    crownProvided: true,
    crownSubsidy: 0.9, // 90% covered by Crown
    basePrice: 2500,
    maintenanceCost: 40
}   
};
    
    if (this.characterData.stats.money >= price) {
    
    // Check naval rank requirement
    if (shipData[shipId].requiresNavalRank) {
        const requiredRank = shipData[shipId].requiresNavalRank;
        const naval = this.gameState.navalCareer;
        const currentRankIndex = naval && naval.enlisted ? Math.min(this.getNavalRankFromExperience(naval.experience), 6) : -1;
        
        if (currentRankIndex < requiredRank) {
            const ranks = ['Seaman', 'Able Seaman', 'Midshipman', 'Lieutenant', 'Commander', 'Captain', 'Admiral'];
            this.showActivityResult('‚öìÔ∏è Naval Rank Required', 
                `This military vessel requires naval rank of ${ranks[requiredRank]} or higher.<br><br>` +
                `Your current naval status: ${naval && naval.enlisted ? ranks[currentRankIndex] : 'Civilian'}`);
            return;
        }
    }
    
    // Calculate Crown subsidy for naval officers
    let finalPrice = price;
    let subsidyMessage = '';
    
    // Check for Crown subsidy
    if (shipData[shipId].crownProvided && this.gameState.navalCareer && this.gameState.navalCareer.enlisted) {
        const naval = this.gameState.navalCareer;
        const rankIndex = Math.min(this.getNavalRankFromExperience(naval.experience), 6);
        
        if (rankIndex >= shipData[shipId].requiresNavalRank) {
            const subsidy = shipData[shipId].crownSubsidy;
            const discount = Math.floor(price * subsidy);
            finalPrice = price - discount;
            subsidyMessage = `<br><br><strong>üëë Royal Navy Benefit:</strong><br>Crown subsidy: ${discount} gold (${Math.floor(subsidy*100)}% discount)<br>Your cost: ${finalPrice} gold`;
        }
    }

// Check for veteran ship discount
if (this.gameState.navalCareer && this.gameState.navalCareer.veteran && !this.gameState.navalCareer.veteranDiscountUsed) {
    const veteranDiscount = Math.floor(finalPrice * this.gameState.navalCareer.veteranShipDiscount);
    finalPrice = finalPrice - veteranDiscount;
    subsidyMessage += `<br><br><strong>üéñÔ∏è Naval Veteran Benefit:</strong><br>Veteran discount: ${veteranDiscount} gold (30% off)<br>Final cost: ${finalPrice} gold<br><em>This benefit can only be used once.</em>`;
    
    // Mark the discount as used
    this.gameState.navalCareer.veteranDiscountUsed = true;
}

        
    // Deduct the final price (after any subsidy)
    this.characterData.stats.money -= finalPrice;
        
    // Prompt for ship name
    const shipName = prompt(`Name your new ${shipData[shipId].name}:`, `HMS ${this.characterData.name}'s Pride`);
    const finalShipName = shipName && shipName.trim() ? shipName.trim() : `HMS ${this.characterData.name}'s Pride`;
    
    // Initialize ships array if it doesn't exist
if (!this.gameState.ownedShips) {
    this.gameState.ownedShips = [];
}

// Create the new ship object
const newShip = {
    ...shipData[shipId],
    shipName: finalShipName,
    condition: 100,
    location: this.gameState.currentLocation,
    cargoHold: {},
    namedCrew: [],
    upgrades: {
        cannons: 0,
        armor: 0,
        speed: 0,
        storage: 0
    },
    baseStats: {
        combat: shipData[shipId].baseCombat || 10,
        defense: shipData[shipId].baseDefense || 10,
        speed: shipData[shipId].baseSpeed || 10,
        cargo: shipData[shipId].cargo
    }
};

// Add to ships array
this.gameState.ownedShips.push(newShip);

// For backward compatibility, keep current ship as primary (don't switch)
if (!this.gameState.ownedShip) {
    // Only set if we don't have a primary ship yet
    this.gameState.ownedShip = this.gameState.ownedShips[0];
}
        
        this.showActivityResult('üéâ Ship Purchased!', 
            `Congratulations! You are now the proud owner of "${this.gameState.ownedShip.shipName}"!<br><br>` +
            `Ship Type: ${shipData[shipId].name}<br>` +
            'Your ship is docked at the harbor, ready for trade and adventure.<br><br>' +
            '<strong>What changes:</strong><br>' +
            '‚Ä¢ Faster travel (if you\'re at the same port as your ship)<br>' +
            '‚Ä¢ Cargo space for bulk trading<br>' +
            '‚Ä¢ Ability to hire crew<br>' +
            '‚Ä¢ Access to more dangerous but profitable routes<br><br>' +
            '<em>+1 Social reputation (ship owners are respected!)</em>');
        
        this.characterData.reputation.merchant += 1;
        trackGameEvent('ship_purchased', {
    ship_type: shipId,
    ship_name: finalShipName,
    price: price,
    player_money_remaining: this.characterData.stats.money
});
        
        setTimeout(() => {
            this.visitShipyard();
        }, 3000);
        }
    } catch (error) {
        console.error('Ship purchase failed:', error);
        this.showActivityResult('‚ùå Purchase Failed', 
            `Could not purchase ship.<br><br>` +
            `<strong>Error:</strong> ${error.message}<br><br>` +
            `<em>Please check your funds and try again.</em>`);
    }
}



switchToPrimaryShip(shipIndex) {
    if (this.gameState.ownedShips[shipIndex]) {
        this.gameState.ownedShip = this.gameState.ownedShips[shipIndex];
        this.showActivityResult('‚öì Ship Changed', 
            `You are now commanding "${this.gameState.ownedShip.shipName}"!<br><br>` +
            `<em>This ship is now your primary vessel for trading and combat.</em>`);
        
        setTimeout(() => {
            this.visitShipyard();
        }, 2000);
    }
}

sellSpecificShip(shipIndex, sellPrice) {
    const ship = this.gameState.ownedShips[shipIndex];
    const hasCargo = ship.cargoHold && Object.keys(ship.cargoHold).length > 0;
    
    if (hasCargo) {
        this.showActivityResult('‚ö†Ô∏è Cannot Sell Ship', 
            `You cannot sell "${ship.shipName}" while it has cargo aboard!<br><br>` +
            `<strong>Please first:</strong><br>` +
            `‚Ä¢ Unload all cargo<br><br>`);
        return;
    }
    
    if (confirm(`Sell "${ship.shipName}" for ${sellPrice} gold?`)) {
        this.characterData.stats.money += sellPrice;
        
        // Remove from ships array
        this.gameState.ownedShips.splice(shipIndex, 1);
        
        // If this was the primary ship, set new primary
        if (this.gameState.ownedShip && ship.shipName === this.gameState.ownedShip.shipName) {
            this.gameState.ownedShip = this.gameState.ownedShips.length > 0 ? this.gameState.ownedShips[0] : null;
        }
        
        this.showActivityResult('üí∞ Ship Sold', 
            `You sold "${ship.shipName}" for ${sellPrice} gold!<br><br>` +
            `${this.gameState.ownedShips.length > 0 ? 
                `Primary ship: "${this.gameState.ownedShip.shipName}"` : 
                'You no longer own any ships.'}`);
        
        setTimeout(() => {
            this.visitShipyard();
        }, 3000);
    }
}




hireCaptain(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    if (!ship) {
        this.showActivityResult('‚ùå Ship Not Found', 'Ship not found in your fleet!');
        return;
    }
    
    if (ship.captain) {
        this.showActivityResult('üë©‚Äç‚úàÔ∏è Captain Already Hired', `"${ship.shipName}" already has Captain ${ship.captain.name}!`);
        return;
    }
    
    const captains = [
        { name: 'Captain Morgan', skill: 0.8, salary: 15, specialty: 'combat', description: 'Veteran warrior, +20% combat effectiveness' },
        { name: 'Captain Swift', skill: 0.9, salary: 20, specialty: 'trading', description: 'Master trader, +15% trading profits' },
        { name: 'Captain Blackwater', skill: 0.7, salary: 12, specialty: 'speed', description: 'Fast sailor, -2 days on all voyages' },
        { name: 'Captain Cross', skill: 0.75, salary: 14, specialty: 'navigation', description: 'Expert navigator, -50% storm damage' }
    ];
    
    let content = `<strong>üé© Captains Available for "${ship.shipName}"</strong><br><br>`;
    content += 'Hire a skilled captain to command your ship:<br><br>';
    
    captains.forEach((captain, index) => {
        const upfront = captain.salary * 6; // 6 months upfront
        const canAfford = this.characterData.stats.money >= upfront;
        
        content += `<div style="border: 1px solid #8b4513; padding: 10px; margin: 5px 0; background: ${canAfford ? 'white' : '#f5f5f5'};">
            <strong>${captain.name}</strong><br>
            Skill: ${(captain.skill * 100).toFixed(0)}% | Specialty: ${captain.specialty}<br>
            ${captain.description}<br>
            Monthly Salary: ${captain.salary} gold | Upfront: ${upfront} gold<br><br>
            ${canAfford ? 
                `<button onclick="game.confirmHireCaptain(${shipIndex}, ${index})">Hire Captain (${upfront} gold)</button>` :
                `<button disabled>Cannot afford (${upfront} gold needed)</button>`
            }
        </div>`;
    });
    
    this.showActivityResult('‚öì Captain Recruitment', content);
}


confirmHireCaptain(shipIndex, captainIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captains = [
        { name: 'Captain Morgan', skill: 0.8, salary: 15, specialty: 'combat', description: 'Veteran warrior, +20% combat effectiveness' },
        { name: 'Captain Swift', skill: 0.9, salary: 20, specialty: 'trading', description: 'Master trader, +15% trading profits' },
        { name: 'Captain Blackwater', skill: 0.7, salary: 12, specialty: 'speed', description: 'Fast sailor, -2 days on all voyages' },
        { name: 'Captain Cross', skill: 0.75, salary: 14, specialty: 'navigation', description: 'Expert navigator, -50% storm damage' }
    ];
    
    const captain = captains[captainIndex];
    const upfront = captain.salary * 6;
    
    if (this.characterData.stats.money >= upfront) {
        this.characterData.stats.money -= upfront;
        
        // Add captain to ship
        ship.captain = {
            ...captain,
            hiredDate: this.gameState.totalDays,
            contract: 180, // 6 months
            loyalty: 50 // starts at neutral
        };
        
        this.showActivityResult('üé© Captain Hired!', 
            `You have hired ${captain.name} to command "${ship.shipName}"!<br><br>` +
            `<strong>Captain Details:</strong><br>` +
            `‚Ä¢ Skill: ${(captain.skill * 100).toFixed(0)}%<br>` +
            `‚Ä¢ Specialty: ${captain.specialty}<br>` +
            `‚Ä¢ Contract: 6 months<br>` +
            `‚Ä¢ Monthly salary: ${captain.salary} gold<br><br>` +
            `${captain.description}<br><br>` +
            `<em>Your ship can now operate independently or with enhanced effectiveness!</em>`);
        
        setTimeout(() => {
            this.visitShipyard();
        }, 4000);
    }
}


setupTradingRoute(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    if (!ship.captain) {
        this.showActivityResult('‚ùå No Captain', 'You need to hire a captain first!');
        return;
    }

      // Check if ship is already on a mission
    if (ship.automatedMission) {
        const missionNames = {
            trade_route: 'Trading Route',
            pirate_patrol: 'Anti-Piracy Patrol', 
            message_courier: 'Express Courier',
            exploration: 'Mapping Expedition'
        };
        
        const returnDate = this.getDayAsMonthYear(ship.automatedMission.endDate);
        const daysLeft = ship.automatedMission.endDate - this.gameState.totalDays;
        
        this.showActivityResult('üö¢ Ship Already on Mission', 
            `"${ship.shipName}" is currently on a ${missionNames[ship.automatedMission.type]}.<br><br>` +
            `<strong>Mission Status:</strong><br>` +
            `‚Ä¢ Captain ${ship.captain.name} is handling operations<br>` +
            `‚Ä¢ Expected return: ${returnDate}<br>` +
            `‚Ä¢ Days remaining: ${Math.max(0, daysLeft)}<br><br>` +
            `<em>Your ship will return automatically when the mission completes.</em>`);
        return;
    }  
    
    let content = `<strong>üó∫Ô∏è Automated Missions for "${ship.shipName}"</strong><br><br>`;
    content += `Captain ${ship.captain.name} can handle missions automatically.<br><br>`;
    
    const missions = [
        { 
            id: 'trade_route', 
            name: 'Trading Route', 
            duration: 30,
            profit: '50-150 gold',
            description: 'Captain handles buying low and selling high',
            specialty: 'trading'
        },
        { 
            id: 'pirate_patrol', 
            name: 'Anti-Piracy Patrol', 
            duration: 60,
            profit: '80-200 gold',
            description: 'Hunt pirates for bounties and prizes',
            specialty: 'combat'
        },
        { 
            id: 'message_courier', 
            name: 'Express Courier', 
            duration: 15,
            profit: '30-80 gold',
            description: 'Fast delivery missions between ports',
            specialty: 'speed'
        },
        { 
            id: 'exploration', 
            name: 'Mapping Expedition', 
            duration: 90,
            profit: '100-300 gold',
            description: 'Explore and map new trade routes',
            specialty: 'navigation'
        }
    ];
    
    missions.forEach(mission => {
        const bonus = ship.captain.specialty === mission.specialty ? ' (SPECIALTY BONUS!)' : '';
        content += `<div style="border: 1px solid #2c5234; padding: 10px; margin: 5px 0;">
            <strong>${mission.name}</strong>${bonus}<br>
            Duration: ${mission.duration} days<br>
            Expected profit: ${mission.profit}<br>
            ${mission.description}<br><br>
            <button onclick="game.startAutomatedMission(${shipIndex}, '${mission.id}', ${mission.duration})">Start Mission</button>
        </div>`;
    });
    
    this.showActivityResult('üö¢ Automated Missions', content);
}
        
manageSpecificShip(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    if (!ship) return;
    
    const isPrimary = this.gameState.ownedShip && ship.shipName === this.gameState.ownedShip.shipName;
    
    let content = `<strong>üö¢ Managing "${ship.shipName}"</strong><br><br>`;
    content += `<strong>Ship Details:</strong><br>`;
    content += `Type: ${ship.name} ${isPrimary ? '(Primary)' : ''}<br>`;
    content += `Location: ${ship.location}<br>`;
    content += `Condition: ${ship.condition}%<br>`;
    content += `Cargo: ${this.getShipCargoCount(ship)} / ${ship.cargo}<br><br>`;
    
    // Captain management
    if (ship.captain) {
        content += `<strong>üë®‚Äç‚úàÔ∏è Captain: ${ship.captain.name}</strong><br>`;
        content += `Skill: ${(ship.captain.skill * 100).toFixed(0)}% | Specialty: ${ship.captain.specialty}<br>`;
        content += `Monthly Salary: ${ship.captain.salary} gold<br>`;
        content += `Contract: ${ship.captain.contract} days remaining<br><br>`;
        content += `<button onclick="game.fireCaptain(${shipIndex})" style="background: #dc3545; color: white;">Fire Captain</button><br><br>`;
    } else {
        content += `<strong>No Captain Assigned</strong><br><br>`;
        content += `<button onclick="game.hireCaptain(${shipIndex})" style="background: #007bff; color: white;">Hire Captain</button><br><br>`;
    }
    
    // Ship actions
    content += `<strong>Ship Actions:</strong><br>`;
    content += `<button onclick="game.repairSpecificShip(${shipIndex})">Repair Ship</button> `;
    content += `<button onclick="game.upgradeSpecificShip(${shipIndex})">Upgrade Ship</button><br><br>`;
    
    content += `<button onclick="game.visitShipyard()" style="background: #6c757d; color: white;">Back to Fleet</button>`;
    
    this.showActivityResult(`‚öì Ship Management`, content);
}


startAutomatedMission(shipIndex, missionType, duration) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    console.log('Debug mission start values:');
console.log('totalDays:', this.gameState.totalDays);
console.log('duration:', duration);
console.log('shipIndex:', shipIndex);
console.log('missionType:', missionType);
    
    // Set up the automated mission
    ship.automatedMission = {
        type: missionType,
        startDate: this.gameState.totalDays,
        duration: duration,
        endDate: this.gameState.totalDays + duration
    };
console.log('Mission created:', ship.automatedMission);

        
    
    // Captain is now busy
    captain.status = 'on_mission';
    
    const missionNames = {
        trade_route: 'Trading Route',
        pirate_patrol: 'Anti-Piracy Patrol', 
        message_courier: 'Express Courier',
        exploration: 'Mapping Expedition'
    };
    
    // Convert return date to readable format
    const returnDate = this.getDayAsMonthYear(ship.automatedMission.endDate);
    
    this.showActivityResult('üö¢ Mission Started!', 
        `Captain ${captain.name} has departed with "${ship.shipName}" on a ${missionNames[missionType]}!<br><br>` +
        `<strong>Mission Details:</strong><br>` +
        `‚Ä¢ Duration: ${duration} days<br>` +
        `‚Ä¢ Expected return: ${returnDate}<br>` +
        `‚Ä¢ Captain will handle all ship operations<br><br>` +
        `<em>Your ship will automatically return with profits when the mission completes.</em>`);
    
    setTimeout(() => {
        this.visitShipyard();
    }, 8000); // Extended to 8 seconds instead of 4
}


 checkAutomatedMissions() {
    console.log("=== CHECKING AUTOMATED MISSIONS ===");
    if (!this.gameState.ownedShips) return [];
    
    let completedMissions = [];
    
    this.gameState.ownedShips.forEach((ship, index) => {
        console.log(`Ship ${ship.shipName}: Has captain: ${!!ship.captain}, Has mission: ${!!ship.automatedMission}`);
        if (ship.automatedMission && this.gameState.totalDays >= ship.automatedMission.endDate) {
            console.log(`Completing mission for ship ${index}`);
            const missionResult = this.completeMission(ship, index);
            if (missionResult) {
                completedMissions.push(missionResult);
            }
        }
    });
    
    return completedMissions;
}


showMissionResults(completedMissions) {
    if (completedMissions.length === 0) return;
    
    let content = `<strong>üö¢ Mission${completedMissions.length > 1 ? 's' : ''} Complete!</strong><br><br>`;
    
    let totalProfit = 0;
    completedMissions.forEach(mission => {
        totalProfit += mission.profit;
        content += `<strong>${mission.missionType}</strong><br>`;
        content += `Ship: "${mission.shipName}" | Captain: ${mission.captainName}<br>`;
        content += `Profit: ${mission.profit} gold${mission.specialtyBonus ? ' (Specialty Bonus!)' : ''}<br>`;
        
        if (mission.complications.length > 0) {
            content += `<em>Complications: ${mission.complications.join(', ')}</em><br>`;
        }
        content += `<br>`;
    });
    
    content += `<strong>Total Mission Profits: ${totalProfit} gold</strong><br><br>`;
    content += `<em>Your ships are now available for new missions.</em>`;
    
    this.showEmergencyEvent('üö¢ Mission Report', content);
}
        
completeMission(ship, shipIndex) {
    const mission = ship.automatedMission;
    const captain = ship.captain;
    
    // Calculate profits based on mission type and captain skill
    let baseProfit = 0;
    const missionProfits = {
        trade_route: [50, 150],
        pirate_patrol: [80, 200],
        message_courier: [30, 80], 
        exploration: [100, 300]
    };
    
    const profitRange = missionProfits[mission.type];
    baseProfit = profitRange[0] + Math.random() * (profitRange[1] - profitRange[0]);

        
  // Mission risks and complications
let missionSuccess = true;
let complications = [];

// Base failure chance (reduced by captain skill)
const failureChance = 0.15 * (1 - captain.skill); // 15% base, reduced by skill

if (Math.random() < failureChance) {
    missionSuccess = false;
    baseProfit = Math.floor(baseProfit * 0.3);
    complications.push('Mission objectives only partially completed');
}

// Ship damage chance (higher for combat missions)
const damageChance = mission.type === 'pirate_patrol' ? 0.3 : 0.15;
if (Math.random() < damageChance) {
    const damage = Math.floor(Math.random() * 20) + 10; // 10-30 damage
    ship.condition = Math.max(10, ship.condition - damage);
    complications.push(`Ship took ${damage}% damage`);
}

// Crew loyalty loss if ship condition is poor
if (ship.condition < 50 && ship.namedCrew) {
    ship.namedCrew.forEach(member => {
        member.loyalty = Math.max(20, member.loyalty - 10);
    });
    complications.push('Crew morale suffered due to poor ship condition');
}

// Captain loyalty change based on success
if (missionSuccess) {
    captain.loyalty = Math.min(100, captain.loyalty + 5);
} else {
    captain.loyalty = Math.max(30, captain.loyalty - 10);
    complications.push('Captain disappointed with mission outcome');
}  
    // Captain skill bonus
    const skillBonus = captain.skill * 0.5; // Up to 50% bonus
    const finalProfit = Math.floor(baseProfit * (1 + skillBonus));
    
    // Specialty bonus
    const specialtyBonus = captain.specialty === mission.type ? 1.3 : 1;
    const totalProfit = Math.floor(finalProfit * specialtyBonus);
    
    this.characterData.stats.money += totalProfit;
    
    // Reset mission status
    delete ship.automatedMission;
    captain.status = 'available';
    
    // Show completion
    const missionNames = {
        trade_route: 'Trading Route',
        pirate_patrol: 'Anti-Piracy Patrol',
        message_courier: 'Express Courier', 
        exploration: 'Mapping Expedition'
    };
    
    // CREATE the resultText that was missing!
let resultText = `<strong>üö¢ ${missionNames[mission.type]} Complete!</strong><br><br>`;
resultText += `Captain ${captain.name} has returned with "${ship.shipName}"!<br><br>`;
resultText += `<strong>Mission Results:</strong><br>`;
resultText += `‚Ä¢ Profit earned: ${totalProfit} gold<br>`;
resultText += `‚Ä¢ Captain loyalty: ${missionSuccess ? '+5' : '-10'} (now ${captain.loyalty}%)<br>`;

if (complications.length > 0) {
    resultText += `<br><strong>‚ö†Ô∏è Mission Complications:</strong><br>`;
    complications.forEach(complication => {
        resultText += `‚Ä¢ ${complication}<br>`;
    });
}

if (captain.specialty === mission.type) {
    resultText += `<br><strong>üåü Specialty Bonus Applied!</strong><br>`;
    resultText += `Captain ${captain.name}'s ${captain.specialty} expertise increased profits by 30%!<br>`;
}

resultText += `<br><em>Your ship is now available for new missions.</em>`;

// Return the mission results instead of showing them immediately
    trackGameEvent('mission_completed', {
    mission_type: mission.type,
    ship_name: ship.shipName,
    captain_name: captain.name,
    duration_days: mission.duration,
    profit_earned: totalProfit,
    mission_success: missionSuccess,
    specialty_bonus: captain.specialty === mission.type,
    complications_count: complications.length
});
return {
    shipName: ship.shipName,
    captainName: captain.name,
    missionType: missionNames[mission.type],
    profit: totalProfit,
    success: missionSuccess,
    complications: complications,
    specialtyBonus: captain.specialty === mission.type,
    resultText: resultText
};
}

getDayAsMonthYear(dayNumber) {
    const totalMonths = Math.floor(dayNumber / 30);
    const gameYear = 1 + Math.floor(totalMonths / 12);
    const month = (totalMonths % 12) + 1;
    
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    return `${monthNames[month - 1]}, Year ${gameYear}`;
}


        

repairSpecificShip(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    if (!ship) return;
    
    const repairCost = Math.floor((100 - ship.condition) * 2);
    
    if (repairCost === 0) {
        this.showActivityResult('üîß Ship Condition', `"${ship.shipName}" is already in perfect condition!`);
        return;
    }
    
    if (this.characterData.stats.money >= repairCost) {
        this.characterData.stats.money -= repairCost;
        ship.condition = 100;
        
        this.showActivityResult('üîß Ship Repaired', 
            `"${ship.shipName}" has been fully repaired!<br><br>` +
            `Cost: ${repairCost} gold<br>` +
            `Condition: 100%`);
        
        setTimeout(() => {
            this.manageSpecificShip(shipIndex);
        }, 2000);
    } else {
        this.showActivityResult('üí∞ Cannot Afford Repairs', 
            `Repairs for "${ship.shipName}" cost ${repairCost} gold.<br><br>` +
            `You only have ${this.characterData.stats.money} gold.`);
    }
}

upgradeSpecificShip(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    if (!ship) return;
    
    // Ensure upgrades exist
    if (!ship.upgrades) {
        ship.upgrades = { cannons: 0, armor: 0, speed: 0, storage: 0 };
    }
    if (!ship.baseStats) {
        ship.baseStats = { combat: 10, defense: 10, speed: 10, cargo: ship.cargo };
    }
    
    let content = `<strong>‚öíÔ∏è Ship Upgrades - "${ship.shipName}"</strong><br><br>`;
    
    // Show current stats in styled box
    const currentCombat = ship.baseStats.combat + (ship.upgrades.cannons * 8);
    const currentDefense = ship.baseStats.defense + (ship.upgrades.armor * 6);
    const currentSpeed = ship.baseStats.speed + (ship.upgrades.speed * 4);
    const currentCargo = ship.baseStats.cargo + (ship.upgrades.storage * 5);
    
    content += `<div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px;">`;
    content += `<strong>Current Ship Stats:</strong><br>`;
    content += `‚öîÔ∏è Combat Power: ${currentCombat}<br>`;
    content += `üõ°Ô∏è Defense Rating: ${currentDefense}<br>`;
    content += `üí® Speed: ${currentSpeed}<br>`;
    content += `üì¶ Cargo Capacity: ${currentCargo}<br>`;
    content += `</div>`;
    
    content += `<strong>Available Upgrades:</strong><br><br>`;
    
    // Cannon upgrades
    const cannonLevel = ship.upgrades.cannons;
    const cannonCost = (cannonLevel + 1) * 200;
    const cannonNames = ['No Cannons', 'Light Cannons', 'Medium Cannons', 'Heavy Cannons'];
    
    content += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>‚öîÔ∏è Cannons</strong> - Level ${cannonLevel}/3<br>`;
    content += `Current: ${cannonNames[cannonLevel]}<br>`;
    content += `Combat Power: +${cannonLevel * 8}<br><br>`;
    
    if (cannonLevel < 3) {
        const nextLevel = cannonNames[cannonLevel + 1];
        const canAfford = this.characterData.stats.money >= cannonCost;
        const buttonHtml = canAfford ?
            `<button onclick="game.performUpgrade(${shipIndex}, 'cannons', ${cannonCost})">Upgrade to ${nextLevel} (${cannonCost} gold)</button>` :
            `<button disabled>Upgrade to ${nextLevel} (${cannonCost} gold)</button>`;
        content += buttonHtml;
    } else {
        content += `<em>Maximum firepower achieved!</em>`;
    }
    content += `</div>`;
    
    // Armor upgrades
    const armorLevel = ship.upgrades.armor;
    const armorCost = (armorLevel + 1) * 150;
    const armorNames = ['No Armor', 'Iron Plating', 'Reinforced Hull', 'Battle Armor'];
    
    content += `<div style="border: 2px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üõ°Ô∏è Hull Armor</strong> - Level ${armorLevel}/3<br>`;
    content += `Current: ${armorNames[armorLevel]}<br>`;
    content += `Defense Rating: +${armorLevel * 6}<br><br>`;
    
    if (armorLevel < 3) {
        const nextLevel = armorNames[armorLevel + 1];
        const canAfford = this.characterData.stats.money >= armorCost;
        const buttonHtml = canAfford ?
            `<button onclick="game.performUpgrade(${shipIndex}, 'armor', ${armorCost})">Upgrade to ${nextLevel} (${armorCost} gold)</button>` :
            `<button disabled>Upgrade to ${nextLevel} (${armorCost} gold)</button>`;
        content += buttonHtml;
    } else {
        content += `<em>Maximum armor achieved!</em>`;
    }
    content += `</div>`;
    
    // Speed upgrades
    const speedLevel = ship.upgrades.speed;
    const speedCost = (speedLevel + 1) * 100;
    const speedNames = ['Standard Sails', 'Fine Sails', 'Racing Sails', 'Storm Sails'];
    
    content += `<div style="border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üí® Sail Quality</strong> - Level ${speedLevel}/3<br>`;
    content += `Current: ${speedNames[speedLevel]}<br>`;
    content += `Speed Bonus: +${speedLevel * 4}<br><br>`;
    
    if (speedLevel < 3) {
        const nextLevel = speedNames[speedLevel + 1];
        const canAfford = this.characterData.stats.money >= speedCost;
        const buttonHtml = canAfford ?
            `<button onclick="game.performUpgrade(${shipIndex}, 'speed', ${speedCost})">Upgrade to ${nextLevel} (${speedCost} gold)</button>` :
            `<button disabled>Upgrade to ${nextLevel} (${speedCost} gold)</button>`;
        content += buttonHtml;
    } else {
        content += `<em>Maximum speed achieved!</em>`;
    }
    content += `</div>`;
    
    // Storage upgrades removed - focus on combat upgrades
content += `<br><em>üí° Tip: Buy larger ships for more cargo capacity!</em><br>`;
    
    content += `<br><button onclick="game.manageSpecificShip(${shipIndex})" style="background: #6c757d; color: white; padding: 10px 20px;">Back to Ship Management</button>`;
    
    this.showActivityResult('‚öíÔ∏è Ship Upgrades', content);
}
            
manageCaptain(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    
    if (!captain) {
        this.hireCaptain(shipIndex);
        return;
    }
    
    let content = `<strong>üë®‚Äç‚úàÔ∏è Managing Captain ${captain.name}</strong><br><br>`;
    content += `<strong>Captain Details:</strong><br>`;
    content += `Ship: "${ship.shipName}"<br>`;
    content += `Skill: ${(captain.skill * 100).toFixed(0)}%<br>`;
    content += `Specialty: ${captain.specialty}<br>`;
    content += `Loyalty: ${captain.loyalty}%<br>`;
    content += `Monthly Salary: ${captain.salary} gold<br>`;
    content += `Contract: ${captain.contract} days remaining<br><br>`;
    
    // Contract management buttons
if (captain.graceWarning) {
    content += `<div style="background: #f8d7da; border: 2px solid #dc3545; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <strong>üö® Captain threatening to leave in ${captain.graceDays} days!</strong>
    </div>`;
}

content += `<button onclick="game.renewCaptainContract(${shipIndex})" style="background: #28a745; color: white;">Renew Contract</button> `;
// Contract management buttons
if (captain.graceWarning) {
    content += `<div style="background: #f8d7da; border: 2px solid #dc3545; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <strong>üö® Captain threatening to leave in ${captain.graceDays} days!</strong>
    </div>`;
}


content += `<button onclick="game.manageCaptainLoyalty(${shipIndex})" style="background: #6f42c1; color: white;">Manage Loyalty</button> `;
content += `<button onclick="game.fireCaptain(${shipIndex})" style="background: #dc3545; color: white;">Fire Captain</button> `;
    content += `<button onclick="game.setupTradingRoute(${shipIndex})" style="background: #007bff; color: white;">Assign Mission</button><br><br>`;
    content += `<button onclick="game.manageSpecificShip(${shipIndex})" style="background: #6c757d; color: white;">Back to Ship</button>`;
    
    this.showActivityResult('üë®‚Äç‚úàÔ∏è Captain Management', content);
}

performUpgrade(shipIndex, upgradeType, cost) {
    const ship = this.gameState.ownedShips[shipIndex];
    
    this.characterData.stats.money -= cost;
    ship.upgrades[upgradeType]++;
    
    const upgradeNames = {
        cannons: 'Additional Cannons',
        armor: 'Hull Reinforcement', 
        speed: 'Sail Improvements',
        storage: 'Cargo Expansion'
    };
    
    this.showActivityResult('‚öíÔ∏è Upgrade Complete!', 
        `${upgradeNames[upgradeType]} installed on "${ship.shipName}"!<br><br>` +
        `Cost: ${cost} gold<br>` +
        `New level: ${ship.upgrades[upgradeType]}`);
    
    setTimeout(() => {
        this.upgradeSpecificShip(shipIndex);
    }, 2000);
}


renewCaptainContract(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    
    if (!captain) {
        this.showActivityResult('‚ùå No Captain', 'No captain to renew contract with!');
        return;
    }
    
    // Calculate renewal cost (base salary + experience bonus)
    const experienceBonus = Math.floor((180 - captain.contract) / 30) * 2; // 2 gold per month served
    const newSalary = captain.salary + experienceBonus;
    const renewalCost = newSalary * 6; // 6 months upfront
    
    let content = `<strong>üíº Contract Renewal - Captain ${captain.name}</strong><br><br>`;
    content += `<strong>Current Status:</strong><br>`;
    content += `Ship: "${ship.shipName}"<br>`;
    content += `Days Remaining: ${captain.contract}<br>`;
    content += `Current Salary: ${captain.salary} gold/month<br><br>`;
    
    content += `<strong>Renewal Terms:</strong><br>`;
    content += `New Salary: ${newSalary} gold/month (+${experienceBonus} experience bonus)<br>`;
    content += `Contract Length: 6 months (180 days)<br>`;
    content += `Total Cost: ${renewalCost} gold<br><br>`;
    
    if (captain.graceWarning) {
        content += `<div style="background: #f8d7da; border: 2px solid #dc3545; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>üö® URGENT: Captain threatening to leave in ${captain.graceDays} days!</strong>
        </div>`;
    }
    
    if (this.characterData.stats.money >= renewalCost) {
        content += `<button onclick="game.confirmRenewalContract(${shipIndex}, ${newSalary}, ${renewalCost})" style="background: #28a745; color: white; padding: 10px 20px;">Renew Contract (${renewalCost} gold)</button><br><br>`;
    } else {
        content += `<button disabled style="background: #6c757d; color: white; padding: 10px 20px;">Cannot Afford (${renewalCost} gold needed)</button><br><br>`;
    }
    
    content += `<button onclick="game.manageCaptain(${shipIndex})" style="background: #6c757d; color: white;">Back to Captain Management</button>`;
    
    this.showActivityResult('üíº Contract Renewal', content);
}

confirmRenewalContract(shipIndex, newSalary, renewalCost) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    
    this.characterData.stats.money -= renewalCost;
    captain.salary = newSalary;
    captain.contract = 180; // 6 months
    captain.graceWarning = false;
    captain.graceDays = 0;
    captain.loyalty = Math.min(100, captain.loyalty + 10); // Renewal boosts loyalty
    
    this.showActivityResult('‚úÖ Contract Renewed!', 
        `Captain ${captain.name}'s contract has been renewed!<br><br>` +
        `<strong>New Terms:</strong><br>` +
        `‚Ä¢ Contract: 6 months (180 days)<br>` +
        `‚Ä¢ Monthly Salary: ${newSalary} gold<br>` +
        `‚Ä¢ Loyalty: +10 (now ${captain.loyalty}%)<br><br>` +
        `<em>The captain is pleased with the renewal!</em>`);
    
    setTimeout(() => {
        this.manageCaptain(shipIndex);
    }, 3000);
}

manageCaptainLoyalty(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    
    if (!captain) {
        this.showActivityResult('‚ùå No Captain', 'No captain to manage!');
        return;
    }
    
    let content = `<strong>üéñÔ∏è Captain Loyalty - ${captain.name}</strong><br><br>`;
    content += `Ship: "${ship.shipName}"<br>`;
    content += `Current Loyalty: ${captain.loyalty}%<br>`;
    content += `Specialty: ${captain.specialty}<br><br>`;
    
    // Loyalty level description
    if (captain.loyalty >= 80) {
        content += `<div style="background: #d4edda; border: 2px solid #28a745; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>üåü Extremely Loyal</strong> - Captain is completely devoted
        </div>`;
    } else if (captain.loyalty >= 60) {
        content += `<div style="background: #d1ecf1; border: 2px solid #17a2b8; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>üëç Loyal</strong> - Captain is satisfied with service
        </div>`;
    } else if (captain.loyalty >= 40) {
        content += `<div style="background: #fff3cd; border: 2px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>üòê Neutral</strong> - Captain is content but not enthusiastic
        </div>`;
    } else {
        content += `<div style="background: #f8d7da; border: 2px solid #dc3545; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>üò† Disloyal</strong> - Captain is unhappy and may leave
        </div>`;
    }
    
    content += '<br><strong>üéÅ Improve Loyalty:</strong><br><br>';
    
    // Bonus payment
    const bonusAmount = captain.salary * 2;
    content += `<div style="border: 1px solid #28a745; padding: 10px; margin: 5px 0; border-radius: 5px;">
        <strong>üí∞ Bonus Payment</strong><br>
        Pay extra ${bonusAmount} gold (+15 loyalty)<br>
        ${this.characterData.stats.money >= bonusAmount ? 
            `<button onclick="game.giveCaptainBonus(${shipIndex}, ${bonusAmount})">Give Bonus (${bonusAmount} gold)</button>` :
            `<button disabled>Cannot afford (${bonusAmount} gold needed)</button>`
        }
    </div>`;
    
    // Shore leave (costs time)
    content += `<div style="border: 1px solid #17a2b8; padding: 10px; margin: 5px 0; border-radius: 5px;">
        <strong>üèñÔ∏è Shore Leave</strong><br>
        Grant 3 days shore leave (+10 loyalty)<br>
        <button onclick="game.grantShoreLeave(${shipIndex})">Grant Shore Leave</button>
    </div>`;
    
    // Promotion (expensive but permanent)
    if (captain.loyalty < 90) {
        const promotionCost = captain.salary * 5;
        content += `<div style="border: 1px solid #6f42c1; padding: 10px; margin: 5px 0; border-radius: 5px;">
            <strong>‚≠ê Promotion</strong><br>
            Promote captain (+25 loyalty, +5 salary)<br>
            ${this.characterData.stats.money >= promotionCost ? 
                `<button onclick="game.promoteCaptain(${shipIndex}, ${promotionCost})">Promote Captain (${promotionCost} gold)</button>` :
                `<button disabled>Cannot afford (${promotionCost} gold needed)</button>`
            }
        </div>`;
    }
    
    content += `<br><button onclick="game.manageCaptain(${shipIndex})" style="background: #6c757d; color: white;">Back to Captain Management</button>`;
    
    this.showActivityResult('üéñÔ∏è Captain Loyalty', content);
}

giveCaptainBonus(shipIndex, amount) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    
    this.characterData.stats.money -= amount;
    captain.loyalty = Math.min(100, captain.loyalty + 15);
    
    this.showActivityResult('üí∞ Bonus Paid!', 
        `Captain ${captain.name} is grateful for the ${amount} gold bonus!<br><br>` +
        `Loyalty increased by +15 (now ${captain.loyalty}%)`);
    
    setTimeout(() => {
        this.manageCaptainLoyalty(shipIndex);
    }, 2000);
}

grantShoreLeave(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    
    captain.loyalty = Math.min(100, captain.loyalty + 10);
    
    this.showActivityResult('üèñÔ∏è Shore Leave Granted!', 
        `Captain ${captain.name} enjoyed 3 days of shore leave!<br><br>` +
        `Loyalty increased by +10 (now ${captain.loyalty}%)<br><br>` +
        `<em>Time advanced: 3 days</em>`);
    
    // Advance time by 3 days
    this.advanceTime(3);
    
    setTimeout(() => {
        this.manageCaptainLoyalty(shipIndex);
    }, 2000);
}

promoteCaptain(shipIndex, cost) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    
    this.characterData.stats.money -= cost;
    captain.loyalty = Math.min(100, captain.loyalty + 25);
    captain.salary += 5;
    
    this.showActivityResult('‚≠ê Captain Promoted!', 
        `Captain ${captain.name} has been promoted!<br><br>` +
        `‚Ä¢ Loyalty: +25 (now ${captain.loyalty}%)<br>` +
        `‚Ä¢ New salary: ${captain.salary} gold/month<br><br>` +
        `<em>The captain is extremely pleased with the recognition!</em>`);
    
    setTimeout(() => {
        this.manageCaptainLoyalty(shipIndex);
    }, 3000);
}

        
        
fireCaptain(shipIndex) {
    const ship = this.gameState.ownedShips[shipIndex];
    const captain = ship.captain;
    
    if (confirm(`Fire Captain ${captain.name} from "${ship.shipName}"?`)) {
        // Pay remaining contract (severance)
        const severance = Math.floor(captain.salary * 2); // 2 months severance
        this.characterData.stats.money -= severance;
        
        ship.captain = null;
        
        this.showActivityResult('üëã Captain Dismissed', 
            `Captain ${captain.name} has been dismissed from "${ship.shipName}".<br><br>` +
            `Severance pay: ${severance} gold<br><br>` +
            `<em>The ship is now without a captain.</em>`);
        
        setTimeout(() => {
            this.manageSpecificShip(shipIndex);
        }, 3000);
    }
}


        
calculateShipSellPrice(ship) {
    // Base ship prices
    const basePrices = {
        'Rowing Boat': 50,
        'Sloop': 500,
        'Racing Schooner': 800,
        'Dutch Fluyt': 1200,
        'Fast Frigate': 1500,
        'Brigantine': 2000,
        'Explorer\'s Bark': 2500,
        'Privateer Vessel': 3000,
        'Treasure Galleon': 4000,
        'Ship of the Line': 8000
    };
    
    const basePrice = basePrices[ship.name] || 1000;
    
    // 60% of base price, modified by condition
    let sellPrice = Math.floor(basePrice * 0.6);
    
    // Condition affects price
    const conditionMultiplier = ship.condition / 100;
    sellPrice = Math.floor(sellPrice * conditionMultiplier);
    
    // Upgrades add significant value (70% of upgrade cost)
if (ship.upgrades) {
    const cannonValue = ship.upgrades.cannons * 140; // 70% of 200 gold per level
    const armorValue = ship.upgrades.armor * 105;    // 70% of 150 gold per level  
    const speedValue = ship.upgrades.speed * 70;     // 70% of 100 gold per level
    const storageValue = ship.upgrades.storage * 35; // 70% of 50 gold per level
    
    const totalUpgradeValue = cannonValue + armorValue + speedValue + storageValue;
    sellPrice += totalUpgradeValue;
}

return Math.max(10, sellPrice); // Minimum 10 gold
}

sellShip(sellPrice) {
    const ship = this.gameState.ownedShip;
    const hasCargo = ship.cargoHold && Object.keys(ship.cargoHold).length > 0;
    
    if (hasCargo) {
        this.showActivityResult('‚ö†Ô∏è Cannot Sell Ship', 
            `You cannot sell your ship while it has cargo aboard!<br><br>` +
            `<strong>Please first:</strong><br>` +
            `‚Ä¢ Unload all cargo<br><br>` +
            `<em>The shipyard won't accept a ship with goods still aboard.</em>`);
        return;
    }
    
    // Confirm sale
    const crewCount = ship.namedCrew ? ship.namedCrew.length : 0;
    let confirmMessage = `Are you sure you want to sell "${ship.shipName}" for ${sellPrice} gold?`;
    
    if (crewCount > 0) {
        confirmMessage += `\n\nYour ${crewCount} crew members will be transferred to your crew roster and available for your next ship.`;
    }
    
    if (confirm(confirmMessage)) {
        // Transfer crew to available roster
        if (!this.gameState.availableCrew) {
            this.gameState.availableCrew = [];
        }
        
        if (ship.namedCrew && ship.namedCrew.length > 0) {
            // Add crew to available roster
            ship.namedCrew.forEach(member => {
                member.status = 'available'; // Mark as available for hire
                this.gameState.availableCrew.push(member);
            });
        }
        
        this.characterData.stats.money += sellPrice;
        this.gameState.ownedShip = null;
        
        let resultText = `You have sold "${ship.shipName}" for ${sellPrice} gold.<br><br>` +
            `<strong>Sale Complete:</strong><br>` +
            `‚Ä¢ Received: ${sellPrice} gold<br>` +
            `‚Ä¢ Current funds: ${this.characterData.stats.money} gold<br>`;
        
        if (crewCount > 0) {
            resultText += `‚Ä¢ ${crewCount} crew members added to your roster<br>`;
        }
        
        resultText += `<br><em>You are now without a ship. Your former crew will be available when you purchase a new vessel.</em>`;
        
        this.showActivityResult('üí∞ Ship Sold!', resultText);
        
        setTimeout(() => {
            this.visitShipyard();
        }, 3000);
    }
}    

manageShip() {
    this.setContext('ship_management');
    const ship = this.gameState.ownedShip;
    let content = `<strong>üö¢ Managing: "${ship.shipName}"</strong><br><br>`;
    
    content += `<strong>Ship Status:</strong><br>`;
    content += `Location: ${this.getLocationName(ship.location)}<br>`;
content += `Condition: ${ship.condition}%<br>`;
content += `Crew: ${ship.crew}/${ship.maxCrew}<br>`;
content += `Cargo: ${this.getCargoAmount()}/${this.getShipCargoCapacity()}<br><br>`;

// Warn about low ship condition affecting crew
if (ship.condition < 30 && ship.namedCrew && ship.namedCrew.length > 0) {
    content += `<div style="background: #ffebee; border: 2px solid #f44336; padding: 10px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>‚ö†Ô∏è CREW MORALE WARNING!</strong><br>`;
    content += `Your crew is losing loyalty due to the ship's terrible condition!<br>`;
    content += `<em>(-1 loyalty per day until repairs are made)</em>`;
    content += `</div>`;
}
    
    // Ship is in same location as player
    if (ship.location === this.gameState.currentLocation) {
        content += '<strong>Available Actions:</strong><br>';
        
        if (ship.condition < 100) {
            const repairCost = Math.floor((100 - ship.condition) * 2);
            const canAfford = this.characterData.stats.money >= repairCost;
            const repairButton = canAfford ? 
                `<button onclick="game.repairShip(${repairCost})">Repair Ship (${repairCost} gold)</button>` :
                `<button disabled>Repair Ship (${repairCost} gold)</button>`;
            content += repairButton + '<br>';
        }
        content += '<button onclick="game.rewardCrew()">Reward Crew</button><br>';
content += '<button onclick="game.improveCrewConditions()">Improve Ship Conditions (50 gold)</button><br>';
        content += '<button onclick="game.loadCargo()">Load/Unload Cargo</button><br>';
        content += '<button onclick="game.hireCrew()">Manage Crew</button><br>';
        
        content += '<button onclick="game.upgradeShip()">Upgrade Ship</button><br>';
        content += '<button onclick="game.sailWithShip()">Sail to Another Port</button><br>';
    } else {
        content += `<em>Your ship is docked in ${this.getLocationName(ship.location)}. Travel there to manage it.</em>`;
    }
    
    // Use direct content update instead of showActivityResult to avoid context change
document.getElementById('activityTitle').innerHTML = 'üö¢ Ship Management';
document.getElementById('activityContent').innerHTML = content;
document.getElementById('locationView').classList.add('hidden');
document.getElementById('activityPanel').classList.remove('hidden');
this.updateDisplay();
}

improveCrewConditions() {
    const ship = this.gameState.ownedShip;
    const cost = 50;
    
    if (this.characterData.stats.money < cost) {
        this.showActivityResult('üí∞ Not Enough Gold', `You need ${cost} gold to improve ship conditions.`);
        return;
    }
    
    this.characterData.stats.money -= cost;
    
    // Boost all crew loyalty
    ship.namedCrew.forEach(member => {
        member.loyalty = Math.min(100, member.loyalty + 10);
    });
    
    // Small ship condition boost
    ship.condition = Math.min(100, ship.condition + 5);
    
    this.showActivityResult('‚≠ê Conditions Improved!', 
        `You invest in better food, equipment, and living conditions for your crew!<br><br>` +
        `<strong>Improvements:</strong><br>` +
        `‚Ä¢ All crew loyalty +10<br>` +
        `‚Ä¢ Ship condition +5<br>` +
        `‚Ä¢ Cost: ${cost} gold<br><br>` +
        `<em>"Thank you Captain! These improvements make all the difference!"</em>`);
}



getLocationMarketPrices() {
    const location = this.gameState.currentLocation;
    
    if (['london', 'amsterdam', 'lisbon', 'bristol'].includes(location)) {
        // European ports - cheap European goods, expensive colonial goods
        return {
            textiles: { buy: 10, sell: 8 },
            tools: { buy: 15, sell: 12 },
            weapons: { buy: 30, sell: 25 },
            sugar: { buy: 20, sell: 15 },      // Expensive (imported)
            tobacco: { buy: 25, sell: 20 },   // Expensive (imported)
            rum: { buy: 22, sell: 18 }        // Expensive (imported)
        };
    } else {
        // Colonial ports - expensive European goods, cheap colonial goods
        return {
            textiles: { buy: 18, sell: 15 },   // Expensive (imported)
            tools: { buy: 25, sell: 20 },     // Expensive (imported)
            weapons: { buy: 45, sell: 35 },   // Expensive (imported)
            sugar: { buy: 8, sell: 6 },       // Cheap (local)
            tobacco: { buy: 10, sell: 8 },    // Cheap (local)
            rum: { buy: 12, sell: 10 }        // Cheap (local)
        };
    }
}
        
        
getCargoAmount() {
    const cargo = this.gameState.ownedShip.cargoHold;
    return Object.values(cargo).reduce((total, quantity) => total + quantity, 0);
}

getShipCargoCapacity() {
    const ship = this.gameState.ownedShip;
    if (!ship) return 0;
    
    let capacity = ship.cargo;
    
    // Dutch Fluyt gets +15 cargo bonus
    if (ship.specialAbility === 'cargo_master') {
        capacity += 15;
    }
    
    // Add upgrade bonuses
    if (ship.upgrades && ship.upgrades.storage) {
        capacity += ship.upgrades.storage * 5;
    }
    
    return capacity;
}

    

repairShip(cost) {
    this.characterData.stats.money -= cost;
    this.gameState.ownedShip.condition = 100;
    
    // Give crew repair experience
    const expGains = this.giveCrewExperience('repair', 20);
    
    let resultText = `"${this.gameState.ownedShip.shipName}" has been fully repaired and is seaworthy once again!<br><br>` +
        `Cost: ${cost} gold`;

    if (expGains && expGains.length > 0) {
        resultText += `<br><br><strong>üåü Crew Experience:</strong><br>`;
        expGains.forEach(gain => {
            resultText += `‚Ä¢ ${gain}<br>`;
        });
    }

    this.showActivityResult('üîß Ship Repaired', resultText);
    
    // Don't automatically navigate anywhere - let user click return button
setTimeout(() => {
    console.log('Repair complete - user can now navigate manually');
}, 2000);
}

loadCargo() {
    const ship = this.gameState.ownedShip;
    const personalItems = this.getPersonalInventoryCount();
    const shipCargo = this.getShipCargoCount();
    
    let content = `<strong>üì¶ Cargo Transfer - "${this.gameState.ownedShip.shipName}"</strong><br><br>`;
    
    content += `<div style="background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px;">`;
    const shipCapacity = this.getShipCargoCapacity();
content += `<strong>Capacity:</strong> Personal ${personalItems}/${this.gameState.personalInventoryLimit} | Ship ${shipCargo}/${shipCapacity}`;
    content += `</div>`;
    
    content += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
    
    // Transfer TO ship
    content += '<div><h4>üì§ Load onto Ship</h4>';
    const hasPersonalGoods = Object.keys(this.gameState.inventory).length > 0;
    
    if (hasPersonalGoods && shipCargo < ship.cargo) {
        Object.keys(this.gameState.inventory).forEach(good => {
            const quantity = this.gameState.inventory[good];
            const goodName = this.goodsInfo[good].name;
            
            if (quantity > 0) {
                const maxTransfer = Math.min(quantity, shipCapacity - shipCargo);
                content += `<div style="border: 1px solid #ccc; padding: 8px; margin: 5px 0;">
                    <strong>${goodName}</strong> (Have: ${quantity})<br>
                    <input type="number" id="transfer_to_ship_${good}" min="1" max="${maxTransfer}" value="1" style="width: 60px; margin: 5px;">
                    <button onclick="game.transferToShip('${good}')">Load</button>
                </div>`;
            }
        });
    } else if (!hasPersonalGoods) {
        content += '<p><em>No personal goods to transfer.</em></p>';
    } else {
        content += '<p><em>Ship cargo hold is full.</em></p>';
    }
    content += '</div>';
    
    // Transfer FROM ship
    content += '<div><h4>üì• Unload from Ship</h4>';
    const hasShipGoods = ship.cargoHold && Object.keys(ship.cargoHold).length > 0;
    
    if (hasShipGoods && personalItems < this.gameState.personalInventoryLimit) {
        Object.keys(ship.cargoHold).forEach(good => {
            const quantity = ship.cargoHold[good];
            const goodName = this.goodsInfo[good].name;
            
            if (quantity > 0) {
                const maxTransfer = Math.min(quantity, this.gameState.personalInventoryLimit - personalItems);
                content += `<div style="border: 1px solid #ccc; padding: 8px; margin: 5px 0;">
                    <strong>${goodName}</strong> (Ship has: ${quantity})<br>
                    <input type="number" id="transfer_from_ship_${good}" min="1" max="${maxTransfer}" value="1" style="width: 60px; margin: 5px;">
                    <button onclick="game.transferFromShip('${good}')">Unload</button>
                </div>`;
            }
        });
    } else if (!hasShipGoods) {
        content += '<p><em>No ship cargo to unload.</em></p>';
    } else {
        content += '<p><em>Your personal inventory is full.</em></p>';
    }
    content += '</div></div>';
    
    this.showActivityResult('üì¶ Cargo Management', content);
}

transferToShip(good) {
    const input = document.getElementById(`transfer_to_ship_${good}`);
    const quantity = parseInt(input.value) || 1;
    
    if (this.gameState.inventory[good] >= quantity) {
        // Remove from personal inventory
        this.gameState.inventory[good] -= quantity;
        if (this.gameState.inventory[good] === 0) {
            delete this.gameState.inventory[good];
        }
        
        // Add to ship
        if (!this.gameState.ownedShip.cargoHold) {
            this.gameState.ownedShip.cargoHold = {};
        }
        if (!this.gameState.ownedShip.cargoHold[good]) {
            this.gameState.ownedShip.cargoHold[good] = 0;
        }
        this.gameState.ownedShip.cargoHold[good] += quantity;
        
        const goodName = this.goodsInfo[good].name;
        this.showActivityResult('üì§ Cargo Loaded', 
            `Transferred ${quantity} ${goodName} to your ship's cargo hold.`);
        
        setTimeout(() => {
            this.loadCargo();
        }, 1500);
    }
}

transferFromShip(good) {
    const input = document.getElementById(`transfer_from_ship_${good}`);
    const quantity = parseInt(input.value) || 1;
    
    if (this.gameState.ownedShip.cargoHold[good] >= quantity) {
        // Remove from ship
        this.gameState.ownedShip.cargoHold[good] -= quantity;
        if (this.gameState.ownedShip.cargoHold[good] === 0) {
            delete this.gameState.ownedShip.cargoHold[good];
        }
        
        // Add to personal inventory
        if (!this.gameState.inventory[good]) {
            this.gameState.inventory[good] = 0;
        }
        this.gameState.inventory[good] += quantity;
        
        const goodName = this.goodsInfo[good].name;
        this.showActivityResult('üì• Cargo Unloaded', 
            `Transferred ${quantity} ${goodName} to your personal inventory.`);
        
        setTimeout(() => {
            this.loadCargo();
        }, 1500);
    }
}



hireCrew() {
    this.setContext('crew_management');
    const ship = this.gameState.ownedShip;
    const availablePositions = ship.maxCrew - ship.crew;
    
    let content = `<strong>üë• Crew Management - "${ship.shipName}"</strong><br><br>`;
    
    content += `<strong>Current Crew:</strong> ${ship.crew}/${ship.maxCrew}<br><br>`;
    
    // Show current named crew
    if (ship.namedCrew && ship.namedCrew.length > 0) {
        content += '<strong>üåü Current Crew Members:</strong><br>';
        ship.namedCrew.forEach(member => {
            const levelStars = '‚òÖ'.repeat(member.level);
            content += `<div style="border: 1px solid #ccc; padding: 8px; margin: 5px 0; border-radius: 5px;">
                <strong>${member.name}</strong> ${levelStars}<br>
                <em>${member.specialty.toUpperCase()}</em> | ${member.personality.trait} ${member.personality.background}<br>
                Loyalty: ${member.loyalty}% | Experience: ${member.experience}<br>
                <button onclick="game.viewCrewDetails('${member.name}')">View Details</button>
            </div>`;
        });
        content += '<br>';
    }
    
    if (availablePositions > 0) {
    content += '<strong>üÜï Hire Crew:</strong><br>';
    content += `Available positions: ${availablePositions}<br><br>`;
    
    // Show former crew first (if any)
    if (this.gameState.availableCrew && this.gameState.availableCrew.length > 0) {
        content += '<strong>üë• Your Former Crew (Free to rehire):</strong><br>';
        this.gameState.availableCrew.forEach((member, index) => {
            const levelStars = '‚òÖ'.repeat(member.level);
            content += `<div style="border: 2px solid #28a745; padding: 10px; margin: 5px 0; border-radius: 5px; background: #f8fff8;">
                <strong>${member.name}</strong> ${levelStars}<br>
                <em>${member.specialty.toUpperCase()}</em> | ${member.personality.trait} ${member.personality.background}<br>
                Loyalty: ${member.loyalty}% | Experience: ${member.experience}<br>
                <button onclick="game.rehireFormerCrew(${index})">Rehire ${member.name} (FREE)</button>
            </div>`;
        });
        content += '<br>';
    }
    
    // Generate available crew - ensure variety
const availableCrew = [];
const specialties = ['gunner', 'navigator', 'cook', 'bosun', 'surgeon', 'carpenter'];

// First, add one of each specialty if we have room
const crewToShow = Math.min(6, availablePositions + 3);
for (let i = 0; i < crewToShow; i++) {
    if (i < specialties.length) {
        // Guarantee one of each specialty first
        availableCrew.push(this.generateCrewMember(specialties[i]));
    } else {
        // Then add random ones
        availableCrew.push(this.generateCrewMember());
    }
}
        
        availableCrew.forEach((member, index) => {
            const hireCost = 20 + (member.level * 5);
            const canAfford = this.characterData.stats.money >= hireCost;
            
            let skillsText = '';
            Object.keys(member.skills).forEach(skill => {
                if (member.skills[skill] > 1) {
                    skillsText += `${skill}: ${member.skills[skill]} `;
                }
            });
            
            const buttonHtml = canAfford ? 
                `<button onclick="game.hireNamedCrew(${index})">Hire (${hireCost} gold)</button>` :
                `<button disabled>Hire (${hireCost} gold)</button>`;
            
            content += `<div style="border: 1px solid #28a745; padding: 10px; margin: 5px 0; border-radius: 5px;">
                <strong>${member.name}</strong><br>
                <em>${member.specialty.toUpperCase()}</em> | ${member.personality.trait} ${member.personality.background}<br>
                <strong>Skills:</strong> ${skillsText}<br>
                Loyalty: ${member.loyalty}%<br>
                ${buttonHtml}
            </div>`;
        });
        
        // Store available crew for hiring
this.availableCrewForHire = availableCrew;
    } else {
        content += '<em>Your ship is at maximum crew capacity.</em><br><br>';
    }
    
    // Add refresh button outside the availability check so it's always visible
    content += '<button onclick="game.refreshAvailableCrew()" style="background: #6c757d; color: white;">üîÑ Refresh Available Crew</button><br><br>';
    
    this.showActivityResult('üë• Crew Management', content);
}

refreshAvailableCrew() {
    // Simple refresh - just call hireCrew again
    this.hireCrew();
}
        
hireNamedCrew(index) {
    const member = this.availableCrewForHire[index];
    const cost = 20 + (member.level * 5);
    
    if (this.characterData.stats.money >= cost && this.gameState.ownedShip.crew < this.gameState.ownedShip.maxCrew) {
        this.characterData.stats.money -= cost;
        this.gameState.ownedShip.crew++;
        // Initialize namedCrew array if it doesn't exist (backward compatibility)
if (!this.gameState.ownedShip.namedCrew) {
    this.gameState.ownedShip.namedCrew = [];
}
this.gameState.ownedShip.namedCrew.push(member);
        
        this.showActivityResult('üéâ Crew Member Hired!', 
            `Welcome aboard, ${member.name}!<br><br>` +
            `<strong>New Crew Member:</strong><br>` +
            `‚Ä¢ Specialty: ${member.specialty.toUpperCase()}<br>` +
            `‚Ä¢ Personality: ${member.personality.trait} ${member.personality.background}<br>` +
            `‚Ä¢ Starting Loyalty: ${member.loyalty}%<br><br>` +
            `<em>"${this.getHiringQuote(member)}"</em>`);
        
        setTimeout(() => {
            this.hireCrew();
        }, 3000);
    }
}

rehireFormerCrew(index) {
    const member = this.gameState.availableCrew[index];
    const ship = this.gameState.ownedShip;
    
    if (ship.crew < ship.maxCrew) {
        // Remove from available crew
        this.gameState.availableCrew.splice(index, 1);
        
        // Add to ship
        ship.crew++;
        if (!ship.namedCrew) {
            ship.namedCrew = [];
        }
        ship.namedCrew.push(member);
        
        this.showActivityResult('üéâ Crew Member Rehired!', 
            `Welcome back, ${member.name}!<br><br>` +
            `<strong>Returning Crew Member:</strong><br>` +
            `‚Ä¢ No hiring cost for former crew<br>` +
            `‚Ä¢ All experience and skills retained<br>` +
            `‚Ä¢ Loyalty: ${member.loyalty}%<br><br>` +
            `<em>"Good to be back aboard, Captain!"</em>`);
        
        setTimeout(() => {
            this.hireCrew();
        }, 2500);
    }
}


getShipSpecialAbility() {
    const ship = this.gameState.ownedShip;
    return ship ? ship.specialAbility : null;
}

applyShipSpecialBonuses(baseValue, abilityType) {
    const ability = this.getShipSpecialAbility();
    if (!ability) return baseValue;
    
    switch (ability) {
        case 'speed_demon': // Racing Schooner
            if (abilityType === 'escape_chance') return baseValue * 1.8;
            if (abilityType === 'travel_speed') return Math.max(1, baseValue - 1);
            break;
            
        case 'cargo_master': // Dutch Fluyt
            if (abilityType === 'crew_wages') return baseValue * 0.5;
            break;
            
        case 'pirate_hunter': // Fast Frigate
            if (abilityType === 'pirate_bounty') return baseValue * 2;
            if (abilityType === 'combat_vs_pirates') return baseValue * 1.3;
            break;
            
        case 'exploration_master': // Explorer's Bark
            if (abilityType === 'expedition_success') return baseValue * 1.5;
            break;
            
        case 'privateer': // Privateer Vessel
            if (abilityType === 'pirate_bounty') return baseValue * 2;
            if (abilityType === 'crown_reputation') return baseValue * 1.5;
            break;
            
        case 'treasure_ship': // Treasure Galleon
            if (abilityType === 'pirate_attraction') return baseValue * 2.5;
            break;
            
        case 'battle_fortress': // Ship of the Line
            if (abilityType === 'combat_power') return baseValue * 1.5;
            if (abilityType === 'intimidation') return baseValue * 3;
            break;
    }
    
    return baseValue;
}


    
getHiringQuote(member) {
    const quotes = {
        'gunner': ['Aye Captain, these cannons will sing under my care!', 'I\'ll make every shot count, sir!'],
        'navigator': ['I know these waters like the back of my hand, Captain.', 'Trust me to guide us true, sir.'],
        'cook': ['The crew will eat well with me in the galley, Captain!', 'A well-fed crew is a loyal crew, sir!'],
        'bosun': ['I\'ll keep the crew in line and the ship shipshape!', 'Discipline and seamanship, that\'s my way!'],
        'surgeon': ['I\'ll keep the crew healthy and patch up battle wounds.', 'Medicine and surgery, at your service!'],
        'carpenter': ['This ship will stay afloat as long as I draw breath!', 'I\'ll keep her timbers strong, Captain!']
    };
    
    const specialtyQuotes = quotes[member.specialty] || ['Ready to serve, Captain!'];
    return specialtyQuotes[Math.floor(Math.random() * specialtyQuotes.length)];
}



viewCrewDetails(crewName) {
    const ship = this.gameState.ownedShip;
    const member = ship.namedCrew.find(crew => crew.name === crewName);
    
    if (!member) return;
    
    const levelStars = '‚òÖ'.repeat(member.level);
    const expToNext = this.getExpForNextLevel(member.level) - member.experience;
    const timeServed = this.getTimeServed(member.joinedDate);
    
    let content = `<strong>üìã ${member.name} ${levelStars}</strong><br><br>`;
    
    content += `<div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px;">`;
    content += `<strong>Specialty:</strong> ${member.specialty.toUpperCase()}<br>`;
    content += `<strong>Level:</strong> ${member.level}/5<br>`;
    content += `<strong>Experience:</strong> ${member.experience} (${expToNext} to next level)<br>`;
    content += `<strong>Loyalty:</strong> ${member.loyalty}%<br>`;
    content += `<strong>Time Served:</strong> ${timeServed}<br>`;
    content += `</div>`;
    
    content += `<strong>üìà Skills:</strong><br>`;
    Object.keys(member.skills).forEach(skill => {
        const skillLevel = member.skills[skill];
        const skillStars = '‚óè'.repeat(skillLevel) + '‚óã'.repeat(5 - skillLevel);
        content += `${skill.toUpperCase()}: ${skillStars} (${skillLevel}/5)<br>`;
    });
    
    content += `<br><strong>üé≠ Personality:</strong><br>`;
    content += `${member.personality.trait} ${member.personality.background}<br><br>`;
    
    // Show recent achievements
    if (member.achievements && member.achievements.length > 0) {
        content += `<strong>üèÜ Recent Achievements:</strong><br>`;
        member.achievements.slice(-3).forEach(achievement => {
            content += `‚Ä¢ ${achievement}<br>`;
        });
    }
    
    
    // Add firing option
content += `<br><div style="border: 2px solid #dc3545; padding: 10px; margin: 10px 0; border-radius: 8px; background: #ffebee;">`;
content += `<strong>‚ö†Ô∏è Crew Management</strong><br>`;
content += `<button onclick="game.fireCrewMember('${member.name}')" style="background: #dc3545; color: white;">Fire ${member.name}</button>`;
content += `<br><small><em>Warning: Firing crew members may anger the remaining crew</em></small>`;
content += `</div>`;
    this.showActivityResult('üìã Crew Details', content);
}

getExpForNextLevel(currentLevel) {
    const expLevels = [0, 100, 250, 500, 1000, 2000]; // Level 1-5 requirements
    return expLevels[currentLevel] || 2000;
}

getTimeServed(joinedDate) {
    const monthsServed = (this.gameState.year - joinedDate.year) * 12 + (this.gameState.month - joinedDate.month);
    if (monthsServed < 1) return 'New recruit';
    if (monthsServed < 6) return `${monthsServed} months`;
    if (monthsServed < 12) return 'Half a year';
    const years = Math.floor(monthsServed / 12);
    const remainingMonths = monthsServed % 12;
    return years === 1 ? '1 year' : `${years} years${remainingMonths > 0 ? `, ${remainingMonths} months` : ''}`;
}    


getCrewCombatBonus() {
    const ship = this.gameState.ownedShip;
    if (!ship || !ship.namedCrew) return 0;
    
    let combatBonus = 0;
    ship.namedCrew.forEach(member => {
        if (member.specialty === 'gunner') {
            // Gunners provide big combat bonus based on their skill level
            combatBonus += member.skills.gunnery * 3;
        }
        if (member.specialty === 'bosun') {
            // Bosuns help coordinate the crew in combat
            combatBonus += member.skills.seamanship * 1.5;
        }
    });
    
    // Apply ship special combat bonuses
let shipBonus = 0;
const ability = this.getShipSpecialAbility();

if (ability === 'battle_fortress') {
    shipBonus += 15; // Ship of the Line gets massive combat bonus
} else if (ability === 'pirate_hunter' || ability === 'privateer') {
    shipBonus += 8; // Military ships get combat bonus
}

return Math.floor(combatBonus + shipBonus);
}


    
getCrewNavigationBonus() {
    const ship = this.gameState.ownedShip;
    if (!ship || !ship.namedCrew) return { timeReduction: 0, damageReduction: 0 };
    
    let timeReduction = 0;
    let damageReduction = 0;
    
    ship.namedCrew.forEach(member => {
        if (member.specialty === 'navigator') {
            // Skilled navigators reduce travel time and storm damage
            timeReduction += member.skills.navigation * 0.1; // 10% per navigation skill level
            damageReduction += member.skills.navigation * 0.05; // 5% damage reduction per level
        }
    });
    
    return { 
        timeReduction: Math.min(timeReduction, 0.5), // Cap at 50% time reduction
        damageReduction: Math.min(damageReduction, 0.3) // Cap at 30% damage reduction
    };
}

getCrewRepairBonus() {
    const ship = this.gameState.ownedShip;
    if (!ship || !ship.namedCrew) return 0;
    
    let repairBonus = 0;
    ship.namedCrew.forEach(member => {
        if (member.specialty === 'carpenter') {
            // Carpenters reduce daily wear and provide passive repair
            repairBonus += member.skills.repair * 0.5;
        }
    });
    
    return repairBonus;
}

getCrewLoyaltyBonus() {
    const ship = this.gameState.ownedShip;
    if (!ship || !ship.namedCrew || ship.namedCrew.length === 0) return 1.0;
    
    const avgLoyalty = ship.namedCrew.reduce((sum, member) => sum + member.loyalty, 0) / ship.namedCrew.length;
    
    // High loyalty (80+) = 110% efficiency, Low loyalty (40-) = 70% efficiency
    return 0.7 + (avgLoyalty / 100) * 0.4;
}


checkCrewLoyaltyEvents() {
    const ship = this.gameState.ownedShip;
    if (!ship.namedCrew || ship.namedCrew.length === 0) return;
    
    // Calculate average loyalty
    const avgLoyalty = ship.namedCrew.reduce((sum, member) => sum + member.loyalty, 0) / ship.namedCrew.length;
    
    // Very low loyalty (under 30) - mutiny risk!
    if (avgLoyalty < 30 && Math.random() < 0.05) { // 5% chance per day
        this.handleMutinyEvent();
        return;
    }
    
    // Low loyalty (30-50) - crew demands
    if (avgLoyalty < 50 && Math.random() < 0.03) { // 3% chance per day
        this.handleCrewDemands();
        return;
    }
    
    // Check for individual crew leaving due to low loyalty
    ship.namedCrew.forEach((member, index) => {
        if (member.loyalty < 25 && Math.random() < 0.02) { // 2% chance per day
            this.handleCrewAbandon(member, index);
        }
    });
}

handleMutinyEvent() {
    const ship = this.gameState.ownedShip;
    
    // Find the most disloyal crew member as ringleader
    const ringleader = ship.namedCrew.reduce((lowest, member) => 
        member.loyalty < lowest.loyalty ? member : lowest);
    
    let content = `<strong>üè¥‚Äç‚ò†Ô∏è MUTINY ABOARD "${ship.shipName}"!</strong><br><br>`;
    content += `${ringleader.name} leads a mutiny against your command!<br><br>`;
    content += `"We've had enough of your leadership, Captain! Stand down or face the consequences!"<br><br>`;
    
    content += `<strong>Choose your response:</strong><br><br>`;
    
    // Option 1: Fight the mutiny
    content += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>‚öîÔ∏è FIGHT THE MUTINY</strong><br>`;
    content += `Stand your ground and fight to regain control!<br>`;
    content += `<em>Risk: Crew casualties, ship damage</em><br>`;
    content += `<button onclick="game.resolveMutiny('fight')">Fight for Command!</button>`;
    content += `</div>`;
    
    // Option 2: Negotiate
    content += `<div style="border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>ü§ù NEGOTIATE</strong><br>`;
    content += `Try to talk down the mutineers and address their grievances.<br>`;
    content += `<em>Cost: Gold to improve conditions</em><br>`;
    content += `<button onclick="game.resolveMutiny('negotiate')">Hear Their Demands</button>`;
    content += `</div>`;
    
    // Option 3: Surrender command (if wealthy enough)
    if (this.characterData.stats.money > 200) {
        content += `<div style="border: 2px solid #6c757d; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
        content += `<strong>üè≥Ô∏è ABANDON SHIP</strong><br>`;
        content += `Take what you can and abandon the ship to the mutineers.<br>`;
        content += `<em>Lose ship but keep most of your gold</em><br>`;
        content += `<button onclick="game.resolveMutiny('abandon')">Abandon Ship</button>`;
        content += `</div>`;
    }


// Mutiny is always critical
this.criticalMessageActive = true;
this.showEmergencyEvent('üè¥‚Äç‚ò†Ô∏è Mutiny!', content);
}

handleCrewDemands() {
    const ship = this.gameState.ownedShip;
    const demandCost = Math.floor(Math.random() * 50) + 30; // 30-80 gold
    
    let content = `<strong>üò† Crew Unrest aboard "${ship.shipName}"</strong><br><br>`;
    content += `Your crew is unhappy and making demands!<br><br>`;
    content += `"Captain, we need better conditions! Better food, better pay, or we might start looking for a new ship!"<br><br>`;
    
    content += `<strong>Their demands:</strong><br>`;
    content += `‚Ä¢ ${demandCost} gold for improved provisions<br>`;
    content += `‚Ä¢ Promise of better treatment<br><br>`;
    
    const canAfford = this.characterData.stats.money >= demandCost;
    
    if (canAfford) {
        content += `<button onclick="game.resolveCrewDemands(${demandCost}, true)">Pay ${demandCost} gold (Crew +15 Loyalty)</button><br>`;
    } else {
        content += `<button disabled>Pay ${demandCost} gold (You don't have enough!)</button><br>`;
    }
    content += `<button onclick="game.resolveCrewDemands(${demandCost}, false)">Refuse Their Demands</button>`;
    
    this.showEmergencyEvent('üò† Crew Demands', content);
}

handleCrewAbandon(member, index) {
    const ship = this.gameState.ownedShip;
    
    // Remove the crew member
    ship.namedCrew.splice(index, 1);
    ship.crew--;
    
    this.showEmergencyEvent('üö™ Crew Member Leaves', 
        `<strong>${member.name} has abandoned ship!</strong><br><br>` +
        `"I can't serve under these conditions anymore, Captain. I'm finding another ship."<br><br>` +
        `<strong>Consequences:</strong><br>` +
        `‚Ä¢ Lost: ${member.name} (${member.specialty})<br>` +
        `‚Ä¢ Crew count: ${ship.crew}/${ship.maxCrew}<br>` +
        `‚Ä¢ Other crew members are concerned (-5 loyalty to all)<br><br>` +
        `<em>Low loyalty is driving away your experienced sailors...</em>`);
    
    // Reduce loyalty of remaining crew
    ship.namedCrew.forEach(remainingMember => {
        remainingMember.loyalty = Math.max(0, remainingMember.loyalty - 5);
    });
}
        

resolveMutiny(choice) {
    const ship = this.gameState.ownedShip;
    
    if (choice === 'fight') {
        // Fight the mutiny - risky but can succeed
        const fightSuccess = Math.random() < (0.5 + this.characterData.stats.leadership * 0.1);
        
        if (fightSuccess) {
            // Victory - execute ringleaders, others fall in line
            const casualties = Math.floor(Math.random() * 2) + 1;
            ship.crew = Math.max(1, ship.crew - casualties);
            ship.namedCrew = ship.namedCrew.slice(casualties); // Remove first few crew
            ship.condition -= Math.floor(Math.random() * 15) + 10; // Ship damage from fighting
            
            // Survivors fear you but respect your strength
            ship.namedCrew.forEach(member => {
                member.loyalty = Math.min(100, member.loyalty + 20);
            });
            
            this.showEmergencyEvent('‚öîÔ∏è Mutiny Crushed!',
                `You successfully crush the mutiny through force!<br><br>` +
                `<strong>Consequences:</strong><br>` +
                `‚Ä¢ ${casualties} mutineers killed or marooned<br>` +
                `‚Ä¢ Ship damaged in the fighting (-${Math.floor(Math.random() * 15) + 10} condition)<br>` +
                `‚Ä¢ Surviving crew respects your strength (+20 loyalty)<br>` +
                `‚Ä¢ Your reputation for harsh discipline spreads<br><br>` +
                `<em>"Let this be a lesson to anyone who questions my command!"</em>`);
            
            this.characterData.reputation.pirate += 1; // Pirates respect strength
            this.characterData.stats.leadership += 0.3;
            
        } else {
            // Defeat - lose ship and most possessions
            const goldLoss = Math.floor(this.characterData.stats.money * 0.7);
            this.characterData.stats.money -= goldLoss;
            this.gameState.ownedShip = null;
            
            this.showEmergencyEvent('üíÄ Mutiny Successful!',
                `The mutineers overpower you and seize control of the ship!<br><br>` +
                `<strong>Devastating Loss:</strong><br>` +
                `‚Ä¢ Ship "${ship.shipName}" seized by mutineers<br>` +
                `‚Ä¢ ${goldLoss} gold stolen<br>` +
                `‚Ä¢ You barely escape with your life<br>` +
                `‚Ä¢ Marooned at the nearest port<br><br>` +
                `<em>"You should have treated us better, Captain. Now the ship is ours!"</em>`);
            
            this.characterData.reputation.merchant -= 2; // Word spreads of your failure
        }
        
    } else if (choice === 'negotiate') {
        const negotiationCost = Math.floor(Math.random() * 100) + 80; // 80-180 gold
        
        if (this.characterData.stats.money >= negotiationCost) {
            this.characterData.stats.money -= negotiationCost;
            
            // Successful negotiation
            ship.namedCrew.forEach(member => {
                member.loyalty = Math.min(100, member.loyalty + 25);
            });
            
            this.showEmergencyEvent('ü§ù Mutiny Resolved!',
                `You successfully negotiate with the mutineers!<br><br>` +
                `<strong>Agreement Reached:</strong><br>` +
                `‚Ä¢ Paid ${negotiationCost} gold for better conditions<br>` +
                `‚Ä¢ All crew loyalty restored (+25 to all)<br>` +
                `‚Ä¢ Ship upgrades and better provisions<br>` +
                `‚Ä¢ Your leadership skills improve<br><br>` +
                `<em>"We're glad you listened to our concerns, Captain. We'll serve you loyally."</em>`);
            
            this.characterData.stats.social += 0.5;
            this.characterData.stats.leadership += 0.3;
            
        } else {
            // Can't afford negotiation - mutiny continues
            this.showEmergencyEvent('üí∏ Negotiation Failed!',
                `You don't have enough gold to meet their demands!<br><br>` +
                `"If you can't provide for us, then you're not fit to be captain!"<br><br>` +
                `<em>The mutiny escalates...</em>`);
            
            setTimeout(() => {
                this.resolveMutiny('fight'); // Force into combat
            }, 3000);
        }
        
    } else if (choice === 'abandon') {
        // Abandon ship - lose ship but keep most gold
        const goldSaved = Math.floor(this.characterData.stats.money * 0.8);
        this.characterData.stats.money = goldSaved;
        this.gameState.ownedShip = null;
        
        this.showEmergencyEvent('üè≥Ô∏è Ship Abandoned!',
            `You wisely abandon the ship to the mutineers and escape!<br><br>` +
            `<strong>Strategic Retreat:</strong><br>` +
            `‚Ä¢ Lost ship "${ship.shipName}" to mutineers<br>` +
            `‚Ä¢ Saved ${goldSaved} gold (80% of your wealth)<br>` +
            `‚Ä¢ No casualties or violence<br>` +
            `‚Ä¢ Live to sail another day<br><br>` +
            `<em>"Sometimes the wise captain knows when to cut losses."</em>`);
        
        this.characterData.stats.social += 0.2; // Peaceful resolution
    }
}

resolveCrewDemands(cost, accept) {
    const ship = this.gameState.ownedShip;
    
    if (accept) {
        this.characterData.stats.money -= cost;
        
        // Boost loyalty significantly
        ship.namedCrew.forEach(member => {
            member.loyalty = Math.min(100, member.loyalty + 15);
        });
        
        this.showEmergencyEvent('‚úÖ Crew Satisfied!',
            `You meet your crew's demands and they're happy!<br><br>` +
            `<strong>Investment in Crew:</strong><br>` +
            `‚Ä¢ Paid ${cost} gold for better conditions<br>` +
            `‚Ä¢ All crew loyalty increased (+15)<br>` +
            `‚Ä¢ Improved morale and performance<br><br>` +
            `<em>"Thank you Captain! We'll serve you well!"</em>`);
        
    } else {
        // Refuse demands - loyalty drops further
        ship.namedCrew.forEach(member => {
            member.loyalty = Math.max(0, member.loyalty - 10);
        });
        
        this.showEmergencyEvent('üò† Crew Angry!',
            `You refuse your crew's demands and they're furious!<br><br>` +
            `<strong>Consequences:</strong><br>` +
            `‚Ä¢ All crew loyalty decreased (-10)<br>` +
            `‚Ä¢ Risk of future unrest increases<br>` +
            `‚Ä¢ Crew performance will suffer<br><br>` +
            `<em>"Fine Captain, but don't expect us to be happy about it!"</em>`);
    }
}
    

fireCrewMember(crewName) {
    const ship = this.gameState.ownedShip;
    const memberIndex = ship.namedCrew.findIndex(crew => crew.name === crewName);
    
    if (memberIndex === -1) return;
    
    const member = ship.namedCrew[memberIndex];
    
    // Remove the crew member
    ship.namedCrew.splice(memberIndex, 1);
    ship.crew--;
    
    // Firing affects remaining crew loyalty based on the fired member's loyalty
    let loyaltyEffect = 0;
    if (member.loyalty > 70) {
        loyaltyEffect = -8; // Firing a loyal crew member angers others
    } else if (member.loyalty < 30) {
        loyaltyEffect = +3; // Firing a disloyal crew member relieves others
    } else {
        loyaltyEffect = -3; // Neutral effect
    }
    
    ship.namedCrew.forEach(remainingMember => {
        remainingMember.loyalty = Math.max(0, Math.min(100, remainingMember.loyalty + loyaltyEffect));
    });
    
    let resultText = `<strong>${member.name} has been dismissed from service!</strong><br><br>`;
    resultText += `"I understand, Captain. I'll find another ship."<br><br>`;
    resultText += `<strong>Consequences:</strong><br>`;
    resultText += `‚Ä¢ Lost: ${member.name} (${member.specialty})<br>`;
    resultText += `‚Ä¢ Crew count: ${ship.crew}/${ship.maxCrew}<br>`;
    
    if (loyaltyEffect > 0) {
        resultText += `‚Ä¢ Remaining crew approves (+${loyaltyEffect} loyalty)<br>`;
        resultText += `<em>"Good riddance! That one was nothing but trouble."</em>`;
    } else if (loyaltyEffect < 0) {
        resultText += `‚Ä¢ Remaining crew disapproves (${loyaltyEffect} loyalty)<br>`;
        resultText += `<em>"Poor ${member.name}... we could be next."</em>`;
    } else {
        resultText += `‚Ä¢ Remaining crew has mixed feelings<br>`;
    }
    
    this.showActivityResult('üö™ Crew Dismissed', resultText);
}

rewardCrew() {
    const ship = this.gameState.ownedShip;
    
    if (!ship.namedCrew || ship.namedCrew.length === 0) {
        this.showActivityResult('üë• No Crew to Reward', 
            'You don\'t have any crew members to reward.');
        return;
    }
    
    let content = `<strong>üéÅ Reward Your Crew - "${ship.shipName}"</strong><br><br>`;
    content += 'Rewarding your crew improves loyalty and performance.<br><br>';
    
    // Individual crew rewards
    content += '<strong>üë§ Individual Rewards:</strong><br><br>';
    ship.namedCrew.forEach((member, index) => {
        content += `<div style="border: 1px solid #28a745; padding: 10px; margin: 5px 0; border-radius: 5px;">`;
        content += `<strong>${member.name}</strong> (${member.specialty}) - Loyalty: ${member.loyalty}%<br>`;
        content += `<button onclick="game.giveBonusToCrew(${index}, 'small')">Small Bonus (5 gold)</button> `;
        content += `<button onclick="game.giveBonusToCrew(${index}, 'large')">Large Bonus (15 gold)</button>`;
        content += `</div>`;
    });
    
    content += '<br><strong>üë• Crew-Wide Rewards:</strong><br><br>';
    
    const totalCrew = ship.namedCrew.length;
    const smallCrewCost = totalCrew * 3;
    const largeCrewCost = totalCrew * 8;
    const feastCost = totalCrew * 5 + 20; // Base feast cost plus per person
    
    content += `<div style="border: 1px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üç∫ Crew Drinks</strong> (${smallCrewCost} gold)<br>`;
    content += `Buy drinks for everyone at the tavern.<br>`;
    content += `<button onclick="game.rewardAllCrew('drinks', ${smallCrewCost})">Buy Crew Drinks</button><br><br>`;
    
    content += `<strong>üí∞ Pay Bonus</strong> (${largeCrewCost} gold)<br>`;
    content += `Give everyone extra pay for good service.<br>`;
    content += `<button onclick="game.rewardAllCrew('bonus', ${largeCrewCost})">Pay Crew Bonus</button><br><br>`;
    
    content += `<strong>üçñ Feast</strong> (${feastCost} gold)<br>`;
    content += `Throw a grand feast for the entire crew.<br>`;
    content += `<button onclick="game.rewardAllCrew('feast', ${feastCost})">Throw Feast</button>`;
    content += `</div>`;
    
    this.showActivityResult('üéÅ Crew Rewards', content);
}


giveBonusToCrew(crewIndex, bonusType) {
    const ship = this.gameState.ownedShip;
    const member = ship.namedCrew[crewIndex];
    const costs = { small: 5, large: 15 };
    const cost = costs[bonusType];
    
    if (this.characterData.stats.money < cost) {
        this.showActivityResult('üí∞ Not Enough Gold', `You need ${cost} gold for this bonus.`);
        return;
    }
    
    this.characterData.stats.money -= cost;
    
    const loyaltyBoost = bonusType === 'small' ? 8 : 20;
    member.loyalty = Math.min(100, member.loyalty + loyaltyBoost);
    
    // Experience bonus for being rewarded
    member.experience += bonusType === 'small' ? 5 : 15;
    
    const rewards = {
        small: ['extra rum ration', 'silver coin', 'fine tobacco', 'new clothes', 'shore leave'],
        large: ['gold coins', 'fine weapon', 'quality boots', 'premium rum', 'silk vest']
    };
    
    const reward = rewards[bonusType][Math.floor(Math.random() * rewards[bonusType].length)];
    
    this.showActivityResult('üéÅ Crew Member Rewarded', 
        `You give ${member.name} ${reward} as a reward for good service.<br><br>` +
        `"Thank you, Captain! I won't forget your generosity!"<br><br>` +
        `<strong>Effects:</strong><br>` +
        `‚Ä¢ +${loyaltyBoost} loyalty (now ${member.loyalty}%)<br>` +
        `‚Ä¢ +${bonusType === 'small' ? 5 : 15} experience<br>` +
        `‚Ä¢ Improved crew morale<br><br>` +
        `<em>A generous captain earns loyal followers.</em>`);
        
    // Check for level up
    this.checkCrewLevelUp(member);
}

rewardAllCrew(rewardType, cost) {
    const ship = this.gameState.ownedShip;
    
    if (this.characterData.stats.money < cost) {
        this.showActivityResult('üí∞ Not Enough Gold', `You need ${cost} gold for this reward.`);
        return;
    }
    
    this.characterData.stats.money -= cost;
    
    let loyaltyBoost, expBoost, description;
    
    switch(rewardType) {
        case 'drinks':
            loyaltyBoost = 5;
            expBoost = 3;
            description = 'You buy drinks for the entire crew at the local tavern.';
            break;
        case 'bonus':
            loyaltyBoost = 12;
            expBoost = 8;
            description = 'You distribute bonus pay to all crew members.';
            break;
        case 'feast':
            loyaltyBoost = 18;
            expBoost = 12;
            description = 'You throw a magnificent feast with the finest food and entertainment.';
            break;
    }
    
    // Apply to all crew
    ship.namedCrew.forEach(member => {
        member.loyalty = Math.min(100, member.loyalty + loyaltyBoost);
        member.experience += expBoost;
        
        // Check for level ups
        this.checkCrewLevelUp(member);
    });
    
    // Leadership skill bonus for captain
    this.characterData.stats.leadership += 0.3;
    
    this.showActivityResult('üéâ Crew Celebration!', 
        `${description}<br><br>` +
        `The crew cheers and toasts to your leadership!<br><br>` +
        `<strong>Effects on All Crew:</strong><br>` +
        `‚Ä¢ +${loyaltyBoost} loyalty<br>` +
        `‚Ä¢ +${expBoost} experience<br><br>` +
        `<strong>Captain Benefits:</strong><br>` +
        `‚Ä¢ +0.3 Leadership skill<br><br>` +
        `<em>"Three cheers for the Captain! Hip hip hooray!"</em>`);
}

            

checkCrewDeaths(eventType, baseDangerLevel) {
    const ship = this.gameState.ownedShip;
    if (!ship || !ship.namedCrew || ship.namedCrew.length === 0) return [];
    
    // Check if we have a surgeon
    const hasSurgeon = ship.namedCrew.some(member => member.specialty === 'surgeon');
    const surgeonSkill = hasSurgeon ? 
        ship.namedCrew.find(member => member.specialty === 'surgeon').skills.medicine : 0;
    
    // Calculate death chance based on event type and medical care
    let deathChance = baseDangerLevel;
    
    if (hasSurgeon) {
        // Surgeon dramatically reduces death chance
        deathChance *= (1 - (surgeonSkill * 0.15)); // 15% reduction per surgery skill level
    } else {
        // No surgeon = much higher death risk
        deathChance *= 2.5;
    }
    
    const casualties = [];
    
    // Check each crew member for death
    ship.namedCrew.forEach((member, index) => {
        // Older, less experienced crew more likely to die
        const memberRisk = deathChance + (member.level < 2 ? 0.02 : 0);
        
        if (Math.random() < memberRisk) {
            casualties.push({
                name: member.name,
                specialty: member.specialty,
                index: index,
                cause: eventType
            });
        }
    });
    
    // Remove dead crew members (in reverse order to preserve indices)
    casualties.reverse().forEach(casualty => {
        ship.namedCrew.splice(casualty.index, 1);
        ship.crew--;
    });
    
    // Surviving crew lose loyalty from witnessing deaths
    if (casualties.length > 0) {
        const loyaltyLoss = casualties.length * 8; // 8 loyalty per death
        ship.namedCrew.forEach(survivor => {
            survivor.loyalty = Math.max(0, survivor.loyalty - loyaltyLoss);
        });
    }
    
    return casualties;
}

getDeathReport(casualties, eventType, hasSurgeon) {
    if (casualties.length === 0) return '';
    
    let report = `<br><br><div style="background: #2c2c2c; color: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #dc3545;">`;
    report += `<strong>üíÄ CASUALTIES</strong><br><br>`;
    
    casualties.forEach(casualty => {
        report += `‚Ä¢ <strong>${casualty.name}</strong> (${casualty.specialty}) - killed by ${casualty.cause}<br>`;
    });
    
    report += `<br><strong>Impact:</strong><br>`;
    report += `‚Ä¢ ${casualties.length} crew member(s) lost<br>`;
    report += `‚Ä¢ Surviving crew morale drops (-${casualties.length * 8} loyalty)<br>`;
    
    if (!hasSurgeon && casualties.length > 0) {
        report += `<br><em style="color: #ffcdd2;">‚öïÔ∏è A ship's surgeon could have saved some of these lives...</em>`;
    } else if (hasSurgeon) {
        report += `<br><em style="color: #c8e6c9;">‚öïÔ∏è Your surgeon's skill prevented even more casualties.</em>`;
    }
    
    report += `</div>`;
    return report;
}


        
giveCrewExperience(activityType, amount = 10) {
    const ship = this.gameState.ownedShip;
    if (!ship || !ship.namedCrew || ship.namedCrew.length === 0) return [];
    
    const expGains = [];
    
    ship.namedCrew.forEach(member => {
        let expGain = amount;
        let bonusReason = '';
        
        // Specialty bonuses for relevant activities
        switch(activityType) {
            case 'combat':
                if (member.specialty === 'gunner') {
                    expGain *= 2;
                    bonusReason = ' (gunnery specialty)';
                }
                break;
            case 'travel':
                if (member.specialty === 'navigator') {
                    expGain *= 1.5;
                    bonusReason = ' (navigation specialty)';
                }
                break;
            case 'repair':
                if (member.specialty === 'carpenter') {
                    expGain *= 2;
                    bonusReason = ' (carpentry specialty)';
                }
                break;
            case 'medical':
                if (member.specialty === 'surgeon') {
                    expGain *= 2;
                    bonusReason = ' (medical specialty)';
                }
                break;
        }
        
        // Personality bonuses
        if (member.personality.trait === 'Ambitious') {
            expGain = Math.floor(expGain * 1.2);
        }
        
        member.experience += expGain;
        expGains.push(`${member.name}: +${expGain} exp${bonusReason}`);
        
        // Check for level up and collect level up info
const levelUpInfo = this.checkCrewLevelUp(member);
if (levelUpInfo) {
    expGains[expGains.length - 1] += ` ‚Üí LEVEL UP! Now Level ${levelUpInfo.newLevel}`;
}
    });
    
    return expGains;
}

checkCrewLevelUp(member) {
    const requiredExp = this.getExpForNextLevel(member.level);
    
    if (member.experience >= requiredExp && member.level < 5) {
        const oldLevel = member.level;
        member.level++;
        
        // Improve skills on level up
        this.improveCrewSkills(member);
        
        // Increase loyalty
        member.loyalty = Math.min(100, member.loyalty + 10);
        
        // Add achievement
        if (!member.achievements) member.achievements = [];
        member.achievements.push(`Promoted to Level ${member.level}!`);
        
        // Return level up info instead of showing modal immediately
        return {
            name: member.name,
            oldLevel: oldLevel,
            newLevel: member.level,
            specialty: member.specialty
        };
    }
    
    return null;
}
    

improveCrewSkills(member) {
    // Improve primary specialty skill first
    const specialtySkills = {
        'gunner': 'gunnery',
        'navigator': 'navigation', 
        'cook': 'cooking',
        'bosun': 'seamanship',
        'surgeon': 'medicine',
        'carpenter': 'repair'
    };
    
    const primarySkill = specialtySkills[member.specialty];
    if (primarySkill && member.skills[primarySkill] < 5) {
        member.skills[primarySkill]++;
    }
    
    // Small chance to improve other skills
    Object.keys(member.skills).forEach(skill => {
        if (skill !== primarySkill && Math.random() < 0.3 && member.skills[skill] < 5) {
            member.skills[skill]++;
        }
    });
}

        

sailWithShip() {
        this.showActivityResult('‚õµ Sail Your Ship', 
            '<strong>Take command and sail to your destination.</strong><br><br>' +
            '<em>Ship sailing system coming soon...</em><br><br>' +
            'For now, use the regular Travel option.');
    }


    upgradeShip() {
    this.setContext('upgrades');
    const ship = this.gameState.ownedShip;

        // BACKWARD COMPATIBILITY: Add missing properties for old saves
    if (!ship.baseStats) {
        // Determine base stats from ship name/type
        const baseStatsByType = {
            'Rowing Boat': { combat: 5, defense: 5, speed: 15, cargo: 2 },
            'Sloop': { combat: 12, defense: 8, speed: 18, cargo: 10 },
            'Brigantine': { combat: 20, defense: 15, speed: 12, cargo: 25 }
        };
        
        ship.baseStats = baseStatsByType[ship.name] || { combat: 10, defense: 10, speed: 10, cargo: ship.cargo };
    }
    
    if (!ship.upgrades) {
        ship.upgrades = {
            cannons: 0,
            armor: 0, 
            speed: 0,
            storage: 0
        };
    }
        
    let content = `<strong>‚öîÔ∏è Ship Upgrades - "${ship.shipName}"</strong><br><br>`;
    
    // Show current stats
    const currentCombat = ship.baseStats.combat + (ship.upgrades.cannons * 8);
    const currentDefense = ship.baseStats.defense + (ship.upgrades.armor * 6);
    const currentSpeed = ship.baseStats.speed + (ship.upgrades.speed * 4);
    const currentCargo = ship.baseStats.cargo + (ship.upgrades.storage * 5);
    
    content += `<div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px;">`;
    content += `<strong>Current Ship Stats:</strong><br>`;
    content += `‚öîÔ∏è Combat Power: ${currentCombat}<br>`;
    content += `üõ°Ô∏è Defense Rating: ${currentDefense}<br>`;
    content += `üí® Speed: ${currentSpeed}<br>`;
    content += `üì¶ Cargo Capacity: ${currentCargo}<br>`;
    content += `</div>`;
    
    content += `<strong>Available Upgrades:</strong><br><br>`;
    
    // Cannon upgrades
    const cannonLevel = ship.upgrades.cannons;
    const cannonCost = (cannonLevel + 1) * 200;
    const cannonNames = ['No Cannons', 'Light Cannons', 'Medium Cannons', 'Heavy Cannons', 'MAX FIREPOWER'];
    
    content += `<div style="border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>‚öîÔ∏è Cannons</strong> - Level ${cannonLevel}/3<br>`;
    content += `Current: ${cannonNames[cannonLevel]}<br>`;
    content += `Combat Power: +${cannonLevel * 8}<br><br>`;
    
    if (cannonLevel < 3) {
        const nextLevel = cannonNames[cannonLevel + 1];
        const canAfford = this.characterData.stats.money >= cannonCost;
        const buttonHtml = canAfford ? 
            `<button onclick="game.buyUpgrade('cannons', ${cannonCost})">Upgrade to ${nextLevel} (${cannonCost} gold)</button>` :
            `<button disabled>Upgrade to ${nextLevel} (${cannonCost} gold)</button>`;
        content += buttonHtml;
    } else {
        content += `<em>Maximum firepower achieved!</em>`;
    }
    content += `</div>`;
    
    // Armor upgrades
    const armorLevel = ship.upgrades.armor;
    const armorCost = (armorLevel + 1) * 150;
    const armorNames = ['No Armor', 'Iron Plating', 'Reinforced Hull', 'Battle Armor', 'FORTRESS'];
    
    content += `<div style="border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üõ°Ô∏è Armor</strong> - Level ${armorLevel}/3<br>`;
    content += `Current: ${armorNames[armorLevel]}<br>`;
    content += `Defense Rating: +${armorLevel * 6}<br><br>`;
    
    if (armorLevel < 3) {
        const nextLevel = armorNames[armorLevel + 1];
        const canAfford = this.characterData.stats.money >= armorCost;
        const buttonHtml = canAfford ? 
            `<button onclick="game.buyUpgrade('armor', ${armorCost})">Upgrade to ${nextLevel} (${armorCost} gold)</button>` :
            `<button disabled>Upgrade to ${nextLevel} (${armorCost} gold)</button>`;
        content += buttonHtml;
    } else {
        content += `<em>Maximum protection achieved!</em>`;
    }
    content += `</div>`;
    
    // Speed upgrades
    const speedLevel = ship.upgrades.speed;
    const speedCost = (speedLevel + 1) * 100;
    const speedNames = ['Standard Sails', 'Fine Sails', 'Racing Sails', 'Storm Sails', 'WIND MASTER'];
    
    content += `<div style="border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px;">`;
    content += `<strong>üí® Speed</strong> - Level ${speedLevel}/3<br>`;
    content += `Current: ${speedNames[speedLevel]}<br>`;
    content += `Speed Bonus: +${speedLevel * 4}<br><br>`;
    
    if (speedLevel < 3) {
        const nextLevel = speedNames[speedLevel + 1];
        const canAfford = this.characterData.stats.money >= speedCost;
        const buttonHtml = canAfford ? 
            `<button onclick="game.buyUpgrade('speed', ${speedCost})">Upgrade to ${nextLevel} (${speedCost} gold)</button>` :
            `<button disabled>Upgrade to ${nextLevel} (${speedCost} gold)</button>`;
        content += buttonHtml;
    } else {
        content += `<em>Maximum speed achieved!</em>`;
    }
    content += `</div>`;
    
    this.showActivityResult('‚öîÔ∏è Ship Upgrades', content);
}

buyUpgrade(upgradeType, cost) {
    const ship = this.gameState.ownedShip;
    
    if (this.characterData.stats.money >= cost) {
        // Deduct money
        this.characterData.stats.money -= cost;
        
        // Increase upgrade level
ship.upgrades[upgradeType]++;

// Track total ship value
if (!ship.totalValue) {
    ship.totalValue = ship.purchasePrice || 1000; // Default for old ships
}
ship.totalValue += cost;
        
        // Update ship cargo capacity if storage upgrade
        if (upgradeType === 'storage') {
            ship.cargo = ship.baseStats.cargo + (ship.upgrades.storage * 5);
        }
        
        // Get upgrade names for display
        const upgradeNames = {
            cannons: ['No Cannons', 'Light Cannons', 'Medium Cannons', 'Heavy Cannons'][ship.upgrades.cannons],
            armor: ['No Armor', 'Iron Plating', 'Reinforced Hull', 'Battle Armor'][ship.upgrades.armor],
            speed: ['Standard Sails', 'Fine Sails', 'Racing Sails', 'Storm Sails'][ship.upgrades.speed],
            storage: ['Standard Hold', 'Expanded Hold', 'Maximum Hold'][ship.upgrades.storage]
        };
        
        const upgradeBonuses = {
            cannons: `+${ship.upgrades.cannons * 8} Combat Power`,
            armor: `+${ship.upgrades.armor * 6} Defense Rating`, 
            speed: `+${ship.upgrades.speed * 4} Speed`,
            storage: `+${ship.upgrades.storage * 5} Cargo Capacity`
        };
        
        // Show success message
        this.showActivityResult('üîß Upgrade Complete!', 
            `<strong>Ship upgrade successful!</strong><br><br>` +
            `üí∞ Cost: ${cost} gold<br>` +
            `‚öîÔ∏è New Equipment: ${upgradeNames[upgradeType]}<br>` +
            `üìà Bonus: ${upgradeBonuses[upgradeType]}<br><br>` +
            `<em>Your ship "${ship.shipName}" is now more formidable!</em>`);
        
        // Return to previous context after delay
setTimeout(() => {
    if (this.currentContext === 'upgrades') {
        this.upgradeShip();
    } else {
        this.returnToPreviousContext();
    }
}, 3000);
        
    } else {
        alert(`You need ${cost} gold for this upgrade!`);
    }
}

        

        
    
    joinExpedition(expeditionId) {
        const expeditions = {
            african_coast: {
                name: 'African Coast Survey',
                days: 14,
                risk: 0.3,
                cost: 50,
                rewards: { gold: [100, 300], reputation: 2 },
                description: 'Map the African coastline and establish trading posts',
                successRewards: {
                    discoveredRoutes: ['african_gold_route'],
                    unlockedGoods: ['ivory', 'gold_dust'],
                    skills: { navigation: 0.5, leadership: 0.3 }
                }
            },
            spice_route: {
                name: 'New Spice Route', 
                days: 21,
                risk: 0.4,
                cost: 100,
                rewards: { gold: [200, 500], reputation: 3 },
                description: 'Discover faster routes to the spice islands',
                successRewards: {
                    discoveredRoutes: ['fast_spice_route'],
                    unlockedGoods: ['rare_spices', 'silk'],
                    skills: { navigation: 0.8, trading: 0.5 }
                }
            },
            brazil_expedition: {
                name: 'Brazil Interior',
                days: 30,
                risk: 0.5,
                cost: 200,
                rewards: { gold: [300, 800], reputation: 5 },
                description: 'Explore the Brazilian interior for gold and rare goods',
                successRewards: {
                    discoveredRoutes: ['brazil_interior'],
                    unlockedGoods: ['brazilian_gold', 'exotic_woods', 'sugar_cane'],
                    skills: { leadership: 1.0, navigation: 0.5 },
                    specialUnlock: 'colonial_expansion'
                }
            }
        };
        
        const expedition = expeditions[expeditionId];
        this.characterData.stats.money -= expedition.cost;
        
        const success = Math.random() > expedition.risk;
        
        if (success) {
    // More generous rewards - always get at least 75% of max possible
    const minReward = expedition.rewards.gold[0];
    const maxReward = expedition.rewards.gold[1];
    const goldReward = Math.floor(minReward + (maxReward - minReward) * 0.75 + 
        Math.random() * (maxReward - minReward) * 0.25);
            
            this.characterData.stats.money += goldReward;
            this.gameState.explorationData.reputation += expedition.rewards.reputation;
            this.gameState.explorationData.completedExpeditions.push(expeditionId);
            
            // Apply success rewards
            const successRewards = expedition.successRewards;
            
            // Add discovered routes
            if (successRewards.discoveredRoutes) {
                if (!this.gameState.explorationData.discoveredRoutes) {
                    this.gameState.explorationData.discoveredRoutes = [];
                }
                successRewards.discoveredRoutes.forEach(route => {
                    if (!this.gameState.explorationData.discoveredRoutes.includes(route)) {
                        this.gameState.explorationData.discoveredRoutes.push(route);
                    }
                });
            }
            
            // Add unlocked goods to trading system
            if (successRewards.unlockedGoods) {
                if (!this.gameState.unlockedGoods) {
                    this.gameState.unlockedGoods = [];
                }
                successRewards.unlockedGoods.forEach(good => {
                    if (!this.gameState.unlockedGoods.includes(good)) {
                        this.gameState.unlockedGoods.push(good);
                    }
                });
            }
            
            // Apply skill bonuses
            if (successRewards.skills) {
                Object.keys(successRewards.skills).forEach(skill => {
                    this.characterData.stats[skill] += successRewards.skills[skill];
                });
            }
            
            // Special unlocks
            if (successRewards.specialUnlock) {
                if (!this.gameState.specialUnlocks) {
                    this.gameState.specialUnlocks = [];
                }
                this.gameState.specialUnlocks.push(successRewards.specialUnlock);
            }
            
            let rewardText = `Your ${expedition.name} expedition was successful!<br><br>` +
                           `<strong>üí∞ Immediate Rewards:</strong><br>` +
                           `‚Ä¢ ${goldReward} gold<br>` +
                           `‚Ä¢ +${expedition.rewards.reputation} exploration reputation<br><br>`;
            
            if (successRewards.discoveredRoutes) {
                rewardText += `<strong>üó∫Ô∏è New Trade Routes:</strong><br>`;
                successRewards.discoveredRoutes.forEach(route => {
                    rewardText += `‚Ä¢ ${route.replace('_', ' ').toUpperCase()}<br>`;
                });
                rewardText += '<br>';
            }
            
            if (successRewards.unlockedGoods) {
                rewardText += `<strong>üì¶ New Goods Available:</strong><br>`;
                successRewards.unlockedGoods.forEach(good => {
                    rewardText += `‚Ä¢ ${good.replace('_', ' ').toUpperCase()}<br>`;
                });
                rewardText += '<br>';
            }
            
            if (successRewards.skills) {
                rewardText += `<strong>üìà Skill Improvements:</strong><br>`;
                Object.keys(successRewards.skills).forEach(skill => {
                    rewardText += `‚Ä¢ +${successRewards.skills[skill]} ${skill.toUpperCase()}<br>`;
                });
                rewardText += '<br>';
            }
            
            if (successRewards.specialUnlock === 'colonial_expansion') {
                rewardText += `<strong>üåé MAJOR DISCOVERY:</strong><br>` +
                            `‚Ä¢ Access to COLONIAL EXPANSION unlocked!<br>` +
                            `‚Ä¢ New World opportunities now available!<br><br>`;
            }
            
            rewardText += `<em>These discoveries will open new opportunities across the empire!</em>`;
            
            this.showEmergencyEvent('üéâ Expedition Success!', rewardText);
        } else {
    const loss = Math.floor(expedition.cost * 0.15); // Reduced loss from 30% to 15%
            this.showActivityResult('‚ö†Ô∏è Expedition Difficulties', 
                `Your ${expedition.name} expedition encountered serious problems.<br><br>` +
                `<strong>Setbacks:</strong><br>` +
                `‚Ä¢ Additional costs: ${loss} gold<br>` +
                `‚Ä¢ Equipment damaged, crew injuries<br>` +
                `‚Ä¢ Some maps and supplies lost<br><br>` +
                `<strong>But not all is lost...</strong><br>` +
                `‚Ä¢ +1 exploration reputation (experience gained)<br>` +
                `‚Ä¢ +0.2 leadership skill (crisis management)<br><br>` +
                `<em>The crew returns with valuable experience despite the setbacks. Sometimes failure teaches more than success.</em>`);
            this.characterData.stats.money -= loss;
            this.gameState.explorationData.reputation += 1;
            this.characterData.stats.leadership += 0.2;
        }
        
            this.advanceRegularTime(expedition.days);        
        
    }

}        
       
// Initialize the game when page loads
window.addEventListener('DOMContentLoaded', () => {
    window.game = new ColonialGame();
});

    </script>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyD6bJC0uBWIRYSmk6Td-iBxG4OuV7UldgU",
  authDomain: "tides-of-fortune.firebaseapp.com",
  projectId: "tides-of-fortune",
  storageBucket: "tides-of-fortune.firebasestorage.app",
  messagingSenderId: "970834608669",
  appId: "1:970834608669:web:d590e957504e4382bdfcf4",
  measurementId: "G-EDLXEW8645"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();

console.log('Firebase Analytics initialized');
// Game Analytics Helper Function
window.trackGameEvent = function(eventName, parameters = {}) {
  if (analytics) {
    analytics.logEvent(eventName, parameters);
  }
  console.log('Analytics Event:', eventName, parameters);
};

// Track game start
trackGameEvent('game_loaded');

    
</script>
            
        
<script>
// Mobile-friendly testing background unlock
let titleTapCount = 0;
let titleTapTimer = null;

document.getElementById('titleScreen').querySelector('h1').addEventListener('click', function() {
    titleTapCount++;
    
    if (titleTapTimer) {
        clearTimeout(titleTapTimer);
    }
    
    if (titleTapCount >= 3) {
        const testingCard = document.getElementById('testingBackground');
        if (testingCard.style.display === 'none') {
            testingCard.style.display = 'block';
            // Optional: Brief flash to confirm activation
            this.style.color = '#d4af37';
            setTimeout(() => this.style.color = '#2c3e50', 200);
        } else {
            testingCard.style.display = 'none';
        }
        titleTapCount = 0;
    }
    
    // Reset counter after 2 seconds
    titleTapTimer = setTimeout(() => {
        titleTapCount = 0;
    }, 2000);
});
    </script>
</body>
</html>
